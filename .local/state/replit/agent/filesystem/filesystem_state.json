{"file_contents":{"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"server/storage.ts":{"content":"// Updated storage with only the 10 specified destinations\nimport { \n  User, Trip, Itinerary, BlogPost, Merchandise, Destination, Experience, \n  InsertUser, InsertTrip, InsertItinerary, InsertBlogPost, InsertMerchandise, \n  InsertDestination, InsertExperience, ExpenseGroup, Expense, \n  InsertExpenseGroup, InsertExpense, GeneratedItinerary, InsertGeneratedItinerary\n} from \"@shared/schema\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: number): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUserPremiumStatus(id: number, isPremium: boolean): Promise<User | undefined>;\n  \n  // Trip operations\n  getTrip(id: number): Promise<Trip | undefined>;\n  getTripsByUserId(userId: number): Promise<Trip[]>;\n  createTrip(trip: InsertTrip): Promise<Trip>;\n\n  // Itinerary operations\n  getItinerary(id: number): Promise<Itinerary | undefined>;\n  getItinerariesByTripId(tripId: number): Promise<Itinerary[]>;\n  createItinerary(itinerary: InsertItinerary): Promise<Itinerary>;\n\n  // Blog post operations\n  getBlogPost(id: number): Promise<BlogPost | undefined>;\n  getFreeBlogPosts(): Promise<BlogPost[]>;\n  getAllBlogPosts(): Promise<BlogPost[]>;\n  createBlogPost(blogPost: InsertBlogPost): Promise<BlogPost>;\n\n  // Merchandise operations\n  getMerchandise(id: number): Promise<Merchandise | undefined>;\n  getAllMerchandise(): Promise<Merchandise[]>;\n  getMerchandiseByType(type: string): Promise<Merchandise[]>;\n  createMerchandise(merchandise: InsertMerchandise): Promise<Merchandise>;\n\n  // Destination operations\n  getDestination(id: number): Promise<Destination | undefined>;\n  getAllDestinations(): Promise<Destination[]>;\n  createDestination(destination: InsertDestination): Promise<Destination>;\n\n  // Experience operations\n  getExperience(id: number): Promise<Experience | undefined>;\n  getAllExperiences(): Promise<Experience[]>;\n  createExperience(experience: InsertExperience): Promise<Experience>;\n  \n  // Expense group operations (SplittaBro feature)\n  getExpenseGroup(id: number): Promise<ExpenseGroup | undefined>;\n  getExpenseGroupsByTripId(tripId: number): Promise<ExpenseGroup[]>;\n  getAllExpenseGroups(): Promise<ExpenseGroup[]>;\n  createExpenseGroup(group: InsertExpenseGroup): Promise<ExpenseGroup>;\n  \n  // Expense operations (SplittaBro feature)\n  getExpense(id: number): Promise<Expense | undefined>;\n  getExpensesByGroupId(groupId: number): Promise<Expense[]>;\n  createExpense(expense: InsertExpense): Promise<Expense>;\n  updateExpense(id: number, expense: Partial<InsertExpense>): Promise<Expense | undefined>;\n  deleteExpense(id: number): Promise<boolean>;\n  \n  // Generated Itinerary operations (OneClick Assistant)\n  getGeneratedItinerary(id: number): Promise<GeneratedItinerary | undefined>;\n  getGeneratedItinerariesByUserId(userId: number): Promise<GeneratedItinerary[]>;\n  createGeneratedItinerary(itinerary: InsertGeneratedItinerary): Promise<GeneratedItinerary>;\n  updateGeneratedItinerary(id: number, itinerary: Partial<InsertGeneratedItinerary>): Promise<GeneratedItinerary | undefined>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<number, User>;\n  private trips: Map<number, Trip>;\n  private itineraries: Map<number, Itinerary>;\n  private blogPosts: Map<number, BlogPost>;\n  private merchandiseItems: Map<number, Merchandise>;\n  private destinations: Map<number, Destination>;\n  private experiences: Map<number, Experience>;\n  private expenseGroups: Map<number, ExpenseGroup>;\n  private expenseItems: Map<number, Expense>;\n  private generatedItineraries: Map<number, GeneratedItinerary>;\n\n  private userId: number;\n  private tripId: number;\n  private itineraryId: number;\n  private blogPostId: number;\n  private merchandiseId: number;\n  private destinationId: number;\n  private experienceId: number;\n  private expenseGroupId: number;\n  private expenseId: number;\n  private generatedItineraryId: number;\n\n  constructor() {\n    this.users = new Map();\n    this.trips = new Map();\n    this.itineraries = new Map();\n    this.blogPosts = new Map();\n    this.merchandiseItems = new Map();\n    this.destinations = new Map();\n    this.experiences = new Map();\n    this.expenseGroups = new Map();\n    this.expenseItems = new Map();\n    this.generatedItineraries = new Map();\n\n    this.userId = 1;\n    this.tripId = 1;\n    this.itineraryId = 1;\n    this.blogPostId = 1;\n    this.merchandiseId = 1;\n    this.destinationId = 1;\n    this.experienceId = 1;\n    this.expenseGroupId = 1;\n    this.expenseId = 1;\n    this.generatedItineraryId = 1;\n\n    // Initialize with sample data\n    this.initializeDestinations();\n    this.initializeExperiences();\n    this.initializeBlogPosts();\n    this.initializeMerchandise();\n  }\n\n  // User operations\n  async getUser(id: number): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.username === username);\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.email === email);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const user: User = { \n      id: this.userId++, \n      ...insertUser,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.users.set(user.id, user);\n    return user;\n  }\n\n  async updateUserPremiumStatus(id: number, isPremium: boolean): Promise<User | undefined> {\n    const user = this.users.get(id);\n    if (!user) return undefined;\n    \n    const updatedUser: User = {\n      ...user,\n      isPremium,\n      updatedAt: new Date()\n    };\n    this.users.set(id, updatedUser);\n    return updatedUser;\n  }\n\n  // Trip operations\n  async getTrip(id: number): Promise<Trip | undefined> {\n    return this.trips.get(id);\n  }\n\n  async getTripsByUserId(userId: number): Promise<Trip[]> {\n    return Array.from(this.trips.values()).filter(trip => trip.userId === userId);\n  }\n\n  async createTrip(insertTrip: InsertTrip): Promise<Trip> {\n    const trip: Trip = { \n      id: this.tripId++, \n      ...insertTrip,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.trips.set(trip.id, trip);\n    return trip;\n  }\n\n  // Itinerary operations\n  async getItinerary(id: number): Promise<Itinerary | undefined> {\n    return this.itineraries.get(id);\n  }\n\n  async getItinerariesByTripId(tripId: number): Promise<Itinerary[]> {\n    return Array.from(this.itineraries.values()).filter(itinerary => itinerary.tripId === tripId);\n  }\n\n  async createItinerary(insertItinerary: InsertItinerary): Promise<Itinerary> {\n    const itinerary: Itinerary = { \n      id: this.itineraryId++, \n      ...insertItinerary,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.itineraries.set(itinerary.id, itinerary);\n    return itinerary;\n  }\n\n  // Blog post operations\n  async getBlogPost(id: number): Promise<BlogPost | undefined> {\n    return this.blogPosts.get(id);\n  }\n\n  async getFreeBlogPosts(): Promise<BlogPost[]> {\n    return Array.from(this.blogPosts.values()).filter(post => !post.isPremium);\n  }\n\n  async getAllBlogPosts(): Promise<BlogPost[]> {\n    return Array.from(this.blogPosts.values());\n  }\n\n  async createBlogPost(insertBlogPost: InsertBlogPost): Promise<BlogPost> {\n    const blogPost: BlogPost = { \n      id: this.blogPostId++, \n      ...insertBlogPost,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.blogPosts.set(blogPost.id, blogPost);\n    return blogPost;\n  }\n\n  // Merchandise operations\n  async getMerchandise(id: number): Promise<Merchandise | undefined> {\n    return this.merchandiseItems.get(id);\n  }\n\n  async getAllMerchandise(): Promise<Merchandise[]> {\n    return Array.from(this.merchandiseItems.values());\n  }\n\n  async getMerchandiseByType(type: string): Promise<Merchandise[]> {\n    return Array.from(this.merchandiseItems.values()).filter(item => item.type === type);\n  }\n\n  async createMerchandise(insertMerchandise: InsertMerchandise): Promise<Merchandise> {\n    const merchandise: Merchandise = { \n      id: this.merchandiseId++, \n      ...insertMerchandise,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.merchandiseItems.set(merchandise.id, merchandise);\n    return merchandise;\n  }\n\n  // Destination operations\n  async getDestination(id: number): Promise<Destination | undefined> {\n    return this.destinations.get(id);\n  }\n\n  async getAllDestinations(): Promise<Destination[]> {\n    return Array.from(this.destinations.values());\n  }\n\n  async createDestination(insertDestination: InsertDestination): Promise<Destination> {\n    const destination: Destination = { \n      id: this.destinationId++, \n      ...insertDestination,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.destinations.set(destination.id, destination);\n    return destination;\n  }\n\n  // Experience operations\n  async getExperience(id: number): Promise<Experience | undefined> {\n    return this.experiences.get(id);\n  }\n\n  async getAllExperiences(): Promise<Experience[]> {\n    return Array.from(this.experiences.values());\n  }\n\n  async createExperience(insertExperience: InsertExperience): Promise<Experience> {\n    const experience: Experience = { \n      id: this.experienceId++, \n      ...insertExperience,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.experiences.set(experience.id, experience);\n    return experience;\n  }\n\n  // Expense group operations\n  async getExpenseGroup(id: number): Promise<ExpenseGroup | undefined> {\n    return this.expenseGroups.get(id);\n  }\n\n  async getExpenseGroupsByTripId(tripId: number): Promise<ExpenseGroup[]> {\n    return Array.from(this.expenseGroups.values()).filter(group => group.tripId === tripId);\n  }\n\n  async getAllExpenseGroups(): Promise<ExpenseGroup[]> {\n    return Array.from(this.expenseGroups.values());\n  }\n\n  async createExpenseGroup(insertGroup: InsertExpenseGroup): Promise<ExpenseGroup> {\n    const group: ExpenseGroup = { \n      id: this.expenseGroupId++, \n      ...insertGroup,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.expenseGroups.set(group.id, group);\n    return group;\n  }\n\n  // Expense operations\n  async getExpense(id: number): Promise<Expense | undefined> {\n    return this.expenseItems.get(id);\n  }\n\n  async getExpensesByGroupId(groupId: number): Promise<Expense[]> {\n    return Array.from(this.expenseItems.values()).filter(expense => expense.groupId === groupId);\n  }\n\n  async createExpense(insertExpense: InsertExpense): Promise<Expense> {\n    const expense: Expense = { \n      id: this.expenseId++, \n      ...insertExpense,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.expenseItems.set(expense.id, expense);\n    return expense;\n  }\n\n  async updateExpense(id: number, updateData: Partial<InsertExpense>): Promise<Expense | undefined> {\n    const expense = this.expenseItems.get(id);\n    if (!expense) return undefined;\n    \n    const updatedExpense: Expense = {\n      ...expense,\n      ...updateData,\n      updatedAt: new Date()\n    };\n    this.expenseItems.set(id, updatedExpense);\n    return updatedExpense;\n  }\n\n  async deleteExpense(id: number): Promise<boolean> {\n    return this.expenseItems.delete(id);\n  }\n\n  // Generated Itinerary operations (OneClick Assistant)\n  async getGeneratedItinerary(id: number): Promise<GeneratedItinerary | undefined> {\n    return this.generatedItineraries.get(id);\n  }\n\n  async getGeneratedItinerariesByUserId(userId: number): Promise<GeneratedItinerary[]> {\n    return Array.from(this.generatedItineraries.values()).filter(\n      itinerary => itinerary.userId === userId\n    );\n  }\n\n  async createGeneratedItinerary(insertItinerary: InsertGeneratedItinerary): Promise<GeneratedItinerary> {\n    const itinerary: GeneratedItinerary = { \n      id: this.generatedItineraryId++, \n      ...insertItinerary,\n      status: insertItinerary.status || \"draft\",\n      createdAt: new Date()\n    };\n    this.generatedItineraries.set(itinerary.id, itinerary);\n    return itinerary;\n  }\n\n  async updateGeneratedItinerary(id: number, updates: Partial<InsertGeneratedItinerary>): Promise<GeneratedItinerary | undefined> {\n    const itinerary = this.generatedItineraries.get(id);\n    if (!itinerary) return undefined;\n    \n    const updatedItinerary: GeneratedItinerary = {\n      ...itinerary,\n      ...updates\n    };\n    this.generatedItineraries.set(id, updatedItinerary);\n    return updatedItinerary;\n  }\n\n  // Initialize with only the 10 specified destinations\n  private initializeDestinations() {\n    const destinations = [\n      {\n        name: \"Roma\",\n        country: \"Italy\",\n        image: \"https://images.unsplash.com/photo-1552832230-c0197dd311b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"La Città Eterna - storia, cultura e vita notturna indimenticabile nella capitale italiana.\",\n        tags: [\"Storia\", \"Cultura\", \"Vita notturna\"],\n        rating: \"4.8\",\n        reviewCount: 512\n      },\n      {\n        name: \"Ibiza\",\n        country: \"Spain\", \n        image: \"https://images.unsplash.com/photo-1519046904884-53103b34b206?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"L'isola del divertimento - club leggendari, spiagge da sogno e feste senza fine.\",\n        tags: [\"Club\", \"Spiagge\", \"Festa\"],\n        rating: \"4.9\",\n        reviewCount: 678\n      },\n      {\n        name: \"Barcellona\", \n        country: \"Spain\",\n        image: \"https://images.unsplash.com/photo-1583422409516-2895a77efded?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Sole, mare, sangria e vita notturna spettacolare - la destinazione mediterranea perfetta.\",\n        tags: [\"Spiagge\", \"Vita notturna\", \"Cultura\"],\n        rating: \"4.9\",\n        reviewCount: 445\n      },\n      {\n        name: \"Praga\",\n        country: \"Czech Republic\",\n        image: \"https://images.unsplash.com/photo-1541849546-216549ae216d?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Fascino medievale e vita notturna leggendaria - perfetta per gli amanti della birra.\",\n        tags: [\"Birra\", \"Vita notturna\", \"Cultura\"],\n        rating: \"4.8\",\n        reviewCount: 342\n      },\n      {\n        name: \"Budapest\",\n        country: \"Hungary\",\n        image: \"https://images.unsplash.com/photo-1468824357306-a439d58ccb1c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Terme, ruin bar e vita notturna incredibile nella Perla del Danubio.\",\n        tags: [\"Terme\", \"Ruin Bars\", \"Vita notturna\"],\n        rating: \"4.6\",\n        reviewCount: 298\n      },\n      {\n        name: \"Cracovia\",\n        country: \"Poland\",\n        image: \"https://images.unsplash.com/photo-1598970434795-0c54fe7c0648?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Città storica con prezzi accessibili e vita notturna vivace nel cuore della Polonia.\",\n        tags: [\"Storia\", \"Prezzi bassi\", \"Vita notturna\"],\n        rating: \"4.5\",\n        reviewCount: 234\n      },\n      {\n        name: \"Amsterdam\",\n        country: \"Netherlands\",\n        image: \"https://images.unsplash.com/photo-1512470876302-972faa2aa9a4?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"La Venezia del Nord - tour sui canali, vita notturna e addii al celibato indimenticabili.\",\n        tags: [\"Canali\", \"Vita notturna\", \"Cultura\"],\n        rating: \"4.7\",\n        reviewCount: 389\n      },\n      {\n        name: \"Berlino\",\n        country: \"Germany\",\n        image: \"https://images.unsplash.com/photo-1599946347371-68eb71b16afc?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Club underground, street art e vita notturna senza fine nella capitale europea delle feste.\",\n        tags: [\"Underground\", \"Club\", \"Arte\"],\n        rating: \"4.5\",\n        reviewCount: 267\n      },\n      {\n        name: \"Lisbona\",\n        country: \"Portugal\",\n        image: \"https://images.unsplash.com/photo-1585208798174-6cedd86e019a?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Fascino costiero, vita notturna vivace e pesce fresco nella splendida capitale portoghese.\",\n        tags: [\"Costa\", \"Vita notturna\", \"Gastronomia\"],\n        rating: \"4.4\",\n        reviewCount: 189\n      },\n      {\n        name: \"Palma de Mallorca\",\n        country: \"Spain\",\n        image: \"https://images.unsplash.com/photo-1562883676-8c7feb83f09b?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=500&q=90\",\n        description: \"Isola balearica con spiagge cristalline, beach club e vita notturna mediterranea.\",\n        tags: [\"Spiagge\", \"Beach club\", \"Isola\"],\n        rating: \"4.6\",\n        reviewCount: 156\n      }\n    ];\n    \n    destinations.forEach(destination => {\n      this.createDestination(destination);\n    });\n  }\n\n  private initializeExperiences() {\n    const experiences = [\n      {\n        name: \"The Ultimate BroNight\",\n        description: \"Epic club-hopping, exclusive nightclubs, casinos, and unforgettable alcohol-fueled adventures.\",\n        image: \"https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      },\n      {\n        name: \"My Olympic Bro\",\n        description: \"Exciting sports activities, live sporting events, competitive challenges, and vibrant bars.\",\n        image: \"https://images.unsplash.com/photo-1518063319789-7217e6706b04?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      },\n      {\n        name: \"Chill and Feel the Bro\",\n        description: \"Relaxed upscale experiences, chic restaurants, refined bars, and elegant city tours.\",\n        image: \"https://images.unsplash.com/photo-1534766555764-ce878a5e3a2b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      },\n      {\n        name: \"The Wild Broventure\",\n        description: \"One last wild adventure with your bros - outdoor activities, hiking, camping, and beers by the fire.\",\n        image: \"https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      }\n    ];\n    \n    experiences.forEach(experience => {\n      this.createExperience(experience);\n    });\n  }\n\n  private initializeBlogPosts() {\n    const blogPosts = [\n      {\n        title: \"Roma: The Night We Can't Remember\",\n        excerpt: \"Epic Roman nights that blend history with modern party culture...\",\n        content: \"From Trastevere's wine bars to Testaccio's underground clubs, Rome offers an incredible nightlife scene...\",\n        image: \"https://images.unsplash.com/photo-1552832230-c0197dd311b5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        tags: [\"nightlife\", \"rome\", \"history\"],\n        isPremium: false\n      },\n      {\n        title: \"Ibiza Uncovered: The Ultimate Party Guide\",\n        excerpt: \"Everything you need to know about Ibiza's legendary club scene...\",\n        content: \"From Amnesia to Pacha, we break down the best clubs, when to go, and how to do it right...\",\n        image: \"https://images.unsplash.com/photo-1544552866-d3ed42536cfd?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        tags: [\"ibiza\", \"clubs\", \"nightlife\"],\n        isPremium: true\n      },\n      {\n        title: \"Cracovia: Eastern Europe's Hidden Gem\",\n        excerpt: \"Discover why Poland's ancient capital is becoming the go-to destination...\",\n        content: \"Affordable prices, incredible architecture, and a nightlife scene that rivals any major European city...\",\n        image: \"https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        tags: [\"krakow\", \"budget\", \"culture\"],\n        isPremium: false\n      }\n    ];\n    \n    blogPosts.forEach(post => {\n      this.createBlogPost(post);\n    });\n  }\n\n  private initializeMerchandise() {\n    const merchandise = [\n      {\n        name: \"Custom T-Shirts\",\n        description: \"Personalized bachelor party t-shirts with your group's name and destination\",\n        price: 25.99,\n        image: \"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        type: \"apparel\"\n      },\n      {\n        name: \"ByeBro Flask Set\",\n        description: \"Premium stainless steel flasks engraved with your bachelor party details\",\n        price: 45.99,\n        image: \"https://images.unsplash.com/photo-1544966503-7cc5ac882d5d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        type: \"accessories\"\n      },\n      {\n        name: \"Memory Book\",\n        description: \"Custom photo album to capture all your unforgettable moments\",\n        price: 35.99,\n        image: \"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        type: \"keepsakes\"\n      }\n    ];\n    \n    merchandise.forEach(item => {\n      this.createMerchandise(item);\n    });\n  }\n}\n\nexport const storage = new MemStorage();","path":null,"size_bytes":21125,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/SplittaBro.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogDescription } from '@/components/ui/dialog';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Separator } from '@/components/ui/separator';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Plus, Users, Receipt, DollarSign, User, Trash2, Edit, Calculator, ArrowRight, TrendingUp, Sparkles } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\n\ninterface ExpenseGroup {\n  id: number;\n  name: string;\n  description?: string;\n  members: string[];\n  totalAmount: number;\n  currency: string;\n  createdAt: string;\n}\n\ninterface Expense {\n  id: number;\n  groupId: number;\n  description: string;\n  amount: number;\n  paidBy: string;\n  splitBetween: string[];\n  category: string;\n  date: string;\n  receipt?: string;\n}\n\ninterface Settlement {\n  from: string;\n  to: string;\n  amount: number;\n}\n\nconst createGroupSchema = z.object({\n  name: z.string().min(1, 'Nome gruppo richiesto'),\n  description: z.string().optional(),\n  members: z.array(z.string()).min(1, 'Almeno un membro richiesto'),\n});\n\nconst createExpenseSchema = z.object({\n  description: z.string().min(1, 'Descrizione richiesta'),\n  amount: z.number().min(0.01, 'Importo deve essere maggiore di 0'),\n  paidBy: z.string().min(1, 'Chi ha pagato è richiesto'),\n  splitBetween: z.array(z.string()).min(1, 'Seleziona almeno una persona'),\n  category: z.string().min(1, 'Categoria richiesta'),\n  date: z.string().min(1, 'Data richiesta'),\n  splitEqually: z.boolean().optional(),\n});\n\ntype CreateGroupFormValues = z.infer<typeof createGroupSchema>;\ntype CreateExpenseFormValues = z.infer<typeof createExpenseSchema>;\n\nexport function SplittaBro() {\n  const [groups, setGroups] = useState<ExpenseGroup[]>([]);\n  const [expenses, setExpenses] = useState<Expense[]>([]);\n  const [selectedGroup, setSelectedGroup] = useState<ExpenseGroup | null>(null);\n  const [showCreateGroup, setShowCreateGroup] = useState(false);\n  const [showCreateExpense, setShowCreateExpense] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isCreatingGroup, setIsCreatingGroup] = useState(false);\n  const { toast } = useToast();\n  const [location, navigate] = useLocation();\n\n  const groupForm = useForm<CreateGroupFormValues>({\n    resolver: zodResolver(createGroupSchema),\n    defaultValues: {\n      name: '',\n      description: '',\n      members: [],\n    },\n  });\n\n  const [newMemberName, setNewMemberName] = useState('');\n\n  const expenseForm = useForm<CreateExpenseFormValues>({\n    resolver: zodResolver(createExpenseSchema),\n    defaultValues: {\n      description: '',\n      amount: 0,\n      paidBy: '',\n      splitBetween: [],\n      category: 'food',\n      date: new Date().toISOString().split('T')[0],\n      splitEqually: false,\n    },\n  });\n\n  useEffect(() => {\n    loadGroups();\n  }, []);\n\n  useEffect(() => {\n    if (selectedGroup) {\n      loadExpenses(selectedGroup.id);\n    }\n  }, [selectedGroup]);\n\n  const loadGroups = async () => {\n    try {\n      const response = await fetch('/api/expense-groups');\n      if (response.ok) {\n        const groupsData = await response.json();\n        setGroups(groupsData);\n      }\n    } catch (error) {\n      console.error('Errore caricamento gruppi:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const loadExpenses = async (groupId: number) => {\n    try {\n      const response = await fetch(`/api/expense-groups/${groupId}/expenses`);\n      if (response.ok) {\n        const expensesData = await response.json();\n        setExpenses(expensesData);\n      }\n    } catch (error) {\n      console.error('Errore caricamento spese:', error);\n    }\n  };\n\n  const onCreateGroup = async (data: CreateGroupFormValues) => {\n    setIsCreatingGroup(true);\n    \n    try {\n      const response = await fetch('/api/expense-groups', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: data.name,\n          description: data.description,\n          members: data.members,\n          currency: 'EUR',\n        }),\n      });\n\n      if (response.ok) {\n        const newGroup = await response.json();\n        setGroups(prev => [...prev, newGroup]);\n        setShowCreateGroup(false);\n        groupForm.reset({\n          name: '',\n          description: '',\n          members: [],\n        });\n        setNewMemberName('');\n        \n        // Redirect automatico al gruppo appena creato\n        setSelectedGroup(newGroup);\n        \n        toast({\n          title: \"✅ Gruppo creato con successo!\",\n          description: `${newGroup.name} è stato creato. Ora puoi aggiungere le spese.`,\n        });\n      } else {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.message || 'Errore nella creazione del gruppo');\n      }\n    } catch (error) {\n      console.error('Errore creazione gruppo:', error);\n      toast({\n        title: \"❌ Impossibile creare il gruppo\",\n        description: error instanceof Error \n          ? error.message \n          : \"Si è verificato un errore. Controlla la connessione e riprova più tardi.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsCreatingGroup(false);\n    }\n  };\n\n  const addMember = () => {\n    if (newMemberName.trim()) {\n      const currentMembers = groupForm.getValues('members') || [];\n      if (!currentMembers.includes(newMemberName.trim())) {\n        groupForm.setValue('members', [...currentMembers, newMemberName.trim()]);\n        setNewMemberName('');\n      }\n    }\n  };\n\n  const removeMember = (memberToRemove: string) => {\n    const currentMembers = groupForm.getValues('members') || [];\n    groupForm.setValue('members', currentMembers.filter(m => m !== memberToRemove));\n  };\n\n  const onCreateExpense = async (data: CreateExpenseFormValues) => {\n    if (!selectedGroup) return;\n\n    try {\n      const splitBetween = data.splitEqually ? selectedGroup.members : data.splitBetween;\n      \n      const response = await fetch('/api/expenses', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          groupId: selectedGroup.id,\n          description: data.description,\n          amount: Math.round(data.amount * 100),\n          paidBy: data.paidBy,\n          splitBetween: splitBetween,\n          category: data.category,\n          date: data.date,\n        }),\n      });\n\n      if (response.ok) {\n        const newExpense = await response.json();\n        setExpenses(prev => [...prev, newExpense]);\n        setShowCreateExpense(false);\n        expenseForm.reset({\n          description: '',\n          amount: 0,\n          paidBy: '',\n          splitBetween: [],\n          category: 'food',\n          date: new Date().toISOString().split('T')[0],\n          splitEqually: false,\n        });\n        \n        const groupTotal = [...expenses, newExpense].reduce((sum, exp) => sum + exp.amount, 0) / 100;\n        setGroups(prev => prev.map(g => \n          g.id === selectedGroup.id ? { ...g, totalAmount: groupTotal } : g\n        ));\n        \n        toast({\n          title: \"Spesa aggiunta!\",\n          description: \"La spesa è stata registrata con successo.\",\n        });\n      } else {\n        const errorData = await response.json();\n        console.error('Errore validazione:', errorData);\n        throw new Error('Errore nella creazione della spesa');\n      }\n    } catch (error) {\n      console.error('Errore creazione spesa:', error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiungere la spesa. Riprova.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const calculateSettlements = (group: ExpenseGroup, expenses: Expense[]): Settlement[] => {\n    if (!group || expenses.length === 0) return [];\n\n    const balances: { [member: string]: number } = {};\n    \n    group.members.forEach(member => {\n      balances[member] = 0;\n    });\n\n    expenses.forEach(expense => {\n      const amountPerPerson = expense.amount / expense.splitBetween.length;\n      balances[expense.paidBy] += expense.amount;\n      expense.splitBetween.forEach(member => {\n        balances[member] -= amountPerPerson;\n      });\n    });\n\n    const settlements: Settlement[] = [];\n    const creditors = Object.entries(balances).filter(([_, amount]) => amount > 0);\n    const debtors = Object.entries(balances).filter(([_, amount]) => amount < 0);\n\n    creditors.forEach(([creditor, creditAmount]) => {\n      debtors.forEach(([debtor, debtAmount]) => {\n        if (Math.abs(debtAmount) > 0.01 && creditAmount > 0.01) {\n          const settlementAmount = Math.min(creditAmount, Math.abs(debtAmount));\n          settlements.push({\n            from: debtor,\n            to: creditor,\n            amount: settlementAmount,\n          });\n          \n          balances[creditor] -= settlementAmount;\n          balances[debtor] += settlementAmount;\n        }\n      });\n    });\n\n    return settlements.filter(s => s.amount > 0.01);\n  };\n\n  const getCategoryIcon = (category: string) => {\n    const icons: { [key: string]: string } = {\n      food: '🍽️',\n      transport: '🚗',\n      accommodation: '🏨',\n      entertainment: '🎉',\n      shopping: '🛍️',\n      other: '📋',\n    };\n    return icons[category] || '📋';\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-black via-gray-900 to-black flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"relative w-16 h-16 mx-auto mb-4\">\n            <div className=\"absolute inset-0 rounded-full border-4 border-red-600/30\"></div>\n            <div className=\"absolute inset-0 rounded-full border-4 border-red-600 border-t-transparent animate-spin\"></div>\n          </div>\n          <p className=\"text-white text-lg\">Caricamento SplittaBro...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-black via-gray-900 to-black text-white\">\n      <div className=\"container mx-auto px-4 py-6 md:py-8\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row items-center justify-between mb-8 gap-4\">\n          <button\n            onClick={() => navigate('/')}\n            className=\"font-poppins font-bold text-xl md:text-2xl transform transition-transform hover:scale-105 cursor-pointer\"\n            data-testid=\"button-home\"\n          >\n            <span className=\"text-white\">Bye</span><span className=\"text-red-600\">Bro</span>\n          </button>\n          <div className=\"text-center flex-1\">\n            <div className=\"flex items-center justify-center gap-3 mb-2\">\n              <Sparkles className=\"w-8 h-8 text-red-500\" />\n              <h1 className=\"text-3xl md:text-5xl font-bold bg-gradient-to-r from-red-500 via-red-600 to-red-500 bg-clip-text text-transparent\">\n                SplittaBro\n              </h1>\n              <Sparkles className=\"w-8 h-8 text-red-500\" />\n            </div>\n            <p className=\"text-gray-400 text-sm md:text-base\">Dividi le spese del tuo addio al celibato</p>\n          </div>\n          <div className=\"w-20 hidden md:block\"></div>\n        </div>\n\n        {!selectedGroup ? (\n          /* Vista Gruppi */\n          <div className=\"space-y-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n              <h2 className=\"text-2xl md:text-3xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent\">\n                I tuoi gruppi\n              </h2>\n              <Dialog open={showCreateGroup} onOpenChange={setShowCreateGroup}>\n                <DialogTrigger asChild>\n                  <Button \n                    className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white shadow-lg shadow-red-500/30 w-full sm:w-auto\"\n                    data-testid=\"button-create-group\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Nuovo Gruppo\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"bg-gradient-to-br from-gray-900 to-black border border-red-500/20 text-white max-w-md\">\n                  <DialogHeader>\n                    <DialogTitle className=\"text-white text-xl\">Crea Nuovo Gruppo</DialogTitle>\n                    <DialogDescription className=\"text-gray-400\">\n                      Crea un nuovo gruppo per dividere le spese del tuo addio al celibato\n                    </DialogDescription>\n                  </DialogHeader>\n                  <form onSubmit={groupForm.handleSubmit(onCreateGroup)} className=\"space-y-4\">\n                    <div>\n                      <Label htmlFor=\"name\" className=\"text-white\">Nome Gruppo</Label>\n                      <Input\n                        id=\"name\"\n                        {...groupForm.register('name')}\n                        placeholder=\"es. Addio al Celibato Marco\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-group-name\"\n                      />\n                      {groupForm.formState.errors.name && (\n                        <p className=\"text-red-400 text-sm mt-1\">\n                          {groupForm.formState.errors.name.message}\n                        </p>\n                      )}\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"description\" className=\"text-white\">Descrizione (opzionale)</Label>\n                      <Textarea\n                        id=\"description\"\n                        {...groupForm.register('description')}\n                        placeholder=\"Descrizione del gruppo...\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-group-description\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-white\">Membri</Label>\n                      <div className=\"space-y-2 mt-2\">\n                        <div className=\"flex gap-2\">\n                          <Input\n                            value={newMemberName}\n                            onChange={(e) => setNewMemberName(e.target.value)}\n                            placeholder=\"Nome del membro\"\n                            className=\"bg-gray-800/50 border-gray-700 text-white flex-1\"\n                            onKeyPress={(e) => {\n                              if (e.key === 'Enter') {\n                                e.preventDefault();\n                                addMember();\n                              }\n                            }}\n                            data-testid=\"input-member-name\"\n                          />\n                          <Button\n                            type=\"button\"\n                            onClick={addMember}\n                            className=\"bg-red-600 hover:bg-red-700\"\n                            data-testid=\"button-add-member\"\n                          >\n                            <Plus className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        <ScrollArea className=\"max-h-32\">\n                          <div className=\"space-y-1\">\n                            {groupForm.watch('members')?.map((member, index) => (\n                              <div \n                                key={index} \n                                className=\"flex items-center justify-between bg-gradient-to-r from-red-500/10 to-red-600/10 px-3 py-2 rounded-lg border border-red-500/30\"\n                                data-testid={`member-${index}`}\n                              >\n                                <span className=\"text-white text-sm font-medium\">{member}</span>\n                                <Button\n                                  type=\"button\"\n                                  onClick={() => removeMember(member)}\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"text-red-400 hover:text-red-300 hover:bg-red-900/20 h-8 w-8 p-0\"\n                                  data-testid={`button-remove-member-${index}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4\" />\n                                </Button>\n                              </div>\n                            ))}\n                          </div>\n                        </ScrollArea>\n                        {groupForm.formState.errors.members && (\n                          <p className=\"text-red-400 text-sm\">\n                            {groupForm.formState.errors.members.message}\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                    \n                    <DialogFooter>\n                      <Button \n                        type=\"submit\" \n                        disabled={isCreatingGroup}\n                        className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 w-full disabled:opacity-50 disabled:cursor-not-allowed\"\n                        data-testid=\"button-submit-group\"\n                      >\n                        {isCreatingGroup ? (\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div>\n                            Creazione in corso...\n                          </div>\n                        ) : (\n                          \"Crea Gruppo\"\n                        )}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            {groups.length === 0 ? (\n              <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-red-500/20 backdrop-blur-sm\">\n                <CardContent className=\"text-center py-16\">\n                  <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4\">\n                    <Users className=\"h-10 w-10 text-red-400\" />\n                  </div>\n                  <h3 className=\"text-2xl font-bold text-white mb-2\">Nessun gruppo ancora</h3>\n                  <p className=\"text-gray-400 mb-6 max-w-md mx-auto\">Crea il tuo primo gruppo per iniziare a dividere le spese del tuo addio al celibato!</p>\n                  <Button\n                    onClick={() => setShowCreateGroup(true)}\n                    className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 shadow-lg shadow-red-500/30\"\n                    data-testid=\"button-create-first-group\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Crea il primo gruppo\n                  </Button>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n                {groups.map((group) => (\n                  <Card\n                    key={group.id}\n                    className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 hover:border-red-500 cursor-pointer transition-all hover:shadow-xl hover:shadow-red-500/20 backdrop-blur-sm group\"\n                    onClick={() => setSelectedGroup(group)}\n                    data-testid={`group-card-${group.id}`}\n                  >\n                    <CardHeader>\n                      <div className=\"flex justify-between items-start\">\n                        <div className=\"flex-1\">\n                          <CardTitle className=\"text-white text-lg mb-1 group-hover:text-red-400 transition-colors\">\n                            {group.name}\n                          </CardTitle>\n                          {group.description && (\n                            <p className=\"text-gray-400 text-sm\">{group.description}</p>\n                          )}\n                        </div>\n                        <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 px-3 py-1 rounded-lg border border-red-500/30\">\n                          <p className=\"text-red-400 font-bold text-sm\">€{(group.totalAmount || 0).toFixed(2)}</p>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"flex items-center text-gray-400 text-sm mb-3\">\n                        <Users className=\"h-4 w-4 mr-2 text-red-400\" />\n                        {group.members.length} membri\n                      </div>\n                      <div className=\"flex flex-wrap gap-1.5\">\n                        {group.members.slice(0, 3).map((member) => (\n                          <Badge key={member} variant=\"secondary\" className=\"text-xs bg-gradient-to-r from-gray-800 to-gray-700 text-gray-300 border border-gray-600\">\n                            {member}\n                          </Badge>\n                        ))}\n                        {group.members.length > 3 && (\n                          <Badge variant=\"secondary\" className=\"text-xs bg-gradient-to-r from-red-900/30 to-red-800/30 text-red-400 border border-red-500/30\">\n                            +{group.members.length - 3}\n                          </Badge>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </div>\n        ) : (\n          /* Vista Dettaglio Gruppo */\n          <div className=\"space-y-6\">\n            <div className=\"flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full md:w-auto\">\n                <Button\n                  onClick={() => setSelectedGroup(null)}\n                  variant=\"outline\"\n                  className=\"border-gray-700 text-white hover:bg-red-900/20 hover:border-red-500 w-full sm:w-auto\"\n                  data-testid=\"button-back-to-groups\"\n                >\n                  ← Torna ai gruppi\n                </Button>\n                <div>\n                  <h2 className=\"text-2xl md:text-3xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent\">\n                    {selectedGroup.name}\n                  </h2>\n                  <div className=\"flex items-center gap-2 mt-1\">\n                    <TrendingUp className=\"w-4 h-4 text-red-400\" />\n                    <p className=\"text-gray-400\">Totale: <span className=\"text-red-400 font-bold\">€{(selectedGroup.totalAmount || 0).toFixed(2)}</span></p>\n                  </div>\n                </div>\n              </div>\n              <Dialog open={showCreateExpense} onOpenChange={setShowCreateExpense}>\n                <DialogTrigger asChild>\n                  <Button \n                    className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white shadow-lg shadow-red-500/30 w-full md:w-auto\"\n                    data-testid=\"button-add-expense\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Aggiungi Spesa\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"bg-gradient-to-br from-gray-900 to-black border border-red-500/20 text-white max-w-md max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle className=\"text-white text-xl\">Aggiungi Nuova Spesa</DialogTitle>\n                    <DialogDescription className=\"text-gray-400\">\n                      Registra una nuova spesa per il gruppo e seleziona chi deve partecipare alla divisione\n                    </DialogDescription>\n                  </DialogHeader>\n                  <form onSubmit={expenseForm.handleSubmit(onCreateExpense)} className=\"space-y-4\">\n                    <div>\n                      <Label htmlFor=\"description\" className=\"text-white\">Descrizione</Label>\n                      <Input\n                        id=\"description\"\n                        {...expenseForm.register('description')}\n                        placeholder=\"es. Cena al ristorante\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-expense-description\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"amount\" className=\"text-white\">Importo (€)</Label>\n                      <Input\n                        id=\"amount\"\n                        type=\"number\"\n                        step=\"0.01\"\n                        {...expenseForm.register('amount', { valueAsNumber: true })}\n                        placeholder=\"0.00\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-expense-amount\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"paidBy\" className=\"text-white\">Chi ha pagato</Label>\n                      <Select onValueChange={(value) => expenseForm.setValue('paidBy', value)}>\n                        <SelectTrigger className=\"bg-gray-800/50 border-gray-700 text-white mt-1\" data-testid=\"select-paid-by\">\n                          <SelectValue placeholder=\"Seleziona chi ha pagato\" className=\"text-white\" />\n                        </SelectTrigger>\n                        <SelectContent className=\"bg-gray-800 border-gray-700 text-white\">\n                          {selectedGroup.members.map((member) => (\n                            <SelectItem key={member} value={member} className=\"text-white focus:text-white\">\n                              {member}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-white\">Dividi tra</Label>\n                      <div className=\"space-y-2 mt-2\">\n                        <label className=\"flex items-center space-x-2 text-white p-2 rounded-lg bg-red-500/10 border border-red-500/30 cursor-pointer hover:bg-red-500/20 transition-colors\">\n                          <input\n                            type=\"checkbox\"\n                            {...expenseForm.register('splitEqually')}\n                            onChange={(e) => {\n                              if (e.target.checked) {\n                                expenseForm.setValue('splitBetween', selectedGroup.members);\n                              } else {\n                                expenseForm.setValue('splitBetween', []);\n                              }\n                            }}\n                            className=\"rounded border-gray-600\"\n                            data-testid=\"checkbox-split-equally\"\n                          />\n                          <span className=\"text-sm font-medium\">Dividi equamente tra tutti</span>\n                        </label>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          {selectedGroup.members.map((member, idx) => (\n                            <label \n                              key={member} \n                              className=\"flex items-center space-x-2 text-white p-2 rounded-lg bg-gray-800/50 border border-gray-700 cursor-pointer hover:bg-gray-700/50 transition-colors\"\n                            >\n                              <input\n                                type=\"checkbox\"\n                                checked={expenseForm.watch('splitBetween')?.includes(member) || false}\n                                onChange={(e) => {\n                                  const currentSplit = expenseForm.getValues('splitBetween') || [];\n                                  if (e.target.checked) {\n                                    expenseForm.setValue('splitBetween', [...currentSplit, member]);\n                                  } else {\n                                    expenseForm.setValue('splitBetween', currentSplit.filter(m => m !== member));\n                                    expenseForm.setValue('splitEqually', false);\n                                  }\n                                }}\n                                className=\"rounded border-gray-600\"\n                                data-testid={`checkbox-split-member-${idx}`}\n                              />\n                              <span className=\"text-sm\">{member}</span>\n                            </label>\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"category\" className=\"text-white\">Categoria</Label>\n                      <Select onValueChange={(value) => expenseForm.setValue('category', value)} defaultValue=\"food\">\n                        <SelectTrigger className=\"bg-gray-800/50 border-gray-700 text-white mt-1\" data-testid=\"select-category\">\n                          <SelectValue placeholder=\"Seleziona categoria\" className=\"text-white\" />\n                        </SelectTrigger>\n                        <SelectContent className=\"bg-gray-800 border-gray-700 text-white\">\n                          <SelectItem value=\"food\" className=\"text-white focus:text-white\">🍽️ Cibo</SelectItem>\n                          <SelectItem value=\"transport\" className=\"text-white focus:text-white\">🚗 Trasporti</SelectItem>\n                          <SelectItem value=\"accommodation\" className=\"text-white focus:text-white\">🏨 Alloggio</SelectItem>\n                          <SelectItem value=\"entertainment\" className=\"text-white focus:text-white\">🎉 Divertimento</SelectItem>\n                          <SelectItem value=\"shopping\" className=\"text-white focus:text-white\">🛍️ Shopping</SelectItem>\n                          <SelectItem value=\"other\" className=\"text-white focus:text-white\">📋 Altro</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"date\" className=\"text-white\">Data</Label>\n                      <Input\n                        id=\"date\"\n                        type=\"date\"\n                        {...expenseForm.register('date')}\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-expense-date\"\n                      />\n                    </div>\n                    \n                    <DialogFooter>\n                      <Button \n                        type=\"submit\" \n                        className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 w-full\"\n                        data-testid=\"button-submit-expense\"\n                      >\n                        Aggiungi Spesa\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"grid lg:grid-cols-3 gap-6\">\n              {/* Lista Spese */}\n              <div className=\"lg:col-span-2\">\n                <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 backdrop-blur-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-white flex items-center text-lg md:text-xl\">\n                      <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 p-2 rounded-lg mr-3\">\n                        <Receipt className=\"h-5 w-5 text-red-400\" />\n                      </div>\n                      Spese ({expenses.length})\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {expenses.length === 0 ? (\n                      <div className=\"text-center py-12\">\n                        <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\">\n                          <Receipt className=\"h-8 w-8 text-red-400\" />\n                        </div>\n                        <p className=\"text-gray-400\">Nessuna spesa ancora registrata</p>\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[500px] pr-4\">\n                        <div className=\"space-y-3\">\n                          {expenses.map((expense, idx) => (\n                            <div\n                              key={expense.id}\n                              className=\"p-4 bg-gradient-to-r from-gray-800/50 to-gray-700/30 rounded-xl border border-gray-700 hover:border-red-500/50 transition-all group\"\n                              data-testid={`expense-${idx}`}\n                            >\n                              <div className=\"flex justify-between items-start mb-3\">\n                                <div className=\"flex items-start space-x-3 flex-1\">\n                                  <span className=\"text-2xl\">\n                                    {getCategoryIcon(expense.category)}\n                                  </span>\n                                  <div className=\"flex-1\">\n                                    <h4 className=\"font-semibold text-white group-hover:text-red-400 transition-colors\">\n                                      {expense.description}\n                                    </h4>\n                                    <p className=\"text-sm text-gray-400 mt-1\">\n                                      Pagato da <span className=\"text-red-400 font-medium\">{expense.paidBy}</span>\n                                    </p>\n                                  </div>\n                                </div>\n                                <div className=\"text-right ml-4\">\n                                  <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 px-3 py-1 rounded-lg border border-red-500/30\">\n                                    <p className=\"font-bold text-red-400\">€{(expense.amount / 100).toFixed(2)}</p>\n                                  </div>\n                                  <p className=\"text-xs text-gray-500 mt-1\">\n                                    {new Date(expense.date).toLocaleDateString('it-IT')}\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"flex flex-wrap gap-1.5 items-center\">\n                                <span className=\"text-xs text-gray-500\">Diviso tra:</span>\n                                {expense.splitBetween.map((member) => (\n                                  <Badge \n                                    key={member} \n                                    variant=\"secondary\" \n                                    className=\"text-xs bg-gradient-to-r from-gray-700 to-gray-600 text-gray-300 border border-gray-600\"\n                                  >\n                                    {member}\n                                  </Badge>\n                                ))}\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Sidebar */}\n              <div className=\"space-y-6\">\n                {/* Regolamenti */}\n                <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 backdrop-blur-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-white flex items-center text-lg\">\n                      <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 p-2 rounded-lg mr-3\">\n                        <Calculator className=\"h-5 w-5 text-red-400\" />\n                      </div>\n                      Regolamenti\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {(() => {\n                      const settlements = calculateSettlements(selectedGroup, expenses);\n                      return settlements.length === 0 ? (\n                        <div className=\"text-center py-8\">\n                          <div className=\"bg-gradient-to-br from-green-500/20 to-green-600/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\">\n                            <DollarSign className=\"h-8 w-8 text-green-400\" />\n                          </div>\n                          <p className=\"text-gray-400 font-medium\">Tutti i conti sono in pari!</p>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {settlements.map((settlement, index) => (\n                            <div\n                              key={index}\n                              className=\"p-3 bg-gradient-to-r from-red-500/10 to-red-600/5 rounded-lg border border-red-500/30\"\n                              data-testid={`settlement-${index}`}\n                            >\n                              <div className=\"flex items-center justify-between gap-2\">\n                                <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                                  <User className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                                  <span className=\"text-white font-medium truncate\">{settlement.from}</span>\n                                  <ArrowRight className=\"h-4 w-4 text-red-400 flex-shrink-0\" />\n                                  <span className=\"text-white font-medium truncate\">{settlement.to}</span>\n                                </div>\n                                <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 px-2 py-1 rounded border border-red-500/30 flex-shrink-0\">\n                                  <span className=\"font-bold text-red-400 text-sm whitespace-nowrap\">\n                                    €{(settlement.amount / 100).toFixed(2)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      );\n                    })()}\n                  </CardContent>\n                </Card>\n\n                {/* Membri del gruppo */}\n                <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 backdrop-blur-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-white flex items-center text-lg\">\n                      <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 p-2 rounded-lg mr-3\">\n                        <Users className=\"h-5 w-5 text-red-400\" />\n                      </div>\n                      Membri ({selectedGroup.members.length})\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {selectedGroup.members.map((member, idx) => (\n                        <div\n                          key={member}\n                          className=\"flex items-center space-x-3 p-3 bg-gradient-to-r from-gray-800/50 to-gray-700/30 rounded-lg border border-gray-700 hover:border-red-500/50 transition-all\"\n                          data-testid={`group-member-${idx}`}\n                        >\n                          <div className=\"bg-gradient-to-br from-red-500/20 to-red-600/10 p-2 rounded-full\">\n                            <User className=\"h-4 w-4 text-red-400\" />\n                          </div>\n                          <span className=\"text-white font-medium\">{member}</span>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":41267,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"server/routes/itinerary.ts":{"content":"import { Request, Response } from 'express';\nimport { z } from 'zod';\nimport { fromZodError } from 'zod-validation-error';\n\n// Schema per validare i dati in arrivo dal frontend per Zapier\nconst zapierItinerarySchema = z.object({\n  citta: z.string().min(1, \"Città è richiesta\"),\n  date: z.object({\n    startDate: z.string(),\n    endDate: z.string()\n  }),\n  persone: z.number().int().min(1, \"Numero persone deve essere almeno 1\"),\n  interessi: z.array(z.string()).optional().default([]),\n  budget: z.enum([\"economico\", \"medio\", \"alto\"]).optional().default(\"medio\"),\n  esperienze: z.array(z.string()).optional().default([])\n});\n\n/**\n * Route POST /api/generate-itinerary\n * Integra con Zapier webhook per generare itinerari AI-powered\n * \n * Riceve: città, date, persone, interessi, budget\n * Invia a Zapier: payload strutturato per ChatGPT\n * Ritorna: itinerario AI generato o fallback locale\n */\nexport const generateZapierItinerary = async (req: Request, res: Response) => {\n  try {\n    // Valida i dati in ingresso\n    const requestData = zapierItinerarySchema.parse(req.body);\n    \n    // Prepara payload per Zapier webhook\n    const zapierPayload = {\n      destination: requestData.citta,\n      startDate: requestData.date.startDate,\n      endDate: requestData.date.endDate,\n      groupSize: requestData.persone,\n      budget: requestData.budget,\n      interests: requestData.interessi,\n      experiences: requestData.esperienze,\n      timestamp: new Date().toISOString(),\n      source: \"ByeBro OneClick Assistant\",\n      language: \"italian\"\n    };\n    \n    // Invia dati a Zapier webhook (se configurato)\n    let zapierResponse = null;\n    const zapierWebhookUrl = process.env.ZAPIER_WEBHOOK_URL;\n    \n    if (zapierWebhookUrl) {\n      try {\n        console.log(\"📡 Sending data to Zapier webhook:\", zapierPayload);\n        \n        const response = await fetch(zapierWebhookUrl, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'User-Agent': 'ByeBro-Assistant/1.0'\n          },\n          body: JSON.stringify(zapierPayload),\n          signal: AbortSignal.timeout(30000) // 30 secondi timeout\n        });\n        \n        if (response.ok) {\n          zapierResponse = await response.json();\n          console.log(\"✅ Zapier response received:\", zapierResponse);\n        } else {\n          console.error(\"❌ Zapier webhook error:\", response.status, response.statusText);\n        }\n      } catch (error) {\n        console.error(\"🔥 Error calling Zapier webhook:\", error);\n      }\n    } else {\n      console.log(\"⚠️ ZAPIER_WEBHOOK_URL not configured, using fallback\");\n    }\n    \n    // Genera contenuto itinerario (AI o fallback)\n    let itineraryContent = \"Itinerario personalizzato in generazione...\";\n    \n    if (zapierResponse && zapierResponse.itinerary) {\n      // Usa l'itinerario generato da ChatGPT tramite Zapier\n      itineraryContent = zapierResponse.itinerary;\n    } else {\n      // Fallback: genera un itinerario di base strutturato\n      const duration = Math.ceil(\n        (new Date(requestData.date.endDate).getTime() - new Date(requestData.date.startDate).getTime()) \n        / (1000 * 60 * 60 * 24)\n      );\n      \n      itineraryContent = `🎉 Addio al Celibato a ${requestData.citta}\n      \n📅 Durata: ${duration} giorni per ${requestData.persone} persone\n💰 Budget: ${requestData.budget}\n🎯 Interessi: ${requestData.interessi.join(', ') || 'Divertimento generale'}\n\n📋 Itinerario personalizzato:\n${zapierWebhookUrl ? \n  'Stiamo elaborando il vostro itinerario perfetto con ChatGPT tramite Zapier...' : \n  'Webhook Zapier non configurato - usando generazione locale'\n}\n\n⏰ L'itinerario dettagliato ${zapierWebhookUrl ? 'arriverà a breve!' : 'è pronto!'}`;\n    }\n    \n    // Calcola prezzo basato su budget e destinazione\n    const calculatePrice = (budget: string, destination: string, people: number) => {\n      const basePrices = {\n        'economico': { roma: 250, ibiza: 350, barcellona: 280 },\n        'medio': { roma: 450, ibiza: 650, barcellona: 480 },\n        'alto': { roma: 750, ibiza: 1200, barcellona: 850 }\n      };\n      \n      const destinationKey = destination.toLowerCase() as keyof typeof basePrices[typeof budget];\n      const basePrice = basePrices[budget as keyof typeof basePrices]?.[destinationKey] || \n                       basePrices[budget as keyof typeof basePrices]?.roma || 400;\n      \n      return Math.round(basePrice * Math.min(people * 0.15 + 0.85, 1.5));\n    };\n    \n    // Ritorna risposta strutturata\n    return res.status(200).json({\n      success: true,\n      itinerary: {\n        name: `Addio al Celibato a ${requestData.citta}`,\n        description: itineraryContent,\n        duration: `${Math.ceil((new Date(requestData.date.endDate).getTime() - new Date(requestData.date.startDate).getTime()) / (1000 * 60 * 60 * 24))} giorni`,\n        price: calculatePrice(requestData.budget, requestData.citta, requestData.persone),\n        rating: \"5.0\"\n      },\n      aiContent: itineraryContent,\n      zapierProcessed: !!zapierResponse,\n      zapierWebhookConfigured: !!zapierWebhookUrl,\n      message: zapierResponse ? \n        \"Itinerario generato con AI tramite Zapier\" : \n        zapierWebhookUrl ? \n          \"Itinerario in elaborazione tramite Zapier\" : \n          \"Itinerario generato localmente\"\n    });\n    \n  } catch (error: any) {\n    console.error(\"💥 Error generating itinerary:\", error);\n    \n    if (error instanceof z.ZodError) {\n      return res.status(400).json({ \n        success: false,\n        message: \"Parametri itinerario non validi\", \n        errors: fromZodError(error).message \n      });\n    }\n    \n    return res.status(500).json({ \n      success: false,\n      message: \"Errore nella generazione dell'itinerario\",\n      error: error.message || String(error)\n    });\n  }\n};","path":null,"size_bytes":5843,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/pages/Dashboard.tsx":{"content":"import { useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Trip } from \"@shared/schema\";\nimport Header from \"@/components/Header\";\nimport Footer from \"@/components/Footer\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Calendar, Map, GlassWater, ListChecks, Shirt, Crown } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\nexport default function Dashboard() {\n  const { user, isAuthenticated } = useAuth();\n  const [location, setLocation] = useLocation();\n\n  // Redirect if not authenticated\n  useEffect(() => {\n    if (!isAuthenticated) {\n      setLocation(\"/\");\n    }\n  }, [isAuthenticated, setLocation]);\n\n  // Fetch user trips\n  const { data: trips, isLoading, error } = useQuery<Trip[]>({\n    queryKey: [`/api/trips/user/${user?.id}`],\n    enabled: !!user?.id,\n  });\n\n  if (!isAuthenticated) {\n    return null; // Will redirect in useEffect\n  }\n\n  return (\n    <div className=\"min-h-screen flex flex-col bg-light\">\n      <Header />\n      \n      <main className=\"flex-grow py-10\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"mb-8\">\n            <h1 className=\"text-3xl font-bold font-poppins mb-2\">Welcome, {user?.firstName || user?.username}!</h1>\n            <p className=\"text-gray-600\">Manage your bachelor party plans and preferences.</p>\n          </div>\n          \n          <div className=\"flex items-center mb-8\">\n            <div className=\"bg-primary text-white p-2 rounded-full mr-4\">\n              {user?.isPremium && <Crown className=\"h-6 w-6\" />}\n            </div>\n            <div>\n              <h2 className=\"font-bold text-lg\">\n                {user?.isPremium ? 'Premium Member' : 'Free Membership'}\n              </h2>\n              <p className=\"text-sm text-gray-600\">\n                {user?.isPremium \n                  ? 'You have access to all premium features' \n                  : 'Upgrade to access premium features'}\n              </p>\n            </div>\n            {!user?.isPremium && (\n              <Button \n                className=\"ml-auto bg-primary hover:bg-accent\"\n                onClick={() => setLocation(\"/#premium-features\")}\n              >\n                Upgrade Now\n              </Button>\n            )}\n          </div>\n          \n          <Tabs defaultValue=\"trips\" className=\"w-full\">\n            <TabsList className=\"mb-6\">\n              <TabsTrigger value=\"trips\"><ListChecks className=\"mr-2 h-4 w-4\" /> My Trips</TabsTrigger>\n              <TabsTrigger value=\"merchandise\"><Shirt className=\"mr-2 h-4 w-4\" /> My Merchandise</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"trips\">\n              {isLoading ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  {[1, 2].map((i) => (\n                    <Card key={i} className=\"shadow-md\">\n                      <CardHeader>\n                        <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                        <Skeleton className=\"h-4 w-1/2\" />\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-2\">\n                          <Skeleton className=\"h-4 w-full\" />\n                          <Skeleton className=\"h-4 w-full\" />\n                          <Skeleton className=\"h-4 w-3/4\" />\n                        </div>\n                      </CardContent>\n                      <CardFooter>\n                        <Skeleton className=\"h-10 w-full\" />\n                      </CardFooter>\n                    </Card>\n                  ))}\n                </div>\n              ) : error ? (\n                <div className=\"text-center p-10\">\n                  <p className=\"text-red-500\">Error loading your trips. Please try again later.</p>\n                </div>\n              ) : trips && trips.length > 0 ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  {trips.map((trip) => (\n                    <Card key={trip.id} className=\"shadow-md\">\n                      <CardHeader>\n                        <div className=\"flex justify-between items-start\">\n                          <CardTitle>{trip.name}</CardTitle>\n                          <div className=\"px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800\">\n                            {trip.experienceType}\n                          </div>\n                        </div>\n                        <CardDescription>\n                          <div className=\"flex items-center text-sm text-gray-500 mt-1\">\n                            <Calendar className=\"mr-1 h-3 w-3\" /> \n                            {trip.startDate} - {trip.endDate}\n                          </div>\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          <div className=\"flex items-center text-sm\">\n                            <Map className=\"mr-2 h-4 w-4 text-primary\" />\n                            <span>Destinations: {trip.destinations.join(\", \")}</span>\n                          </div>\n                          <div className=\"flex items-center text-sm\">\n                            <GlassWater className=\"mr-2 h-4 w-4 text-primary\" />\n                            <span>Activities: {trip.activities.slice(0, 2).join(\", \")}\n                              {trip.activities.length > 2 ? ` and ${trip.activities.length - 2} more` : \"\"}\n                            </span>\n                          </div>\n                          <div className=\"text-sm\">\n                            <span className=\"font-semibold\">Budget:</span> €{trip.budget} per person\n                          </div>\n                        </div>\n                      </CardContent>\n                      <CardFooter>\n                        <Button \n                          className=\"w-full bg-primary hover:bg-accent\"\n                          onClick={() => setLocation(`/itinerary/${trip.id}`)}\n                        >\n                          View Itineraries\n                        </Button>\n                      </CardFooter>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center p-10 border-2 border-dashed border-gray-300 rounded-xl\">\n                  <h3 className=\"text-xl font-bold mb-2\">No Trips Planned Yet</h3>\n                  <p className=\"text-gray-600 mb-4\">Start planning your unforgettable bachelor party experience!</p>\n                  <Button \n                    className=\"bg-primary hover:bg-accent\"\n                    onClick={() => setLocation(\"/#trip-planning\")}\n                  >\n                    Plan Your First Trip\n                  </Button>\n                </div>\n              )}\n            </TabsContent>\n            \n            <TabsContent value=\"merchandise\">\n              <div className=\"text-center p-10 border-2 border-dashed border-gray-300 rounded-xl\">\n                <h3 className=\"text-xl font-bold mb-2\">No Merchandise Orders Yet</h3>\n                <p className=\"text-gray-600 mb-4\">Customize t-shirts and other gear for your bachelor party!</p>\n                <Button \n                  className=\"bg-primary hover:bg-accent\"\n                  onClick={() => setLocation(\"/merchandise\")}\n                >\n                  Shop Merchandise\n                </Button>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n      \n      <Footer />\n    </div>\n  );\n}\n","path":null,"size_bytes":7931,"size_tokens":null},"replit.md":{"content":"# ByeBi Dual-Brand Travel Platform\n\n## Overview\nByeBi is an AI-powered dual-brand travel platform featuring **ByeBro** for bachelor parties and **ByeBride** for bachelorette parties. It offers \"The Chat Bro\" / \"The Chat Bride\" as central chat assistants for conversational flight search and itinerary generation, and comprehensive expense management via SplittaBro/SplittaBride. The platform's core vision is to streamline group travel planning for specific event types (bachelor/bachelorette parties) by leveraging AI for personalized and efficient itinerary creation, with a strong focus on user experience and brand-specific customization.\n\n## User Preferences\n- Language: Italian interface preferred\n- Style: Informal, enthusiastic tone with emojis for trip planning\n- Visual: ByeBro red theme colors for branding consistency\n- Focus: Conversational approach over dropdown menus for user interaction\n\n## System Architecture\nThe platform is built with React and TypeScript for the frontend, utilizing Shadcn components with Tailwind CSS for a modern UI/UX featuring dark gradients, glassmorphism, and responsive design. Wouter handles client-side routing. The backend is an Express.js server with in-memory storage.\n\nKey architectural decisions include a dual-brand system starting with a ByeBi landing page for brand selection (ByeBro: red/black, bachelor focus; ByeBride: pink/black, bachelorette focus). All shared components are brand-aware, dynamically adjusting content and themes.\n\nThe OneClick Assistant implements a strict, step-by-step conversational flow with origin city selection and real flight integration:\n1. User specifies destination → AI asks for origin city (Italian airports)\n2. User provides origin city → [SET_ORIGIN:CityName] directive emitted\n3. User provides dates and participants\n4. Backend fetches real flights via Aviasales API from origin to destination\n5. AI presents 3 flight options with real prices\n6. User selects flight (1, 2, or 3) → [SELECT_FLIGHT:X] directive emitted\n7. User selects experiences from 4 options\n8. Itinerary generated with selected flight details propagated to checkout\n\nAI responses are parsed for structured commands (SET_DESTINATION, SET_ORIGIN, SET_DATES, SET_PARTICIPANTS, SELECT_FLIGHT, SHOW_EXPERIENCES, UNLOCK_ITINERARY_BUTTON) to automatically update frontend state. The city-to-IATA mapping covers 17 Italian airports and 10 European destinations.\n\n**Real Flow Architecture (December 2024 refactor):**\nThe booking flow uses a unified TripContext data contract stored in localStorage under 'currentItinerary':\n```typescript\ninterface TripContext {\n  origin: string;           // IATA code or city name\n  destination: string;      // City name\n  startDate: string;        // YYYY-MM-DD (user's trip dates)\n  endDate: string;          // YYYY-MM-DD\n  people: number;           // Number of travelers\n  aviasalesCheckoutUrl: string;  // Pre-built Aviasales deep link\n  flightLabel?: string;     // Display label for flight section\n}\n```\n- **Chatbot** → writes TripContext to localStorage\n- **Itinerary.tsx** (/itinerary) → reads TripContext, shows trip summary, Aviasales link, continue to checkout\n- **Checkout.tsx** (/checkout) → reads TripContext, shows Aviasales button + real Amadeus hotel search\n\n**Flight prices are NEVER shown** - users book flights directly via Aviasales partner links.\n**Date handling**: All dates use string-only formatters (formatDateRangeIT, normalizeFutureTripDate) - NO Date() constructor to avoid timezone issues.\n\n**Entry points** (all unified, December 2024):\n- TripPlanningForm.tsx → saves currentItinerary → navigates to /itinerary\n- ChatDialogCompact.tsx / ChatDialogCompactBride.tsx → saves currentItinerary → navigates to /itinerary\n\nThe hero section of each brand features a centered chat assistant (\"The Chat Bro\" for ByeBro, \"The Chat Bride\" for ByeBride) as the primary entry point for trip planning. Expense management is handled by brand-specific SplittaBro/SplittaBride components with corresponding themes and robust group creation flows.\n\n## GetYourGuide Integration (January 2026)\nAffiliate links for experiences/activities are integrated via `GetYourGuideCta` component in Itinerary and Checkout pages.\n\n**Supported destinations**:\n- Rome, Barcelona, Ibiza, Prague, Budapest, Krakow, Amsterdam, Berlin, Lisbon, Palma de Mallorca\n\n**Files**:\n- `client/src/lib/getyourguide.ts` - Link mapping with IT/EN city name normalization (Roma↔Rome, Barcellona↔Barcelona, etc.)\n- `client/src/lib/track.ts` - Event tracking helper (console log structured)\n- `client/src/components/GetYourGuideCta.tsx` - Reusable CTA component\n\n**Behavior**: CTA only renders for supported destinations. Opens affiliate link in new tab with tracking event.\n\n## i18n System (February 2026)\nComplete internationalization system supporting Italian (default), English, and Spanish.\n\n**Architecture**:\n- `client/src/contexts/LanguageContext.tsx` - LanguageProvider, useTranslation hook, t() function with {{param}} interpolation\n- `client/src/locales/it.json` - Italian translations (221 keys, default/fallback)\n- `client/src/locales/en.json` - English translations (221 keys, lazy-loaded)\n- `client/src/locales/es.json` - Spanish translations (221 keys, lazy-loaded)\n\n**Usage**: `const { t, locale, setLocale } = useTranslation();` then `t('key.name')` or `t('key.name', { param: value })`\n\n**Language selector**: Flag dropdown in Header navbar (🇮🇹/🇬🇧/🇪🇸), persisted to localStorage under `byebi_locale`\n\n**Refactored components**: Header, Footer, BrandSelection, HeroSection, HeroSectionBride, Testimonials, Newsletter, SecretBlog, CustomMerchandise, PremiumFeatures, AuthModal, Itinerary, Checkout, GetYourGuideCta, not-found\n\n**Note**: Italian locale is loaded synchronously (bundled) for instant first render. EN/ES are lazy-loaded on demand. Chat responses are handled separately by AI language detection.\n\n## External Dependencies\n- **GROQ API**: Primary AI engine (llama-3.3-70b-versatile) for ultra-fast streaming chat responses (Server-Sent Events) and structured JSON generation for activity ideas.\n- **OpenAI API**: Backup AI engine.\n- **Pexels API**: Used for dynamic destination image search, with a fallback to Unsplash.\n- **Zapier**: Integrated via webhooks for AI-powered itinerary generation, allowing structured data exchange for ChatGPT processing.\n- **GetYourGuide**: Affiliate links for city-based experiences (10 destinations supported).\n```","path":null,"size_bytes":6487,"size_tokens":null},"client/src/contexts/AuthContext.tsx":{"content":"import { createContext, useContext, ReactNode, useState, useEffect } from \"react\";\nimport { User } from \"@shared/schema\";\n\ninterface AuthContextType {\n  user: User | null;\n  isAuthenticated: boolean;\n  login: (user: User) => void;\n  logout: () => void;\n  updateUser: (user: User) => void;\n}\n\nconst AuthContext = createContext<AuthContextType>({\n  user: null,\n  isAuthenticated: false,\n  login: () => {},\n  logout: () => {},\n  updateUser: () => {},\n});\n\nexport const useAuth = () => useContext(AuthContext);\n\ninterface AuthProviderProps {\n  children: ReactNode;\n}\n\nexport const AuthProvider = ({ children }: AuthProviderProps) => {\n  const [user, setUser] = useState<User | null>(null);\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\n\n  // Check for saved user on initial load\n  useEffect(() => {\n    const savedUser = localStorage.getItem(\"byebroUser\");\n    if (savedUser) {\n      try {\n        const parsedUser = JSON.parse(savedUser);\n        setUser(parsedUser);\n        setIsAuthenticated(true);\n      } catch (error) {\n        console.error(\"Failed to parse saved user:\", error);\n        localStorage.removeItem(\"byebroUser\");\n      }\n    }\n  }, []);\n\n  const login = (userData: User) => {\n    setUser(userData);\n    setIsAuthenticated(true);\n    // Store user in localStorage for persistence\n    localStorage.setItem(\"byebroUser\", JSON.stringify(userData));\n  };\n\n  const logout = () => {\n    setUser(null);\n    setIsAuthenticated(false);\n    localStorage.removeItem(\"byebroUser\");\n  };\n\n  const updateUser = (userData: User) => {\n    setUser(userData);\n    localStorage.setItem(\"byebroUser\", JSON.stringify(userData));\n  };\n\n  return (\n    <AuthContext.Provider value={{ user, isAuthenticated, login, logout, updateUser }}>\n      {children}\n    </AuthContext.Provider>\n  );\n};\n","path":null,"size_bytes":1802,"size_tokens":null},"client/src/pages/SplittaBroTestPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { AlertCircle, Plus, Calculator, Euro, Users, Trash2 } from \"lucide-react\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\n\n// Schema validazione\nconst expenseSchema = z.object({\n  description: z.string().min(1, \"Descrizione richiesta\"),\n  amount: z.number().min(0.01, \"Importo deve essere maggiore di 0\"),\n  paidBy: z.string().min(1, \"Pagatore richiesto\"),\n  category: z.string().min(1, \"Categoria richiesta\"),\n  date: z.string(),\n});\n\ntype ExpenseForm = z.infer<typeof expenseSchema>;\n\n// Tipi\ninterface Participant {\n  name: string;\n  email?: string;\n}\n\ninterface ExpenseGroup {\n  id: number;\n  name: string;\n  participants: Participant[];\n  tripId: number;\n  createdAt: string;\n}\n\ninterface Expense {\n  id: number;\n  groupId: number;\n  description: string;\n  amount: number;\n  paidBy: string;\n  splitWith: { name: string; share: number }[];\n  category: string;\n  date: string;\n  createdAt: string;\n}\n\nexport default function SplittaBroTestPage() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [selectedGroup, setSelectedGroup] = useState<number | null>(null);\n  const [showExpenseDialog, setShowExpenseDialog] = useState(false);\n\n  const form = useForm<ExpenseForm>({\n    resolver: zodResolver(expenseSchema),\n    defaultValues: {\n      description: \"\",\n      amount: 0,\n      paidBy: \"\",\n      category: \"Cibo\",\n      date: new Date().toISOString().split('T')[0],\n    }\n  });\n\n  // Crea gruppo demo\n  const createDemoGroup = useMutation({\n    mutationFn: async () => {\n      const demoGroup = {\n        name: \"Test Gruppo Amsterdam\",\n        tripId: 0,\n        participants: [\n          { name: \"Marco\", email: \"marco@test.com\" },\n          { name: \"Luca\", email: \"luca@test.com\" },\n          { name: \"Andrea\", email: \"andrea@test.com\" },\n          { name: \"Paolo\", email: \"paolo@test.com\" }\n        ]\n      };\n      const response = await apiRequest('POST', '/api/expense-groups', demoGroup);\n      return await response.json();\n    },\n    onSuccess: (group) => {\n      setSelectedGroup(group.id);\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups'] });\n      toast({\n        title: \"Gruppo creato\",\n        description: \"Gruppo demo creato con successo\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Errore nella creazione del gruppo\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Ottieni gruppi\n  const { data: groups = [], isLoading: loadingGroups } = useQuery<ExpenseGroup[]>({\n    queryKey: ['/api/expense-groups'],\n    staleTime: 30000\n  });\n\n  // Ottieni spese del gruppo selezionato\n  const { data: expenses = [], isLoading: loadingExpenses } = useQuery<Expense[]>({\n    queryKey: ['/api/expense-groups', selectedGroup, 'expenses'],\n    enabled: !!selectedGroup,\n    staleTime: 10000\n  });\n\n  // Crea spesa\n  const createExpense = useMutation({\n    mutationFn: async (data: ExpenseForm) => {\n      const group = groups.find(g => g.id === selectedGroup);\n      if (!group) throw new Error(\"Gruppo non trovato\");\n\n      const amountInCents = Math.round(data.amount * 100);\n      const sharePerPerson = Math.round(amountInCents / group.participants.length);\n      \n      const splitWith = group.participants.map((p, index) => ({\n        name: p.name,\n        share: index === 0 ? sharePerPerson + (amountInCents - sharePerPerson * group.participants.length) : sharePerPerson\n      }));\n\n      const expense = {\n        ...data,\n        amount: amountInCents,\n        groupId: selectedGroup!,\n        splitWith,\n        date: new Date(data.date)\n      };\n\n      const response = await apiRequest('POST', '/api/expenses', expense);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups', selectedGroup, 'expenses'] });\n      setShowExpenseDialog(false);\n      form.reset();\n      toast({\n        title: \"Spesa aggiunta\",\n        description: \"Spesa registrata con successo\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Errore nell'aggiunta della spesa\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const deleteExpense = useMutation({\n    mutationFn: (id: number) => apiRequest('DELETE', `/api/expenses/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups', selectedGroup, 'expenses'] });\n      toast({\n        title: \"Spesa rimossa\",\n        description: \"Spesa eliminata con successo\",\n      });\n    }\n  });\n\n  // Imposta gruppo di default\n  useEffect(() => {\n    if (groups.length > 0 && !selectedGroup) {\n      setSelectedGroup(groups[0].id);\n    }\n  }, [groups, selectedGroup]);\n\n  // Calcola totali\n  const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);\n  const formatAmount = (cents: number) => `€${(cents / 100).toFixed(2)}`;\n\n  // Calcola bilanci\n  const calculateBalances = () => {\n    const group = groups.find(g => g.id === selectedGroup);\n    if (!group) return [];\n\n    const balances: Record<string, { paid: number; owed: number; balance: number }> = {};\n    \n    group.participants.forEach(p => {\n      balances[p.name] = { paid: 0, owed: 0, balance: 0 };\n    });\n\n    expenses.forEach(expense => {\n      balances[expense.paidBy].paid += expense.amount;\n      expense.splitWith.forEach(split => {\n        if (balances[split.name]) {\n          balances[split.name].owed += split.share;\n        }\n      });\n    });\n\n    Object.keys(balances).forEach(name => {\n      balances[name].balance = balances[name].paid - balances[name].owed;\n    });\n\n    return Object.entries(balances).map(([name, data]) => ({ name, ...data }));\n  };\n\n  const balances = calculateBalances();\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"text-center mb-8\">\n          <div className=\"flex items-center justify-center gap-3 mb-4\">\n            <Calculator className=\"h-8 w-8 text-red-600\" />\n            <h1 className=\"text-4xl font-bold bg-gradient-to-r from-red-600 to-black bg-clip-text text-transparent\">\n              SplittaBro Test\n            </h1>\n          </div>\n          <p className=\"text-gray-600 text-lg\">Gestione spese condivise per il tuo gruppo</p>\n        </div>\n\n        {/* Controlli */}\n        <div className=\"mb-6 flex flex-wrap gap-4 justify-center\">\n          {groups.length === 0 && (\n            <Button \n              onClick={() => createDemoGroup.mutate()}\n              disabled={createDemoGroup.isPending}\n              className=\"bg-red-600 hover:bg-red-700\"\n            >\n              {createDemoGroup.isPending ? \"Creando...\" : \"Crea Gruppo Demo\"}\n            </Button>\n          )}\n\n          {groups.length > 0 && (\n            <Select value={selectedGroup?.toString()} onValueChange={(val) => setSelectedGroup(parseInt(val))}>\n              <SelectTrigger className=\"w-64\">\n                <SelectValue placeholder=\"Seleziona gruppo\" />\n              </SelectTrigger>\n              <SelectContent>\n                {groups.map(group => (\n                  <SelectItem key={group.id} value={group.id.toString()}>\n                    {group.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          )}\n        </div>\n\n        {selectedGroup && (\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            {/* Statistiche */}\n            <div className=\"space-y-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Users className=\"h-5 w-5\" />\n                    Partecipanti\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {groups.find(g => g.id === selectedGroup)?.participants.map(p => (\n                    <div key={p.name} className=\"flex items-center gap-2 mb-2\">\n                      <div className=\"w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center text-sm font-bold\">\n                        {p.name.charAt(0)}\n                      </div>\n                      <span>{p.name}</span>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Euro className=\"h-5 w-5\" />\n                    Bilanci\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {balances.map(balance => (\n                    <div key={balance.name} className=\"flex justify-between items-center mb-2\">\n                      <span>{balance.name}</span>\n                      <Badge variant={balance.balance >= 0 ? \"default\" : \"destructive\"}>\n                        {formatAmount(balance.balance)}\n                      </Badge>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Lista spese */}\n            <div className=\"lg:col-span-2\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <div>\n                    <CardTitle>Spese del Gruppo</CardTitle>\n                    <CardDescription>\n                      Totale: {formatAmount(totalExpenses)} • {expenses.length} spese\n                    </CardDescription>\n                  </div>\n                  \n                  <Dialog open={showExpenseDialog} onOpenChange={setShowExpenseDialog}>\n                    <DialogTrigger asChild>\n                      <Button className=\"bg-red-600 hover:bg-red-700\">\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Aggiungi Spesa\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>Nuova Spesa</DialogTitle>\n                        <DialogDescription>Aggiungi una nuova spesa al gruppo</DialogDescription>\n                      </DialogHeader>\n                      \n                      <form onSubmit={form.handleSubmit((data) => createExpense.mutate(data))} className=\"space-y-6\">\n                        {/* Descrizione e Importo */}\n                        <div className=\"space-y-4\">\n                          <div>\n                            <Label className=\"text-base font-medium\">Descrizione della spesa</Label>\n                            <Input \n                              {...form.register(\"description\")} \n                              placeholder=\"Inserisci descrizione (es. Cena al ristorante)\" \n                              className=\"text-lg\"\n                            />\n                            {form.formState.errors.description && (\n                              <p className=\"text-red-500 text-sm mt-1\">{form.formState.errors.description.message}</p>\n                            )}\n                          </div>\n\n                          <div>\n                            <Label className=\"text-base font-medium\">Importo totale</Label>\n                            <div className=\"relative\">\n                              <span className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg\">€</span>\n                              <Input \n                                type=\"number\" \n                                step=\"0.01\" \n                                {...form.register(\"amount\", { valueAsNumber: true })} \n                                placeholder=\"0.00\"\n                                className=\"text-lg pl-8\"\n                              />\n                            </div>\n                            {form.formState.errors.amount && (\n                              <p className=\"text-red-500 text-sm mt-1\">{form.formState.errors.amount.message}</p>\n                            )}\n                          </div>\n                        </div>\n\n                        {/* Chi ha pagato */}\n                        <div>\n                          <Label className=\"text-base font-medium\">Pagato da</Label>\n                          <Select onValueChange={(value) => form.setValue(\"paidBy\", value)}>\n                            <SelectTrigger className=\"text-lg\">\n                              <SelectValue placeholder=\"Seleziona chi ha pagato\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {groups.find(g => g.id === selectedGroup)?.participants.map(p => (\n                                <SelectItem key={p.name} value={p.name}>\n                                  <div className=\"flex items-center gap-2\">\n                                    <div className=\"w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold\">\n                                      {p.name.charAt(0)}\n                                    </div>\n                                    {p.name}\n                                  </div>\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          {form.formState.errors.paidBy && (\n                            <p className=\"text-red-500 text-sm mt-1\">{form.formState.errors.paidBy.message}</p>\n                          )}\n                        </div>\n\n                        {/* Divisione spesa */}\n                        <div>\n                          <Label className=\"text-base font-medium\">Come dividere la spesa?</Label>\n                          <div className=\"mt-2 p-4 border rounded-lg bg-gray-50\">\n                            <div className=\"flex items-center justify-between mb-3\">\n                              <span className=\"text-sm font-medium text-gray-700\">Dividi equamente tra tutti</span>\n                              <span className=\"text-sm text-gray-500\">\n                                {form.watch(\"amount\") > 0 && groups.find(g => g.id === selectedGroup) ? \n                                  `€${(form.watch(\"amount\") / groups.find(g => g.id === selectedGroup)!.participants.length).toFixed(2)} a testa` : \n                                  '€0.00 a testa'\n                                }\n                              </span>\n                            </div>\n                            \n                            <div className=\"space-y-2\">\n                              {groups.find(g => g.id === selectedGroup)?.participants.map(p => (\n                                <div key={p.name} className=\"flex items-center justify-between py-2 px-3 bg-white rounded border\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <div className=\"w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold\">\n                                      {p.name.charAt(0)}\n                                    </div>\n                                    <span className=\"text-sm font-medium\">{p.name}</span>\n                                  </div>\n                                  <span className=\"text-sm font-medium text-green-600\">\n                                    {form.watch(\"amount\") > 0 ? \n                                      `€${(form.watch(\"amount\") / groups.find(g => g.id === selectedGroup)!.participants.length).toFixed(2)}` : \n                                      '€0.00'\n                                    }\n                                  </span>\n                                </div>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Categoria e Data */}\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div>\n                            <Label className=\"text-base font-medium\">Categoria</Label>\n                            <Select onValueChange={(value) => form.setValue(\"category\", value)} defaultValue=\"Cibo\">\n                              <SelectTrigger>\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"Cibo\">🍽️ Cibo & Ristoranti</SelectItem>\n                                <SelectItem value=\"Trasporto\">🚗 Trasporto</SelectItem>\n                                <SelectItem value=\"Alloggio\">🏨 Alloggio</SelectItem>\n                                <SelectItem value=\"Attività\">🎯 Attività & Divertimento</SelectItem>\n                                <SelectItem value=\"Bevande\">🍺 Bevande & Locali</SelectItem>\n                                <SelectItem value=\"Shopping\">🛍️ Shopping</SelectItem>\n                                <SelectItem value=\"Altro\">📝 Altro</SelectItem>\n                              </SelectContent>\n                            </Select>\n                          </div>\n\n                          <div>\n                            <Label className=\"text-base font-medium\">Data</Label>\n                            <Input type=\"date\" {...form.register(\"date\")} />\n                          </div>\n                        </div>\n\n                        <DialogFooter className=\"mt-6\">\n                          <Button type=\"button\" variant=\"outline\" onClick={() => setShowExpenseDialog(false)}>\n                            Annulla\n                          </Button>\n                          <Button \n                            type=\"submit\" \n                            disabled={createExpense.isPending}\n                            className=\"bg-green-600 hover:bg-green-700\"\n                          >\n                            {createExpense.isPending ? \"Salvando...\" : \"Salva spesa\"}\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </DialogContent>\n                  </Dialog>\n                </CardHeader>\n\n                <CardContent>\n                  {loadingExpenses ? (\n                    <div className=\"text-center py-8\">Caricamento spese...</div>\n                  ) : expenses.length === 0 ? (\n                    <div className=\"text-center py-8 text-gray-500\">\n                      <AlertCircle className=\"h-12 w-12 mx-auto mb-4 text-gray-400\" />\n                      <p>Nessuna spesa registrata</p>\n                      <p className=\"text-sm\">Aggiungi la prima spesa per iniziare</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {expenses.map(expense => (\n                        <div key={expense.id} className=\"border rounded-lg p-4\">\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div>\n                              <h4 className=\"font-medium\">{expense.description}</h4>\n                              <p className=\"text-sm text-gray-600\">\n                                Pagato da {expense.paidBy} • {expense.category}\n                              </p>\n                              <p className=\"text-xs text-gray-500\">\n                                {new Date(expense.date).toLocaleDateString('it-IT')}\n                              </p>\n                            </div>\n                            <div className=\"text-right\">\n                              <div className=\"text-lg font-bold text-green-600\">\n                                {formatAmount(expense.amount)}\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => deleteExpense.mutate(expense.id)}\n                                className=\"text-red-600 hover:text-red-700\"\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </div>\n                          <Separator className=\"my-2\" />\n                          <div className=\"text-sm text-gray-600\">\n                            <strong>Divisione:</strong>\n                            <div className=\"mt-1 flex flex-wrap gap-2\">\n                              {expense.splitWith.map((split, idx) => (\n                                <Badge key={idx} variant=\"outline\">\n                                  {split.name}: {formatAmount(split.share)}\n                                </Badge>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":22017,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/pages/auth-page.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useForm } from \"react-hook-form\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Loader2 } from \"lucide-react\";\n\n// Validation schemas\nconst loginSchema = z.object({\n  username: z.string().min(1, \"Username is required\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\nconst registerSchema = z.object({\n  username: z.string().min(3, \"Username must be at least 3 characters\"),\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  fullName: z.string().optional(),\n});\n\ntype LoginFormValues = z.infer<typeof loginSchema>;\ntype RegisterFormValues = z.infer<typeof registerSchema>;\n\nexport default function AuthPage() {\n  const { user, loginMutation, registerMutation } = useAuth();\n  const [, navigate] = useLocation();\n  const [activeTab, setActiveTab] = useState<\"login\" | \"register\">(\"login\");\n\n  // Redirect if user is already logged in\n  useEffect(() => {\n    if (user) {\n      navigate(\"/\");\n    }\n  }, [user, navigate]);\n\n  // Login form\n  const loginForm = useForm<LoginFormValues>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      username: \"\",\n      password: \"\",\n    },\n  });\n\n  // Register form\n  const registerForm = useForm<RegisterFormValues>({\n    resolver: zodResolver(registerSchema),\n    defaultValues: {\n      username: \"\",\n      email: \"\",\n      password: \"\",\n      fullName: \"\",\n    },\n  });\n\n  // Submit handlers\n  const onLoginSubmit = (data: LoginFormValues) => {\n    loginMutation.mutate(data);\n  };\n\n  const onRegisterSubmit = (data: RegisterFormValues) => {\n    registerMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"flex min-h-screen\">\n      {/* Authentication Form */}\n      <div className=\"w-full lg:w-1/2 p-8 flex items-center justify-center bg-black text-white\">\n        <div className=\"max-w-md w-full space-y-8\">\n\n          <div className=\"text-center\">\n            <h2 className=\"mt-6 text-3xl font-bold text-white\">\n              Welcome to <span className=\"text-red-600\">Bye</span>Bro\n            </h2>\n            <p className=\"mt-2 text-sm text-gray-400\">\n              One more Night, no more rights!\n            </p>\n          </div>\n\n          <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as \"login\" | \"register\")} className=\"mt-8\">\n            <TabsList className=\"grid w-full grid-cols-2 bg-gray-900\">\n              <TabsTrigger value=\"login\" className=\"text-white data-[state=active]:bg-red-600\">Login</TabsTrigger>\n              <TabsTrigger value=\"register\" className=\"text-white data-[state=active]:bg-red-600\">Sign Up</TabsTrigger>\n            </TabsList>\n\n            {/* Login Form */}\n            <TabsContent value=\"login\" className=\"mt-6\">\n              <Form {...loginForm}>\n                <form onSubmit={loginForm.handleSubmit(onLoginSubmit)} className=\"space-y-4 auth-page-form\">\n                  <FormField\n                    control={loginForm.control}\n                    name=\"username\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Username</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"username\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={loginForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Password</FormLabel>\n                        <FormControl>\n                          <Input type=\"password\" placeholder=\"••••••••\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full bg-red-600 hover:bg-red-700 text-white\"\n                    disabled={loginMutation.isPending}\n                  >\n                    {loginMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Logging in...\n                      </>\n                    ) : (\n                      \"Login\"\n                    )}\n                  </Button>\n                </form>\n              </Form>\n            </TabsContent>\n\n            {/* Register Form */}\n            <TabsContent value=\"register\" className=\"mt-6\">\n              <Form {...registerForm}>\n                <form onSubmit={registerForm.handleSubmit(onRegisterSubmit)} className=\"space-y-4 auth-page-form\">\n                  <FormField\n                    control={registerForm.control}\n                    name=\"username\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Username</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"username\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={registerForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email</FormLabel>\n                        <FormControl>\n                          <Input type=\"email\" placeholder=\"you@example.com\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={registerForm.control}\n                    name=\"fullName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Full Name (Optional)</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"John Doe\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={registerForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Password</FormLabel>\n                        <FormControl>\n                          <Input type=\"password\" placeholder=\"••••••••\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full bg-red-600 hover:bg-red-700 text-white\"\n                    disabled={registerMutation.isPending}\n                  >\n                    {registerMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Creating account...\n                      </>\n                    ) : (\n                      \"Create Account\"\n                    )}\n                  </Button>\n                </form>\n              </Form>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n\n      {/* Hero image section - senza filtro colorato */}\n      <div\n        className=\"hidden lg:block lg:w-1/2 bg-cover bg-center\"\n        style={{\n          backgroundImage:\n            \"url('https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80')\",\n        }}\n      >\n        <div className=\"h-full w-full p-12 flex flex-col justify-end bg-black bg-opacity-40\">\n          <div className=\"text-white\">\n            <h2 className=\"text-4xl font-bold mb-4\">Join ByeBro Today</h2>\n            <p className=\"mb-6 text-lg\">\n              Plan your ultimate bachelor party experience with personalized itineraries,\n              exclusive destinations, and premium features.\n            </p>\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div className=\"flex items-center\">\n                <span className=\"mr-2 text-white font-bold\">✓</span> AI-Generated Itineraries\n              </div>\n              <div className=\"flex items-center\">\n                <span className=\"mr-2 text-white font-bold\">✓</span> Expense Sharing\n              </div>\n              <div className=\"flex items-center\">\n                <span className=\"mr-2 text-white font-bold\">✓</span> Exclusive Destinations\n              </div>\n              <div className=\"flex items-center\">\n                <span className=\"mr-2 text-white font-bold\">✓</span> Custom Merchandise\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":9630,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"server/index.ts":{"content":"import \"dotenv/config\";\nimport express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport amadeusDebugRoute from \"./routes/amadeus-debug\";\n\nconst app = express();\nimport aviasalesRouter from \"./routes/aviasales\";\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\napp.use(\"/api/aviasales\", aviasalesRouter);\napp.use(\"/api/amadeus\", amadeusDebugRoute);\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on port 5000\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = Number(process.env.PORT) || 5000;\n  const host = process.env.HOST ?? \"0.0.0.0\";\n  const listenOptions: Parameters<typeof server.listen>[0] = { port, host };\n\n  // reusePort is not supported on some platforms (e.g. macOS)\n  if (process.platform === \"linux\") {\n    listenOptions.reusePort = true;\n  }\n\n  server.listen(listenOptions, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2389,"size_tokens":null},"client/src/pages/SplittaBroMainPage.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, Users, Trash2, Share, Calculator, Euro } from \"lucide-react\";\n\n// Schemas\nconst createGroupSchema = z.object({\n  name: z.string().min(1, \"Il nome del gruppo è obbligatorio\"),\n  participants: z.array(z.string().min(1, \"Nome obbligatorio\")).min(2, \"Servono almeno 2 partecipanti\")\n});\n\nconst expenseSchema = z.object({\n  description: z.string().min(1, \"Descrizione obbligatoria\"),\n  amount: z.number().min(0.01, \"Importo deve essere maggiore di 0\"),\n  paidBy: z.string().min(1, \"Seleziona chi ha pagato\"),\n  category: z.string().min(1, \"Categoria obbligatoria\"),\n  date: z.string()\n});\n\ntype CreateGroupForm = z.infer<typeof createGroupSchema>;\ntype ExpenseForm = z.infer<typeof expenseSchema>;\n\ninterface Participant {\n  name: string;\n  email?: string;\n}\n\ninterface ExpenseGroup {\n  id: number;\n  name: string;\n  participants: Participant[];\n  tripId: number;\n  createdAt: string;\n}\n\ninterface Expense {\n  id: number;\n  groupId: number;\n  description: string;\n  amount: number;\n  paidBy: string;\n  splitWith: { name: string; share: number }[];\n  category: string;\n  date: string;\n  createdAt: string;\n}\n\nexport default function SplittaBroMainPage() {\n  const [selectedGroup, setSelectedGroup] = useState<number | null>(null);\n  const [showCreateGroupDialog, setShowCreateGroupDialog] = useState(false);\n  const [showExpenseDialog, setShowExpenseDialog] = useState(false);\n  const [participants, setParticipants] = useState<string[]>([\"\", \"\"]);\n  const { toast } = useToast();\n\n  const groupForm = useForm<CreateGroupForm>({\n    resolver: zodResolver(createGroupSchema),\n    defaultValues: {\n      name: \"\",\n      participants: [\"\", \"\"]\n    }\n  });\n\n  const expenseForm = useForm<ExpenseForm>({\n    resolver: zodResolver(expenseSchema),\n    defaultValues: {\n      description: \"\",\n      amount: 0,\n      paidBy: \"\",\n      category: \"Cibo\",\n      date: new Date().toISOString().split('T')[0],\n    },\n  });\n\n  // Carica gruppi\n  const { data: groups = [] } = useQuery<ExpenseGroup[]>({\n    queryKey: ['/api/expense-groups'],\n    queryFn: async () => {\n      const response = await apiRequest(\"GET\", \"/api/expense-groups\");\n      return await response.json();\n    }\n  });\n\n  // Carica spese del gruppo selezionato\n  const { data: expenses = [] } = useQuery<Expense[]>({\n    queryKey: ['/api/expense-groups', selectedGroup, 'expenses'],\n    queryFn: async () => {\n      if (!selectedGroup) return [];\n      const response = await apiRequest(\"GET\", `/api/expense-groups/${selectedGroup}/expenses`);\n      return await response.json();\n    },\n    enabled: !!selectedGroup\n  });\n\n  // Crea gruppo\n  const createGroup = useMutation({\n    mutationFn: async (data: CreateGroupForm) => {\n      const validParticipants = data.participants.filter(p => p.trim() !== \"\");\n      \n      const groupData = {\n        name: data.name.trim(),\n        participants: validParticipants.map(name => ({ name: name.trim() })),\n        tripId: 0\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/expense-groups\", groupData);\n      return await response.json();\n    },\n    onSuccess: (group) => {\n      setSelectedGroup(group.id);\n      setShowCreateGroupDialog(false);\n      groupForm.reset();\n      setParticipants([\"\", \"\"]);\n      toast({\n        title: \"Gruppo creato!\",\n        description: `Il gruppo \"${group.name}\" è stato creato.`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: \"Errore nella creazione del gruppo\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Crea spesa\n  const createExpense = useMutation({\n    mutationFn: async (data: ExpenseForm) => {\n      if (!selectedGroup) throw new Error(\"Nessun gruppo selezionato\");\n      \n      const group = groups.find((g: ExpenseGroup) => g.id === selectedGroup);\n      if (!group) throw new Error(\"Gruppo non trovato\");\n\n      const sharePerPerson = Math.round((data.amount * 100) / group.participants.length);\n      const remainder = (data.amount * 100) - (sharePerPerson * group.participants.length);\n      \n      const splitWith = group.participants.map((participant: Participant, index: number) => ({\n        name: participant.name,\n        share: index === group.participants.length - 1 ? sharePerPerson + remainder : sharePerPerson\n      }));\n\n      const expenseData = {\n        groupId: selectedGroup,\n        description: data.description,\n        amount: Math.round(data.amount * 100),\n        paidBy: data.paidBy,\n        splitWith,\n        category: data.category,\n        date: data.date\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/expenses\", expenseData);\n      return await response.json();\n    },\n    onSuccess: () => {\n      setShowExpenseDialog(false);\n      expenseForm.reset();\n      toast({\n        title: \"Spesa aggiunta!\",\n        description: \"La spesa è stata registrata nel gruppo.\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups', selectedGroup, 'expenses'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: \"Errore nell'aggiunta della spesa\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Aggiungi partecipante\n  const addParticipant = () => {\n    setParticipants([...participants, \"\"]);\n    groupForm.setValue(\"participants\", [...participants, \"\"]);\n  };\n\n  // Rimuovi partecipante\n  const removeParticipant = (index: number) => {\n    if (participants.length > 2) {\n      const updated = participants.filter((_, i) => i !== index);\n      setParticipants(updated);\n      groupForm.setValue(\"participants\", updated);\n    }\n  };\n\n  // Aggiorna partecipante\n  const updateParticipant = (index: number, name: string) => {\n    const updated = [...participants];\n    updated[index] = name;\n    setParticipants(updated);\n    groupForm.setValue(\"participants\", updated);\n  };\n\n  // Calcola bilanci\n  const calculateBalances = () => {\n    if (!selectedGroup) return [];\n    \n    const group = groups.find((g: ExpenseGroup) => g.id === selectedGroup);\n    if (!group) return [];\n\n    const balances: Record<string, { paid: number; owed: number; balance: number }> = {};\n    \n    // Inizializza bilanci\n    group.participants.forEach((participant: Participant) => {\n      balances[participant.name] = { paid: 0, owed: 0, balance: 0 };\n    });\n\n    // Calcola totali\n    expenses.forEach((expense: Expense) => {\n      const paidBy = expense.paidBy;\n      const amount = expense.amount;\n      \n      if (balances[paidBy]) {\n        balances[paidBy].paid += amount;\n      }\n      \n      if (expense.splitWith && Array.isArray(expense.splitWith)) {\n        expense.splitWith.forEach((split: { name: string; share: number }) => {\n          if (split && split.name && balances[split.name]) {\n            balances[split.name].owed += (split.share || 0);\n          }\n        });\n      }\n    });\n    \n    // Calcola bilancio finale\n    Object.keys(balances).forEach(person => {\n      if (balances[person]) {\n        balances[person].balance = balances[person].paid - balances[person].owed;\n      }\n    });\n\n    return Object.entries(balances).map(([name, balance]) => ({ name, ...balance }));\n  };\n\n  // Condividi gruppo\n  const shareGroup = () => {\n    if (!selectedGroup) return;\n    \n    const group = groups.find((g: ExpenseGroup) => g.id === selectedGroup);\n    if (!group) return;\n\n    const balances = calculateBalances();\n    const totalAmount = expenses.reduce((sum: number, expense: Expense) => sum + expense.amount, 0);\n    \n    let message = `🧾 *SplittaBro - ${group.name}*\\n\\n`;\n    message += `💰 *Totale spese:* €${(totalAmount / 100).toFixed(2)}\\n`;\n    message += `👥 *Partecipanti:* ${group.participants.map((p: Participant) => p.name).join(', ')}\\n\\n`;\n    \n    message += `*📊 Bilanci:*\\n`;\n    balances.forEach(balance => {\n      const status = balance.balance > 0.01 ? '✅ In credito' : \n                    balance.balance < -0.01 ? '❌ Deve pagare' : '✅ In pari';\n      message += `• ${balance.name}: €${(balance.balance / 100).toFixed(2)} ${status}\\n`;\n    });\n    \n    message += `\\n🔗 Accedi al gruppo: ${window.location.href}`;\n    \n    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;\n    window.open(whatsappUrl, '_blank');\n  };\n\n  const formatAmount = (amount: number) => `€${(amount / 100).toFixed(2)}`;\n\n  const selectedGroupData = groups.find(g => g.id === selectedGroup);\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 py-8\">\n      <div className=\"container mx-auto px-4 max-w-6xl\">\n        {/* Header */}\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-2\">SplittaBro</h1>\n          <p className=\"text-xl text-gray-600\">Dividi le spese con i tuoi amici</p>\n        </div>\n\n        {/* Sezione gruppi */}\n        {groups.length === 0 ? (\n          <Card className=\"max-w-md mx-auto\">\n            <CardHeader className=\"text-center\">\n              <div className=\"w-16 h-16 bg-red-600 text-white rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Users className=\"h-8 w-8\" />\n              </div>\n              <CardTitle>Benvenuto in SplittaBro!</CardTitle>\n              <CardDescription>\n                Crea il tuo primo gruppo per iniziare a dividere le spese con i tuoi amici\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Dialog open={showCreateGroupDialog} onOpenChange={setShowCreateGroupDialog}>\n                <DialogTrigger asChild>\n                  <Button className=\"w-full bg-red-600 hover:bg-red-700\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Crea il tuo primo gruppo\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-w-md\">\n                  <DialogHeader>\n                    <DialogTitle>Crea nuovo gruppo</DialogTitle>\n                    <DialogDescription>\n                      Aggiungi i tuoi amici per iniziare a dividere le spese\n                    </DialogDescription>\n                  </DialogHeader>\n                  \n                  <form onSubmit={groupForm.handleSubmit((data) => createGroup.mutate(data))} className=\"space-y-4\">\n                    <div>\n                      <Label>Nome del gruppo</Label>\n                      <Input \n                        {...groupForm.register(\"name\")} \n                        placeholder=\"es. Viaggio Amsterdam, Cena gruppo...\"\n                      />\n                      {groupForm.formState.errors.name && (\n                        <p className=\"text-red-500 text-sm mt-1\">{groupForm.formState.errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <Label>Partecipanti</Label>\n                      <div className=\"space-y-2\">\n                        {participants.map((participant, index) => (\n                          <div key={index} className=\"flex gap-2\">\n                            <Input\n                              value={participant}\n                              onChange={(e) => updateParticipant(index, e.target.value)}\n                              placeholder={`Nome partecipante ${index + 1}`}\n                            />\n                            {participants.length > 2 && (\n                              <Button\n                                type=\"button\"\n                                variant=\"outline\"\n                                size=\"icon\"\n                                onClick={() => removeParticipant(index)}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={addParticipant}\n                        className=\"w-full mt-2\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Aggiungi partecipante\n                      </Button>\n                    </div>\n\n                    <DialogFooter>\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setShowCreateGroupDialog(false)}>\n                        Annulla\n                      </Button>\n                      <Button type=\"submit\" disabled={createGroup.isPending} className=\"bg-red-600 hover:bg-red-700\">\n                        {createGroup.isPending ? \"Creando...\" : \"Crea gruppo\"}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n            {/* Lista gruppi */}\n            <div className=\"lg:col-span-1\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <CardTitle className=\"text-lg\">I tuoi gruppi</CardTitle>\n                  <Dialog open={showCreateGroupDialog} onOpenChange={setShowCreateGroupDialog}>\n                    <DialogTrigger asChild>\n                      <Button size=\"sm\" className=\"bg-red-600 hover:bg-red-700\">\n                        <Plus className=\"h-4 w-4\" />\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent className=\"max-w-md\">\n                      <DialogHeader>\n                        <DialogTitle>Crea nuovo gruppo</DialogTitle>\n                        <DialogDescription>\n                          Aggiungi i tuoi amici per iniziare a dividere le spese\n                        </DialogDescription>\n                      </DialogHeader>\n                      \n                      <form onSubmit={groupForm.handleSubmit((data) => createGroup.mutate(data))} className=\"space-y-4\">\n                        <div>\n                          <Label>Nome del gruppo</Label>\n                          <Input \n                            {...groupForm.register(\"name\")} \n                            placeholder=\"es. Viaggio Amsterdam, Cena gruppo...\"\n                          />\n                          {groupForm.formState.errors.name && (\n                            <p className=\"text-red-500 text-sm mt-1\">{groupForm.formState.errors.name.message}</p>\n                          )}\n                        </div>\n\n                        <div>\n                          <Label>Partecipanti</Label>\n                          <div className=\"space-y-2\">\n                            {participants.map((participant, index) => (\n                              <div key={index} className=\"flex gap-2\">\n                                <Input\n                                  value={participant}\n                                  onChange={(e) => updateParticipant(index, e.target.value)}\n                                  placeholder={`Nome partecipante ${index + 1}`}\n                                />\n                                {participants.length > 2 && (\n                                  <Button\n                                    type=\"button\"\n                                    variant=\"outline\"\n                                    size=\"icon\"\n                                    onClick={() => removeParticipant(index)}\n                                  >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                  </Button>\n                                )}\n                              </div>\n                            ))}\n                          </div>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            onClick={addParticipant}\n                            className=\"w-full mt-2\"\n                          >\n                            <Plus className=\"h-4 w-4 mr-2\" />\n                            Aggiungi partecipante\n                          </Button>\n                        </div>\n\n                        <DialogFooter>\n                          <Button type=\"button\" variant=\"outline\" onClick={() => setShowCreateGroupDialog(false)}>\n                            Annulla\n                          </Button>\n                          <Button type=\"submit\" disabled={createGroup.isPending} className=\"bg-red-600 hover:bg-red-700\">\n                            {createGroup.isPending ? \"Creando...\" : \"Crea gruppo\"}\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </DialogContent>\n                  </Dialog>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-2\">\n                    {groups.map((group: ExpenseGroup) => (\n                      <div\n                        key={group.id}\n                        className={`p-3 rounded-lg cursor-pointer transition-colors ${\n                          selectedGroup === group.id\n                            ? \"bg-red-100 border-2 border-red-300\"\n                            : \"bg-gray-100 hover:bg-gray-200\"\n                        }`}\n                        onClick={() => setSelectedGroup(group.id)}\n                      >\n                        <div className=\"font-medium text-sm\">{group.name}</div>\n                        <div className=\"text-xs text-gray-500\">{group.participants.length} partecipanti</div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Contenuto gruppo selezionato */}\n            {selectedGroup && selectedGroupData && (\n              <div className=\"lg:col-span-3 space-y-6\">\n                {/* Header gruppo */}\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Users className=\"h-5 w-5\" />\n                        {selectedGroupData.name}\n                      </CardTitle>\n                      <CardDescription>\n                        {selectedGroupData.participants.length} partecipanti • {expenses.length} spese\n                      </CardDescription>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button variant=\"outline\" onClick={shareGroup}>\n                        <Share className=\"h-4 w-4 mr-2\" />\n                        Condividi su WhatsApp\n                      </Button>\n                      <Dialog open={showExpenseDialog} onOpenChange={setShowExpenseDialog}>\n                        <DialogTrigger asChild>\n                          <Button className=\"bg-red-600 hover:bg-red-700\">\n                            <Plus className=\"h-4 w-4 mr-2\" />\n                            Aggiungi spesa\n                          </Button>\n                        </DialogTrigger>\n                        <DialogContent className=\"max-w-md\">\n                          <DialogHeader>\n                            <DialogTitle>Nuova spesa</DialogTitle>\n                            <DialogDescription>\n                              Aggiungi una spesa al gruppo {selectedGroupData.name}\n                            </DialogDescription>\n                          </DialogHeader>\n                          \n                          <form onSubmit={expenseForm.handleSubmit((data) => createExpense.mutate(data))} className=\"space-y-6\">\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label className=\"text-base font-medium\">Descrizione della spesa</Label>\n                                <Input \n                                  {...expenseForm.register(\"description\")} \n                                  placeholder=\"Inserisci descrizione (es. Cena al ristorante)\" \n                                  className=\"text-lg\"\n                                />\n                                {expenseForm.formState.errors.description && (\n                                  <p className=\"text-red-500 text-sm mt-1\">{expenseForm.formState.errors.description.message}</p>\n                                )}\n                              </div>\n\n                              <div>\n                                <Label className=\"text-base font-medium\">Importo totale</Label>\n                                <div className=\"relative\">\n                                  <span className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg\">€</span>\n                                  <Input \n                                    type=\"number\" \n                                    step=\"0.01\" \n                                    {...expenseForm.register(\"amount\", { valueAsNumber: true })} \n                                    placeholder=\"0.00\"\n                                    className=\"text-lg pl-8\"\n                                  />\n                                </div>\n                                {expenseForm.formState.errors.amount && (\n                                  <p className=\"text-red-500 text-sm mt-1\">{expenseForm.formState.errors.amount.message}</p>\n                                )}\n                              </div>\n                            </div>\n\n                            <div>\n                              <Label className=\"text-base font-medium\">Pagato da</Label>\n                              <Select onValueChange={(value) => expenseForm.setValue(\"paidBy\", value)}>\n                                <SelectTrigger className=\"text-lg\">\n                                  <SelectValue placeholder=\"Seleziona chi ha pagato\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {selectedGroupData.participants.map((p: Participant) => (\n                                    <SelectItem key={p.name} value={p.name}>\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold\">\n                                          {p.name.charAt(0)}\n                                        </div>\n                                        {p.name}\n                                      </div>\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              {expenseForm.formState.errors.paidBy && (\n                                <p className=\"text-red-500 text-sm mt-1\">{expenseForm.formState.errors.paidBy.message}</p>\n                              )}\n                            </div>\n\n                            <div>\n                              <Label className=\"text-base font-medium\">Come dividere la spesa?</Label>\n                              <div className=\"mt-2 p-4 border rounded-lg bg-gray-50\">\n                                <div className=\"flex items-center justify-between mb-3\">\n                                  <span className=\"text-sm font-medium text-gray-700\">Dividi equamente tra tutti</span>\n                                  <span className=\"text-sm text-gray-500\">\n                                    {expenseForm.watch(\"amount\") > 0 ? \n                                      `€${(expenseForm.watch(\"amount\") / selectedGroupData.participants.length).toFixed(2)} a testa` : \n                                      '€0.00 a testa'\n                                    }\n                                  </span>\n                                </div>\n                                \n                                <div className=\"space-y-2\">\n                                  {selectedGroupData.participants.map((p: Participant) => (\n                                    <div key={p.name} className=\"flex items-center justify-between py-2 px-3 bg-white rounded border\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold\">\n                                          {p.name.charAt(0)}\n                                        </div>\n                                        <span className=\"text-sm font-medium\">{p.name}</span>\n                                      </div>\n                                      <span className=\"text-sm font-medium text-green-600\">\n                                        {expenseForm.watch(\"amount\") > 0 ? \n                                          `€${(expenseForm.watch(\"amount\") / selectedGroupData.participants.length).toFixed(2)}` : \n                                          '€0.00'\n                                        }\n                                      </span>\n                                    </div>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-4\">\n                              <div>\n                                <Label className=\"text-base font-medium\">Categoria</Label>\n                                <Select onValueChange={(value) => expenseForm.setValue(\"category\", value)} defaultValue=\"Cibo\">\n                                  <SelectTrigger>\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"Cibo\">🍽️ Cibo & Ristoranti</SelectItem>\n                                    <SelectItem value=\"Trasporto\">🚗 Trasporto</SelectItem>\n                                    <SelectItem value=\"Alloggio\">🏨 Alloggio</SelectItem>\n                                    <SelectItem value=\"Attività\">🎯 Attività & Divertimento</SelectItem>\n                                    <SelectItem value=\"Bevande\">🍺 Bevande & Locali</SelectItem>\n                                    <SelectItem value=\"Shopping\">🛍️ Shopping</SelectItem>\n                                    <SelectItem value=\"Altro\">📝 Altro</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n\n                              <div>\n                                <Label className=\"text-base font-medium\">Data</Label>\n                                <Input type=\"date\" {...expenseForm.register(\"date\")} />\n                              </div>\n                            </div>\n\n                            <DialogFooter className=\"mt-6\">\n                              <Button type=\"button\" variant=\"outline\" onClick={() => setShowExpenseDialog(false)}>\n                                Annulla\n                              </Button>\n                              <Button \n                                type=\"submit\" \n                                disabled={createExpense.isPending}\n                                className=\"bg-green-600 hover:bg-green-700\"\n                              >\n                                {createExpense.isPending ? \"Salvando...\" : \"Salva spesa\"}\n                              </Button>\n                            </DialogFooter>\n                          </form>\n                        </DialogContent>\n                      </Dialog>\n                    </div>\n                  </CardHeader>\n                </Card>\n\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                  {/* Lista spese */}\n                  <div className=\"lg:col-span-2\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Euro className=\"h-5 w-5\" />\n                          Spese del gruppo\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        {expenses.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {expenses.map((expense: Expense) => (\n                              <div key={expense.id} className=\"p-4 border rounded-lg bg-white\">\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <div className=\"flex items-center gap-3\">\n                                    <Badge variant=\"outline\">{expense.category}</Badge>\n                                    <div>\n                                      <div className=\"font-medium\">{expense.description}</div>\n                                      <div className=\"text-sm text-gray-500\">\n                                        Pagato da {expense.paidBy} • {new Date(expense.date).toLocaleDateString()}\n                                      </div>\n                                    </div>\n                                  </div>\n                                  <div className=\"text-right\">\n                                    <div className=\"text-lg font-bold text-gray-900\">\n                                      {formatAmount(expense.amount)}\n                                    </div>\n                                  </div>\n                                </div>\n                                \n                                <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-gray-600 bg-gray-50 rounded p-2\">\n                                  {expense.splitWith && Array.isArray(expense.splitWith) ? expense.splitWith.map((split, index) => (\n                                    <div key={index} className=\"flex justify-between\">\n                                      <span>{split.name}:</span>\n                                      <span className=\"font-medium\">{formatAmount(split.share)}</span>\n                                    </div>\n                                  )) : (\n                                    <div className=\"text-gray-500\">Nessuna divisione disponibile</div>\n                                  )}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className=\"text-center py-8 text-gray-500\">\n                            Nessuna spesa registrata\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  {/* Bilanci */}\n                  <div className=\"space-y-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Calculator className=\"h-5 w-5\" />\n                          Bilanci\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          {calculateBalances().map((balance, index) => (\n                            <div key={index} className={`flex items-center justify-between p-4 rounded-lg transition-all hover:shadow-md ${\n                              balance.balance > 0.01\n                                ? \"bg-green-50 border border-green-200\" \n                                : balance.balance < -0.01\n                                  ? \"bg-red-50 border border-red-200\" \n                                  : \"bg-gray-50 border border-gray-200\"\n                            }`}>\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"w-12 h-12 bg-red-600 text-white rounded-full flex items-center justify-center font-bold text-lg\">\n                                  {balance.name.charAt(0).toUpperCase()}\n                                </div>\n                                <div className=\"flex flex-col\">\n                                  <span className=\"font-semibold text-lg\">{balance.name}</span>\n                                  <div className=\"text-sm text-gray-500\">\n                                    Ha pagato {formatAmount(balance.paid)} • Deve {formatAmount(balance.owed)}\n                                  </div>\n                                </div>\n                              </div>\n                              <div className=\"text-right\">\n                                <div className={`text-2xl font-bold ${\n                                  balance.balance > 0.01\n                                    ? \"text-green-600\" \n                                    : balance.balance < -0.01\n                                      ? \"text-red-600\" \n                                      : \"text-gray-600\"\n                                }`}>\n                                  {balance.balance > 0.01 ? \"+\" : \"\"}{formatAmount(balance.balance)}\n                                </div>\n                                <div className={`text-sm font-medium ${\n                                  balance.balance > 0.01\n                                    ? \"text-green-600\" \n                                    : balance.balance < -0.01\n                                      ? \"text-red-600\" \n                                      : \"text-gray-600\"\n                                }`}>\n                                  {balance.balance > 0.01 ? \"In credito\" : \n                                   balance.balance < -0.01 ? \"Deve pagare\" : \"In pari\"}\n                                </div>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":35269,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/components/ui/optimized-image.tsx":{"content":"import { useState, useEffect, useRef, memo } from \"react\";\nimport { optimizeImageUrl } from \"@/lib/performance\";\n\ninterface OptimizedImageProps extends React.ImgHTMLAttributes<HTMLImageElement> {\n  src: string;\n  alt: string;\n  width?: number;\n  height?: number;\n  className?: string;\n  loadingMode?: \"lazy\" | \"eager\";\n  quality?: number;\n  fallback?: string;\n  onLoad?: () => void;\n  onError?: () => void;\n}\n\n/**\n * Component that optimizes images with lazy loading and placeholders\n */\nexport const OptimizedImage = memo(function OptimizedImage({\n  src,\n  alt,\n  width = 600,\n  height = 400,\n  className = \"\",\n  loadingMode = \"lazy\",\n  quality = 80,\n  fallback = \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Crect width='40' height='40' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' font-size='6' text-anchor='middle' alignment-baseline='middle' font-family='sans-serif' fill='%23aaaaaa'%3EImage%3C/text%3E%3C/svg%3E\",\n  onLoad,\n  onError,\n  ...props\n}: OptimizedImageProps) {\n  const [isLoaded, setIsLoaded] = useState(false);\n  const [error, setError] = useState(false);\n  const imageRef = useRef<HTMLImageElement>(null);\n  const observer = useRef<IntersectionObserver | null>(null);\n\n  // Ottimizza URL con dimensioni e qualità\n  const optimizedSrc = error\n    ? fallback\n    : optimizeImageUrl(\n        src,\n        width,\n        height,\n        quality\n      );\n\n  useEffect(() => {\n    // Reset lo stato se cambia la src\n    if (src) {\n      setIsLoaded(false);\n      setError(false);\n    }\n  }, [src]);\n\n  useEffect(() => {\n    // Lazy loading con IntersectionObserver\n    if (loadingMode === \"lazy\" && \"IntersectionObserver\" in window) {\n      const img = imageRef.current;\n\n      const handleIntersection: IntersectionObserverCallback = (entries) => {\n        entries.forEach((entry) => {\n          if (entry.isIntersecting) {\n            if (img && img.dataset.src) {\n              // Carica l'immagine quando diventa visibile\n              img.src = img.dataset.src;\n              observer.current?.unobserve(img);\n            }\n          }\n        });\n      };\n\n      observer.current = new IntersectionObserver(handleIntersection, {\n        rootMargin: \"200px 0px\",  // Precarica quando l'immagine è a 200px di distanza\n        threshold: 0.01,\n      });\n\n      if (img) observer.current.observe(img);\n\n      return () => {\n        if (img && observer.current) observer.current.unobserve(img);\n      };\n    }\n  }, [loadingMode, optimizedSrc]);\n\n  // Gestione eventi di caricamento\n  const handleLoad = () => {\n    setIsLoaded(true);\n    if (onLoad) onLoad();\n  };\n\n  const handleError = () => {\n    setError(true);\n    if (onError) onError();\n  };\n\n  return (\n    <div\n      className={`overflow-hidden ${className}`}\n      style={{ position: \"relative\", width: \"100%\", height: \"auto\" }}\n    >\n      {/* Placeholder/skeleton mentre l'immagine carica */}\n      {!isLoaded && (\n        <div\n          className=\"absolute inset-0 bg-gray-200 animate-pulse\"\n          style={{\n            backgroundSize: \"cover\",\n            backgroundPosition: \"center\",\n          }}\n        />\n      )}\n\n      <img\n        ref={imageRef}\n        src={loadingMode === \"lazy\" ? fallback : optimizedSrc}\n        data-src={loadingMode === \"lazy\" ? optimizedSrc : undefined}\n        alt={alt}\n        width={width}\n        height={height}\n        onLoad={handleLoad}\n        onError={handleError}\n        className={`w-full h-auto transition-opacity duration-300 ${\n          isLoaded ? \"opacity-100\" : \"opacity-0\"\n        }`}\n        loading={loadingMode}\n        decoding=\"async\"\n        {...props}\n      />\n    </div>\n  );\n});\n\nexport default OptimizedImage;","path":null,"size_bytes":3722,"size_tokens":null},"client/src/pages/DestinationsPage.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Destination, Experience } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Star, StarHalf } from \"lucide-react\";\nimport Header from \"@/components/Header\";\nimport Footer from \"@/components/Footer\";\nimport ReactCountryFlag from \"react-country-flag\";\n\nexport default function DestinationsPage() {\n  const { data: destinations, isLoading: isLoadingDestinations } = useQuery<Destination[]>({\n    queryKey: [\"/api/destinations\"],\n  });\n\n  const { data: experiences } = useQuery<Experience[]>({\n    queryKey: [\"/api/experiences\"],\n  });\n\n  // Helper function to convert country name to country code\n  const getCountryCode = (country: string): string => {\n    const countryMap: Record<string, string> = {\n      \"Netherlands\": \"NL\",\n      \"Germany\": \"DE\",\n      \"Spain\": \"ES\",\n      \"Italy\": \"IT\",\n      \"France\": \"FR\",\n      \"United Kingdom\": \"GB\",\n      \"Czech Republic\": \"CZ\",\n      \"Croatia\": \"HR\",\n      \"Poland\": \"PL\",\n      \"Belgium\": \"BE\",\n      \"Portugal\": \"PT\",\n      \"Greece\": \"GR\",\n      \"Sweden\": \"SE\",\n      \"Denmark\": \"DK\",\n      \"Austria\": \"AT\",\n      \"Hungary\": \"HU\",\n      \"Ireland\": \"IE\",\n      \"Switzerland\": \"CH\"\n    };\n    \n    return countryMap[country] || \"EU\"; // Usa l'UE come fallback\n  };\n\n  // Helper function to render rating stars\n  const renderRatingStars = (rating: string) => {\n    const ratingNum = parseFloat(rating);\n    const fullStars = Math.floor(ratingNum);\n    const hasHalfStar = ratingNum % 1 >= 0.5;\n    const stars = [];\n\n    for (let i = 0; i < fullStars; i++) {\n      stars.push(<Star key={`full-${i}`} className=\"fill-yellow-400 text-yellow-400 h-4 w-4\" />);\n    }\n\n    if (hasHalfStar) {\n      stars.push(<StarHalf key=\"half\" className=\"fill-yellow-400 text-yellow-400 h-4 w-4\" />);\n    }\n\n    return stars;\n  };\n\n  // Helper function to get best experience types for a destination\n  const getDestinationExperiences = (destination: Destination) => {\n    const destinationName = destination.name.toLowerCase();\n    const destinationCountry = destination.country.toLowerCase();\n    \n    // Experience matching logic\n    const experienceMatches = {\n      \"The Ultimate BroNight\": [\n        \"amsterdam\", \"berlin\", \"prague\", \"barcelona\", \"budapest\", \"london\",\n        \"netherlands\", \"germany\", \"czech republic\", \"spain\", \"hungary\", \"united kingdom\"\n      ],\n      \"My Olympic Bro\": [\n        \"barcelona\", \"bilbao\", \"munich\", \"london\", \"milan\", \"rome\", \"paris\",\n        \"spain\", \"germany\", \"united kingdom\", \"italy\", \"france\"\n      ],\n      \"Chill & Feel the Bro\": [\n        \"rome\", \"florence\", \"paris\", \"barcelona\", \"lisbon\", \"copenhagen\", \"vienna\",\n        \"italy\", \"france\", \"spain\", \"portugal\", \"denmark\", \"austria\"\n      ],\n      \"The Wild Broventure\": [\n        \"interlaken\", \"barcelona\", \"split\", \"ibiza\", \"mykonos\", \"berlin\", \"prague\",\n        \"switzerland\", \"spain\", \"croatia\", \"greece\", \"germany\", \"czech republic\"\n      ]\n    };\n    \n    // Find matching experiences\n    const matchingExperiences = [];\n    for (const [expName, locations] of Object.entries(experienceMatches)) {\n      if (locations.some(loc => \n        destinationName.includes(loc) || \n        destinationCountry.includes(loc)\n      )) {\n        matchingExperiences.push(expName);\n      }\n    }\n    \n    // Add special cases\n    if (destinationName === \"amsterdam\") {\n      // Amsterdam is the ultimate party city\n      if (!matchingExperiences.includes(\"The Ultimate BroNight\")) {\n        matchingExperiences.unshift(\"The Ultimate BroNight\");\n      }\n    } \n    else if (destinationName === \"bilbao\") {\n      // Bilbao for sports\n      if (!matchingExperiences.includes(\"My Olympic Bro\")) {\n        matchingExperiences.unshift(\"My Olympic Bro\");\n      }\n    }\n    else if (destinationName === \"paris\") {\n      // Paris for culinary excellence\n      if (!matchingExperiences.includes(\"Chill & Feel the Bro\")) {\n        matchingExperiences.unshift(\"Chill & Feel the Bro\");\n      }\n    }\n    \n    return matchingExperiences.slice(0, 2); // Return top 2 matches\n  };\n\n  // Helper to get the experience color\n  const getExperienceColor = (expName: string) => {\n    const colorMap: Record<string, string> = {\n      \"The Ultimate BroNight\": \"bg-red-600\",\n      \"My Olympic Bro\": \"bg-blue-600\",\n      \"Chill & Feel the Bro\": \"bg-green-600\",\n      \"The Wild Broventure\": \"bg-amber-600\"\n    };\n    \n    return colorMap[expName] || \"bg-gray-600\";\n  };\n\n  if (isLoadingDestinations) {\n    return (\n      <>\n        <Header />\n        <main>\n          <div className=\"container mx-auto px-4 py-12\">\n            <div className=\"text-center mb-12\">\n              <Skeleton className=\"h-12 w-64 mx-auto\" />\n              <Skeleton className=\"h-5 w-full max-w-xl mx-auto mt-3\" />\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8\">\n              {[1, 2, 3, 4, 5, 6].map((i) => (\n                <div key={i} className=\"bg-white rounded-xl overflow-hidden shadow-lg\">\n                  <Skeleton className=\"h-64 w-full\" />\n                  <div className=\"p-4\">\n                    <Skeleton className=\"h-6 w-40 mb-2\" />\n                    <Skeleton className=\"h-4 w-24 mb-4\" />\n                    <Skeleton className=\"h-4 w-full mb-2\" />\n                    <Skeleton className=\"h-4 w-full mb-2\" />\n                    <Skeleton className=\"h-4 w-3/4 mb-4\" />\n                    <div className=\"flex justify-between\">\n                      <Skeleton className=\"h-4 w-24\" />\n                      <Skeleton className=\"h-10 w-24\" />\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </main>\n        <Footer />\n      </>\n    );\n  }\n\n  return (\n    <>\n      <Header />\n      <main className=\"bg-gray-100\">\n        <section className=\"bg-black text-white py-20\">\n          <div className=\"container mx-auto px-4\">\n            <div className=\"text-center\">\n              <h1 className=\"text-4xl md:text-5xl font-bold mb-6\">Bachelor Party Destinations</h1>\n              <p className=\"text-xl max-w-3xl mx-auto\">\n                Discover the perfect city for your group's last adventure together. \n                From wild nightlife to thrilling adventures, we've got the ideal spot for every team.\n              </p>\n            </div>\n          </div>\n        </section>\n        \n        <section className=\"py-16\">\n          <div className=\"container mx-auto px-4\">\n            <div className=\"mb-12\">\n              <h2 className=\"text-3xl font-bold mb-4\">All Destinations</h2>\n              <p className=\"text-gray-600\">\n                Each destination is tagged with the experiences that match its vibe best. Look for the colored badges!\n              </p>\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8\">\n              {destinations?.map((destination) => {\n                const recommendedExperiences = getDestinationExperiences(destination);\n                \n                return (\n                  <div key={destination.id} className=\"bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition duration-300\">\n                    <div className=\"relative h-64 overflow-hidden\">\n                      <img \n                        src={destination.image} \n                        alt={`${destination.name} - ${destination.country}`} \n                        className=\"w-full h-full object-cover transition duration-500 hover:scale-105\" \n                      />\n                      <div className=\"absolute top-4 left-4 flex items-center space-x-2\">\n                        <ReactCountryFlag \n                          countryCode={getCountryCode(destination.country)}\n                          svg\n                          style={{\n                            width: '1.7em',\n                            height: '1.7em',\n                            border: '2px solid white',\n                            borderRadius: '50%',\n                            objectFit: 'cover'\n                          }}\n                        />\n                      </div>\n                      <div className=\"absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black to-transparent\">\n                        <h3 className=\"text-white text-xl font-bold\">{destination.name}</h3>\n                        <p className=\"text-white text-sm\">{destination.country}</p>\n                      </div>\n                    </div>\n                    \n                    <div className=\"p-6\">\n                      <div className=\"flex flex-wrap gap-2 mb-4\">\n                        {recommendedExperiences.map((expName, i) => (\n                          <span \n                            key={i} \n                            className={`${getExperienceColor(expName)} text-white text-xs px-3 py-1 rounded-full`}\n                          >\n                            {expName}\n                          </span>\n                        ))}\n                        {destination.tags?.map((tag, i) => (\n                          <span \n                            key={`tag-${i}`} \n                            className=\"bg-gray-200 text-gray-800 text-xs px-3 py-1 rounded-full\"\n                          >\n                            {tag}\n                          </span>\n                        ))}\n                      </div>\n                      \n                      <p className=\"text-gray-700 mb-4\">{destination.description}</p>\n                      \n                      <div className=\"flex items-center\">\n                        <div className=\"text-yellow-400 flex\">\n                          {renderRatingStars(destination.rating)}\n                        </div>\n                        <span className=\"text-gray-600 ml-2 text-sm\">{destination.rating} ({destination.reviewCount} reviews)</span>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        </section>\n      </main>\n      <Footer />\n    </>\n  );\n}","path":null,"size_bytes":10197,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  html {\n    /* Miglioramento dello scroll */\n    scroll-behavior: smooth;\n    overflow-x: hidden;\n    overscroll-behavior: contain;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    /* Previene l'overshooting dello scroll */\n    overscroll-behavior-y: none;\n    /* Rendering più fluido */\n    text-rendering: optimizeSpeed;\n  }\n\n  /* Ottimizzazioni per i link */\n  a, button {\n    @apply cursor-pointer touch-manipulation;\n  }\n\n  /* Movimento e animations ottimizzate */\n  .animate-optimized {\n    will-change: transform, opacity;\n    backface-visibility: hidden;\n    transform: translateZ(0);\n  }\n\n  /* Miglioramento transizioni */\n  .transition {\n    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  /* Scrollbar personalizzata */\n  ::-webkit-scrollbar {\n    width: 8px;\n    height: 8px;\n  }\n\n  ::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  ::-webkit-scrollbar-thumb {\n    @apply bg-gray-300 rounded-full;\n  }\n\n  ::-webkit-scrollbar-thumb:hover {\n    @apply bg-gray-400;\n  }\n  \n  /* Custom styles per l'auth page */\n  .auth-page-form input {\n    background-color: #f2f2f2 !important;\n    border-color: #333 !important;\n    color: #000000 !important;\n  }\n  \n  .auth-page-form label {\n    color: #ffffff !important;\n  }\n  \n  .auth-page-form .form-message {\n    color: #ff4c4c !important;\n  }\n}","path":null,"size_bytes":1472,"size_tokens":null},"client/src/components/Testimonials.tsx":{"content":"import { Star } from \"lucide-react\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\n// Testimonial data per brand\nconst testimonialsBro = [\n  {\n    name: \"James Wilson\",\n    rating: 5.0,\n    text: \"ByeBro made planning my best friend's bachelor party so easy. The itinerary was perfect, accommodations were great, and everyone had an amazing time in Amsterdam. Would absolutely recommend!\",\n    image: \"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80\",\n    trip: \"Berlin Trip, July 2023\"\n  },\n  {\n    name: \"Michael Johnson\",\n    rating: 4.5,\n    text: \"The custom t-shirts were a huge hit! Everyone loved them, and the whole experience from planning to partying was seamless. The Secret Blog tips definitely saved us from some rookie mistakes.\",\n    image: \"https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80\",\n    trip: \"Prague Trip, May 2023\"\n  },\n  {\n    name: \"David Thompson\",\n    rating: 5.0,\n    text: \"As the best man, I was stressed about planning the perfect bachelor party. ByeBro took all that stress away. The activities they recommended in Barcelona were spot on, and the groom had the time of his life!\",\n    image: \"https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80\",\n    trip: \"Barcelona Trip, August 2023\"\n  }\n];\n\nconst testimonialsBride = [\n  {\n    name: \"Sarah Martinez\",\n    rating: 5.0,\n    text: \"ByeBride made planning my best friend's bachelorette party absolutely perfect! The spa recommendations and brunch spots in Barcelona were amazing, and the bride had the time of her life!\",\n    image: \"https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80\",\n    trip: \"Barcelona Trip, July 2023\"\n  },\n  {\n    name: \"Emily Johnson\",\n    rating: 4.5,\n    text: \"The custom t-shirts were adorable! Everyone loved them, and the whole experience from planning to celebrating was seamless. The Secret Blog tips for bachelorette parties were incredibly helpful!\",\n    image: \"https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80\",\n    trip: \"Ibiza Trip, May 2023\"\n  },\n  {\n    name: \"Jessica Williams\",\n    rating: 5.0,\n    text: \"As the maid of honor, I was stressed about planning the perfect bachelorette party. ByeBride took all that stress away. The beach club and wellness activities in Palma were exactly what we needed!\",\n    image: \"https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80\",\n    trip: \"Palma Trip, August 2023\"\n  }\n];\n\n// Helper function to render rating stars\nconst renderRatingStars = (rating: number) => {\n  const fullStars = Math.floor(rating);\n  const hasHalfStar = rating % 1 >= 0.5;\n  const stars = [];\n\n  for (let i = 0; i < fullStars; i++) {\n    stars.push(<Star key={`full-${i}`} className=\"fill-yellow-400 text-yellow-400\" />);\n  }\n\n  if (hasHalfStar) {\n    stars.push(\n      <svg key=\"half\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"fill-yellow-400 text-yellow-400\">\n        <path d=\"M12 17.8 5.8 21 7 14.1 2 9.3l7-1L12 2\" fill=\"yellow\" />\n      </svg>\n    );\n  }\n\n  return stars;\n};\n\ntype Brand = 'bro' | 'bride';\n\ninterface TestimonialsProps {\n  brand?: Brand;\n}\n\nexport default function Testimonials({ brand = 'bro' }: TestimonialsProps) {\n  const { t } = useTranslation();\n  const testimonials = brand === 'bride' ? testimonialsBride : testimonialsBro;\n  const subtitle = brand === 'bride' ? t('testimonials.bride.subtitle') : t('testimonials.bro.subtitle');\n  \n  return (\n    <section className=\"py-16 bg-light\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">{t('testimonials.title')}</h2>\n          <p className=\"text-gray-600 max-w-3xl mx-auto\">{subtitle}</p>\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8\">\n          {testimonials.map((testimonial, index) => (\n            <div key={index} className=\"bg-white rounded-xl p-6 shadow-md\">\n              <div className=\"flex items-center mb-4\">\n                <div className=\"text-yellow-400 flex\">\n                  {renderRatingStars(testimonial.rating)}\n                </div>\n                <span className=\"text-gray-600 ml-2\">{testimonial.rating.toFixed(1)}</span>\n              </div>\n              <p className=\"text-gray-600 mb-6 italic\">\"{testimonial.text}\"</p>\n              <div className=\"flex items-center\">\n                <img \n                  src={testimonial.image} \n                  alt={`${testimonial.name} profile photo`} \n                  className=\"w-12 h-12 rounded-full object-cover\" \n                />\n                <div className=\"ml-3\">\n                  <h4 className=\"font-bold text-dark\">{testimonial.name}</h4>\n                  <p className=\"text-gray-500 text-sm\">{testimonial.trip}</p>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":5367,"size_tokens":null},"client/src/pages/SplittaBroPage.tsx":{"content":"import { SplittaBro } from '@/components/SplittaBro';\n\nexport default function SplittaBroPage() {\n  return <SplittaBro />;\n}","path":null,"size_bytes":124,"size_tokens":null},"client/src/pages/ExperiencesPage.tsx":{"content":"import { useEffect } from \"react\";\nimport ExperienceTypes from \"@/components/ExperienceTypes\";\nimport Footer from \"@/components/Footer\";\nimport Newsletter from \"@/components/Newsletter\";\nimport Header from \"@/components/Header\";\n\nexport default function ExperiencesPage() {\n  // Scroll to top on page load\n  useEffect(() => {\n    window.scrollTo(0, 0);\n  }, []);\n\n  return (\n    <div className=\"min-h-screen flex flex-col\">\n      <Header />\n      <main className=\"flex-grow\">\n        <section className=\"py-16 bg-black\">\n          <div className=\"container mx-auto px-4\">\n            <div className=\"text-center mb-12\">\n              <h1 className=\"text-4xl md:text-5xl font-bold font-poppins mb-4 text-white\">Experience Types</h1>\n              <p className=\"text-gray-300 max-w-3xl mx-auto\">\n                Choose the perfect vibe for your bachelor party. From adrenaline-pumping adventures to refined experiences, we've got you covered.\n              </p>\n            </div>\n          </div>\n        </section>\n        \n        <ExperienceTypes />\n        \n        <Newsletter />\n      </main>\n      <Footer />\n    </div>\n  );\n}","path":null,"size_bytes":1132,"size_tokens":null},"client/src/hooks/use-optimized-scroll.tsx":{"content":"import { useEffect, useRef, useState } from 'react';\nimport { throttle } from '@/lib/performance';\n\ninterface ScrollOptions {\n  // Millisecondi di throttle per l'evento di scroll\n  throttleMs?: number;\n  // Offset per triggerare l'evento near-bottom\n  bottomOffset?: number;\n}\n\ninterface ScrollState {\n  // Posizione corrente dello scroll\n  scrollY: number;\n  // Direzione dello scroll (positivo = verso il basso)\n  direction: 'up' | 'down' | null;\n  // Quanto si è scrollato dall'ultimo evento\n  delta: number;\n  // Se si è vicini al fondo della pagina\n  isNearBottom: boolean;\n  // Se si è scrollato abbastanza da nascondere elementi\n  isScrolled: boolean;\n}\n\n/**\n * Hook che fornisce informazioni ottimizzate sullo scroll\n * \n * @param options Opzioni di configurazione\n * @returns Stato dello scroll\n */\nexport function useOptimizedScroll(options: ScrollOptions = {}): ScrollState {\n  const { \n    throttleMs = 100, \n    bottomOffset = 200 \n  } = options;\n  \n  const [scrollY, setScrollY] = useState(0);\n  const [direction, setDirection] = useState<'up' | 'down' | null>(null);\n  const [delta, setDelta] = useState(0);\n  const [isNearBottom, setIsNearBottom] = useState(false);\n  const [isScrolled, setIsScrolled] = useState(false);\n  \n  const lastScrollY = useRef(0);\n  \n  useEffect(() => {\n    const handleScroll = throttle(() => {\n      const currentScrollY = window.scrollY;\n      const currentDirection = currentScrollY > lastScrollY.current ? 'down' : 'up';\n      const currentDelta = Math.abs(currentScrollY - lastScrollY.current);\n      \n      // Calcola se siamo vicini al fondo della pagina\n      const nearBottom = \n        window.innerHeight + currentScrollY >= \n        document.documentElement.scrollHeight - bottomOffset;\n      \n      // Aggiorna lo stato\n      setScrollY(currentScrollY);\n      setDirection(currentDirection);\n      setDelta(currentDelta);\n      setIsNearBottom(nearBottom);\n      setIsScrolled(currentScrollY > 50);\n      \n      // Salva l'ultimo valore di scroll\n      lastScrollY.current = currentScrollY;\n    }, throttleMs);\n    \n    // Imposta lo stato iniziale\n    handleScroll();\n    \n    // Aggiungi l'evento listener\n    window.addEventListener('scroll', handleScroll, { passive: true });\n    \n    // Cleanup\n    return () => {\n      window.removeEventListener('scroll', handleScroll);\n    };\n  }, [throttleMs, bottomOffset]);\n  \n  return {\n    scrollY,\n    direction,\n    delta,\n    isNearBottom,\n    isScrolled\n  };\n}\n\n/**\n * Scroll verso l'elemento specificato con animazione fluida\n */\nexport function scrollToElement(elementId: string, offset = 0): void {\n  const element = document.getElementById(elementId);\n  \n  if (element) {\n    const elementPosition = element.getBoundingClientRect().top;\n    const offsetPosition = elementPosition + window.pageYOffset - offset;\n    \n    window.scrollTo({\n      top: offsetPosition,\n      behavior: 'smooth'\n    });\n  }\n}\n\n/**\n * Disabilita temporaneamente lo scroll\n */\nexport function disableScroll(): () => void {\n  const scrollY = window.scrollY;\n  \n  // Salva la posizione corrente\n  const oldStyle = document.body.style.cssText;\n  \n  // Blocca lo scroll\n  document.body.style.cssText = `\n    overflow: hidden;\n    position: fixed;\n    top: -${scrollY}px;\n    left: 0;\n    right: 0;\n    bottom: 0;\n  `;\n  \n  // Funzione per ripristinare lo scroll\n  return () => {\n    document.body.style.cssText = oldStyle;\n    window.scrollTo(0, scrollY);\n  };\n}","path":null,"size_bytes":3446,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/CustomMerchandise.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Merchandise } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Heart, Upload, Minus, Plus } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\nexport default function CustomMerchandise() {\n  const [customText, setCustomText] = useState(\"\");\n  const [textColor, setTextColor] = useState(\"white\");\n  const [quantity, setQuantity] = useState(6);\n  const [selectedType, setSelectedType] = useState(\"tshirt\");\n  const { toast } = useToast();\n  const { t } = useTranslation();\n\n  const { data: merchandise, isLoading, error } = useQuery<Merchandise[]>({\n    queryKey: [\"/api/merchandise\"],\n    staleTime: 0,\n    refetchOnMount: true,\n  });\n\n  const handleAddToCart = () => {\n    toast({\n      title: t('merch.addedToCartTitle'),\n      description: t('merch.addedToCartDesc', { quantity: String(quantity), type: selectedType }),\n    });\n  };\n\n  const incrementQuantity = () => setQuantity(prev => prev + 1);\n  const decrementQuantity = () => {\n    if (quantity > 1) {\n      setQuantity(prev => prev - 1);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <section className=\"py-16 bg-white\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center mb-12\">\n            <Skeleton className=\"h-10 w-64 mx-auto\" />\n            <Skeleton className=\"h-5 w-96 mx-auto mt-3\" />\n          </div>\n          \n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10\">\n            <div className=\"col-span-1 lg:col-span-2\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                {[1, 2].map((i) => (\n                  <div key={i} className=\"bg-light rounded-xl overflow-hidden shadow-md\">\n                    <Skeleton className=\"h-64 w-full\" />\n                    <div className=\"p-5\">\n                      <Skeleton className=\"h-6 w-36 mb-2\" />\n                      <Skeleton className=\"h-4 w-full mb-4\" />\n                      <div className=\"flex justify-between items-center\">\n                        <Skeleton className=\"h-5 w-24\" />\n                        <Skeleton className=\"h-4 w-24\" />\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n            <div className=\"col-span-1\">\n              <Skeleton className=\"h-[600px] w-full rounded-xl\" />\n            </div>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (error) {\n    return (\n      <section className=\"py-16 bg-white\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center\">\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">{t('merch.title')}</h2>\n            <p className=\"text-red-500\">{t('merch.errorLoading')}</p>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  // Filter merchandise by type\n  const tShirts = merchandise?.filter(item => item.type === \"tshirt\") || [];\n  const caps = merchandise?.filter(item => item.type === \"cap\") || [];\n  const smallItems = merchandise?.filter(item => ![\"tshirt\", \"cap\"].includes(item.type)) || [];\n\n  // Funzione helper per aggiungere il cache buster alle URL delle immagini\n  const getCacheBustedImageUrl = (url: string) => {\n    return `${url}?t=${Date.now()}`;\n  };\n\n  return (\n    <section className=\"py-16 bg-white\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">{t('merch.title')}</h2>\n          <p className=\"text-gray-600 max-w-3xl mx-auto\">{t('merch.subtitle')}</p>\n        </div>\n        \n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10\">\n          <div className=\"col-span-1 lg:col-span-2\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              {/* Product 1 and 2 (T-shirts and Caps) */}\n              {[...tShirts, ...caps].slice(0, 2).map((item) => (\n                <div key={item.id} className=\"bg-light rounded-xl overflow-hidden shadow-md group hover:shadow-lg transition duration-300\">\n                  <div className=\"relative h-64 overflow-hidden\">\n                    <img \n                      src={getCacheBustedImageUrl(item.image)} \n                      alt={item.name} \n                      className=\"w-full h-full object-cover transition duration-500 group-hover:scale-105\" \n                    />\n                    <div className=\"absolute top-3 right-3 bg-white rounded-full p-2 shadow-md\">\n                      <Heart className=\"text-gray-400 hover:text-primary cursor-pointer transition\" />\n                    </div>\n                  </div>\n                  <div className=\"p-5\">\n                    <h3 className=\"text-xl font-bold mb-2 font-poppins\">{item.name}</h3>\n                    <p className=\"text-gray-600 text-sm mb-4\">{item.description}</p>\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-primary font-bold\">€{(item.price / 100).toFixed(2)} <span className=\"text-sm font-normal text-gray-500\">/ {item.type}</span></span>\n                      <Button \n                        variant=\"ghost\" \n                        className=\"text-primary hover:text-accent font-medium\"\n                        onClick={() => setSelectedType(item.type)}\n                      >\n                        {t('merch.customize')}\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n            \n            <div className=\"mt-6 grid grid-cols-1 md:grid-cols-3 gap-6\">\n              {/* Products 3, 4, 5 (Small items) */}\n              {smallItems.slice(0, 3).map((item) => (\n                <div key={item.id} className=\"bg-light rounded-xl overflow-hidden shadow-md group hover:shadow-lg transition duration-300\">\n                  <div className=\"relative h-48 overflow-hidden\">\n                    <img \n                      src={getCacheBustedImageUrl(item.image)} \n                      alt={item.name} \n                      className=\"w-full h-full object-cover transition duration-500 group-hover:scale-105\" \n                    />\n                  </div>\n                  <div className=\"p-4\">\n                    <h3 className=\"text-lg font-bold mb-1 font-poppins\">{item.name}</h3>\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-red-600 font-bold\">€{(item.price / 100).toFixed(2)}</span>\n                      <Button \n                        variant=\"ghost\" \n                        className=\"text-red-600 hover:text-red-700 text-sm font-medium p-0\"\n                        onClick={() => setSelectedType(item.type)}\n                      >\n                        {t('merch.view')}\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n          \n          {/* Customization Panel */}\n          <div className=\"col-span-1\">\n            <div className=\"bg-light rounded-xl shadow-md p-6\">\n              <h3 className=\"text-xl font-bold mb-4 font-poppins\">{t('merch.designTitle')}</h3>\n              <p className=\"text-gray-600 text-sm mb-6\">{t('merch.designSubtitle')}</p>\n              \n              <form onSubmit={(e) => { e.preventDefault(); handleAddToCart(); }}>\n                <div className=\"mb-4\">\n                  <label htmlFor=\"product-type\" className=\"block text-sm font-medium text-gray-700 mb-1\">{t('merch.productType')}</label>\n                  <Select \n                    value={selectedType} \n                    onValueChange={setSelectedType}\n                  >\n                    <SelectTrigger>\n                      <SelectValue placeholder={t('merch.selectType')} />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"tshirt\">{t('merch.tshirt')}</SelectItem>\n                      <SelectItem value=\"cap\">{t('merch.cap')}</SelectItem>\n                      <SelectItem value=\"mug\">{t('merch.mug')}</SelectItem>\n                      <SelectItem value=\"socks\">{t('merch.socks')}</SelectItem>\n                      <SelectItem value=\"badges\">{t('merch.badges')}</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                \n                <div className=\"mb-4\">\n                  <label htmlFor=\"design-text\" className=\"block text-sm font-medium text-gray-700 mb-1\">{t('merch.customText')}</label>\n                  <Input \n                    id=\"design-text\" \n                    value={customText} \n                    onChange={(e) => setCustomText(e.target.value)} \n                    placeholder={t('merch.customTextPlaceholder')} \n                  />\n                </div>\n                \n                <div className=\"mb-4\">\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">{t('merch.textColor')}</label>\n                  <div className=\"grid grid-cols-6 gap-2\">\n                    {[\"white\", \"black\", \"#FF5A5F\", \"#3B82F6\", \"#22C55E\", \"#F59E0B\"].map((color) => (\n                      <Button\n                        key={color}\n                        type=\"button\"\n                        className={`w-8 h-8 rounded-full p-0 ${textColor === color ? 'ring-2 ring-offset-2 ring-red-600' : ''}`}\n                        style={{ backgroundColor: color }}\n                        onClick={() => setTextColor(color)}\n                      />\n                    ))}\n                  </div>\n                </div>\n                \n                <div className=\"mb-4\">\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">{t('merch.uploadTitle')}</label>\n                  <div className=\"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-red-600 transition\">\n                    <Upload className=\"mx-auto text-gray-400 mb-2\" />\n                    <p className=\"text-sm text-gray-500\">{t('merch.uploadClick')}</p>\n                    <p className=\"text-xs text-gray-400 mt-1\">{t('merch.uploadFormats')}</p>\n                  </div>\n                </div>\n                \n                <div className=\"mb-6\">\n                  <label htmlFor=\"quantity\" className=\"block text-sm font-medium text-gray-700 mb-1\">{t('merch.quantity')}</label>\n                  <div className=\"flex\">\n                    <Button \n                      type=\"button\" \n                      variant=\"outline\"\n                      className=\"px-3 rounded-l-lg\"\n                      onClick={decrementQuantity}\n                    >\n                      <Minus className=\"h-4 w-4\" />\n                    </Button>\n                    <Input\n                      type=\"number\"\n                      id=\"quantity\"\n                      min=\"1\"\n                      value={quantity}\n                      onChange={(e) => setQuantity(Number(e.target.value))}\n                      className=\"w-20 text-center rounded-none border-x-0\"\n                    />\n                    <Button \n                      type=\"button\" \n                      variant=\"outline\"\n                      className=\"px-3 rounded-r-lg\"\n                      onClick={incrementQuantity}\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n                \n                <Button type=\"submit\" className=\"w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700\">\n                  {t('merch.addToCart')}\n                </Button>\n                \n                <p className=\"text-xs text-gray-500 mt-4 text-center\">{t('merch.freeNote')}</p>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":12378,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/PremiumFeatures.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Check } from \"lucide-react\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\ntype Brand = 'bro' | 'bride';\n\ninterface PremiumFeaturesProps {\n  brand?: Brand;\n}\n\nexport default function PremiumFeatures({ brand = 'bro' }: PremiumFeaturesProps) {\n  const [selectedPlan, setSelectedPlan] = useState<\"monthly\" | \"annual\">(\"monthly\");\n  const { user, isAuthenticated, updateUser } = useAuth();\n  const { toast } = useToast();\n  const { t } = useTranslation();\n  const isPremium = user?.isPremium || false;\n\n  const handleUpgrade = async () => {\n    if (!isAuthenticated) {\n      toast({\n        title: t('premium.authRequired'),\n        description: t('premium.authRequiredDesc'),\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      const response = await apiRequest(\"POST\", `/api/users/${user?.id}/premium`, {\n        isPremium: true\n      });\n      \n      const updatedUser = await response.json();\n      updateUser(updatedUser);\n      \n      toast({\n        title: t('premium.upgradeSuccess'),\n        description: `${t('premium.upgradeSuccessDesc')}${selectedPlan === \"annual\" ? t('premium.upgradeSuccessAnnual') : \"\"}`,\n      });\n      \n      // Invalidate queries that depend on premium status\n      queryClient.invalidateQueries({ queryKey: [\"/api/blog-posts\"] });\n      \n    } catch (error) {\n      toast({\n        title: t('premium.upgradeFailed'),\n        description: t('premium.upgradeFailedDesc'),\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <section id=\"premium-features\" className=\"py-16 bg-gradient-to-r from-red-600 to-red-700\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3 text-white\">{t('premium.title')}</h2>\n          <p className=\"text-white opacity-90 max-w-3xl mx-auto\">{brand === 'bride' ? t('premium.bride.subtitle') : t('premium.bro.subtitle')}</p>\n        </div>\n        \n        <div className=\"max-w-4xl mx-auto bg-black rounded-xl overflow-hidden shadow-xl border border-red-600\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-3\">\n            <div className=\"p-8 bg-gray-900\">\n              <h3 className=\"text-2xl font-bold mb-6 font-poppins text-white\">{t('premium.benefitsTitle')}</h3>\n              <ul className=\"space-y-4\">\n                <li className=\"flex items-start\">\n                  <Check className=\"text-red-600 mt-1 mr-3 h-5 w-5\" />\n                  <div>\n                    <span className=\"font-medium text-white\">{t(`premium.${brand}.blogTitle`)}</span>\n                    <p className=\"text-sm text-gray-300 mt-1\">{t(`premium.${brand}.blogDesc`)}</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start\">\n                  <Check className=\"text-red-600 mt-1 mr-3 h-5 w-5\" />\n                  <div>\n                    <span className=\"font-medium text-white\">{t(`premium.${brand}.avatarTitle`)}</span>\n                    <p className=\"text-sm text-gray-300 mt-1\">{t(`premium.${brand}.avatarDesc`)}</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start\">\n                  <Check className=\"text-red-600 mt-1 mr-3 h-5 w-5\" />\n                  <div>\n                    <span className=\"font-medium text-white\">{t('premium.itineraryTitle')}</span>\n                    <p className=\"text-sm text-gray-300 mt-1\">{t('premium.itineraryDesc')}</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start\">\n                  <Check className=\"text-red-600 mt-1 mr-3 h-5 w-5\" />\n                  <div>\n                    <span className=\"font-medium text-white\">{t('premium.discountsTitle')}</span>\n                    <p className=\"text-sm text-gray-300 mt-1\">{t('premium.discountsDesc')}</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start\">\n                  <Check className=\"text-red-600 mt-1 mr-3 h-5 w-5\" />\n                  <div>\n                    <span className=\"font-medium text-white\">{t('premium.supportTitle')}</span>\n                    <p className=\"text-sm text-gray-300 mt-1\">{t('premium.supportDesc')}</p>\n                  </div>\n                </li>\n              </ul>\n            </div>\n            \n            <div className=\"col-span-2 p-8 bg-black\">\n              <h3 className=\"text-2xl font-bold mb-6 font-poppins text-white\">{t('premium.choosePlan')}</h3>\n              \n              {isPremium ? (\n                <div className=\"text-center p-6 bg-gray-900 rounded-lg border border-red-600\">\n                  <h4 className=\"text-xl font-bold text-red-600 mb-2\">{t('premium.alreadyMember')}</h4>\n                  <p className=\"text-gray-300\">\n                    {brand === 'bride' ? t('premium.bride.alreadyDesc') : t('premium.bro.alreadyDesc')}\n                  </p>\n                  <Button className=\"mt-4 bg-red-600 hover:bg-red-700\">\n                    {t('premium.goToDashboard')}\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div \n                    className={`border rounded-lg p-6 hover:shadow-md transition duration-300 bg-gray-900 ${\n                      selectedPlan === \"monthly\" ? \"border-red-600 shadow-md\" : \"border-gray-700\"\n                    }`}\n                    onClick={() => setSelectedPlan(\"monthly\")}\n                  >\n                    <div className=\"flex justify-between items-start mb-4\">\n                      <div>\n                        <h4 className=\"text-xl font-bold text-white\">{t('premium.monthly')}</h4>\n                        <p className=\"text-gray-300 text-sm\">{t('premium.monthlyDesc')}</p>\n                      </div>\n                      <div className=\"bg-red-900 text-white text-xs px-2 py-1 rounded-full font-medium\">{t('premium.popular')}</div>\n                    </div>\n                    <div className=\"mb-4\">\n                      <span className=\"text-3xl font-bold text-white\">€2.99</span>\n                      <span className=\"text-gray-400\">{t('premium.monthlyPerMonth')}</span>\n                    </div>\n                    <ul className=\"space-y-2 mb-6\">\n                      <li className=\"flex items-center\">\n                        <Check className=\"text-red-600 mr-2 h-4 w-4\" />\n                        <span className=\"text-sm text-gray-300\">{t('premium.allBenefits')}</span>\n                      </li>\n                      <li className=\"flex items-center\">\n                        <Check className=\"text-red-600 mr-2 h-4 w-4\" />\n                        <span className=\"text-sm text-gray-300\">{t('premium.cancelAnytime')}</span>\n                      </li>\n                      <li className=\"flex items-center\">\n                        <Check className=\"text-red-600 mr-2 h-4 w-4\" />\n                        <span className=\"text-sm text-gray-300\">{t('premium.discount10')}</span>\n                      </li>\n                    </ul>\n                    <Button \n                      className={`w-full ${selectedPlan === \"monthly\" ? \"bg-red-600\" : \"bg-gray-600\"} text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300`}\n                      onClick={handleUpgrade}\n                    >\n                      {t('premium.chooseMonthly')}\n                    </Button>\n                  </div>\n                  \n                  <div \n                    className={`border rounded-lg p-6 hover:shadow-md transition duration-300 bg-gray-900 ${\n                      selectedPlan === \"annual\" ? \"border-red-600 shadow-md\" : \"border-gray-700\"\n                    }`}\n                    onClick={() => setSelectedPlan(\"annual\")}\n                  >\n                    <div className=\"flex justify-between items-start mb-4\">\n                      <div>\n                        <h4 className=\"text-xl font-bold text-white\">{t('premium.annual')}</h4>\n                        <p className=\"text-gray-300 text-sm\">{brand === 'bride' ? t('premium.bride.annualDesc') : t('premium.bro.annualDesc')}</p>\n                      </div>\n                      <div className=\"bg-red-900 text-white text-xs px-2 py-1 rounded-full font-medium\">{t('premium.save33')}</div>\n                    </div>\n                    <div className=\"mb-4\">\n                      <span className=\"text-3xl font-bold text-white\">€23.99</span>\n                      <span className=\"text-gray-400\">{t('premium.annualPerYear')}</span>\n                    </div>\n                    <ul className=\"space-y-2 mb-6\">\n                      <li className=\"flex items-center\">\n                        <Check className=\"text-red-600 mr-2 h-4 w-4\" />\n                        <span className=\"text-sm text-gray-300\">{t('premium.allBenefits')}</span>\n                      </li>\n                      <li className=\"flex items-center\">\n                        <Check className=\"text-red-600 mr-2 h-4 w-4\" />\n                        <span className=\"text-sm text-gray-300\">{t('premium.freeTshirts')}</span>\n                      </li>\n                      <li className=\"flex items-center\">\n                        <Check className=\"text-red-600 mr-2 h-4 w-4\" />\n                        <span className=\"text-sm text-gray-300\">{t('premium.discount20')}</span>\n                      </li>\n                    </ul>\n                    <Button \n                      className={`w-full ${selectedPlan === \"annual\" ? \"bg-red-600\" : \"bg-gray-600\"} text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300`}\n                      onClick={handleUpgrade}\n                    >\n                      {t('premium.chooseAnnual')}\n                    </Button>\n                  </div>\n                </div>\n              )}\n              \n              {!isPremium && (\n                <div className=\"mt-6 text-center text-sm text-gray-300\">\n                  <p>{t('premium.notSure')}<a href=\"#\" className=\"text-red-600 hover:text-red-700\">{t('premium.freeTrial')}</a></p>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":10522,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/HowItWorks.tsx":{"content":"import { Building, Map, GlassWater } from \"lucide-react\";\n\ntype Brand = 'bro' | 'bride';\n\ninterface HowItWorksProps {\n  brand?: Brand;\n}\n\nconst COPY = {\n  bro: {\n    title: \"How ByeBro Works\",\n    subtitle: \"Planning a bachelor party has never been easier. Follow these simple steps to create the ultimate experience.\",\n    bookText: \"Book your trip through our trusted partners, order custom merch, and get ready for an unforgettable bachelor party.\"\n  },\n  bride: {\n    title: \"How ByeBride Works\",\n    subtitle: \"Planning a bachelorette party has never been easier. Follow these simple steps to create the ultimate experience.\",\n    bookText: \"Book your trip through our trusted partners, order custom merch, and get ready for an unforgettable bachelorette party.\"\n  }\n};\n\nexport default function HowItWorks({ brand = 'bro' }: HowItWorksProps) {\n  const copy = COPY[brand];\n  const accentColor = brand === 'bride' ? 'border-pink-600 text-pink-600' : 'border-red-600 text-red-600';\n  \n  return (\n    <section className=\"py-16 bg-black\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3 text-white\">{copy.title}</h2>\n          <p className=\"text-gray-300 max-w-3xl mx-auto\">{copy.subtitle}</p>\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8 mt-12\">\n          <div className=\"bg-gray-900 rounded-lg p-6 shadow-md flex flex-col items-center text-center\">\n            <div className={`w-16 h-16 bg-black border-2 ${accentColor.split(' ')[0]} rounded-full flex items-center justify-center mb-4`}>\n              <Building className={`${accentColor.split(' ')[1]} text-2xl`} />\n            </div>\n            <h3 className=\"text-xl font-bold mb-3 font-poppins text-white\">Sign Up & Share Details</h3>\n            <p className=\"text-gray-300\">Create an account and tell us about the party - who's coming, what you're into, and where you want to go.</p>\n          </div>\n          \n          <div className=\"bg-gray-900 rounded-lg p-6 shadow-md flex flex-col items-center text-center\">\n            <div className={`w-16 h-16 bg-black border-2 ${accentColor.split(' ')[0]} rounded-full flex items-center justify-center mb-4`}>\n              <Map className={`${accentColor.split(' ')[1]} text-2xl`} />\n            </div>\n            <h3 className=\"text-xl font-bold mb-3 font-poppins text-white\">Get Custom Itineraries</h3>\n            <p className=\"text-gray-300\">Our app generates personalized trip options with flights, accommodations, and activities tailored to your preferences.</p>\n          </div>\n          \n          <div className=\"bg-gray-900 rounded-lg p-6 shadow-md flex flex-col items-center text-center\">\n            <div className={`w-16 h-16 bg-black border-2 ${accentColor.split(' ')[0]} rounded-full flex items-center justify-center mb-4`}>\n              <GlassWater className={`${accentColor.split(' ')[1]} text-2xl`} />\n            </div>\n            <h3 className=\"text-xl font-bold mb-3 font-poppins text-white\">Book & Celebrate</h3>\n            <p className=\"text-gray-300\">{copy.bookText}</p>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":3231,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/Header.tsx":{"content":"import { useState, useEffect, useRef, memo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link, useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Menu, X, User, LogOut, Loader2, ArrowLeft, Globe } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useOptimizedScroll } from \"@/hooks/use-optimized-scroll\";\nimport { throttle } from \"@/lib/performance\";\nimport { useTranslation, type Locale } from \"@/contexts/LanguageContext\";\n\nconst FLAG_LABELS: Record<Locale, { flag: string; label: string }> = {\n  it: { flag: '🇮🇹', label: 'Italiano' },\n  en: { flag: '🇬🇧', label: 'English' },\n  es: { flag: '🇪🇸', label: 'Español' },\n};\n\n// Utilizziamo React.memo per evitare re-render inutili\nconst Header = memo(function Header() {\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n  const [selectedBrand, setSelectedBrand] = useState<'byebro' | 'byebride' | null>(null);\n  const [location, navigate] = useLocation();\n  const { user, logoutMutation } = useAuth();\n  const menuRef = useRef<HTMLDivElement>(null);\n  const { t, locale, setLocale } = useTranslation();\n\n  // Check which brand is selected\n  useEffect(() => {\n    const brand = localStorage.getItem('selectedBrand') as 'byebro' | 'byebride' | null;\n    setSelectedBrand(brand);\n  }, []);\n  \n  // Utilizziamo il nostro hook ottimizzato per lo scroll\n  const { isScrolled } = useOptimizedScroll({\n    throttleMs: 50 // Reattivo ma ottimizzato\n  });\n\n  // Utilizziamo throttle per limitare la frequenza delle chiamate\n  const toggleMobileMenu = throttle(() => {\n    setMobileMenuOpen(prev => !prev);\n  }, 200);\n\n  const navigateToAuth = throttle((defaultTab: string = \"login\") => {\n    navigate(`/auth?tab=${defaultTab}`);\n  }, 300);\n\n  const handleLogout = throttle(() => {\n    logoutMutation.mutate();\n  }, 300);\n\n  const handleChangeBrand = throttle(() => {\n    localStorage.removeItem('selectedBrand');\n    window.location.href = '/';\n  }, 300);\n\n  // Chiude il menu mobile quando si clicca all'esterno\n  useEffect(() => {\n    // Ottimizzazione: utilizziamo un unico event listener con throttle\n    const handleClickOutside = throttle((event: MouseEvent) => {\n      if (mobileMenuOpen && menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setMobileMenuOpen(false);\n      }\n    }, 100);\n\n    // Utilizziamo passive: true per migliorare le performance\n    document.addEventListener(\"mousedown\", handleClickOutside, { passive: true });\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, [mobileMenuOpen]); // Dipendenza da mobileMenuOpen per evitare calcoli inutili\n\n  return (\n    <header className={`bg-white sticky top-0 z-50 transition-all duration-300 ${isScrolled ? 'shadow-md py-1' : 'py-2'}`}>\n      <div className=\"container mx-auto px-4 py-2 flex justify-between items-center\">\n        <div className=\"flex items-center gap-3\">\n          <Link href=\"/\" className=\"font-poppins font-bold text-2xl transform transition-transform hover:scale-105\">\n            {selectedBrand === 'byebride' ? (\n              <>\n                <span className=\"text-black\">Bye</span><span className=\"text-pink-600\">Bride</span>\n              </>\n            ) : (\n              <>\n                <span className=\"text-black\">Bye</span><span className=\"text-red-600\">Bro</span>\n              </>\n            )}\n          </Link>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={handleChangeBrand}\n            className=\"text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1\"\n            data-testid=\"button-change-brand\"\n          >\n            <ArrowLeft className=\"w-3 h-3\" />\n            {t('brand.changeBrand')}\n          </Button>\n        </div>\n        \n        <div className=\"hidden md:flex items-center space-x-6\">\n          <Link href=\"/\" className={`text-dark transition font-medium text-sm ${\n            selectedBrand === 'byebride' \n              ? `hover:text-pink-600 ${location === \"/\" ? \"text-pink-600\" : \"\"}`\n              : `hover:text-red-600 ${location === \"/\" ? \"text-red-600\" : \"\"}`\n          }`}>\n            {t('header.howItWorks')}\n          </Link>\n          <Link href=\"/destinations\" className={`text-dark transition font-medium text-sm ${\n            selectedBrand === 'byebride'\n              ? `hover:text-pink-600 ${location === \"/destinations\" ? \"text-pink-600\" : \"\"}`\n              : `hover:text-red-600 ${location === \"/destinations\" ? \"text-red-600\" : \"\"}`\n          }`}>\n            {t('header.destinations')}\n          </Link>\n          <Link href=\"/experiences\" className={`text-dark transition font-medium text-sm ${\n            selectedBrand === 'byebride'\n              ? `hover:text-pink-600 ${location === \"/experiences\" ? \"text-pink-600\" : \"\"}`\n              : `hover:text-red-600 ${location === \"/experiences\" ? \"text-red-600\" : \"\"}`\n          }`}>\n            {t('header.experiences')}\n          </Link>\n          <Link href=\"/secret-blog\" className={`text-dark transition font-medium text-sm ${\n            selectedBrand === 'byebride'\n              ? `hover:text-pink-600 ${location === \"/secret-blog\" ? \"text-pink-600\" : \"\"}`\n              : `hover:text-red-600 ${location === \"/secret-blog\" ? \"text-red-600\" : \"\"}`\n          }`}>\n            {t('header.secretBlog')}\n          </Link>\n          <Link href=\"/merchandise\" className={`text-dark transition font-medium text-sm ${\n            selectedBrand === 'byebride'\n              ? `hover:text-pink-600 ${location === \"/merchandise\" ? \"text-pink-600\" : \"\"}`\n              : `hover:text-red-600 ${location === \"/merchandise\" ? \"text-red-600\" : \"\"}`\n          }`}>\n            {t('header.merch')}\n          </Link>\n          <Link href={selectedBrand === 'byebride' ? \"/splitta-bride\" : \"/splitta-bro\"} className={`text-dark transition font-medium text-sm ${\n            selectedBrand === 'byebride'\n              ? `hover:text-pink-600 ${(location.startsWith(\"/splitta-bro\") || location.startsWith(\"/splitta-bride\")) ? \"text-pink-600\" : \"\"}`\n              : `hover:text-red-600 ${(location.startsWith(\"/splitta-bro\") || location.startsWith(\"/splitta-bride\")) ? \"text-red-600\" : \"\"}`\n          }`}>\n            {selectedBrand === 'byebride' ? 'SplittaBride' : 'SplittaBro'}\n          </Link>\n        </div>\n        \n        <div className=\"flex items-center space-x-2\">\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"text-sm gap-1 px-2\">\n                <span>{FLAG_LABELS[locale].flag}</span>\n                <Globe className=\"w-3.5 h-3.5 text-gray-500\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              {(Object.keys(FLAG_LABELS) as Locale[]).map((loc) => (\n                <DropdownMenuItem\n                  key={loc}\n                  onClick={() => setLocale(loc)}\n                  className={locale === loc ? 'bg-gray-100 font-semibold' : ''}\n                >\n                  <span className=\"mr-2\">{FLAG_LABELS[loc].flag}</span>\n                  {FLAG_LABELS[loc].label}\n                </DropdownMenuItem>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n\n          {user ? (\n            <div className=\"hidden md:block\">\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" className=\"font-medium\">\n                    <User className=\"mr-2 h-4 w-4\" />\n                    {user.username}\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuItem asChild>\n                    <Link href=\"/dashboard\">{t('header.dashboard')}</Link>\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={handleLogout} disabled={logoutMutation.isPending}>\n                    {logoutMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        {t('header.loggingOut')}\n                      </>\n                    ) : (\n                      <>\n                        <LogOut className=\"mr-2 h-4 w-4\" />\n                        {t('header.logout')}\n                      </>\n                    )}\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          ) : (\n            <>\n              <Button\n                variant=\"ghost\"\n                className={`hidden md:block font-medium ${\n                  selectedBrand === 'byebride'\n                    ? 'text-pink-600 hover:text-pink-700'\n                    : 'text-red-600 hover:text-red-700'\n                }`}\n                onClick={() => navigateToAuth(\"login\")}\n              >\n                {t('header.login')}\n              </Button>\n              <Button\n                className={`hidden md:block text-white px-4 py-2 rounded-lg font-medium transition ${\n                  selectedBrand === 'byebride'\n                    ? 'bg-pink-600 hover:bg-pink-700'\n                    : 'bg-red-600 hover:bg-red-700'\n                }`}\n                onClick={() => navigateToAuth(\"register\")}\n              >\n                {t('header.signup')}\n              </Button>\n            </>\n          )}\n          \n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={toggleMobileMenu}\n            className=\"md:hidden\"\n          >\n            {mobileMenuOpen ? <X /> : <Menu />}\n          </Button>\n        </div>\n      </div>\n      \n      {/* Mobile menu */}\n      {mobileMenuOpen && (\n        <div ref={menuRef} className=\"md:hidden bg-white border-t border-gray-200 p-4\">\n          <div className=\"flex flex-col space-y-3\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleChangeBrand}\n              className=\"text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1 justify-start\"\n            >\n              <ArrowLeft className=\"w-3 h-3\" />\n              {t('brand.changeBrand')}\n            </Button>\n            <Link href=\"/\" className={`text-dark transition font-medium ${\n              selectedBrand === 'byebride' ? 'hover:text-pink-600' : 'hover:text-red-600'\n            }`}>{t('header.howItWorks')}</Link>\n            <Link href=\"/destinations\" className={`text-dark transition font-medium ${\n              selectedBrand === 'byebride' ? 'hover:text-pink-600' : 'hover:text-red-600'\n            }`}>{t('header.destinations')}</Link>\n            <Link href=\"/experiences\" className={`text-dark transition font-medium ${\n              selectedBrand === 'byebride' ? 'hover:text-pink-600' : 'hover:text-red-600'\n            }`}>{t('header.experiences')}</Link>\n            <Link href=\"/secret-blog\" className={`text-dark transition font-medium ${\n              selectedBrand === 'byebride' ? 'hover:text-pink-600' : 'hover:text-red-600'\n            }`}>{t('header.secretBlog')}</Link>\n            <Link href=\"/merchandise\" className={`text-dark transition font-medium ${\n              selectedBrand === 'byebride' ? 'hover:text-pink-600' : 'hover:text-red-600'\n            }`}>{t('header.merch')}</Link>\n            <Link href={selectedBrand === 'byebride' ? \"/splitta-bride\" : \"/splitta-bro\"} className={`text-dark transition font-medium ${\n              selectedBrand === 'byebride' ? 'hover:text-pink-600' : 'hover:text-red-600'\n            }`}>{selectedBrand === 'byebride' ? 'SplittaBride' : 'SplittaBro'}</Link>\n            \n            <div className=\"flex flex-col space-y-2 pt-2 border-t border-gray-200 mt-2\">\n              {user ? (\n                <>\n                  <Link href=\"/dashboard\" className=\"text-dark hover:text-red-600 transition font-medium\">{t('header.dashboard')}</Link>\n                  <Button \n                    variant=\"ghost\" \n                    className=\"text-left\" \n                    onClick={handleLogout}\n                    disabled={logoutMutation.isPending}\n                  >\n                    {logoutMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 inline animate-spin\" />\n                        {t('header.loggingOut')}\n                      </>\n                    ) : (\n                      <>\n                        <LogOut className=\"mr-2 h-4 w-4 inline\" />\n                        {t('header.logout')}\n                      </>\n                    )}\n                  </Button>\n                </>\n              ) : (\n                <>\n                  <Button \n                    variant=\"ghost\" \n                    className={`font-medium transition text-left ${\n                      selectedBrand === 'byebride'\n                        ? 'text-pink-600 hover:text-pink-700'\n                        : 'text-red-600 hover:text-red-700'\n                    }`}\n                    onClick={() => navigateToAuth(\"login\")}\n                  >\n                    {t('header.login')}\n                  </Button>\n                  <Button \n                    className={`text-white px-4 py-2 rounded-lg font-medium transition ${\n                      selectedBrand === 'byebride'\n                        ? 'bg-pink-600 hover:bg-pink-700'\n                        : 'bg-red-600 hover:bg-red-700'\n                    }`}\n                    onClick={() => navigateToAuth(\"register\")}\n                  >\n                    {t('header.signup')}\n                  </Button>\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n    </header>\n  );\n});\n\nexport default Header;","path":null,"size_bytes":13907,"size_tokens":null},"client/src/components/SecretBlog.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { BlogPost } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Lock } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\ntype Brand = 'bro' | 'bride';\n\ninterface SecretBlogProps {\n  brand?: Brand;\n}\n\nexport default function SecretBlog({ brand = 'bro' }: SecretBlogProps) {\n  const { isAuthenticated, user } = useAuth();\n  const isPremium = user?.isPremium || false;\n  const { t } = useTranslation();\n  const subtitle = brand === 'bride' ? t('blog.bride.subtitle') : t('blog.bro.subtitle');\n\n  const { data: blogPosts, isLoading, error } = useQuery<BlogPost[]>({\n    queryKey: [\"/api/blog-posts\"],\n  });\n\n  if (isLoading) {\n    return (\n      <section className=\"py-16 bg-black\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex flex-col md:flex-row justify-between items-center mb-12\">\n            <div>\n              <Skeleton className=\"h-10 w-48 mb-3\" />\n              <Skeleton className=\"h-5 w-full max-w-2xl\" />\n            </div>\n            <Skeleton className=\"h-12 w-48 mt-6 md:mt-0\" />\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"bg-gray-900 rounded-xl overflow-hidden shadow-md\">\n                <Skeleton className=\"h-48 w-full\" />\n                <div className=\"p-5\">\n                  <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                  <Skeleton className=\"h-4 w-full mb-4\" />\n                  <Skeleton className=\"h-4 w-full mb-4\" />\n                  <div className=\"flex justify-between items-center\">\n                    <div className=\"flex items-center\">\n                      <Skeleton className=\"w-8 h-8 rounded-full\" />\n                      <Skeleton className=\"h-4 w-20 ml-2\" />\n                    </div>\n                    <Skeleton className=\"h-4 w-24\" />\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (error) {\n    return (\n      <section className=\"py-16 bg-black\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center\">\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3 text-white\">{t('blog.title')}</h2>\n            <p className=\"text-red-500\">{t('blog.errorLoading')}</p>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  const freePosts = blogPosts?.filter(post => !post.isPremium) || [];\n  const premiumPosts = blogPosts?.filter(post => post.isPremium) || [];\n\n  return (\n    <section className=\"py-16 bg-black\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"flex flex-col md:flex-row justify-between items-center mb-12\">\n          <div>\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3 text-white\">{t('blog.title')}</h2>\n            <p className=\"text-gray-300 max-w-2xl\">{subtitle}</p>\n          </div>\n          <div className=\"mt-6 md:mt-0\">\n            {!isPremium && (\n              <Link href=\"#premium-features\">\n                <Button className=\"bg-gradient-to-r from-red-600 to-red-700 text-white font-bold py-3 px-6 rounded-lg transition hover:opacity-90\">\n                  {t('blog.unlockPremium')}\n                </Button>\n              </Link>\n            )}\n          </div>\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10\">\n          {/* Free Blog Posts */}\n          {freePosts.slice(0, 2).map((post) => (\n            <div key={post.id} className=\"bg-gray-900 rounded-xl overflow-hidden shadow-md group hover:shadow-lg transition duration-300\">\n              <div className=\"relative\">\n                <img src={post.image} alt={post.title} className=\"w-full h-48 object-cover\" />\n                <div className=\"absolute top-3 left-3\">\n                  <span className=\"bg-green-500 text-white text-xs px-2 py-1 rounded-full font-medium\">{t('common.free')}</span>\n                </div>\n              </div>\n              <div className=\"p-5\">\n                <h3 className=\"text-xl font-bold mb-2 font-poppins text-white\">{post.title}</h3>\n                <p className=\"text-gray-300 text-sm mb-4 line-clamp-3\">{post.content}</p>\n                <div className=\"flex justify-between items-center\">\n                  <div className=\"flex items-center\">\n                    <div className=\"w-8 h-8 bg-black border border-gray-700 rounded-full flex items-center justify-center\">\n                      <i className=\"fas fa-user text-gray-400\"></i>\n                    </div>\n                    <span className=\"text-gray-300 ml-2 text-sm\">{t('common.anonymous')}</span>\n                  </div>\n                  <Link href={`/secret-blog/${post.id}`} className=\"text-red-600 hover:text-red-700 font-medium\">\n                    {t('common.readMore')}\n                  </Link>\n                </div>\n              </div>\n            </div>\n          ))}\n          \n          {/* Premium Blog Post (Locked for non-premium users) */}\n          {premiumPosts.slice(0, 1).map((post) => (\n            <div key={post.id} className=\"bg-gray-900 rounded-xl overflow-hidden shadow-md group hover:shadow-lg transition duration-300 relative\">\n              {!isPremium && (\n                <div className=\"absolute inset-0 bg-black/80 z-10 flex flex-col items-center justify-center\">\n                  <Lock className=\"text-red-600 text-3xl mb-3\" />\n                  <span className=\"text-white font-bold\">{t('blog.premiumContent')}</span>\n                  <Link href=\"#premium-features\">\n                    <Button className=\"mt-4 bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition\">\n                      {t('blog.upgradeToAccess')}\n                    </Button>\n                  </Link>\n                </div>\n              )}\n              <div className=\"relative\">\n                <img src={post.image} alt={post.title} className=\"w-full h-48 object-cover\" />\n                <div className=\"absolute top-3 left-3\">\n                  <span className=\"bg-red-600 text-white text-xs px-2 py-1 rounded-full font-medium\">{t('common.premium')}</span>\n                </div>\n              </div>\n              <div className=\"p-5\">\n                <h3 className=\"text-xl font-bold mb-2 font-poppins text-white\">{post.title}</h3>\n                <p className=\"text-gray-300 text-sm mb-4 line-clamp-3\">{post.content}</p>\n                <div className=\"flex justify-between items-center\">\n                  <div className=\"flex items-center\">\n                    <div className=\"w-8 h-8 bg-black border border-gray-700 rounded-full flex items-center justify-center\">\n                      <i className=\"fas fa-user text-gray-400\"></i>\n                    </div>\n                    <span className=\"text-gray-300 ml-2 text-sm\">{t('common.anonymous')}</span>\n                  </div>\n                  <Link href={`/secret-blog/${post.id}`} className=\"text-red-600 hover:text-red-700 font-medium\">\n                    {t('common.readMore')}\n                  </Link>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n        \n        <div className=\"text-center\">\n          <Link href=\"/secret-blog\">\n            <Button variant=\"outline\" className=\"border border-red-600 text-red-600 hover:bg-red-600 hover:text-white font-bold py-2 px-6 rounded-lg transition duration-300\">\n              {t('blog.viewAllStories')}\n            </Button>\n          </Link>\n        </div>\n      </div>\n    </section>\n  );\n}","path":null,"size_bytes":7856,"size_tokens":null},"server/zapier-integration.ts":{"content":"import axios from 'axios';\nimport { Request, Response } from 'express';\nimport type { Express } from 'express';\n\ninterface ZapierWebhook {\n  id: string;\n  url: string;\n  event: string;\n  active: boolean;\n  created: Date;\n}\n\n// Archivio in memoria dei webhook attivi\nconst activeWebhooks: ZapierWebhook[] = [];\n\n// Funzione per registrare i webhook Zapier nel nostro sistema\nexport const registerZapierWebhook = async (req: Request, res: Response) => {\n  try {\n    const { url, event } = req.body;\n    \n    if (!url || !event) {\n      return res.status(400).json({ \n        success: false, \n        message: 'Webhook URL and event type are required' \n      });\n    }\n\n    // Genera un ID unico per il webhook\n    const id = `webhook_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    \n    // Memorizza il webhook\n    const newWebhook: ZapierWebhook = {\n      id,\n      url,\n      event,\n      active: true,\n      created: new Date()\n    };\n    \n    activeWebhooks.push(newWebhook);\n    \n    // Verifica il webhook inviando un ping\n    try {\n      await axios.post(url, {\n        event: 'ping',\n        message: 'ByeBro webhook successfully registered',\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Failed to verify webhook URL:', error);\n      // Continuiamo comunque la registrazione anche se la verifica fallisce\n    }\n    \n    return res.status(200).json({\n      success: true,\n      webhook: newWebhook,\n      message: 'Webhook registered successfully'\n    });\n  } catch (error) {\n    console.error('Error registering webhook:', error);\n    return res.status(500).json({ \n      success: false, \n      message: 'Failed to register webhook' \n    });\n  }\n};\n\n// Funzione per eliminare un webhook\nexport const deleteZapierWebhook = (req: Request, res: Response) => {\n  const { id } = req.params;\n  \n  const index = activeWebhooks.findIndex(webhook => webhook.id === id);\n  \n  if (index === -1) {\n    return res.status(404).json({ \n      success: false, \n      message: 'Webhook not found' \n    });\n  }\n  \n  activeWebhooks.splice(index, 1);\n  \n  return res.status(200).json({\n    success: true,\n    message: 'Webhook deleted successfully'\n  });\n};\n\n// Funzione per ottenere i webhook attivi\nexport const getZapierWebhooks = (req: Request, res: Response) => {\n  return res.status(200).json({\n    success: true,\n    webhooks: activeWebhooks\n  });\n};\n\n// Trigger per inviare dati a Zapier quando viene creato un nuovo pacchetto\nexport const triggerPackageCreated = async (packageData: any) => {\n  const relevantWebhooks = activeWebhooks.filter(\n    webhook => webhook.active && webhook.event === 'package_created'\n  );\n  \n  const triggerPromises = relevantWebhooks.map(webhook => {\n    return axios.post(webhook.url, {\n      event: 'package_created',\n      data: packageData,\n      timestamp: new Date().toISOString()\n    }).catch(error => {\n      console.error(`Failed to trigger webhook ${webhook.id}:`, error);\n      // Se il webhook fallisce troppe volte, potremmo disattivarlo\n      // webhook.active = false;\n    });\n  });\n  \n  await Promise.allSettled(triggerPromises);\n};\n\n// Trigger per inviare dati a Zapier quando viene completato un acquisto\nexport const triggerPurchaseCompleted = async (purchaseData: any) => {\n  const relevantWebhooks = activeWebhooks.filter(\n    webhook => webhook.active && webhook.event === 'purchase_completed'\n  );\n  \n  const triggerPromises = relevantWebhooks.map(webhook => {\n    return axios.post(webhook.url, {\n      event: 'purchase_completed',\n      data: purchaseData,\n      timestamp: new Date().toISOString()\n    }).catch(error => {\n      console.error(`Failed to trigger webhook ${webhook.id}:`, error);\n    });\n  });\n  \n  await Promise.allSettled(triggerPromises);\n};\n\n// Funzione da chiamare quando un utente richiede un preventivo personalizzato\nexport const triggerCustomQuoteRequest = async (quoteData: any) => {\n  const relevantWebhooks = activeWebhooks.filter(\n    webhook => webhook.active && webhook.event === 'quote_requested'\n  );\n  \n  const triggerPromises = relevantWebhooks.map(webhook => {\n    return axios.post(webhook.url, {\n      event: 'quote_requested',\n      data: quoteData,\n      timestamp: new Date().toISOString()\n    }).catch(error => {\n      console.error(`Failed to trigger webhook ${webhook.id}:`, error);\n    });\n  });\n  \n  await Promise.allSettled(triggerPromises);\n};\n\n// Integrazione con le API di Zapier\nexport function registerZapierRoutes(app: Express) {\n  // Registrazione di un nuovo webhook Zapier\n  app.post('/api/zapier/webhooks', registerZapierWebhook);\n  \n  // Eliminazione di un webhook\n  app.delete('/api/zapier/webhooks/:id', deleteZapierWebhook);\n  \n  // Ottenere i webhook attivi\n  app.get('/api/zapier/webhooks', getZapierWebhooks);\n  \n  // Endpoint per ricevere dati da Zapier (per azioni da Zapier a ByeBro)\n  app.post('/api/zapier/receive', async (req: Request, res: Response) => {\n    try {\n      const { action, data } = req.body;\n      \n      if (!action || !data) {\n        return res.status(400).json({ \n          success: false, \n          message: 'Action and data are required' \n        });\n      }\n      \n      // Gestire diverse azioni da Zapier\n      switch (action) {\n        case 'create_package':\n          // Logica per creare un pacchetto da Zapier\n          console.log('Creating package from Zapier:', data);\n          // Qui implementeremmo la logica per creare un pacchetto nel nostro sistema\n          break;\n          \n        case 'update_pricing':\n          // Logica per aggiornare i prezzi\n          console.log('Updating pricing from Zapier:', data);\n          break;\n          \n        case 'send_notification':\n          // Logica per inviare notifiche\n          console.log('Sending notification from Zapier:', data);\n          break;\n          \n        default:\n          return res.status(400).json({ \n            success: false, \n            message: `Unknown action: ${action}` \n          });\n      }\n      \n      return res.status(200).json({\n        success: true,\n        message: `Action '${action}' processed successfully`\n      });\n    } catch (error) {\n      console.error('Error processing Zapier action:', error);\n      return res.status(500).json({ \n        success: false, \n        message: 'Failed to process Zapier action' \n      });\n    }\n  });\n}\n\n// Esempi di utilizzo per gli eventi Zapier nel nostro assistente\n/* \n  // Nel componente dell'assistente, quando viene creato un pacchetto:\n  import { triggerPackageCreated } from '@/server/zapier-integration';\n  \n  // Dopo che l'utente ha finalizzato un pacchetto\n  const packageData = {\n    id: '12345',\n    user: {\n      id: user.id,\n      email: user.email\n    },\n    destination: 'Amsterdam',\n    startDate: '2025-06-15',\n    endDate: '2025-06-18',\n    activities: selectedActivities,\n    transportation: selectedTransportation,\n    accommodation: selectedHotel,\n    totalPrice: totalPrice\n  };\n  \n  // Invia l'evento a Zapier\n  await triggerPackageCreated(packageData);\n  \n  // Dopo che è stato completato un acquisto\n  const purchaseData = {\n    packageId: '12345',\n    user: {\n      id: user.id, \n      email: user.email\n    },\n    paymentMethod: 'card',\n    amount: totalPrice,\n    purchaseDate: new Date().toISOString()\n  };\n  \n  // Invia l'evento a Zapier\n  await triggerPurchaseCompleted(purchaseData);\n*/","path":null,"size_bytes":7373,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport { AuthProvider } from \"./contexts/AuthContext\";\n\ncreateRoot(document.getElementById(\"root\")!).render(\n  <AuthProvider>\n    <App />\n  </AuthProvider>\n);\n","path":null,"size_bytes":253,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/lib/protected-route.tsx":{"content":"import { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\nexport function ProtectedRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: React.ComponentType;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-border\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  // Wrap the component in a function to avoid type errors\n  return (\n    <Route path={path}>\n      <Component />\n    </Route>\n  );\n}","path":null,"size_bytes":779,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"server/storage-new.ts":{"content":"// Updated storage with only the 10 specified destinations\nimport { \n  User, Trip, Itinerary, BlogPost, Merchandise, Destination, Experience, \n  InsertUser, InsertTrip, InsertItinerary, InsertBlogPost, InsertMerchandise, \n  InsertDestination, InsertExperience, ExpenseGroup, Expense, \n  InsertExpenseGroup, InsertExpense \n} from \"@shared/schema\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: number): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUserPremiumStatus(id: number, isPremium: boolean): Promise<User | undefined>;\n  \n  // Trip operations\n  getTrip(id: number): Promise<Trip | undefined>;\n  getTripsByUserId(userId: number): Promise<Trip[]>;\n  createTrip(trip: InsertTrip): Promise<Trip>;\n\n  // Itinerary operations\n  getItinerary(id: number): Promise<Itinerary | undefined>;\n  getItinerariesByTripId(tripId: number): Promise<Itinerary[]>;\n  createItinerary(itinerary: InsertItinerary): Promise<Itinerary>;\n\n  // Blog post operations\n  getBlogPost(id: number): Promise<BlogPost | undefined>;\n  getFreeBlogPosts(): Promise<BlogPost[]>;\n  getAllBlogPosts(): Promise<BlogPost[]>;\n  createBlogPost(blogPost: InsertBlogPost): Promise<BlogPost>;\n\n  // Merchandise operations\n  getMerchandise(id: number): Promise<Merchandise | undefined>;\n  getAllMerchandise(): Promise<Merchandise[]>;\n  getMerchandiseByType(type: string): Promise<Merchandise[]>;\n  createMerchandise(merchandise: InsertMerchandise): Promise<Merchandise>;\n\n  // Destination operations\n  getDestination(id: number): Promise<Destination | undefined>;\n  getAllDestinations(): Promise<Destination[]>;\n  createDestination(destination: InsertDestination): Promise<Destination>;\n\n  // Experience operations\n  getExperience(id: number): Promise<Experience | undefined>;\n  getAllExperiences(): Promise<Experience[]>;\n  createExperience(experience: InsertExperience): Promise<Experience>;\n  \n  // Expense group operations (SplittaBro feature)\n  getExpenseGroup(id: number): Promise<ExpenseGroup | undefined>;\n  getExpenseGroupsByTripId(tripId: number): Promise<ExpenseGroup[]>;\n  getAllExpenseGroups(): Promise<ExpenseGroup[]>;\n  createExpenseGroup(group: InsertExpenseGroup): Promise<ExpenseGroup>;\n  \n  // Expense operations (SplittaBro feature)\n  getExpense(id: number): Promise<Expense | undefined>;\n  getExpensesByGroupId(groupId: number): Promise<Expense[]>;\n  createExpense(expense: InsertExpense): Promise<Expense>;\n  updateExpense(id: number, expense: Partial<InsertExpense>): Promise<Expense | undefined>;\n  deleteExpense(id: number): Promise<boolean>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<number, User>;\n  private trips: Map<number, Trip>;\n  private itineraries: Map<number, Itinerary>;\n  private blogPosts: Map<number, BlogPost>;\n  private merchandiseItems: Map<number, Merchandise>;\n  private destinations: Map<number, Destination>;\n  private experiences: Map<number, Experience>;\n  private expenseGroups: Map<number, ExpenseGroup>;\n  private expenseItems: Map<number, Expense>;\n\n  private userId: number;\n  private tripId: number;\n  private itineraryId: number;\n  private blogPostId: number;\n  private merchandiseId: number;\n  private destinationId: number;\n  private experienceId: number;\n  private expenseGroupId: number;\n  private expenseId: number;\n\n  constructor() {\n    this.users = new Map();\n    this.trips = new Map();\n    this.itineraries = new Map();\n    this.blogPosts = new Map();\n    this.merchandiseItems = new Map();\n    this.destinations = new Map();\n    this.experiences = new Map();\n    this.expenseGroups = new Map();\n    this.expenseItems = new Map();\n\n    this.userId = 1;\n    this.tripId = 1;\n    this.itineraryId = 1;\n    this.blogPostId = 1;\n    this.merchandiseId = 1;\n    this.destinationId = 1;\n    this.experienceId = 1;\n    this.expenseGroupId = 1;\n    this.expenseId = 1;\n\n    // Initialize with sample data\n    this.initializeDestinations();\n    this.initializeExperiences();\n    this.initializeBlogPosts();\n    this.initializeMerchandise();\n  }\n\n  // User operations\n  async getUser(id: number): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.username === username);\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.email === email);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const user: User = { \n      id: this.userId++, \n      ...insertUser,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.users.set(user.id, user);\n    return user;\n  }\n\n  async updateUserPremiumStatus(id: number, isPremium: boolean): Promise<User | undefined> {\n    const user = this.users.get(id);\n    if (!user) return undefined;\n    \n    const updatedUser: User = {\n      ...user,\n      isPremium,\n      updatedAt: new Date()\n    };\n    this.users.set(id, updatedUser);\n    return updatedUser;\n  }\n\n  // Trip operations\n  async getTrip(id: number): Promise<Trip | undefined> {\n    return this.trips.get(id);\n  }\n\n  async getTripsByUserId(userId: number): Promise<Trip[]> {\n    return Array.from(this.trips.values()).filter(trip => trip.userId === userId);\n  }\n\n  async createTrip(insertTrip: InsertTrip): Promise<Trip> {\n    const trip: Trip = { \n      id: this.tripId++, \n      ...insertTrip,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.trips.set(trip.id, trip);\n    return trip;\n  }\n\n  // Itinerary operations\n  async getItinerary(id: number): Promise<Itinerary | undefined> {\n    return this.itineraries.get(id);\n  }\n\n  async getItinerariesByTripId(tripId: number): Promise<Itinerary[]> {\n    return Array.from(this.itineraries.values()).filter(itinerary => itinerary.tripId === tripId);\n  }\n\n  async createItinerary(insertItinerary: InsertItinerary): Promise<Itinerary> {\n    const itinerary: Itinerary = { \n      id: this.itineraryId++, \n      ...insertItinerary,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.itineraries.set(itinerary.id, itinerary);\n    return itinerary;\n  }\n\n  // Blog post operations\n  async getBlogPost(id: number): Promise<BlogPost | undefined> {\n    return this.blogPosts.get(id);\n  }\n\n  async getFreeBlogPosts(): Promise<BlogPost[]> {\n    return Array.from(this.blogPosts.values()).filter(post => !post.isPremium);\n  }\n\n  async getAllBlogPosts(): Promise<BlogPost[]> {\n    return Array.from(this.blogPosts.values());\n  }\n\n  async createBlogPost(insertBlogPost: InsertBlogPost): Promise<BlogPost> {\n    const blogPost: BlogPost = { \n      id: this.blogPostId++, \n      ...insertBlogPost,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.blogPosts.set(blogPost.id, blogPost);\n    return blogPost;\n  }\n\n  // Merchandise operations\n  async getMerchandise(id: number): Promise<Merchandise | undefined> {\n    return this.merchandiseItems.get(id);\n  }\n\n  async getAllMerchandise(): Promise<Merchandise[]> {\n    return Array.from(this.merchandiseItems.values());\n  }\n\n  async getMerchandiseByType(type: string): Promise<Merchandise[]> {\n    return Array.from(this.merchandiseItems.values()).filter(item => item.type === type);\n  }\n\n  async createMerchandise(insertMerchandise: InsertMerchandise): Promise<Merchandise> {\n    const merchandise: Merchandise = { \n      id: this.merchandiseId++, \n      ...insertMerchandise,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.merchandiseItems.set(merchandise.id, merchandise);\n    return merchandise;\n  }\n\n  // Destination operations\n  async getDestination(id: number): Promise<Destination | undefined> {\n    return this.destinations.get(id);\n  }\n\n  async getAllDestinations(): Promise<Destination[]> {\n    return Array.from(this.destinations.values());\n  }\n\n  async createDestination(insertDestination: InsertDestination): Promise<Destination> {\n    const destination: Destination = { \n      id: this.destinationId++, \n      ...insertDestination,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.destinations.set(destination.id, destination);\n    return destination;\n  }\n\n  // Experience operations\n  async getExperience(id: number): Promise<Experience | undefined> {\n    return this.experiences.get(id);\n  }\n\n  async getAllExperiences(): Promise<Experience[]> {\n    return Array.from(this.experiences.values());\n  }\n\n  async createExperience(insertExperience: InsertExperience): Promise<Experience> {\n    const experience: Experience = { \n      id: this.experienceId++, \n      ...insertExperience,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.experiences.set(experience.id, experience);\n    return experience;\n  }\n\n  // Expense group operations\n  async getExpenseGroup(id: number): Promise<ExpenseGroup | undefined> {\n    return this.expenseGroups.get(id);\n  }\n\n  async getExpenseGroupsByTripId(tripId: number): Promise<ExpenseGroup[]> {\n    return Array.from(this.expenseGroups.values()).filter(group => group.tripId === tripId);\n  }\n\n  async getAllExpenseGroups(): Promise<ExpenseGroup[]> {\n    return Array.from(this.expenseGroups.values());\n  }\n\n  async createExpenseGroup(insertGroup: InsertExpenseGroup): Promise<ExpenseGroup> {\n    const group: ExpenseGroup = { \n      id: this.expenseGroupId++, \n      ...insertGroup,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.expenseGroups.set(group.id, group);\n    return group;\n  }\n\n  // Expense operations\n  async getExpense(id: number): Promise<Expense | undefined> {\n    return this.expenseItems.get(id);\n  }\n\n  async getExpensesByGroupId(groupId: number): Promise<Expense[]> {\n    return Array.from(this.expenseItems.values()).filter(expense => expense.groupId === groupId);\n  }\n\n  async createExpense(insertExpense: InsertExpense): Promise<Expense> {\n    const expense: Expense = { \n      id: this.expenseId++, \n      ...insertExpense,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.expenseItems.set(expense.id, expense);\n    return expense;\n  }\n\n  async updateExpense(id: number, updateData: Partial<InsertExpense>): Promise<Expense | undefined> {\n    const expense = this.expenseItems.get(id);\n    if (!expense) return undefined;\n    \n    const updatedExpense: Expense = {\n      ...expense,\n      ...updateData,\n      updatedAt: new Date()\n    };\n    this.expenseItems.set(id, updatedExpense);\n    return updatedExpense;\n  }\n\n  async deleteExpense(id: number): Promise<boolean> {\n    return this.expenseItems.delete(id);\n  }\n\n  // Initialize with only the 10 specified destinations\n  private initializeDestinations() {\n    const destinations = [\n      {\n        name: \"Roma\",\n        country: \"Italy\",\n        image: \"https://images.unsplash.com/photo-1552832230-c0197dd311b5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        description: \"La Città Eterna - storia, cultura e vita notturna indimenticabile nella capitale italiana.\",\n        tags: [\"Storia\", \"Cultura\", \"Vita notturna\"],\n        rating: \"4.8\",\n        reviewCount: 512\n      },\n      {\n        name: \"Ibiza\",\n        country: \"Spain\", \n        image: \"https://images.pexels.com/photos/3580532/pexels-photo-3580532.jpeg?auto=compress&cs=tinysrgb&h=300&w=500\",\n        description: \"L'isola del divertimento - club leggendari, spiagge da sogno e feste senza fine.\",\n        tags: [\"Club\", \"Spiagge\", \"Festa\"],\n        rating: \"4.9\",\n        reviewCount: 678\n      },\n      {\n        name: \"Barcellona\", \n        country: \"Spain\",\n        image: \"https://images.unsplash.com/photo-1544738413-433b2b94e57e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        description: \"Sole, mare, sangria e vita notturna spettacolare - la destinazione mediterranea perfetta.\",\n        tags: [\"Spiagge\", \"Vita notturna\", \"Cultura\"],\n        rating: \"4.9\",\n        reviewCount: 445\n      },\n      {\n        name: \"Praga\",\n        country: \"Czech Republic\",\n        image: \"https://images.unsplash.com/photo-1541849546-216549ae216d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        description: \"Fascino medievale e vita notturna leggendaria - perfetta per gli amanti della birra.\",\n        tags: [\"Birra\", \"Vita notturna\", \"Cultura\"],\n        rating: \"4.8\",\n        reviewCount: 342\n      },\n      {\n        name: \"Budapest\",\n        country: \"Hungary\",\n        image: \"https://images.pexels.com/photos/764494/pexels-photo-764494.jpeg?auto=compress&cs=tinysrgb&h=300&w=500\",\n        description: \"Terme, ruin bar e vita notturna incredibile nella Perla del Danubio.\",\n        tags: [\"Terme\", \"Ruin Bars\", \"Vita notturna\"],\n        rating: \"4.6\",\n        reviewCount: 298\n      },\n      {\n        name: \"Cracovia\",\n        country: \"Poland\",\n        image: \"https://images.pexels.com/photos/32861252/pexels-photo-32861252.jpeg?auto=compress&cs=tinysrgb&h=300&w=500\",\n        description: \"Città storica con prezzi accessibili e vita notturna vivace nel cuore della Polonia.\",\n        tags: [\"Storia\", \"Prezzi bassi\", \"Vita notturna\"],\n        rating: \"4.5\",\n        reviewCount: 234\n      },\n      {\n        name: \"Amsterdam\",\n        country: \"Netherlands\",\n        image: \"https://images.pexels.com/photos/3884483/pexels-photo-3884483.jpeg?auto=compress&cs=tinysrgb&h=300&w=500\",\n        description: \"La Venezia del Nord - tour sui canali, vita notturna e addii al celibato indimenticabili.\",\n        tags: [\"Canali\", \"Vita notturna\", \"Cultura\"],\n        rating: \"4.7\",\n        reviewCount: 389\n      },\n      {\n        name: \"Berlino\",\n        country: \"Germany\",\n        image: \"https://images.unsplash.com/photo-1560969184-10fe8719e047?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        description: \"Club underground, street art e vita notturna senza fine nella capitale europea delle feste.\",\n        tags: [\"Underground\", \"Club\", \"Arte\"],\n        rating: \"4.5\",\n        reviewCount: 267\n      },\n      {\n        name: \"Lisbona\",\n        country: \"Portugal\",\n        image: \"https://images.unsplash.com/photo-1555881400-74d7acaacd8b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        description: \"Fascino costiero, vita notturna vivace e pesce fresco nella splendida capitale portoghese.\",\n        tags: [\"Costa\", \"Vita notturna\", \"Gastronomia\"],\n        rating: \"4.4\",\n        reviewCount: 189\n      },\n      {\n        name: \"Palma de Mallorca\",\n        country: \"Spain\",\n        image: \"https://images.pexels.com/photos/386158/pexels-photo-386158.jpeg?auto=compress&cs=tinysrgb&h=300&w=500\",\n        description: \"Isola balearica con spiagge cristalline, beach club e vita notturna mediterranea.\",\n        tags: [\"Spiagge\", \"Beach club\", \"Isola\"],\n        rating: \"4.6\",\n        reviewCount: 156\n      }\n    ];\n    \n    destinations.forEach(destination => {\n      this.createDestination(destination);\n    });\n  }\n\n  private initializeExperiences() {\n    const experiences = [\n      {\n        name: \"The Ultimate BroNight\",\n        description: \"Epic club-hopping, exclusive nightclubs, casinos, and unforgettable alcohol-fueled adventures.\",\n        image: \"https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      },\n      {\n        name: \"My Olympic Bro\",\n        description: \"Exciting sports activities, live sporting events, competitive challenges, and vibrant bars.\",\n        image: \"https://images.unsplash.com/photo-1518063319789-7217e6706b04?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      },\n      {\n        name: \"Chill and Feel the Bro\",\n        description: \"Relaxed upscale experiences, chic restaurants, refined bars, and elegant city tours.\",\n        image: \"https://images.unsplash.com/photo-1534766555764-ce878a5e3a2b?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      },\n      {\n        name: \"The Wild Broventure\",\n        description: \"One last wild adventure with your bros - outdoor activities, hiking, camping, and beers by the fire.\",\n        image: \"https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\"\n      }\n    ];\n    \n    experiences.forEach(experience => {\n      this.createExperience(experience);\n    });\n  }\n\n  private initializeBlogPosts() {\n    const blogPosts = [\n      {\n        title: \"Roma: The Night We Can't Remember\",\n        excerpt: \"Epic Roman nights that blend history with modern party culture...\",\n        content: \"From Trastevere's wine bars to Testaccio's underground clubs, Rome offers an incredible nightlife scene...\",\n        image: \"https://images.unsplash.com/photo-1552832230-c0197dd311b5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        tags: [\"nightlife\", \"rome\", \"history\"],\n        isPremium: false\n      },\n      {\n        title: \"Ibiza Uncovered: The Ultimate Party Guide\",\n        excerpt: \"Everything you need to know about Ibiza's legendary club scene...\",\n        content: \"From Amnesia to Pacha, we break down the best clubs, when to go, and how to do it right...\",\n        image: \"https://images.unsplash.com/photo-1544552866-d3ed42536cfd?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        tags: [\"ibiza\", \"clubs\", \"nightlife\"],\n        isPremium: true\n      },\n      {\n        title: \"Cracovia: Eastern Europe's Hidden Gem\",\n        excerpt: \"Discover why Poland's ancient capital is becoming the go-to destination...\",\n        content: \"Affordable prices, incredible architecture, and a nightlife scene that rivals any major European city...\",\n        image: \"https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        tags: [\"krakow\", \"budget\", \"culture\"],\n        isPremium: false\n      }\n    ];\n    \n    blogPosts.forEach(post => {\n      this.createBlogPost(post);\n    });\n  }\n\n  private initializeMerchandise() {\n    const merchandise = [\n      {\n        name: \"Custom T-Shirts\",\n        description: \"Personalized bachelor party t-shirts with your group's name and destination\",\n        price: 25.99,\n        image: \"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        type: \"apparel\"\n      },\n      {\n        name: \"ByeBro Flask Set\",\n        description: \"Premium stainless steel flasks engraved with your bachelor party details\",\n        price: 45.99,\n        image: \"https://images.unsplash.com/photo-1544966503-7cc5ac882d5d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        type: \"accessories\"\n      },\n      {\n        name: \"Memory Book\",\n        description: \"Custom photo album to capture all your unforgettable moments\",\n        price: 35.99,\n        image: \"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&h=300&q=80\",\n        type: \"keepsakes\"\n      }\n    ];\n    \n    merchandise.forEach(item => {\n      this.createMerchandise(item);\n    });\n  }\n}\n\nexport const storage = new MemStorage();","path":null,"size_bytes":19189,"size_tokens":null},"client/src/lib/performance-optimizer.tsx":{"content":"import React, { useEffect, useRef } from 'react';\n\n/**\n * Componente che applica ottimizzazioni di performance a livello globale\n * Migliora reattività di scroll, animazioni e interazioni utente\n */\nexport function PerformanceOptimizer(): JSX.Element {\n  const isOptimized = useRef(false);\n\n  useEffect(() => {\n    if (isOptimized.current) return;\n    \n    // 1. Event Delegation per ridurre il numero di event listeners\n    setupEventDelegation();\n    \n    // 2. Imposta passive: true per gli eventi di scroll per rendere lo scroll più fluido\n    setupPassiveEvents();\n    \n    // 3. Imposta le proprietà CSS will-change solo durante lo scroll per risparmiare memoria\n    setupWillChangeOptimization();\n    \n    // 4. Ottimizzazione delle animazioni CSS\n    setupAnimationOptimizations();\n    \n    // 5. Ritarda i carichi non critici\n    setupDeferredLoading();\n    \n    isOptimized.current = true;\n    \n    return () => {\n      // Pulizia se necessario\n    };\n  }, []);\n\n  // Renderizza un componente vuoto\n  return <></>;\n}\n\n/**\n * Configura event delegation per minimizzare il numero di listeners\n */\nfunction setupEventDelegation() {\n  // Implementa event delegation per click comuni\n  document.addEventListener('click', (e) => {\n    const target = e.target as HTMLElement;\n    \n    // Delegazione per i button che hanno data-action\n    if (target.closest('[data-action]')) {\n      const button = target.closest('[data-action]') as HTMLElement;\n      const action = button.getAttribute('data-action');\n      \n      if (action === 'scroll-to-top') {\n        window.scrollTo({ top: 0, behavior: 'smooth' });\n      }\n    }\n  }, { passive: true });\n}\n\n/**\n * Configura gli eventi come passive per migliorare lo scroll\n */\nfunction setupPassiveEvents() {\n  // Test se passive è supportato\n  let supportsPassive = false;\n  try {\n    const opts = Object.defineProperty({}, 'passive', {\n      get: function() {\n        supportsPassive = true;\n        return true;\n      }\n    });\n    window.addEventListener('testPassive', null as any, opts);\n    window.removeEventListener('testPassive', null as any, opts);\n  } catch (e) {}\n  \n  // Configura gli eventi come passive\n  if (supportsPassive) {\n    const wheelOpt = supportsPassive ? { passive: true } : false;\n    const wheelEvent = 'onwheel' in document.createElement('div') ? 'wheel' : 'mousewheel';\n    \n    window.addEventListener('touchstart', preventDefaultForScrolling, wheelOpt);\n    window.addEventListener('touchmove', preventDefaultForScrolling, wheelOpt);\n    window.addEventListener(wheelEvent, preventDefaultForScrolling, wheelOpt);\n  }\n}\n\n/**\n * Previene i comportamenti di default che causano jank durante lo scroll\n */\nfunction preventDefaultForScrolling(e: Event) {\n  // Previene i comportamenti di default che causano jank solo in casi specifici\n  const target = e.target as HTMLElement;\n  \n  // Controlla se l'elemento è scrollabile e non ha raggiunto i limiti\n  if (target && target.scrollHeight > target.clientHeight) {\n    const scrollTop = target.scrollTop;\n    const scrollHeight = target.scrollHeight;\n    const clientHeight = target.clientHeight;\n    \n    // Se stiamo scrollando normalmente in un elemento scrollabile, non preveniamo il default\n    if (scrollTop > 0 && scrollTop < scrollHeight - clientHeight) {\n      return;\n    }\n  }\n}\n\n/**\n * Ottimizza le proprietà CSS will-change per migliorare le performance\n */\nfunction setupWillChangeOptimization() {\n  let scrollTimeout: number;\n  \n  // Aggiungi will-change solo durante lo scroll\n  window.addEventListener('scroll', () => {\n    document.body.classList.add('is-scrolling');\n    \n    // Rimuovi will-change dopo che lo scroll si è fermato\n    clearTimeout(scrollTimeout);\n    scrollTimeout = window.setTimeout(() => {\n      document.body.classList.remove('is-scrolling');\n    }, 100);\n  }, { passive: true });\n  \n  // Aggiungi stile per applicare will-change\n  const style = document.createElement('style');\n  style.textContent = `\n    .is-scrolling .fixed,\n    .is-scrolling .sticky,\n    .is-scrolling header,\n    .is-scrolling [data-optimize-scroll] {\n      will-change: transform;\n    }\n  `;\n  document.head.appendChild(style);\n}\n\n/**\n * Ottimizza le animazioni CSS\n */\nfunction setupAnimationOptimizations() {\n  const style = document.createElement('style');\n  style.textContent = `\n    @media screen and (prefers-reduced-motion: reduce) {\n      * {\n        animation-duration: 0.001s !important;\n        transition-duration: 0.001s !important;\n      }\n    }\n    \n    /* Usa transform e opacity invece di altre proprietà animabili */\n    [data-optimize-animation] {\n      transition-property: transform, opacity !important;\n    }\n    \n    /* Forza accelerazione hardware su elementi animati */\n    [data-hardware-accelerate] {\n      transform: translateZ(0);\n    }\n  `;\n  document.head.appendChild(style);\n}\n\n/**\n * Ritarda i carichi non critici\n */\nfunction setupDeferredLoading() {\n  // Carica risorse non critiche solo dopo che la pagina è stata renderizzata\n  window.addEventListener('load', () => {\n    setTimeout(() => {\n      const deferredScripts = document.querySelectorAll('script[data-defer]');\n      deferredScripts.forEach(script => {\n        const newScript = document.createElement('script');\n        Array.from(script.attributes).forEach(attr => {\n          if (attr.name !== 'data-defer') {\n            newScript.setAttribute(attr.name, attr.value);\n          }\n        });\n        newScript.appendChild(document.createTextNode(script.innerHTML));\n        script.parentNode?.replaceChild(newScript, script);\n      });\n      \n      // Carica immagini non critiche\n      const lazyImages = document.querySelectorAll('img[data-src]');\n      lazyImages.forEach(img => {\n        if (img instanceof HTMLImageElement && img.dataset.src) {\n          img.src = img.dataset.src;\n        }\n      });\n    }, 100);\n  });\n}\n\nexport default PerformanceOptimizer;","path":null,"size_bytes":5911,"size_tokens":null},"client/src/pages/SplittaBroSimple.tsx":{"content":"export default function SplittaBroSimple() {\n  return (\n    <div className=\"min-h-screen bg-gray-50 py-8\">\n      <div className=\"container mx-auto px-4 max-w-6xl\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-2\">SplittaBro</h1>\n          <p className=\"text-xl text-gray-600\">Dividi le spese con i tuoi amici</p>\n        </div>\n        <div className=\"bg-white p-8 rounded-lg shadow\">\n          <p>SplittaBro funziona! Questa è una versione di test.</p>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":558,"size_tokens":null},"client/src/pages/ImageTestPageFixed.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\n\ninterface ImageResult {\n  id: string;\n  url: string;\n  thumbnail: string;\n  description: string;\n  tags: string[];\n}\n\ninterface ImageSearchResponse {\n  success: boolean;\n  images: ImageResult[];\n  message?: string;\n}\n\nexport default function ImageTestPageFixed() {\n  const [query, setQuery] = useState('Barcelona aerial view');\n  const [results, setResults] = useState<ImageSearchResponse | null>(null);\n  const [loading, setLoading] = useState(false);\n\n  const searchImages = async () => {\n    setLoading(true);\n    try {\n      const response = await fetch(`/api/images/search?query=${encodeURIComponent(query)}&limit=6`);\n      const data = await response.json();\n      setResults(data);\n    } catch (error) {\n      console.error('Error searching images:', error);\n      setResults({\n        success: false,\n        images: [],\n        message: 'Errore nella ricerca'\n      });\n    }\n    setLoading(false);\n  };\n\n  const testBarcelona = async () => {\n    setLoading(true);\n    try {\n      const response = await fetch('/api/images/test');\n      const data = await response.json();\n      setResults(data);\n    } catch (error) {\n      console.error('Error testing Barcelona images:', error);\n    }\n    setLoading(false);\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-6xl\">\n      <Card className=\"mb-6\">\n        <CardHeader>\n          <CardTitle>Test Image Search API</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex gap-4\">\n            <Input\n              value={query}\n              onChange={(e) => setQuery(e.target.value)}\n              placeholder=\"Cerca immagini...\"\n              className=\"flex-1\"\n            />\n            <Button onClick={searchImages} disabled={loading}>\n              {loading ? 'Cercando...' : 'Cerca'}\n            </Button>\n            <Button onClick={testBarcelona} variant=\"outline\" disabled={loading}>\n              Test Barcellona\n            </Button>\n          </div>\n\n          {results && (\n            <div className=\"mt-6\">\n              <div className=\"mb-4 p-4 bg-gray-100 rounded\">\n                <p><strong>Success:</strong> {results.success ? 'Sì' : 'No'}</p>\n                <p><strong>Message:</strong> {results.message}</p>\n                <p><strong>Images Found:</strong> {results.images.length}</p>\n              </div>\n\n              {results.images.length > 0 && (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {results.images.map((image) => (\n                    <Card key={image.id} className=\"overflow-hidden\">\n                      <div className=\"aspect-video overflow-hidden\">\n                        <img\n                          src={image.url}\n                          alt={image.description}\n                          className=\"w-full h-full object-cover hover:scale-105 transition-transform\"\n                          onError={(e) => {\n                            const target = e.target as HTMLImageElement;\n                            target.src = image.thumbnail;\n                          }}\n                        />\n                      </div>\n                      <CardContent className=\"p-4\">\n                        <p className=\"text-sm text-gray-600 mb-2\">{image.description}</p>\n                        <div className=\"flex flex-wrap gap-1\">\n                          {image.tags.map((tag, index) => (\n                            <span\n                              key={index}\n                              className=\"px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded\"\n                            >\n                              {tag}\n                            </span>\n                          ))}\n                        </div>\n                        <p className=\"text-xs text-gray-400 mt-2\">ID: {image.id}</p>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":4271,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/OneClickAssistant.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardFooter,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Loader2,\n  Send,\n  Calendar,\n  MapPin,\n  Utensils,\n  Music,\n  Plane,\n  Car,\n  Gift,\n  PlusCircle,\n  ShoppingCart,\n} from \"lucide-react\";\nimport { useAuth } from \"@/hooks/use-auth\";\n\n// Schema per il form di input\nconst messageSchema = z.object({\n  message: z.string().min(1, \"Il messaggio non può essere vuoto\"),\n});\n\ntype MessageFormValues = z.infer<typeof messageSchema>;\n\n// Tipo per i messaggi nella chat\ninterface ChatMessage {\n  id: string;\n  content: string;\n  sender: \"user\" | \"assistant\";\n  timestamp: Date;\n}\n\n// Tipo per gli elementi del pacchetto\ninterface PackageItem {\n  id: string;\n  type: \"flight\" | \"hotel\" | \"restaurant\" | \"activity\" | \"transport\" | \"event\";\n  title: string;\n  description: string;\n  price: number;\n  imageUrl: string;\n  date?: string;\n  location?: string;\n  duration?: string;\n  rating?: string;\n  selected: boolean;\n}\n\nexport default function OneClickAssistant() {\n  const [brand, setBrand] = useState<\"byebro\" | \"byebride\">(\"byebro\");\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isGeneratingPackage, setIsGeneratingPackage] = useState(false);\n  const [packageItems, setPackageItems] = useState<PackageItem[]>([]);\n  const [showPackageDialog, setShowPackageDialog] = useState(false);\n  const [totalPrice, setTotalPrice] = useState(0);\n  const [checkoutDialogOpen, setCheckoutDialogOpen] = useState(false);\n  const [selectedDestination, setSelectedDestination] = useState<string>(\"\");\n  const [showItineraryDialog, setShowItineraryDialog] = useState(false);\n  const [itineraryData, setItineraryData] = useState<any>(null);\n  const [tripDetails, setTripDetails] = useState({\n    people: 0,\n    days: 0,\n    startDate: \"\",\n    endDate: \"\",\n    adventureType: \"\",\n    interests: [] as string[],\n    budget: \"medio\" as string,\n  });\n  const [conversationState, setConversationState] = useState({\n    askedForPeople: false,\n    askedForDays: false,\n    askedForAdventure: false,\n    currentStep: \"initial\" as\n      | \"initial\"\n      | \"people\"\n      | \"days\"\n      | \"adventure\"\n      | \"complete\",\n  });\n\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  // Detect current brand from localStorage\n  useEffect(() => {\n    const savedBrand = localStorage.getItem(\"selectedBrand\") as\n      | \"byebro\"\n      | \"byebride\"\n      | null;\n    if (savedBrand) {\n      setBrand(savedBrand);\n    }\n  }, []);\n\n  const form = useForm<MessageFormValues>({\n    resolver: zodResolver(messageSchema),\n    defaultValues: {\n      message: \"\",\n    },\n  });\n\n  // Scroll automatico quando arrivano nuovi messaggi\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  // Calcolo del prezzo totale quando cambiano gli elementi selezionati\n  useEffect(() => {\n    const newTotal = packageItems\n      .filter((item) => item.selected)\n      .reduce((acc, item) => acc + item.price, 0);\n    setTotalPrice(newTotal);\n  }, [packageItems]);\n\n  // Check for initial message from hero section\n  useEffect(() => {\n    const initialMessage = localStorage.getItem(\"byebro-initial-message\");\n    if (initialMessage) {\n      localStorage.removeItem(\"byebro-initial-message\");\n      // Wait a bit for the component to mount\n      setTimeout(() => {\n        form.setValue(\"message\", initialMessage);\n        form.handleSubmit(onSubmit)();\n      }, 500);\n    }\n  }, []);\n\n  const onSubmit = async (data: MessageFormValues) => {\n    // Aggiungi il messaggio dell'utente alla chat\n    const userMessage: ChatMessage = {\n      id: Date.now().toString(),\n      content: data.message,\n      sender: \"user\",\n      timestamp: new Date(),\n    };\n\n    setMessages((prev) => [...prev, userMessage]);\n    form.reset();\n    setIsLoading(true);\n\n    // Create conversation history for GROQ (last 6 messages)\n    const conversationHistory = messages.slice(-6).map((msg) => ({\n      role: msg.sender === \"user\" ? \"user\" : \"assistant\",\n      content: msg.content,\n    }));\n\n    try {\n      // Try OPENAI streaming first (ultra-fast!)\n      const payload = {\n        message: data.message,\n        selectedDestination,\n        tripDetails,\n        conversationHistory,\n        partyType: brand === \"byebro\" ? \"bachelor\" : \"bachelorette\",\n      };\n      console.log(\"🔍 OPENAI STREAM PAYLOAD:\", payload);\n\n      const response = await fetch(\"/api/chat/openai-stream\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok || !response.body) {\n        throw new Error(\"OPENAI streaming not available\");\n      }\n\n      // Create a placeholder message for streaming\n      const assistantMessageId = (Date.now() + 1).toString();\n      const assistantMessage: ChatMessage = {\n        id: assistantMessageId,\n        content: \"\",\n        sender: \"assistant\",\n        timestamp: new Date(),\n      };\n\n      setMessages((prev) => [...prev, assistantMessage]);\n      setIsLoading(false);\n\n      // Read the stream\n      const reader = response.body.getReader();\n      const decoder = new TextDecoder();\n      let accumulatedContent = \"\";\n\n      while (true) {\n        const { done, value } = await reader.read();\n\n        if (done) break;\n\n        const chunk = decoder.decode(value);\n        const lines = chunk.split(\"\\n\");\n\n        for (const line of lines) {\n          if (line.startsWith(\"data: \")) {\n            try {\n              const jsonData = JSON.parse(line.slice(6));\n\n              if (jsonData.error) {\n                throw new Error(jsonData.error);\n              }\n\n              if (jsonData.tool_call) {\n                handleToolCall(jsonData.tool_call);\n              }\n\n              if (jsonData.done) {\n                // Streaming complete\n                break;\n              }\n\n              if (jsonData.content) {\n                accumulatedContent += jsonData.content;\n\n                // Update message in real-time\n                setMessages((prev) =>\n                  prev.map((msg) =>\n                    msg.id === assistantMessageId\n                      ? { ...msg, content: accumulatedContent }\n                      : msg,\n                  ),\n                );\n              }\n            } catch (parseError) {\n              console.error(\"Error parsing SSE data:\", parseError);\n            }\n          }\n        }\n      }\n\n      // Extract trip details from response if needed\n      extractTripDetails(data.message);\n    } catch (error) {\n      // Fallback to local response generation\n      console.log(\"GROQ not available, using fallback:\", error);\n      \n      const assistantResponse = generateResponse(data.message);\n\n      const assistantMessage: ChatMessage = {\n        id: (Date.now() + 1).toString(),\n        content: assistantResponse,\n        sender: \"assistant\",\n        timestamp: new Date(),\n      };\n\n      setMessages((prev) => {\n        // Remove any empty streaming message\n        const filtered = prev.filter((msg) => msg.content !== \"\");\n        return [...filtered, assistantMessage];\n      });\n      setIsLoading(false);\n    }\n  };\n\n  interface ToolCallData {\n    name: string;\n    arguments: Record<string, any>;\n  }\n\n  const handleToolCall = (toolCall: ToolCallData) => {\n    console.log(`🔧 Tool call received: ${toolCall.name}`, toolCall.arguments);\n\n    switch (toolCall.name) {\n      case \"set_destination\":\n        const destination = toolCall.arguments.city?.trim()?.toLowerCase();\n        if (destination) {\n          console.log(`📍 Setting destination: ${destination}`);\n          setSelectedDestination(destination);\n        }\n        break;\n\n      case \"set_origin\":\n        const origin = toolCall.arguments.city?.trim();\n        if (origin) {\n          console.log(`🛫 Setting origin city: ${origin}`);\n        }\n        break;\n\n      case \"set_dates\":\n        const startDate = toolCall.arguments.departure_date;\n        const endDate = toolCall.arguments.return_date;\n        if (startDate && endDate) {\n          console.log(`📅 Setting dates: ${startDate} to ${endDate}`);\n          setTripDetails((prev) => ({ ...prev, startDate, endDate }));\n          const start = new Date(startDate);\n          const end = new Date(endDate);\n          const days = Math.ceil(\n            (end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24),\n          );\n          setTripDetails((prev) => ({ ...prev, days }));\n        }\n        break;\n\n      case \"set_participants\":\n        const participants = toolCall.arguments.count;\n        if (typeof participants === \"number\" && participants > 0) {\n          console.log(`👥 Setting participants: ${participants}`);\n          setTripDetails((prev) => ({ ...prev, people: participants }));\n        }\n        break;\n\n      case \"select_flight\":\n        console.log(`✈️ Flight selected: ${toolCall.arguments.flight_number}`);\n        break;\n\n      case \"unlock_checkout\":\n        console.log(\"🔓 Checkout unlocked\");\n        setConversationState((prev) => ({\n          ...prev,\n          currentStep: \"complete\",\n        }));\n        break;\n    }\n  };\n\n  // Function to extract trip details from user messages (deprecated - now using AI directives)\n  const extractTripDetails = (message: string) => {\n    // This function is now mainly for fallback when GROQ is not available\n    const normalizedMessage = message.toLowerCase();\n    let detailsUpdated = false;\n\n    // Extract number of people\n    const peopleMatch = normalizedMessage.match(\n      /(\\d+)\\s*(person|amici|partecipanti|gente|ragazzi|siamo|persone)/i,\n    );\n    if (peopleMatch) {\n      const peopleCount = parseInt(peopleMatch[1]);\n      if (peopleCount > 0 && peopleCount <= 50) {\n        setTripDetails((prev) => ({ ...prev, people: peopleCount }));\n        detailsUpdated = true;\n      }\n    }\n\n    // Extract number of days\n    const daysMatch = normalizedMessage.match(/(\\d+)\\s*(giorni|day|giorno)/i);\n    if (daysMatch) {\n      const daysCount = parseInt(daysMatch[1]);\n      if (daysCount > 0 && daysCount <= 30) {\n        setTripDetails((prev) => ({ ...prev, days: daysCount }));\n        detailsUpdated = true;\n      }\n    }\n\n    return detailsUpdated;\n  };\n\n  // REMOVED: generateIbizaItinerary and checkAndGenerateItinerary\n  // Now using AI directives system - all logic handled by GROQ prompts\n\n  // Varie risposte per evitare ripetizioni\n  const getVariedResponses = (\n    destinationName: string,\n    destinationKey: string,\n  ) => {\n    const responses = {\n      amsterdam: [\n        \"Amsterdam! Fantastica scelta! 🍺 Canali romantici di giorno, follia totale di notte! Quanti siete? E per quanto tempo volete conquistare la città?\",\n        \"AMSTERDAM! Red Light District, coffee shops e vita notturna leggendaria! Dimmi: il gruppo è numeroso? Quando pensate di partire?\",\n        \"Amsterdam è PERFETTA per un addio al celibato! Birra a fiumi, club fantastici e un'atmosfera unica! Siete un gruppo grande? Che periodo avete in mente?\",\n      ],\n      praga: [\n        \"PRAGA! Birra buonissima e prezzi da sogno! 🍻 La combo perfetta per un addio al celibato! Quanti amici si uniscono? Quale weekend preferite?\",\n        \"Praga è una BOMBA per l'addio al celibato! Castelli da favola di giorno, locali pazzeschi di notte! Dimmi del gruppo: quanti partecipanti? Date in mente?\",\n        \"ECCELLENTE scelta Praga! Birra a 1€, club fantastici e tutto spettacolare! Il budget ringrazierà! Quante persone? Quando volete scatenarvi?\",\n      ],\n      budapest: [\n        \"BUDAPEST! Bagni termali per il relax, ruin bar per la follia! 🛁🍻 Perfetto mix! Quanti brave warriors? Quando conquistate la città?\",\n        \"Budapest è magica! Terme di giorno, locali underground di notte! Un addio al celibato leggendario! Gruppo numeroso? Che periodo?\",\n        \"FANTASTICO! Budapest = terme + ruin bar + prezzi ottimi! Addio al celibato da SOGNO! Dimmi: quanti partecipanti? Date preferite?\",\n      ],\n      barcellona: [\n        \"BARCELLONA! Spiagge, tapas e vita notturna pazzesca! 🏖️🌮 La combo vincente! Quanti amici? Quando pensate di conquistare la città catalana?\",\n        \"Barcellona è PERFETTA! Mare di giorno, locali di notte, cibo spettacolare sempre! Dimmi del gruppo: quanti siete? Periodo in mente?\",\n        \"ECCELLENTE! Barcellona = spiagge + festa + cultura! Un mix esplosivo per l'addio al celibato! Gruppo grande? Date favorite?\",\n      ],\n      berlino: [\n        \"BERLINO! Club underground fino all'alba! 🎵 La capitale europea della vita notturna! Quanti party animals? Quando invadete la città?\",\n        \"Berlino è LEGGENDARIA! Techno, club aperti 48h, esperienze uniche! Perfetto per un addio memorabile! Gruppo numeroso? Che weekend?\",\n        \"BOMBA! Berlino = club senza fine + cultura alternativa! Un addio al celibato da FILM! Dimmi: quanti partecipanti? Date in mente?\",\n      ],\n      roma: [\n        \"ROMA! La Città Eterna per un addio al celibato epico! 🏛️🍕 Storia, cibo e vita notturna! Quanti gladiatori moderni? Quando conquistate l'impero?\",\n        \"Roma è SPETTACOLARE! Colosseo di giorno, aperitivi a Trastevere di sera! Un mix perfetto! Gruppo grande? Periodo preferito?\",\n        \"FANTASTICO! Roma = storia + cibo incredibile + locali fantastici! Addio al celibato da imperatori! Quanti amici? Quale weekend?\",\n      ],\n      lisbona: [\n        \"LISBONA! Fascino costiero e vita notturna autentica! 🌊🍷 Una gemma nascosta! Quanti avventurieri? Quando esplorate il Portogallo?\",\n        \"Lisbona è una SCOPERTA! Fado, vino e locali caratteristici! Perfetta per un addio originale! Dimmi del gruppo: quanti siete?\",\n        \"ECCELLENTE! Lisbona = fascino + autenticità + prezzi ottimi! Un addio al celibato diverso dal solito! Gruppo numeroso? Date?\",\n      ],\n      \"palma de mallorca\": [\n        \"PALMA DE MALLORCA! Beach club paradisiaci e acque cristalline! 🏖️🍹 Il sogno mediterraneo! Quanti beach lovers? Quando in paradiso?\",\n        \"Palma è PERFETTA! Spiagge da sogno, yacht party e vita notturna con vista mare! Dimmi: quanti amici? Periodo ideale?\",\n        \"BOMBA! Palma = spiagge + beach club + atmosfera esclusiva! Un addio al celibato VIP! Gruppo grande? Quando partite?\",\n      ],\n      cracovia: [\n        \"CRACOVIA! Prezzi imbattibili e centro storico da favola! 💰🏰 Il massimo risparmio, il massimo divertimento! Quanti? Date?\",\n        \"Cracovia è GENIALE! Spendi poco, ti diverti tanto! Centro UNESCO e locali fantastici! Gruppo numeroso? Quando conquistate la Polonia?\",\n        \"ECCELLENTE! Cracovia = budget friendly + storia + vita notturna! L'addio al celibato intelligente! Quanti partecipanti! Periodo?\",\n      ],\n      ibiza: [\n        \"Ibiza! Dimmi la destinazione esatta che hai scelto e ti aiuterò a organizzare il tuo addio. Quante persone partecipano e quando partite?\",\n        \"Perfetto! Ibiza è una grande scelta. Fammi sapere: quanti siete e in quali date pensate di partire?\",\n        \"Ibiza interessante! Per aiutarti al meglio, dimmi: quante persone e quali sono le date del viaggio?\",\n      ],\n    };\n\n    const destinationResponses =\n      responses[destinationKey as keyof typeof responses] || responses.roma;\n    return destinationResponses[\n      Math.floor(Math.random() * destinationResponses.length)\n    ];\n  };\n\n  // Simulazione delle risposte dell'assistente (in un'implementazione reale utilizzerebbe OpenAI)\n  const generateResponse = (userMessage: string): string => {\n    const normalizedMessage = userMessage.toLowerCase();\n\n    // Extract trip details from user message\n    const detailsUpdated = extractTripDetails(userMessage);\n\n    if (\n      normalizedMessage.includes(\"amsterdam\") ||\n      normalizedMessage.includes(\"olanda\")\n    ) {\n      setSelectedDestination(\"amsterdam\");\n      return getVariedResponses(\"Amsterdam\", \"amsterdam\");\n    } else if (\n      normalizedMessage.includes(\"praga\") ||\n      normalizedMessage.includes(\"repubblica ceca\")\n    ) {\n      setSelectedDestination(\"praga\");\n      return getVariedResponses(\"Praga\", \"praga\");\n    } else if (\n      normalizedMessage.includes(\"budapest\") ||\n      normalizedMessage.includes(\"ungheria\")\n    ) {\n      setSelectedDestination(\"budapest\");\n      return getVariedResponses(\"Budapest\", \"budapest\");\n    } else if (\n      normalizedMessage.includes(\"barcellona\") ||\n      normalizedMessage.includes(\"spagna\")\n    ) {\n      setSelectedDestination(\"barcellona\");\n      return getVariedResponses(\"Barcellona\", \"barcellona\");\n    } else if (\n      normalizedMessage.includes(\"berlino\") ||\n      normalizedMessage.includes(\"germania\")\n    ) {\n      setSelectedDestination(\"berlino\");\n      return getVariedResponses(\"Berlino\", \"berlino\");\n    } else if (\n      normalizedMessage.includes(\"roma\") ||\n      normalizedMessage.includes(\"italia\")\n    ) {\n      setSelectedDestination(\"roma\");\n      return getVariedResponses(\"Roma\", \"roma\");\n    } else if (\n      normalizedMessage.includes(\"lisbona\") ||\n      normalizedMessage.includes(\"portogallo\")\n    ) {\n      setSelectedDestination(\"lisbona\");\n      return getVariedResponses(\"Lisbona\", \"lisbona\");\n    } else if (\n      normalizedMessage.includes(\"palma\") ||\n      normalizedMessage.includes(\"mallorca\")\n    ) {\n      setSelectedDestination(\"palma de mallorca\");\n      return getVariedResponses(\"Palma de Mallorca\", \"palma de mallorca\");\n    } else if (\n      normalizedMessage.includes(\"cracovia\") ||\n      normalizedMessage.includes(\"polonia\")\n    ) {\n      setSelectedDestination(\"cracovia\");\n      return getVariedResponses(\"Cracovia\", \"cracovia\");\n    } else if (normalizedMessage.includes(\"ibiza\")) {\n      setSelectedDestination(\"ibiza\");\n      return getVariedResponses(\"Ibiza\", \"ibiza\");\n    }\n\n    // Varied final responses\n    const finalResponses = [\n      \"Grazie per queste informazioni! Hai altre preferenze o richieste particolari per il tuo addio al celibato?\",\n      \"Perfetto! C'è qualcos'altro che vorresti aggiungere per rendere questo viaggio indimenticabile?\",\n      \"Fantastico! Dimmi se hai altri desideri speciali per questo addio al celibato epico!\",\n      \"Ottimo! Altre preferenze particolari che dovrei considerare per il vostro viaggio?\",\n      \"Grande! Hai richieste speciali o attività particolari in mente?\",\n    ];\n\n    return finalResponses[Math.floor(Math.random() * finalResponses.length)];\n  };\n\n  // Genera un pacchetto con opzioni per volo, hotel, ristoranti e attività\n  const generatePackage = async () => {\n    setIsGeneratingPackage(true);\n\n    try {\n      // Prepara i dati per la chiamata a Zapier\n      const zapierData = {\n        citta: selectedDestination || \"Roma\",\n        date: {\n          startDate:\n            tripDetails.startDate || new Date().toISOString().split(\"T\")[0],\n          endDate:\n            tripDetails.endDate ||\n            new Date(Date.now() + 3 * 24 * 60 * 60 * 1000)\n              .toISOString()\n              .split(\"T\")[0],\n        },\n        persone: tripDetails.people || 4,\n        interessi: tripDetails.interests || [],\n        budget: tripDetails.budget || \"medio\",\n        esperienze: tripDetails.adventureType\n          ? [tripDetails.adventureType]\n          : [],\n      };\n\n      // Chiama la route Zapier per generare l'itinerario AI\n      const response = await apiRequest(\n        \"POST\",\n        \"/api/generate-itinerary\",\n        zapierData,\n      );\n      const result = await response.json();\n\n      if (result.success) {\n        // Mostra messaggio di successo\n        const aiMessage: ChatMessage = {\n          id: (Date.now() + 4).toString(),\n          content: `🎉 ${result.message}\\n\\n${result.aiContent}`,\n          sender: \"assistant\",\n          timestamp: new Date(),\n        };\n\n        setMessages((prev) => [...prev, aiMessage]);\n\n        // Salva l'itinerario generato\n        setItineraryData({\n          title: result.itinerary.name,\n          subtitle: result.itinerary.description,\n          days: [],\n        });\n\n        toast({\n          title: \"Itinerario Generato\",\n          description: result.zapierProcessed\n            ? \"Itinerario creato con AI\"\n            : \"Itinerario in elaborazione\",\n        });\n      } else {\n        throw new Error(\"Errore nella generazione\");\n      }\n    } catch (error) {\n      // Fallback alla generazione locale\n      console.log(\"Fallback to local generation\");\n\n      toast({\n        title: \"Connessione Zapier\",\n        description: \"Utilizzo generazione locale come fallback\",\n        variant: \"default\",\n      });\n    }\n\n    // Simulazione locale di generazione pacchetto\n    setTimeout(() => {\n      let dummyPackage: PackageItem[] = [];\n\n      // Pacchetti specifici per destinazione\n      if (selectedDestination === \"ibiza\") {\n        dummyPackage = [\n          {\n            id: \"1\",\n            type: \"flight\",\n            title: \"Volo per Ibiza\",\n            description: \"Volo diretto da Milano a Ibiza, andata e ritorno\",\n            price: 299.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1074&q=80\",\n            date: \"15 Luglio 2025\",\n            duration: \"2h 15min\",\n            selected: true,\n          },\n          {\n            id: \"2\",\n            type: \"hotel\",\n            title: \"Hotel Pacha\",\n            description:\n              \"Hotel iconico nel cuore di Ibiza, perfetto per la vita notturna\",\n            price: 180.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1571896349842-33c89424de2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Ibiza Town\",\n            rating: \"4.6\",\n            selected: true,\n          },\n          {\n            id: \"3\",\n            type: \"hotel\",\n            title: \"Ushuaïa Ibiza Beach Hotel\",\n            description: \"Hotel luxury con pool party e eventi esclusivi\",\n            price: 350.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Platja d'en Bossa\",\n            rating: \"4.8\",\n            selected: false,\n          },\n          {\n            id: \"4\",\n            type: \"restaurant\",\n            title: \"Amante Beach Restaurant\",\n            description:\n              \"Ristorante con vista mozzafiato e cucina mediterranea (€50-80)\",\n            price: 65.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1559329007-40df8a9345d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1074&q=80\",\n            location: \"Sol d'en Serra\",\n            rating: \"4.7\",\n            selected: true,\n          },\n          {\n            id: \"5\",\n            type: \"restaurant\",\n            title: \"Es Tragón - Michelin Star\",\n            description:\n              \"Esperienza gastronomica stellata, il top di Ibiza (€200+)\",\n            price: 220.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1414235077428-338989a2e8c0?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Sant Llorenç de Balàfia\",\n            rating: \"4.9\",\n            selected: false,\n          },\n          {\n            id: \"6\",\n            type: \"event\",\n            title: \"Ingresso Pacha Club\",\n            description: \"Notte al club più famoso di Ibiza (include 1 drink)\",\n            price: 65.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Ibiza Town\",\n            duration: \"Tutta la notte\",\n            selected: true,\n          },\n          {\n            id: \"7\",\n            type: \"event\",\n            title: \"Hï Ibiza VIP Experience\",\n            description:\n              \"Tavolo VIP al club più tecnologico di Ibiza (€80-120 + consumazioni)\",\n            price: 450.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Platja d'en Bossa\",\n            duration: \"Esperienza VIP\",\n            selected: false,\n          },\n          {\n            id: \"8\",\n            type: \"activity\",\n            title: \"Boat Party Premium\",\n            description: \"Festa in barca con DJ, open bar e snorkeling\",\n            price: 89.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Marina di Ibiza\",\n            duration: \"6 ore\",\n            selected: true,\n          },\n          {\n            id: \"9\",\n            type: \"activity\",\n            title: \"Jet Ski Adventure\",\n            description: \"Tour in jet ski lungo la costa di Ibiza\",\n            price: 120.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1544966503-7cc5ac882d5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            location: \"San Antonio Bay\",\n            duration: \"2 ore\",\n            selected: false,\n          },\n          {\n            id: \"10\",\n            type: \"transport\",\n            title: \"Transfer + Taxi Pass\",\n            description: \"Transfer aeroporto + taxi illimitati per 3 giorni\",\n            price: 45.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80\",\n            duration: \"3 giorni\",\n            selected: true,\n          },\n        ];\n      } else if (!selectedDestination || selectedDestination === \"amsterdam\") {\n        dummyPackage = [\n          {\n            id: \"1\",\n            type: \"flight\",\n            title: \"Volo diretto per Roma\",\n            description:\n              \"Volo diretto da Milano a Roma Fiumicino, andata e ritorno\",\n            price: 129.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1507812984078-917a274065be?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1074&q=80\",\n            date: \"15 Giugno 2025\",\n            duration: \"1h 20min\",\n            selected: true,\n          },\n          {\n            id: \"2\",\n            type: \"hotel\",\n            title: \"Hotel Artemide Roma\",\n            description:\n              \"Hotel 4 stelle nel centro di Roma, vicino alla Stazione Termini\",\n            price: 89.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1611892440504-42a792e24d32?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Centro di Roma\",\n            rating: \"4.5\",\n            selected: true,\n          },\n          {\n            id: \"3\",\n            type: \"hotel\",\n            title: \"Hotel Hassler Roma\",\n            description:\n              \"Hotel di lusso con vista sulla Scalinata di Trinità dei Monti\",\n            price: 249.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1551632436-cbf8dd35adfa?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1171&q=80\",\n            location: \"Piazza di Spagna\",\n            rating: \"4.9\",\n            selected: false,\n          },\n          {\n            id: \"4\",\n            type: \"restaurant\",\n            title: \"Da Enzo al 29\",\n            description: \"Autentica trattoria romana nel cuore di Trastevere\",\n            price: 35.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1559329007-40df8a9345d8?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1074&q=80\",\n            location: \"Trastevere\",\n            rating: \"4.7\",\n            selected: true,\n          },\n          {\n            id: \"5\",\n            type: \"activity\",\n            title: \"Tour del Colosseo e Fori Imperiali\",\n            description:\n              \"Visita guidata con accesso prioritario ai monumenti antichi\",\n            price: 45.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1571613316887-6f8d5cbf7ef7?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Centro Storico\",\n            duration: \"3 ore\",\n            selected: true,\n          },\n          {\n            id: \"6\",\n            type: \"activity\",\n            title: \"Aperitivo Tour a Trastevere\",\n            description:\n              \"Tour dei migliori bar per aperitivo nel quartiere più trendy\",\n            price: 29.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1512470876302-972faa2aa9a4?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80\",\n            location: \"Trastevere\",\n            duration: \"2.5 ore\",\n            selected: true,\n          },\n          {\n            id: \"7\",\n            type: \"activity\",\n            title: \"Musei Vaticani e Cappella Sistina\",\n            description: \"Visita esclusiva ai tesori del Vaticano\",\n            price: 55.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1529973625058-a665431328fb?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1887&q=80\",\n            location: \"Città del Vaticano\",\n            duration: \"4 ore\",\n            selected: false,\n          },\n          {\n            id: \"8\",\n            type: \"transport\",\n            title: \"Roma Pass 3 giorni\",\n            description: \"Trasporto pubblico illimitato + accesso ai musei\",\n            price: 38.99,\n            imageUrl:\n              \"https://images.unsplash.com/photo-1527150122257-eda8fb9c0999?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=387&q=80\",\n            duration: \"3 giorni\",\n            selected: true,\n          },\n        ];\n      }\n\n      setPackageItems(dummyPackage);\n      setShowPackageDialog(true);\n      setIsGeneratingPackage(false);\n\n      // Aggiungi messaggio di conferma\n      const confirmMessage: ChatMessage = {\n        id: (Date.now() + 3).toString(),\n        content:\n          \"Perfetto! Ho generato un pacchetto personalizzato per te. Puoi vedere tutti i dettagli e personalizzare le opzioni. Quando sei pronto, puoi procedere con il checkout.\",\n        sender: \"assistant\",\n        timestamp: new Date(),\n      };\n\n      setMessages((prev) => [...prev, confirmMessage]);\n    }, 2000);\n  };\n\n  const toggleItemSelection = (itemId: string) => {\n    setPackageItems((prev) =>\n      prev.map((item) =>\n        item.id === itemId ? { ...item, selected: !item.selected } : item,\n      ),\n    );\n  };\n\n  const handleCheckout = () => {\n    setShowPackageDialog(false);\n    setCheckoutDialogOpen(true);\n\n    const checkoutMessage: ChatMessage = {\n      id: (Date.now() + 4).toString(),\n      content: `Ottimo! Il tuo pacchetto costa in totale €${totalPrice.toFixed(2)}. Procediamo con il pagamento.`,\n      sender: \"assistant\",\n      timestamp: new Date(),\n    };\n\n    setMessages((prev) => [...prev, checkoutMessage]);\n  };\n\n  const handlePayment = () => {\n    // Simulazione pagamento\n    setCheckoutDialogOpen(false);\n\n    const paymentMessage: ChatMessage = {\n      id: (Date.now() + 5).toString(),\n      content:\n        \"Fantastico! Il pagamento è stato completato con successo. Riceverai tutte le conferme di prenotazione via email. Buon viaggio!\",\n      sender: \"assistant\",\n      timestamp: new Date(),\n    };\n\n    setMessages((prev) => [...prev, paymentMessage]);\n\n    toast({\n      title: \"Pagamento completato!\",\n      description: \"Il tuo pacchetto è stato prenotato con successo.\",\n    });\n  };\n\n  const handleGenerateItinerary = async () => {\n    if (\n      !selectedDestination ||\n      !tripDetails.startDate ||\n      !tripDetails.endDate ||\n      !tripDetails.people ||\n      !tripDetails.adventureType\n    ) {\n      toast({\n        title: \"Dati mancanti\",\n        description:\n          \"Completa tutte le informazioni richieste prima di generare l'itinerario.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGeneratingPackage(true);\n\n    try {\n      const response = await apiRequest(\"POST\", \"/api/generated-itineraries\", {\n        destination: selectedDestination,\n        startDate: tripDetails.startDate,\n        endDate: tripDetails.endDate,\n        participants: tripDetails.people,\n        eventType: tripDetails.adventureType,\n        selectedExperiences: tripDetails.interests,\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to generate itinerary\");\n      }\n\n      const itinerary = await response.json();\n\n      toast({\n        title: \"Itinerario generato!\",\n        description: \"Il tuo itinerario personalizzato è pronto.\",\n      });\n\n      // Navigate to itinerary page with the generated ID\n      window.location.href = `/itinerary/${itinerary.id}`;\n    } catch (error) {\n      console.error(\"Error generating itinerary:\", error);\n      toast({\n        title: \"Errore\",\n        description:\n          \"Si è verificato un errore durante la generazione dell'itinerario. Riprova.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGeneratingPackage(false);\n    }\n  };\n\n  const brandColors = {\n    primary: brand === \"byebro\" ? \"bg-red-600\" : \"bg-pink-600\",\n    primaryText: brand === \"byebro\" ? \"text-red-600\" : \"text-pink-600\",\n    primaryHover: brand === \"byebro\" ? \"hover:bg-red-700\" : \"hover:bg-pink-700\",\n  };\n\n  const brandName = brand === \"byebro\" ? \"ByeBro\" : \"ByeBride\";\n  const eventType =\n    brand === \"byebro\" ? \"addio al celibato\" : \"addio al nubilato\";\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 flex flex-col\">\n      {/* Header */}\n      <div className=\"bg-white border-b border-gray-200 p-4\">\n        <div className=\"container mx-auto max-w-4xl\">\n          <div className=\"flex items-center gap-3\">\n            <div\n              className={`w-10 h-10 ${brandColors.primary} rounded-full flex items-center justify-center`}\n            >\n              <Send className=\"w-6 h-6 text-white\" />\n            </div>\n            <div>\n              <h1 className=\"text-xl font-bold text-gray-900\">\n                One Click Assistant\n              </h1>\n              <p className=\"text-sm text-gray-500\">\n                Il tuo assistente personale per l'{eventType} perfetto\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Chat Container */}\n      <div className=\"flex-1 container mx-auto max-w-4xl p-4\">\n        <Card className=\"h-[600px] flex flex-col\">\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"flex items-center gap-2 text-lg\">\n              <div className=\"w-3 h-3 bg-green-500 rounded-full animate-pulse\"></div>\n              {brandName} Chat Assistant\n            </CardTitle>\n            <CardDescription className=\"text-sm\">\n              {selectedDestination === \"ibiza\"\n                ? `Ibiza - ${tripDetails.people > 0 ? `${tripDetails.people} persone` : \"Raccolta info\"} ${tripDetails.days > 0 ? `• ${tripDetails.days} giorni` : \"\"} ${tripDetails.adventureType ? `• ${tripDetails.adventureType}` : \"\"}`\n                : \"Dimmi dove vuoi andare per il tuo addio al celibato!\"}\n            </CardDescription>\n          </CardHeader>\n\n          <CardContent className=\"flex-1 flex flex-col overflow-hidden\">\n            {/* Messages Area */}\n            <ScrollArea className=\"flex-1 pr-2 mb-4\">\n              <div className=\"space-y-4 p-1\">\n                {messages.map((message) => (\n                  <div\n                    key={message.id}\n                    className={`flex ${message.sender === \"user\" ? \"justify-end\" : \"justify-start\"}`}\n                  >\n                    <div\n                      className={`flex items-start gap-2 max-w-[85%] ${message.sender === \"user\" ? \"flex-row-reverse\" : \"\"}`}\n                    >\n                      <Avatar className=\"w-8 h-8 flex-shrink-0\">\n                        <AvatarFallback\n                          className={`text-white text-xs ${\n                            message.sender === \"assistant\"\n                              ? brandColors.primary\n                              : \"bg-gray-600\"\n                          }`}\n                        >\n                          {message.sender === \"assistant\"\n                            ? brand === \"byebro\"\n                              ? \"BB\"\n                              : \"BD\"\n                            : user?.username?.[0]?.toUpperCase() || \"U\"}\n                        </AvatarFallback>\n                      </Avatar>\n\n                      <div\n                        className={`rounded-lg px-4 py-2 break-words ${\n                          message.sender === \"user\"\n                            ? `${brandColors.primary} text-white`\n                            : `bg-gradient-to-br ${brand === \"byebro\" ? \"from-red-50 to-red-100\" : \"from-pink-50 to-pink-100\"} text-gray-900 border ${brand === \"byebro\" ? \"border-red-200\" : \"border-pink-200\"}`\n                        }`}\n                      >\n                        <p className=\"text-sm whitespace-pre-wrap break-words\">\n                          {message.content}\n                        </p>\n                        <p className=\"text-xs mt-1 opacity-70\">\n                          {message.timestamp.toLocaleTimeString(\"it-IT\", {\n                            hour: \"2-digit\",\n                            minute: \"2-digit\",\n                          })}\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n\n                {isLoading && (\n                  <div className=\"flex justify-start\">\n                    <div className=\"flex items-start gap-2\">\n                      <Avatar className=\"w-8 h-8 flex-shrink-0\">\n                        <AvatarFallback\n                          className={`${brandColors.primary} text-white text-xs`}\n                        >\n                          {brand === \"byebro\" ? \"BB\" : \"BD\"}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div className=\"bg-gray-100 rounded-lg px-4 py-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                          <span className=\"text-sm text-gray-600\">\n                            Sto scrivendo...\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n              <div ref={messagesEndRef} />\n            </ScrollArea>\n\n            {/* Input Form */}\n            <div className=\"border-t pt-4 space-y-2\">\n              {/* Show \"Genera Itinerario\" button when conversation is complete */}\n              {conversationState.currentStep === \"complete\" &&\n                tripDetails.interests.length > 0 && (\n                  <Button\n                    onClick={handleGenerateItinerary}\n                    className={`w-full ${brandColors.primary} ${brandColors.primaryHover} text-white`}\n                    disabled={isGeneratingPackage}\n                    data-testid=\"button-generate-itinerary\"\n                  >\n                    {isGeneratingPackage ? (\n                      <>\n                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Generazione in corso...\n                      </>\n                    ) : (\n                      <>\n                        <Calendar className=\"w-4 h-4 mr-2\" />\n                        Genera Itinerario Completo\n                      </>\n                    )}\n                  </Button>\n                )}\n\n              <form\n                onSubmit={form.handleSubmit(onSubmit)}\n                className=\"flex gap-2\"\n              >\n                <Input\n                  {...form.register(\"message\")}\n                  placeholder=\"Scrivi qui il tuo messaggio...\"\n                  className=\"flex-1\"\n                  disabled={isLoading}\n                />\n                <Button\n                  type=\"submit\"\n                  disabled={isLoading}\n                  className=\"flex-shrink-0\"\n                >\n                  <Send className=\"w-4 h-4\" />\n                </Button>\n              </form>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Package Dialog */}\n      <Dialog open={showPackageDialog} onOpenChange={setShowPackageDialog}>\n        <DialogContent className=\"max-w-4xl h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle>Il tuo pacchetto personalizzato</DialogTitle>\n            <DialogDescription>\n              Seleziona i servizi che desideri includere nel tuo pacchetto\n            </DialogDescription>\n          </DialogHeader>\n\n          <ScrollArea className=\"flex-1\">\n            <div className=\"space-y-4\">\n              {packageItems.map((item) => (\n                <div key={item.id} className=\"border rounded-lg p-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <img\n                      src={item.imageUrl}\n                      alt={item.title}\n                      className=\"w-20 h-20 rounded-lg object-cover\"\n                    />\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-start justify-between\">\n                        <div>\n                          <h3 className=\"font-semibold\">{item.title}</h3>\n                          <p className=\"text-sm text-gray-600 mt-1\">\n                            {item.description}\n                          </p>\n                          {item.location && (\n                            <p className=\"text-xs text-gray-500 mt-1\">\n                              📍 {item.location}\n                            </p>\n                          )}\n                          {item.duration && (\n                            <p className=\"text-xs text-gray-500\">\n                              ⏱️ {item.duration}\n                            </p>\n                          )}\n                          {item.rating && (\n                            <p className=\"text-xs text-gray-500\">\n                              ⭐ {item.rating}\n                            </p>\n                          )}\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-bold text-lg\">€{item.price}</p>\n                          <Badge\n                            variant={item.selected ? \"default\" : \"outline\"}\n                          >\n                            {item.type}\n                          </Badge>\n                        </div>\n                      </div>\n                    </div>\n                    <input\n                      type=\"checkbox\"\n                      checked={item.selected}\n                      onChange={() => toggleItemSelection(item.id)}\n                      className=\"w-5 h-5\"\n                    />\n                  </div>\n                </div>\n              ))}\n            </div>\n          </ScrollArea>\n\n          <DialogFooter className=\"flex items-center justify-between\">\n            <div className=\"text-lg font-bold\">\n              Totale: €{totalPrice.toFixed(2)}\n            </div>\n            <Button onClick={handleCheckout} disabled={totalPrice === 0}>\n              <ShoppingCart className=\"w-4 h-4 mr-2\" />\n              Procedi al Checkout\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Checkout Dialog */}\n      <Dialog open={checkoutDialogOpen} onOpenChange={setCheckoutDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Checkout</DialogTitle>\n            <DialogDescription>\n              Conferma il tuo ordine e procedi al pagamento\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div className=\"border rounded-lg p-4\">\n              <h3 className=\"font-semibold mb-2\">Riepilogo ordine</h3>\n              {packageItems\n                .filter((item) => item.selected)\n                .map((item) => (\n                  <div\n                    key={item.id}\n                    className=\"flex justify-between text-sm py-1\"\n                  >\n                    <span>{item.title}</span>\n                    <span>€{item.price}</span>\n                  </div>\n                ))}\n              <Separator className=\"my-2\" />\n              <div className=\"flex justify-between font-bold\">\n                <span>Totale</span>\n                <span>€{totalPrice.toFixed(2)}</span>\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setCheckoutDialogOpen(false)}\n            >\n              Annulla\n            </Button>\n            <Button onClick={handlePayment}>\n              <Gift className=\"w-4 h-4 mr-2\" />\n              Paga Ora\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Itinerary Dialog */}\n      <Dialog open={showItineraryDialog} onOpenChange={setShowItineraryDialog}>\n        <DialogContent className=\"max-w-6xl h-[90vh]\">\n          <DialogHeader className=\"bg-gradient-to-r from-red-600 to-red-700 text-white p-6 rounded-t-lg -m-6 mb-4\">\n            <DialogTitle className=\"text-2xl font-bold\">\n              {itineraryData?.title || \"Il Vostro Itinerario\"}\n            </DialogTitle>\n            <DialogDescription className=\"text-red-100 text-lg\">\n              {itineraryData?.subtitle || \"Addio al celibato personalizzato\"}\n            </DialogDescription>\n          </DialogHeader>\n\n          <ScrollArea className=\"flex-1 pr-4\">\n            <div className=\"space-y-6\">\n              {itineraryData?.days?.map((day: any, index: number) => (\n                <div\n                  key={index}\n                  className=\"border border-red-200 rounded-xl overflow-hidden\"\n                >\n                  <div className=\"bg-red-50 px-6 py-4 border-b border-red-200\">\n                    <h3 className=\"text-xl font-bold text-red-800\">\n                      {day.title}\n                    </h3>\n                  </div>\n\n                  <div className=\"p-6 space-y-4\">\n                    {day.activities?.map((activity: any, actIndex: number) => (\n                      <div\n                        key={actIndex}\n                        className=\"flex gap-4 p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors\"\n                      >\n                        <div className=\"flex-shrink-0\">\n                          <div className=\"w-16 h-16 bg-red-600 rounded-full flex items-center justify-center text-white font-bold\">\n                            {activity.time}\n                          </div>\n                        </div>\n\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            {activity.type === \"restaurant\" && (\n                              <Utensils className=\"w-5 h-5 text-red-600\" />\n                            )}\n                            {activity.type === \"nightlife\" && (\n                              <Music className=\"w-5 h-5 text-red-600\" />\n                            )}\n                            {activity.type === \"activity\" && (\n                              <MapPin className=\"w-5 h-5 text-red-600\" />\n                            )}\n                            {activity.type === \"arrival\" && (\n                              <Plane className=\"w-5 h-5 text-red-600\" />\n                            )}\n\n                            <h4 className=\"font-bold text-lg text-gray-900\">\n                              {activity.title}\n                            </h4>\n\n                            <Badge\n                              variant={\n                                activity.type === \"restaurant\"\n                                  ? \"default\"\n                                  : activity.type === \"nightlife\"\n                                    ? \"destructive\"\n                                    : activity.type === \"activity\"\n                                      ? \"secondary\"\n                                      : \"outline\"\n                              }\n                              className=\"ml-auto\"\n                            >\n                              {activity.type === \"restaurant\"\n                                ? \"Ristorante\"\n                                : activity.type === \"nightlife\"\n                                  ? \"Vita Notturna\"\n                                  : activity.type === \"activity\"\n                                    ? \"Attività\"\n                                    : \"Arrivo\"}\n                            </Badge>\n                          </div>\n\n                          <p className=\"text-gray-700 leading-relaxed\">\n                            {activity.description}\n                          </p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              ))}\n\n              <div className=\"bg-gradient-to-r from-red-600 to-red-700 text-white p-6 rounded-xl\">\n                <h3 className=\"text-xl font-bold mb-3\">\n                  Consigli Extra per Ibiza\n                </h3>\n                <div className=\"grid md:grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <h4 className=\"font-semibold mb-2\">Prima di partire:</h4>\n                    <ul className=\"space-y-1 text-red-100\">\n                      <li>• Prenota ristoranti top in anticipo</li>\n                      <li>• Compra biglietti club online (-€10-20)</li>\n                      <li>• Scarica app taxi locali</li>\n                    </ul>\n                  </div>\n                  <div>\n                    <h4 className=\"font-semibold mb-2\">Durante il viaggio:</h4>\n                    <ul className=\"space-y-1 text-red-100\">\n                      <li>• Pre-drink prima dei club</li>\n                      <li>• Usa guest list quando disponibile</li>\n                      <li>• Goditi i tramonti di San Antonio</li>\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </ScrollArea>\n\n          <DialogFooter className=\"bg-gray-50 -m-6 mt-4 p-6\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowItineraryDialog(false)}\n            >\n              Chiudi\n            </Button>\n            <Button className=\"bg-red-600 hover:bg-red-700\">\n              <Calendar className=\"w-4 h-4 mr-2\" />\n              Scarica PDF\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":52061,"size_tokens":null},"server/services/groq.ts":{"content":"import Groq from \"groq-sdk\";\n\nconst groq = new Groq({\n  apiKey: process.env.GROQ_API_KEY,\n});\n\ninterface ChatMessage {\n  role: \"system\" | \"user\" | \"assistant\";\n  content: string;\n}\n\ninterface ChatContext {\n  selectedDestination?: string;\n  tripDetails?: {\n    people: number;\n    days: number;\n    adventureType: string;\n    startDate?: string;\n    endDate?: string;\n  };\n  conversationState?: {\n    currentStep: string;\n  };\n  partyType?: \"bachelor\" | \"bachelorette\";\n  origin?: string;\n  originCityName?: string;\n\n  flights?: {\n   .\n    airline: string;\n    departure_at: string;\n    return_at: string;\n    flight_number: number;\n    origin?: string;\n    destination?: string;\n  }[];\n\n  hotels?: {\n    hotelId: string;\n    name: string;\n    stars?: string;\n    priceTotal: number;\n    currency: string;\n    offerId: string;\n    bookingFlow: \"IN_APP\" | \"REDIRECT\";\n    paymentPolicy: string;\n    roomDescription?: string;\n  }[];\n}\n\nexport interface ToolCall {\n  name: string;\n  arguments: Record<string, any>;\n}\n\nexport type StreamChunk =\n  | { type: \"content\"; content: string }\n  | { type: \"tool_call\"; toolCall: ToolCall };\n\nconst TRIP_TOOLS: Groq.Chat.Completions.ChatCompletionTool[] = [\n  {\n    type: \"function\",\n    function: {\n      name: \"set_destination\",\n      description:\n        \"Set the travel destination when the user chooses where they want to go\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          city: { type: \"string\", description: \"The destination city name\" },\n        },\n        required: [\"city\"],\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"set_origin\",\n      description:\n        \"Set the departure city when the user specifies where they want to fly from\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          city: {\n            type: \"string\",\n            description: \"The origin/departure city name\",\n          },\n        },\n        required: [\"city\"],\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"set_dates\",\n      description:\n        \"Set the travel dates when the user provides departure and return dates\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          departure_date: {\n            type: \"string\",\n            description: \"Departure date in YYYY-MM-DD format\",\n          },\n          return_date: {\n            type: \"string\",\n            description: \"Return date in YYYY-MM-DD format\",\n          },\n        },\n        required: [\"departure_date\", \"return_date\"],\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"set_participants\",\n      description:\n        \"Set the number of participants when the user specifies how many people are traveling\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          count: {\n            type: \"integer\",\n            description: \"Number of participants/travelers\",\n          },\n        },\n        required: [\"count\"],\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"select_flight\",\n      description:\n        \"Select a specific flight when the user chooses from the available options\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          flight_number: {\n            type: \"integer\",\n            description: \"The flight option number (1, 2, or 3)\",\n          },\n        },\n        required: [\"flight_number\"],\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"unlock_checkout\",\n      description:\n        \"Unlock the checkout button when the user confirms they want to proceed with booking\",\n      parameters: {\n        type: \"object\",\n        properties: {},\n        required: [],\n      },\n    },\n  },\n];\n\nconst SHARED_SYSTEM_PROMPT = `CRITICAL RULE: You MUST ALWAYS provide a text response to the user, even when calling tools. Never respond with ONLY tool calls - always include a friendly message.\n\nREQUIRED DATA POINTS:\nBefore searching for flights, you MUST have ALL of the following:\n- destination (where they want to go)\n- origin (departure city/airport)\n- departure date\n- return date\n- number of participants\n\nIf the user provides multiple data points in one message, process ALL of them at once by calling the appropriate tools. You don't need to ask one question at a time. If some are still missing, ask for them naturally in your response. Once all information is collected, proceed to search and show flights immediately.\n\nAVAILABLE DESTINATIONS: Rome, Ibiza, Barcelona, Prague, Budapest, Krakow, Amsterdam, Berlin, Lisbon, Palma de Mallorca\n\nTOOL USAGE:\n- Call set_destination when you learn the destination\n- Call set_origin when you learn the departure city\n- Call set_dates when you learn travel dates (convert to YYYY-MM-DD format)\n- Call set_participants when you learn the group size\n- Call select_flight when the user chooses a flight option\n- Call unlock_checkout when the user confirms they want to book\n\nYou can call MULTIPLE tools in a single response if the user provides multiple pieces of information.\n\nPROACTIVE FOLLOW-UPS:\nAfter processing what the user provides, ALWAYS respond with text AND check which required data points are still missing. Ask about them naturally. Be conversational - don't just list what's missing. For example:\n- If you have destination and dates but no origin: \"Great choice! Where will you be flying from?\"\n- If you only have destination: \"Sounds exciting! When are you thinking of going, and how many people will be joining?\"\n- If everything is ready: Proceed to show flights immediately.\n\nBEHAVIOR:\n- ALWAYS include a text message in your response - never just tool calls alone\n- Keep responses concise (2-3 sentences max)\n- Professional and friendly tone\n- Focus ONLY on flights - do NOT suggest experiences, activities, or hotels\n- When the user mentions a new destination, start fresh\n\nCHECKOUT FLOW:\n- When flights are shown and the user confirms (yes, ok, sure, confirm, proceed, perfect, let's do it, etc.), ALWAYS call unlock_checkout immediately\n- NEVER confirm bookings as if they were completed - flights go through external checkout\n\nBOOKING INFO:\n- Flights use external affiliate checkout\n- Hotels will appear at checkout (don't mention them in chat)`;\n\nconst BYEBRO_SYSTEM_PROMPT = `You are the official assistant of ByeBro, part of the BYEBI app. Your task is to help plan bachelor party trips by finding REAL FLIGHTS. ALWAYS respond in the language the user writes in.\n\n${SHARED_SYSTEM_PROMPT}`;\n\nconst BYEBRIDE_SYSTEM_PROMPT = `You are the official assistant of ByeBride, part of the BYEBI app. Your task is to help plan bachelorette party trips by finding REAL FLIGHTS. ALWAYS respond in the language the user writes in.\n\n${SHARED_SYSTEM_PROMPT}`;\n\nfunction buildContextualPrompt(context: ChatContext): string {\n  const basePrompt =\n    context.partyType === \"bachelorette\"\n      ? BYEBRIDE_SYSTEM_PROMPT\n      : BYEBRO_SYSTEM_PROMPT;\n  let contextualPrompt = basePrompt;\n\n  if (context.origin && context.originCityName) {\n    contextualPrompt += `\\n\\nDEPARTURE CITY: ${context.originCityName} (airport code: ${context.origin})`;\n  }\n\n  if (context.selectedDestination) {\n    contextualPrompt += `\\n\\nSELECTED DESTINATION: ${context.selectedDestination.toUpperCase()}`;\n\n    if (context.tripDetails) {\n      contextualPrompt += `\\nTRIP DETAILS:`;\n      if (context.tripDetails.people > 0)\n        contextualPrompt += `\\n- People: ${context.tripDetails.people}`;\n      if (context.tripDetails.days > 0)\n        contextualPrompt += `\\n- Days: ${context.tripDetails.days}`;\n      if (context.tripDetails.adventureType)\n        contextualPrompt += `\\n- Type: ${context.tripDetails.adventureType}`;\n    }\n  }\n\n  if (context.flights && context.flights.length > 0) {\n    const originCity = context.originCityName || \"Rome\";\n    contextualPrompt += `\\n\\nAVAILABLE REAL FLIGHTS (from ${originCity} to ${context.selectedDestination}):`;\n    contextualPrompt += `\\nThese are REAL flights with updated prices. Present them to the user and ask which one they prefer.\\n`;\n    context.flights.forEach((f, idx) => {\n      const depDate = new Date(f.departure_at).toLocaleDateString(\"en-US\", {\n        day: \"numeric\",\n        month: \"long\",\n        year: \"numeric\",\n      });\n      const depTime = new Date(f.departure_at).toLocaleTimeString(\"en-US\", {\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n      const retDate = new Date(f.return_at).toLocaleDateString(\"en-US\", {\n        day: \"numeric\",\n        month: \"long\",\n        year: \"numeric\",\n      });\n      const retTime = new Date(f.return_at).toLocaleTimeString(\"en-US\", {\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n\n      contextualPrompt += `${idx + 1}. Departure: ${depDate} at ${depTime}\\n`;\n      contextualPrompt += `   Return: ${retDate} at ${retTime}\\n`;\n      contextualPrompt += `   Flight no. ${f.flight_number}\\n\\n`;\n    });\n    contextualPrompt += `\\nWhen the user chooses a flight (e.g., \"the 2nd one\", \"I'll take the first\", \"flight 3\"), call select_flight with the flight number.\\n`;\n  }\n\n  return contextualPrompt;\n}\n\nexport async function createGroqChatCompletion(\n  userMessage: string,\n  context: ChatContext,\n  conversationHistory: ChatMessage[] = [],\n): Promise<{ content: string; toolCalls: ToolCall[] }> {\n  try {\n    const contextualPrompt = buildContextualPrompt(context);\n\n    const messages: ChatMessage[] = [\n      { role: \"system\", content: contextualPrompt },\n      ...conversationHistory,\n      { role: \"user\", content: userMessage },\n    ];\n\n    const chatCompletion = await groq.chat.completions.create({\n      messages,\n      model: \"llama-3.3-70b-versatile\",\n      temperature: 0.5,\n      tools: TRIP_TOOLS,\n      tool_choice: \"auto\",\n    });\n\n    const message = chatCompletion.choices[0]?.message;\n    const content = message?.content || \"\";\n    const toolCalls: ToolCall[] = [];\n\n    if (message?.tool_calls) {\n      for (const tc of message.tool_calls) {\n        try {\n          toolCalls.push({\n            name: tc.function.name,\n            arguments: JSON.parse(tc.function.arguments || \"{}\"),\n          });\n        } catch (e) {\n          console.error(\"Error parsing tool call arguments:\", e);\n        }\n      }\n    }\n\n    return { content, toolCalls };\n  } catch (error) {\n    console.error(\"Groq API error:\", error);\n    throw new Error(\"Error communicating with GROQ\");\n  }\n}\n\nexport async function* streamGroqChatCompletion(\n  userMessage: string,\n  context: ChatContext,\n  conversationHistory: ChatMessage[] = [],\n): AsyncGenerator<StreamChunk, void, unknown> {\n  try {\n    const contextualPrompt = buildContextualPrompt(context);\n\n    const messages: ChatMessage[] = [\n      { role: \"system\", content: contextualPrompt },\n      ...conversationHistory,\n      { role: \"user\", content: userMessage },\n    ];\n\n    const stream = await groq.chat.completions.create({\n      messages,\n      model: \"llama-3.3-70b-versatile\",\n      temperature: 0.6,\n      stream: true,\n      tools: TRIP_TOOLS,\n      tool_choice: \"auto\",\n    });\n\n    const toolCallsBuffer: Map<number, { name: string; arguments: string }> =\n      new Map();\n    let hasContent = false;\n    const collectedToolCalls: ToolCall[] = [];\n\n    for await (const chunk of stream) {\n      const delta = chunk.choices[0]?.delta;\n\n      if (delta?.content) {\n        hasContent = true;\n        yield { type: \"content\", content: delta.content };\n      }\n\n      if (delta?.tool_calls) {\n        for (const tc of delta.tool_calls) {\n          const idx = tc.index;\n          if (!toolCallsBuffer.has(idx)) {\n            toolCallsBuffer.set(idx, { name: \"\", arguments: \"\" });\n          }\n          const buffer = toolCallsBuffer.get(idx)!;\n          if (tc.function?.name) {\n            buffer.name = tc.function.name;\n          }\n          if (tc.function?.arguments) {\n            buffer.arguments += tc.function.arguments;\n          }\n        }\n      }\n\n      if (\n        chunk.choices[0]?.finish_reason === \"tool_calls\" ||\n        chunk.choices[0]?.finish_reason === \"stop\"\n      ) {\n        const entries = Array.from(toolCallsBuffer.entries());\n        for (const [, buffer] of entries) {\n          if (buffer.name) {\n            try {\n              const args = buffer.arguments ? JSON.parse(buffer.arguments) : {};\n              const toolCall = { name: buffer.name, arguments: args };\n              collectedToolCalls.push(toolCall);\n              yield { type: \"tool_call\", toolCall };\n            } catch (e) {\n              console.error(\"Error parsing streamed tool call:\", e);\n            }\n          }\n        }\n        toolCallsBuffer.clear();\n      }\n    }\n\n    // If we got tool calls but no content, generate a helpful follow-up message\n    if (!hasContent && collectedToolCalls.length > 0) {\n      const followUpMessage = generateFollowUpMessage(\n        collectedToolCalls,\n        context,\n      );\n      yield { type: \"content\", content: followUpMessage };\n    }\n  } catch (error) {\n    console.error(\"Groq streaming error:\", error);\n    yield {\n      type: \"content\",\n      content:\n        \"Sorry, there was a problem with the streaming. Please try again!\",\n    };\n  }\n}\n\nfunction generateFollowUpMessage(\n  toolCalls: ToolCall[],\n  context: ChatContext,\n): string {\n  const toolNames = toolCalls.map((tc) => tc.name);\n\n  // Check what data we now have after tool calls\n  const hasDestination =\n    toolNames.includes(\"set_destination\") || context.selectedDestination;\n  const hasOrigin = toolNames.includes(\"set_origin\") || context.origin;\n  const hasDates =\n    toolNames.includes(\"set_dates\") ||\n    (context.tripDetails?.startDate && context.tripDetails?.endDate);\n  const hasParticipants =\n    toolNames.includes(\"set_participants\") ||\n    (context.tripDetails?.people && context.tripDetails.people > 0);\n\n  // Get destination from tool call if available\n  const destCall = toolCalls.find((tc) => tc.name === \"set_destination\");\n  const destination =\n    destCall?.arguments?.city || context.selectedDestination || \"\";\n\n  // Generate contextual follow-up\n  if (hasDestination && hasDates && hasOrigin && hasParticipants) {\n    return `Perfect! I've got all the details for your trip to ${destination}. Let me find the best flights for you!`;\n  }\n\n  if (hasDestination && hasDates && hasOrigin) {\n    return `Great choice! ${destination} is an amazing destination. How many people will be joining the trip?`;\n  }\n\n  if (hasDestination && hasDates) {\n    return `${destination} sounds perfect! Which city will you be flying from?`;\n  }\n\n  if (hasDestination && hasOrigin) {\n    return `Got it! When are you planning to travel to ${destination}? Let me know your departure and return dates.`;\n  }\n\n  if (hasDestination) {\n    return `${destination} is an excellent choice! When are you thinking of going, and where will you be flying from?`;\n  }\n\n  return \"Got it! What else can you tell me about your trip plans?\";\n}\n\n","path":null,"size_bytes":14942,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"hsl(var(--background))\",\n        foreground: \"hsl(var(--foreground))\",\n        card: {\n          DEFAULT: \"hsl(var(--card))\",\n          foreground: \"hsl(var(--card-foreground))\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover))\",\n          foreground: \"hsl(var(--popover-foreground))\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary))\",\n          foreground: \"hsl(var(--primary-foreground))\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary))\",\n          foreground: \"hsl(var(--secondary-foreground))\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted))\",\n          foreground: \"hsl(var(--muted-foreground))\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent))\",\n          foreground: \"hsl(var(--accent-foreground))\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive))\",\n          foreground: \"hsl(var(--destructive-foreground))\",\n        },\n        border: \"hsl(var(--border))\",\n        input: \"hsl(var(--input))\",\n        ring: \"hsl(var(--ring))\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1))\",\n          \"2\": \"hsl(var(--chart-2))\",\n          \"3\": \"hsl(var(--chart-3))\",\n          \"4\": \"hsl(var(--chart-4))\",\n          \"5\": \"hsl(var(--chart-5))\",\n        },\n        sidebar: {\n          DEFAULT: \"hsl(var(--sidebar-background))\",\n          foreground: \"hsl(var(--sidebar-foreground))\",\n          primary: \"hsl(var(--sidebar-primary))\",\n          \"primary-foreground\": \"hsl(var(--sidebar-primary-foreground))\",\n          accent: \"hsl(var(--sidebar-accent))\",\n          \"accent-foreground\": \"hsl(var(--sidebar-accent-foreground))\",\n          border: \"hsl(var(--sidebar-border))\",\n          ring: \"hsl(var(--sidebar-ring))\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2787,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport themePlugin from \"@replit/vite-plugin-shadcn-theme-json\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    themePlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n});\n","path":null,"size_bytes":978,"size_tokens":null},"shared/schema.ts":{"content":"import { pgTable, text, serial, integer, boolean, timestamp, json } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// User model\nexport const users = pgTable(\"users\", {\n  id: serial(\"id\").primaryKey(),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  email: text(\"email\").notNull().unique(),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  isPremium: boolean(\"is_premium\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n  email: true,\n  firstName: true,\n  lastName: true,\n});\n\n// Trip model\nexport const trips = pgTable(\"trips\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull(),\n  name: text(\"name\").notNull(),\n  participants: integer(\"participants\").notNull(),\n  startDate: text(\"start_date\").notNull(),\n  endDate: text(\"end_date\").notNull(),\n  departureCity: text(\"departure_city\").notNull(),\n  destinations: text(\"destinations\").array(),\n  experienceType: text(\"experience_type\").notNull(),\n  budget: integer(\"budget\").notNull(),\n  activities: text(\"activities\").array(),\n  specialRequests: text(\"special_requests\"),\n  includeMerch: boolean(\"include_merch\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertTripSchema = createInsertSchema(trips).pick({\n  userId: true,\n  name: true,\n  participants: true,\n  startDate: true,\n  endDate: true,\n  departureCity: true,\n  destinations: true,\n  experienceType: true,\n  budget: true,\n  activities: true,\n  specialRequests: true,\n  includeMerch: true,\n});\n\n// Itinerary model\nexport const itineraries = pgTable(\"itineraries\", {\n  id: serial(\"id\").primaryKey(),\n  tripId: integer(\"trip_id\").notNull(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\").notNull(),\n  duration: text(\"duration\").notNull(),\n  price: integer(\"price\").notNull(),\n  image: text(\"image\").notNull(),\n  rating: text(\"rating\").notNull(),\n  highlights: text(\"highlights\").array(),\n  includes: text(\"includes\").array(),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertItinerarySchema = createInsertSchema(itineraries).pick({\n  tripId: true,\n  name: true,\n  description: true,\n  duration: true,\n  price: true,\n  image: true,\n  rating: true,\n  highlights: true,\n  includes: true,\n});\n\n// Blog post model\nexport const blogPosts = pgTable(\"blog_posts\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  image: text(\"image\").notNull(),\n  isPremium: boolean(\"is_premium\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertBlogPostSchema = createInsertSchema(blogPosts).pick({\n  title: true,\n  content: true,\n  image: true,\n  isPremium: true,\n});\n\n// Merchandise model\nexport const merchandise = pgTable(\"merchandise\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\").notNull(),\n  price: integer(\"price\").notNull(),\n  image: text(\"image\").notNull(),\n  type: text(\"type\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertMerchandiseSchema = createInsertSchema(merchandise).pick({\n  name: true,\n  description: true,\n  price: true,\n  image: true,\n  type: true,\n});\n\n// Destination model\nexport const destinations = pgTable(\"destinations\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  country: text(\"country\").notNull(),\n  image: text(\"image\").notNull(),\n  description: text(\"description\").notNull(),\n  tags: text(\"tags\").array(),\n  rating: text(\"rating\").notNull(),\n  reviewCount: integer(\"review_count\").notNull(),\n});\n\nexport const insertDestinationSchema = createInsertSchema(destinations).pick({\n  name: true,\n  country: true,\n  image: true,\n  description: true,\n  tags: true,\n  rating: true,\n  reviewCount: true,\n});\n\n// Experience model\nexport const experiences = pgTable(\"experiences\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\").notNull(),\n  image: text(\"image\").notNull(),\n});\n\nexport const insertExperienceSchema = createInsertSchema(experiences).pick({\n  name: true,\n  description: true,\n  image: true,\n});\n\n// Expense Group model (for SplittaBro feature)\nexport const expenseGroups = pgTable(\"expense_groups\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  members: json(\"members\").notNull(),\n  totalAmount: integer(\"total_amount\").default(0),\n  currency: text(\"currency\").default(\"EUR\"),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertExpenseGroupSchema = createInsertSchema(expenseGroups).pick({\n  name: true,\n  description: true,\n  members: true,\n  currency: true,\n});\n\n// Expense model (for SplittaBro feature)\nexport const expenses = pgTable(\"expenses\", {\n  id: serial(\"id\").primaryKey(),\n  groupId: integer(\"group_id\").notNull(),\n  description: text(\"description\").notNull(),\n  amount: integer(\"amount\").notNull(),\n  paidBy: text(\"paid_by\").notNull(),\n  splitBetween: json(\"split_between\").notNull(),\n  category: text(\"category\").notNull(),\n  date: text(\"date\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertExpenseSchema = createInsertSchema(expenses).pick({\n  groupId: true,\n  description: true,\n  amount: true,\n  paidBy: true,\n  splitBetween: true,\n  category: true,\n  date: true,\n});\n\n// Export types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type Trip = typeof trips.$inferSelect;\nexport type InsertTrip = z.infer<typeof insertTripSchema>;\n\nexport type Itinerary = typeof itineraries.$inferSelect;\nexport type InsertItinerary = z.infer<typeof insertItinerarySchema>;\n\nexport type BlogPost = typeof blogPosts.$inferSelect;\nexport type InsertBlogPost = z.infer<typeof insertBlogPostSchema>;\n\nexport type Merchandise = typeof merchandise.$inferSelect;\nexport type InsertMerchandise = z.infer<typeof insertMerchandiseSchema>;\n\nexport type Destination = typeof destinations.$inferSelect;\nexport type InsertDestination = z.infer<typeof insertDestinationSchema>;\n\nexport type Experience = typeof experiences.$inferSelect;\nexport type InsertExperience = z.infer<typeof insertExperienceSchema>;\n\nexport type ExpenseGroup = typeof expenseGroups.$inferSelect;\nexport type InsertExpenseGroup = z.infer<typeof insertExpenseGroupSchema>;\n\nexport type Expense = typeof expenses.$inferSelect;\nexport type InsertExpense = z.infer<typeof insertExpenseSchema>;\n\n// Generated Itinerary model (for OneClick Assistant)\nexport const generatedItineraries = pgTable(\"generated_itineraries\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\"),\n  destination: text(\"destination\").notNull(),\n  startDate: text(\"start_date\").notNull(),\n  endDate: text(\"end_date\").notNull(),\n  participants: integer(\"participants\").notNull(),\n  eventType: text(\"event_type\").notNull(),\n  selectedExperiences: text(\"selected_experiences\").array(),\n  flights: json(\"flights\"),\n  hotel: json(\"hotel\"),\n  dailyActivities: json(\"daily_activities\"),\n  totalPrice: integer(\"total_price\").notNull(),\n  status: text(\"status\").default(\"draft\"),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertGeneratedItinerarySchema = createInsertSchema(generatedItineraries).pick({\n  userId: true,\n  destination: true,\n  startDate: true,\n  endDate: true,\n  participants: true,\n  eventType: true,\n  selectedExperiences: true,\n  flights: true,\n  hotel: true,\n  dailyActivities: true,\n  totalPrice: true,\n  status: true,\n});\n\nexport type GeneratedItinerary = typeof generatedItineraries.$inferSelect;\nexport type InsertGeneratedItinerary = z.infer<typeof insertGeneratedItinerarySchema>;\n","path":null,"size_bytes":7896,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2254,"size_tokens":null},"client/src/components/Newsletter.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\nimport { z } from \"zod\";\n\nconst emailSchema = z.string().email(\"Please enter a valid email address\");\n\nexport default function Newsletter() {\n  const [email, setEmail] = useState(\"\");\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const { toast } = useToast();\n  const { t } = useTranslation();\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    try {\n      emailSchema.parse(email);\n      \n      setIsSubmitting(true);\n      \n      // Simulate API call\n      setTimeout(() => {\n        toast({\n          title: t('newsletter.successTitle'),\n          description: t('newsletter.successDesc'),\n        });\n        \n        setEmail(\"\");\n        setIsSubmitting(false);\n      }, 1000);\n      \n    } catch (error) {\n      toast({\n        title: t('newsletter.errorTitle'),\n        description: t('newsletter.errorDesc'),\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <section className=\"py-16 bg-black text-white\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"max-w-3xl mx-auto text-center\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-4\">{t('newsletter.title')}</h2>\n          <p className=\"text-gray-300 mb-8\">{t('newsletter.subtitle')}</p>\n          \n          <form onSubmit={handleSubmit} className=\"flex flex-col md:flex-row gap-3\">\n            <Input\n              type=\"email\"\n              placeholder={t('newsletter.placeholder')}\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              className=\"px-4 py-3 rounded-lg flex-grow focus:outline-none focus:ring-2 focus:ring-red-600 bg-gray-900 text-white border border-gray-700\"\n            />\n            <Button \n              type=\"submit\" \n              className=\"bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300\"\n              disabled={isSubmitting}\n            >\n              {isSubmitting ? t('newsletter.subscribing') : t('newsletter.subscribe')}\n            </Button>\n          </form>\n          \n          <p className=\"text-gray-400 text-sm mt-4\">{t('newsletter.privacy')}</p>\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":2445,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/AuthModal.tsx":{"content":"import { useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { z } from \"zod\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { FaGoogle, FaFacebook } from \"react-icons/fa\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\ninterface AuthModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  defaultTab?: \"login\" | \"signup\";\n}\n\n// Form validation schemas\nconst loginSchema = z.object({\n  username: z.string().min(3, \"Username must be at least 3 characters\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  rememberMe: z.boolean().optional(),\n});\n\nconst signupSchema = z.object({\n  firstName: z.string().min(2, \"First name must be at least 2 characters\"),\n  lastName: z.string().min(2, \"Last name must be at least 2 characters\"),\n  email: z.string().email(\"Please enter a valid email\"),\n  username: z.string().min(3, \"Username must be at least 3 characters\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  confirmPassword: z.string().min(6, \"Password must be at least 6 characters\"),\n  terms: z.boolean().refine(val => val === true, {\n    message: \"You must accept the terms and conditions\",\n  }),\n}).refine(data => data.password === data.confirmPassword, {\n  message: \"Passwords do not match\",\n  path: [\"confirmPassword\"],\n});\n\ntype LoginFormValues = z.infer<typeof loginSchema>;\ntype SignupFormValues = z.infer<typeof signupSchema>;\n\nexport default function AuthModal({ isOpen, onClose, defaultTab = \"login\" }: AuthModalProps) {\n  const [activeTab, setActiveTab] = useState<string>(defaultTab);\n  const { toast } = useToast();\n  const { login } = useAuth();\n  const { t } = useTranslation();\n\n  // Login form\n  const loginForm = useForm<LoginFormValues>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      username: \"\",\n      password: \"\",\n      rememberMe: false,\n    },\n  });\n\n  // Signup form\n  const signupForm = useForm<SignupFormValues>({\n    resolver: zodResolver(signupSchema),\n    defaultValues: {\n      firstName: \"\",\n      lastName: \"\",\n      email: \"\",\n      username: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n      terms: false,\n    },\n  });\n\n  const onLoginSubmit = async (data: LoginFormValues) => {\n    try {\n      const response = await apiRequest(\"POST\", \"/api/login\", {\n        username: data.username,\n        password: data.password,\n      });\n\n      const userData = await response.json();\n      login(userData);\n      \n      toast({\n        title: t('auth.loginSuccess'),\n        description: t('auth.loginSuccessDesc'),\n      });\n      \n      onClose();\n    } catch (error) {\n      toast({\n        title: t('auth.loginFailed'),\n        description: t('auth.loginFailedDesc'),\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const onSignupSubmit = async (data: SignupFormValues) => {\n    try {\n      const response = await apiRequest(\"POST\", \"/api/register\", {\n        firstName: data.firstName,\n        lastName: data.lastName,\n        email: data.email,\n        username: data.username,\n        password: data.password,\n      });\n\n      const userData = await response.json();\n      login(userData);\n      \n      toast({\n        title: t('auth.registerSuccess'),\n        description: t('auth.registerSuccessDesc'),\n      });\n      \n      onClose();\n    } catch (error) {\n      toast({\n        title: t('auth.registerFailed'),\n        description: t('auth.registerFailedDesc'),\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"text-2xl font-bold text-center\">\n            {activeTab === \"login\" ? t('auth.welcomeBack') : t('auth.joinByebro')}\n          </DialogTitle>\n        </DialogHeader>\n        \n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-2 mb-4\">\n            <TabsTrigger value=\"login\">{t('auth.login')}</TabsTrigger>\n            <TabsTrigger value=\"signup\">{t('auth.signup')}</TabsTrigger>\n          </TabsList>\n          \n          <TabsContent value=\"login\">\n            <Form {...loginForm}>\n              <form onSubmit={loginForm.handleSubmit(onLoginSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={loginForm.control}\n                  name=\"username\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t('auth.username')}</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"your@email.com\" {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={loginForm.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t('auth.password')}</FormLabel>\n                      <FormControl>\n                        <Input type=\"password\" placeholder=\"••••••••\" {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <div className=\"flex items-center justify-between\">\n                  <FormField\n                    control={loginForm.control}\n                    name=\"rememberMe\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex items-center space-x-2\">\n                        <FormControl>\n                          <Checkbox \n                            checked={field.value} \n                            onCheckedChange={field.onChange}\n                          />\n                        </FormControl>\n                        <FormLabel className=\"text-sm\">{t('auth.rememberMe')}</FormLabel>\n                      </FormItem>\n                    )}\n                  />\n                  <a href=\"#\" className=\"text-sm text-primary hover:text-accent\">{t('auth.forgotPassword')}</a>\n                </div>\n                \n                <Button type=\"submit\" className=\"w-full bg-primary hover:bg-accent\">\n                  {t('auth.logIn')}\n                </Button>\n              </form>\n            </Form>\n            \n            <div className=\"mt-6 flex items-center justify-center\">\n              <Separator className=\"flex-grow\" />\n              <span className=\"mx-4 text-sm text-gray-500\">OR</span>\n              <Separator className=\"flex-grow\" />\n            </div>\n            \n            <div className=\"mt-6 space-y-3\">\n              <Button variant=\"outline\" className=\"w-full flex items-center justify-center\">\n                <FaGoogle className=\"mr-2 text-red-500\" />\n                {t('auth.continueGoogle')}\n              </Button>\n              <Button variant=\"outline\" className=\"w-full flex items-center justify-center\">\n                <FaFacebook className=\"mr-2 text-blue-600\" />\n                {t('auth.continueFacebook')}\n              </Button>\n            </div>\n          </TabsContent>\n          \n          <TabsContent value=\"signup\">\n            <Form {...signupForm}>\n              <form onSubmit={signupForm.handleSubmit(onSignupSubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={signupForm.control}\n                    name=\"firstName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>{t('auth.firstName')}</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"John\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={signupForm.control}\n                    name=\"lastName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>{t('auth.lastName')}</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"Doe\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                \n                <FormField\n                  control={signupForm.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t('auth.email')}</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"your@email.com\" {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={signupForm.control}\n                  name=\"username\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t('auth.username')}</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"username\" {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={signupForm.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t('auth.password')}</FormLabel>\n                      <FormControl>\n                        <Input type=\"password\" placeholder=\"••••••••\" {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={signupForm.control}\n                  name=\"confirmPassword\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t('auth.confirmPassword')}</FormLabel>\n                      <FormControl>\n                        <Input type=\"password\" placeholder=\"••••••••\" {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={signupForm.control}\n                  name=\"terms\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex items-start space-x-2\">\n                      <FormControl>\n                        <Checkbox \n                          checked={field.value} \n                          onCheckedChange={field.onChange}\n                        />\n                      </FormControl>\n                      <div>\n                        <FormLabel className=\"text-sm\">\n                          {t('auth.agreeTerms')}\n                          <a href=\"#\" className=\"text-primary hover:text-accent ml-1\">{t('auth.termsOfService')}</a>\n                          {t('auth.and')}\n                          <a href=\"#\" className=\"text-primary hover:text-accent ml-1\">{t('auth.privacyPolicy')}</a>\n                        </FormLabel>\n                        <FormMessage />\n                      </div>\n                    </FormItem>\n                  )}\n                />\n                \n                <Button type=\"submit\" className=\"w-full bg-primary hover:bg-accent\">\n                  {t('auth.signUp')}\n                </Button>\n              </form>\n            </Form>\n          </TabsContent>\n        </Tabs>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":12711,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ItineraryResults.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Itinerary } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Star, StarHalf, Calendar, Check } from \"lucide-react\";\n\ninterface ItineraryResultsProps {\n  tripId: number;\n}\n\nexport default function ItineraryResults({ tripId }: ItineraryResultsProps) {\n  const { data: itineraries, isLoading, error } = useQuery<Itinerary[]>({\n    queryKey: [`/api/trips/${tripId}/itineraries`],\n  });\n\n  // Helper function to render rating stars\n  const renderRatingStars = (rating: string) => {\n    const ratingNum = parseFloat(rating);\n    const fullStars = Math.floor(ratingNum);\n    const hasHalfStar = ratingNum % 1 >= 0.5;\n    const stars = [];\n\n    for (let i = 0; i < fullStars; i++) {\n      stars.push(<Star key={`full-${i}`} className=\"fill-yellow-400 text-yellow-400\" />);\n    }\n\n    if (hasHalfStar) {\n      stars.push(<StarHalf key=\"half\" className=\"fill-yellow-400 text-yellow-400\" />);\n    }\n\n    return stars;\n  };\n\n  if (isLoading) {\n    return (\n      <section className=\"py-16 bg-light\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center mb-12\">\n            <Skeleton className=\"h-10 w-72 mx-auto\" />\n            <Skeleton className=\"h-5 w-96 mx-auto mt-3\" />\n          </div>\n          \n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12\">\n            {[1, 2].map((i) => (\n              <div key={i} className=\"bg-white rounded-xl overflow-hidden shadow-lg border border-gray-100\">\n                <Skeleton className=\"h-48 w-full\" />\n                <div className=\"p-6\">\n                  <div className=\"flex justify-between items-center mb-4\">\n                    <Skeleton className=\"h-5 w-40\" />\n                    <Skeleton className=\"h-6 w-24\" />\n                  </div>\n                  <Skeleton className=\"h-4 w-full my-4\" />\n                  <Skeleton className=\"h-4 w-full my-2\" />\n                  <Skeleton className=\"h-4 w-full my-2\" />\n                  <Skeleton className=\"h-4 w-full my-2\" />\n                  <Skeleton className=\"h-10 w-full mt-6\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (error || !itineraries || itineraries.length === 0) {\n    return (\n      <section className=\"py-16 bg-light\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center\">\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">Your Custom Itineraries</h2>\n            <p className=\"text-red-500\">\n              {error ? \"Error loading itineraries. Please try again later.\" : \"No itineraries found for your trip.\"}\n            </p>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"py-16 bg-light\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">Your Custom Itineraries</h2>\n          <p className=\"text-gray-600 max-w-3xl mx-auto\">Based on your preferences, we've created these perfect bachelor party experiences. Choose the one you like best!</p>\n        </div>\n        \n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12\">\n          {itineraries.map((itinerary) => (\n            <div key={itinerary.id} className=\"bg-white rounded-xl overflow-hidden shadow-lg border border-gray-100\">\n              <div className=\"relative h-48 bg-cover bg-center\" style={{ backgroundImage: `url('${itinerary.image}')` }}>\n                <div className=\"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end\">\n                  <div className=\"p-4\">\n                    <h3 className=\"text-white text-xl font-bold font-poppins\">{itinerary.name}</h3>\n                    <div className=\"flex items-center mt-1\">\n                      <div className=\"text-yellow-400 flex\">\n                        {renderRatingStars(itinerary.rating)}\n                      </div>\n                      <span className=\"text-white ml-1 text-sm\">{itinerary.rating}/5 recommended</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              \n              <div className=\"p-6\">\n                <div className=\"flex justify-between items-center mb-4\">\n                  <div className=\"flex items-center\">\n                    <Calendar className=\"text-primary mr-2 h-4 w-4\" />\n                    <span className=\"text-gray-700\">{itinerary.duration}</span>\n                  </div>\n                  <div className=\"text-primary font-bold\">€{itinerary.price} <span className=\"text-sm font-normal text-gray-500\">/ person</span></div>\n                </div>\n                \n                <div className=\"border-t border-gray-100 pt-4 mb-4\">\n                  <h4 className=\"font-bold mb-2\">Itinerary Highlights</h4>\n                  <ul className=\"space-y-2\">\n                    {itinerary.highlights.map((highlight, index) => (\n                      <li key={index} className=\"flex items-start\">\n                        <Check className=\"text-green-500 mt-1 mr-2 h-4 w-4\" />\n                        <span>{highlight}</span>\n                      </li>\n                    ))}\n                  </ul>\n                </div>\n                \n                <div className=\"mb-6\">\n                  <div className=\"flex justify-between mb-2\">\n                    <h4 className=\"font-bold\">Included</h4>\n                    <Button variant=\"link\" className=\"text-primary text-sm hover:text-accent p-0\">\n                      See full details\n                    </Button>\n                  </div>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {itinerary.includes.map((item, index) => (\n                      <span key={index} className=\"bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full font-medium\">\n                        {item}\n                      </span>\n                    ))}\n                  </div>\n                </div>\n                \n                <Button className=\"w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-accent\">\n                  Book This Package\n                </Button>\n              </div>\n            </div>\n          ))}\n        </div>\n        \n        {itineraries.length > 2 && (\n          <div className=\"text-center\">\n            <Button variant=\"outline\" className=\"border border-primary text-primary hover:bg-primary hover:text-white font-bold py-2 px-6 rounded-lg\">\n              Show More Options\n            </Button>\n          </div>\n        )}\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":6771,"size_tokens":null},"server/services/openai.ts":{"content":"import OpenAI from \"openai\";\nimport { generateFallbackItinerary } from \"./fallback-itinerary\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nexport interface ItineraryRequest {\n  destination: string;\n  country: string;\n  days: number;\n  groupSize: number;\n  budget: \"budget\" | \"standard\" | \"luxury\";\n  interests: string[];\n  theme: string;\n}\n\nexport interface DailyPlan {\n  day: number;\n  title: string;\n  schedule: {\n    time: string;\n    activity: string;\n    description: string;\n    location?: string;\n    cost?: string;\n  }[];\n  notes?: string;\n}\n\nexport interface GeneratedItinerary {\n  title: string;\n  destination: string;\n  summary: string;\n  days: DailyPlan[];\n  tips: string[];\n  estimatedTotalCost: string;\n}\n\n\nexport async function generateItinerary(request: ItineraryRequest): Promise<GeneratedItinerary> {\n  try {\n    // Controlla che ci sia una chiave API di OpenAI\n    if (!process.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY === \"\") {\n      console.log(\"No OpenAI API key found, using fallback itinerary\");\n      return generateFallbackItinerary(request);\n    }\n    \n    const prompt = `Generate a detailed bachelor party itinerary for ${request.destination}, ${request.country}. \n    The itinerary should be for ${request.days} days with a group of ${request.groupSize} people.\n    The budget level is \"${request.budget}\" and they are interested in: ${request.interests.join(\", \")}.\n    The bachelor party theme is: ${request.theme}.\n    \n    The itinerary should be wild, playful, and fun, in the style of the movie \"The Hangover\" but realistic and actually doable. \n    Include real venues, local nightclubs, restaurants, and activities that exist in ${request.destination}.\n    \n    Structure the response as a JSON object with the following format:\n    {\n      \"title\": \"Catchy title for the itinerary\",\n      \"destination\": \"${request.destination}, ${request.country}\",\n      \"summary\": \"Brief summary of the itinerary\",\n      \"days\": [\n        {\n          \"day\": 1,\n          \"title\": \"Title for day 1\",\n          \"schedule\": [\n            {\n              \"time\": \"Time slot\",\n              \"activity\": \"Name of activity\",\n              \"description\": \"Detailed description\",\n              \"location\": \"Location name\",\n              \"cost\": \"Estimated cost per person\"\n            }\n          ],\n          \"notes\": \"Special notes about this day\"\n        }\n      ],\n      \"tips\": [\"Tip 1\", \"Tip 2\", \"Tip 3\"],\n      \"estimatedTotalCost\": \"Estimated total cost per person\"\n    }\n    \n    Include at least 4-6 activities per day, with a mix of daytime and nighttime activities.\n    For a luxury budget, include high-end clubs, restaurants, and experiences.\n    For a standard budget, include mid-range options that are still fun and memorable.\n    For a budget option, include affordable alternatives that are still exciting.\n    \n    Make sure each day has a good flow and make the schedule realistic with travel time between venues.`;\n\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          {\n            role: \"system\",\n            content: \"You are an expert bachelor party planner who knows all the best venues, clubs, restaurants, and activities in popular destinations worldwide.\"\n          },\n          {\n            role: \"user\",\n            content: prompt\n          }\n        ],\n        response_format: { type: \"json_object\" }\n      });\n  \n      const itineraryText = response.choices[0].message.content;\n      if (!itineraryText) {\n        console.log(\"Empty response from OpenAI, using fallback itinerary\");\n        return generateFallbackItinerary(request);\n      }\n  \n      try {\n        return JSON.parse(itineraryText) as GeneratedItinerary;\n      } catch (parseError) {\n        console.error(\"Error parsing JSON from OpenAI response:\", parseError);\n        return generateFallbackItinerary(request);\n      }\n    } catch (openaiError) {\n      console.error(\"OpenAI API error, using fallback itinerary:\", JSON.stringify(openaiError));\n      \n      // Verifica se l'API key è configurata\n      if (!process.env.OPENAI_API_KEY) {\n        console.error(\"OPENAI_API_KEY non configurata nell'ambiente\");\n      } else {\n        console.log(\"OPENAI_API_KEY è presente nell'ambiente\");\n      }\n      \n      return generateFallbackItinerary(request);\n    }\n  } catch (error) {\n    console.error(\"Error in generateItinerary function:\", error);\n    // Ritorna comunque un itinerario di fallback in caso di errore\n    return generateFallbackItinerary(request);\n  }\n}\n\nexport async function generateAssistantResponse(context: {\n  userMessage: string;\n  selectedDestination: string;\n  tripDetails: any;\n  conversationState: any;\n}): Promise<{\n  response: string;\n  updatedTripDetails?: any;\n  updatedConversationState?: any;\n  selectedDestination?: string;\n}> {\n  try {\n    if (!process.env.OPENAI_API_KEY) {\n      throw new Error('OpenAI API key not configured');\n    }\n\n    const { userMessage, selectedDestination, tripDetails, conversationState } = context;\n    \n    const systemPrompt = `You are ByeBro assistant for planning bachelor parties. Always reply in the language the user initiates the conversation in with an informal and enthusiastic tone.\n\nAVAILABLE DESTINATIONS: Rome, Ibiza, Barcelona, Prague, Budapest, Kraków, Amsterdam, Berlin, Lisbon, Palma de Mallorca\n\nCONVERSATION RULES:\n1. Your goal is to collect all the information you need to generate a detailed itinerary. As the user provides it, make sure to set it.\n2. NEVER assume the departure city. If the user has not explicitly stated where they are departing from, you MUST ask them.\n3. NEVER ask users to provide dates in a specific format (e.g., YYYY-MM-DD). Accept natural language dates such as \"June 10 to June 14\", \"10/06 to 14/06\", \"next weekend\", \"first weekend of July\", \"August 3–6\". Interpret and normalize dates internally without mentioning the format.\n4. If key information is missing (departure city, dates, number of passengers), ask for it in a natural, minimal, and conversational way. Only ask for what is strictly necessary.\n5. When the destination is provided, confirm it naturally without assuming anything else.\n6. Once ALL required information is available, briefly confirm the full route and dates in natural language, then proceed.\n7. Use emojis and an enthusiastic tone.\n8. Do not repeat already asked questions.\n9. Tone: Friendly, efficient, modern startup assistant. No technical jargon. No mention of formats or backend processes.\n\nCURRENT STATE:\n- Destination: ${selectedDestination || 'none'}\n- People: ${tripDetails?.people || 0}\n- Days: ${tripDetails?.days || 0}\n- Adventure Type: ${tripDetails?.adventureType || 'not specified'}\n- Conversation Step: ${conversationState?.currentStep || 'initial'}\n\nReply to the user's message based on this context. Return your answer in JSON format with this structure:\n{\n  \"response\": \"your reply\",\n  \"updatedTripDetails\": { \"people\": number, \"days\": number, \"adventureType\": \"type\" },\n  \"updatedConversationState\": { \"currentStep\": \"step\", \"askedForPeople\": boolean },\n  \"selectedDestination\": \"destination\"\n}`;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: systemPrompt\n        },\n        {\n          role: \"user\",\n          content: userMessage\n        }\n      ],\n      response_format: { type: \"json_object\" }\n    });\n\n    const result = JSON.parse(response.choices[0].message.content || \"{}\");\n    \n    return {\n      response: result.response || \"Something went wrong. Please try again.\",\n      updatedTripDetails: result.updatedTripDetails,\n      updatedConversationState: result.updatedConversationState,\n      selectedDestination: result.selectedDestination\n    };\n\n  } catch (error) {\n    console.error(\"OpenAI Assistant Error:\", error);\n    throw error;\n  }\n}\n\ninterface ChatMessage {\n  role: \"system\" | \"user\" | \"assistant\";\n  content: string;\n}\n\ninterface ChatContext {\n  selectedDestination?: string;\n  tripDetails?: {\n    people: number;\n    days: number;\n    adventureType: string;\n    startDate?: string;\n    endDate?: string;\n  };\n  conversationState?: {\n    currentStep: string;\n  };\n  partyType?: \"bachelor\" | \"bachelorette\";\n  origin?: string;\n  originCityName?: string;\n\n  flights?: {\n    id?: number;\n    airline: string;\n    departure_at: string;\n    return_at: string;\n    flight_number: number;\n    origin?: string;\n    destination?: string;\n    checkoutUrl?: string;\n  }[];\n\n  hotels?: {\n    hotelId: string;\n    name: string;\n    stars?: string;\n    priceTotal: number;\n    currency: string;\n    offerId: string;\n    bookingFlow: \"IN_APP\" | \"REDIRECT\";\n    paymentPolicy: string;\n    roomDescription?: string;\n  }[];\n}\n\nexport interface ToolCall {\n  name: string;\n  arguments: Record<string, any>;\n}\n\nexport type StreamChunk =\n  | { type: \"content\"; content: string }\n  | { type: \"tool_call\"; toolCall: ToolCall }\n  | { type: \"tool_result\"; name: string; result: Record<string, unknown> };\n\ntype ToolValidationResult = {\n  validToolCalls: ToolCall[];\n  clarification?: string;\n};\n\nfunction isValidISODate(value: string): boolean {\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(value)) {\n    return false;\n  }\n  const parsed = new Date(`${value}T00:00:00Z`);\n  return !Number.isNaN(parsed.getTime());\n}\n\nfunction validateToolCall(toolCall: ToolCall): { valid: boolean; message?: string } {\n  const args = toolCall.arguments || {};\n\n  switch (toolCall.name) {\n    case \"search_flights\": {\n      const origin = typeof args.origin === \"string\" ? args.origin.trim() : \"\";\n      const destination = typeof args.destination === \"string\" ? args.destination.trim() : \"\";\n      let depDate = typeof args.departure_date === \"string\" ? args.departure_date.trim() : \"\";\n      let retDate = typeof args.return_date === \"string\" ? args.return_date.trim() : \"\";\n      const passengers = Number(args.passengers);\n      \n      if (!origin || !destination) {\n        return {\n          valid: false,\n          message: \"I need both the departure city and destination to search flights.\",\n        };\n      }\n      if (!depDate || !retDate || !isValidISODate(depDate) || !isValidISODate(retDate)) {\n        return {\n          valid: false,\n          message: \"I need your travel dates to search flights. When are you going and coming back?\",\n        };\n      }\n\n      const today = new Date().toISOString().slice(0, 10);\n      if (depDate < today) {\n        const [y, m, d] = depDate.split(\"-\").map(Number);\n        const [ry, rm, rd] = retDate.split(\"-\").map(Number);\n        const tripDays = Math.round((new Date(ry, rm - 1, rd).getTime() - new Date(y, m - 1, d).getTime()) / 86400000);\n        const nowYear = new Date().getFullYear();\n        let newYear = nowYear;\n        const candidateDate = `${newYear}-${String(m).padStart(2, \"0\")}-${String(d).padStart(2, \"0\")}`;\n        if (candidateDate < today) newYear++;\n        depDate = `${newYear}-${String(m).padStart(2, \"0\")}-${String(d).padStart(2, \"0\")}`;\n        const newEnd = new Date(newYear, m - 1, d + (tripDays > 0 ? tripDays : 5));\n        retDate = newEnd.toISOString().slice(0, 10);\n        args.departure_date = depDate;\n        args.return_date = retDate;\n        console.log(`📅 Auto-corrected past dates → dep: ${depDate}, ret: ${retDate}`);\n      }\n\n      if (!Number.isInteger(passengers) || passengers <= 0) {\n        return {\n          valid: false,\n          message: \"How many people are traveling?\",\n        };\n      }\n      if (passengers > 9) {\n        args._originalPassengers = passengers;\n        args.passengers = 1;\n        console.log(`👥 Passengers capped: ${passengers} → 1 (per-person search for Amadeus max 9 limit)`);\n      }\n      return { valid: true };\n    }\n    case \"search_hotels\": {\n      const destination = typeof args.destination === \"string\" ? args.destination.trim() : \"\";\n      const checkIn = typeof args.check_in_date === \"string\" ? args.check_in_date.trim() : \"\";\n      const checkOut = typeof args.check_out_date === \"string\" ? args.check_out_date.trim() : \"\";\n      const guests = Number(args.guests);\n\n      if (!destination) {\n        return {\n          valid: false,\n          message: \"Which city should I search hotels in?\",\n        };\n      }\n      if (!checkIn || !checkOut || !isValidISODate(checkIn) || !isValidISODate(checkOut)) {\n        return {\n          valid: false,\n          message: \"I need your check-in and check-out dates to search hotels. When are you arriving and leaving?\",\n        };\n      }\n      if (!Number.isInteger(guests) || guests <= 0) {\n        return {\n          valid: false,\n          message: \"How many guests will be staying?\",\n        };\n      }\n      return { valid: true };\n    }\n    case \"select_flight\": {\n      const flightNumber = Number(args.flight_number);\n      if (!Number.isInteger(flightNumber) || flightNumber <= 0) {\n        return {\n          valid: false,\n          message: \"Which flight option would you like? You can say 1, 2, or 3.\",\n        };\n      }\n      return { valid: true };\n    }\n    case \"unlock_checkout\":\n      return { valid: true };\n    default:\n      return { valid: false, message: \"Can you clarify what you'd like to do?\" };\n  }\n}\n\nfunction validateToolCalls(toolCalls: ToolCall[]): ToolValidationResult {\n  const validToolCalls: ToolCall[] = [];\n  let clarification: string | undefined;\n\n  for (const toolCall of toolCalls) {\n    const validation = validateToolCall(toolCall);\n    if (validation.valid) {\n      validToolCalls.push(toolCall);\n      continue;\n    }\n    if (!clarification && validation.message) {\n      clarification = validation.message;\n    }\n  }\n\n  return { validToolCalls, clarification };\n}\n\n/**\n * Execute a tool call and return the result.\n * This function is used by the server-side tool loop to execute tools\n * and feed results back to OpenAI for natural conversation continuation.\n */\nexport async function executeToolCall(\n  name: string,\n  args: Record<string, unknown>,\n  context: ChatContext\n): Promise<Record<string, unknown>> {\n  switch (name) {\n    case \"search_flights\": {\n      const { searchFlights } = await import(\"./amadeus-flights\");\n      const { cityToIata } = await import(\"./cityMapping\");\n\n      // Helper to extract IATA code from strings like \"Fiumicino (FCO)\" or just use cityToIata\n      const extractIata = (input: string): string => {\n        // First try to extract IATA from parentheses, e.g., \"Fiumicino (FCO)\" -> \"FCO\"\n        const parenMatch = input.match(/\\(([A-Z]{3})\\)/i);\n        if (parenMatch) {\n          return parenMatch[1].toUpperCase();\n        }\n        // Then try cityToIata lookup\n        const mapped = cityToIata(input);\n        if (mapped) {\n          return mapped;\n        }\n        // Finally, if it looks like a 3-letter code already, use it\n        if (/^[A-Z]{3}$/i.test(input.trim())) {\n          return input.trim().toUpperCase();\n        }\n        // Last resort: take first 3 characters\n        return input.substring(0, 3).toUpperCase();\n      };\n\n      const originCity = typeof args.origin === \"string\" ? args.origin : \"\";\n      const destCity = typeof args.destination === \"string\" ? args.destination : \"\";\n      const originIata = extractIata(originCity);\n      const destIata = extractIata(destCity);\n      const numPassengers = typeof args.passengers === \"number\" ? args.passengers : 1;\n      const departureDate = typeof args.departure_date === \"string\" ? args.departure_date : \"\";\n      const returnDate = typeof args.return_date === \"string\" ? args.return_date : undefined;\n\n      console.log(\"🔍 search_flights tool called with:\", {\n        originCity,\n        destCity,\n        originIata,\n        destIata,\n        departure_date: departureDate,\n        return_date: returnDate,\n        passengers: numPassengers\n      });\n\n      try {\n        const flightResults = await searchFlights({\n          originCode: originIata,\n          destinationCode: destIata,\n          departureDate,\n          returnDate,\n          adults: numPassengers,\n          currency: \"EUR\"\n        });\n\n        console.log(\"📦 Amadeus returned\", flightResults.length, \"flights\");\n\n        // Transform to simplified format for OpenAI + add checkout URLs\n        const flights = flightResults.slice(0, 5).map((f) => {\n          const depDate = f.outbound[0]?.departure.at?.slice(0, 10) || departureDate;\n          const retDate = f.inbound?.[0]?.departure.at?.slice(0, 10) || returnDate || depDate;\n          const depDay = depDate.slice(8, 10);\n          const depMonth = depDate.slice(5, 7);\n          const retDay = retDate.slice(8, 10);\n          const retMonth = retDate.slice(5, 7);\n\n          // Generate checkout URL for Aviasales booking\n          const checkoutUrl = `https://www.aviasales.com/search/${originIata}${depDay}${depMonth}${destIata}${retDay}${retMonth}${numPassengers}?marker=${process.env.AVIASALES_PARTNER_ID || \"byebi\"}`;\n\n          return {\n            airline: f.airlines.join(\", \"),\n            price: f.price,\n            currency: f.currency,\n            departure_at: f.outbound[0]?.departure.at,\n            return_at: f.inbound?.[0]?.departure.at,\n            stops: f.stops,\n            duration: f.totalDuration,\n            checkoutUrl\n          };\n        });\n\n        console.log(\"✅ Transformed flights:\", JSON.stringify(flights, null, 2));\n\n        return { flights, origin: originIata, destination: destIata };\n      } catch (error) {\n        console.error(\"❌ Flight search error:\", error);\n        return { error: \"Failed to search flights. Please try again.\", flights: [] };\n      }\n    }\n\n    case \"search_hotels\": {\n      const { searchHotels } = await import(\"./amadeus-hotels\");\n      const { cityToIata } = await import(\"./cityMapping\");\n\n      const destCity = typeof args.destination === \"string\" ? args.destination : \"\";\n      const destIata = cityToIata(destCity) || destCity.substring(0, 3).toUpperCase();\n      const checkIn = typeof args.check_in_date === \"string\" ? args.check_in_date : \"\";\n      const checkOut = typeof args.check_out_date === \"string\" ? args.check_out_date : \"\";\n      const guests = typeof args.guests === \"number\" ? args.guests : 2;\n\n      try {\n        const hotelResults = await searchHotels({\n          cityCode: destIata,\n          checkInDate: checkIn,\n          checkOutDate: checkOut,\n          adults: guests,\n          currency: \"EUR\",\n        });\n\n        const hotels = (hotelResults || []).slice(0, 5).map((h) => ({\n          hotelId: h.hotelId,\n          name: h.name,\n          stars: h.stars,\n          priceTotal: h.priceTotal,\n          currency: h.currency,\n          offerId: h.offerId,\n          bookingFlow: h.bookingFlow,\n          paymentPolicy: h.paymentPolicy,\n          roomDescription: h.roomDescription,\n        }));\n\n        return { hotels, destination: destIata };\n      } catch (error) {\n        console.error(\"Hotel search error:\", error);\n        return { error: \"Failed to search hotels. Please try again.\", hotels: [] };\n      }\n    }\n\n    case \"select_flight\":\n      return { success: true, selected_flight: args.flight_number };\n\n    case \"unlock_checkout\":\n      return { success: true, checkout_unlocked: true };\n\n    default:\n      return { error: `Unknown tool: ${name}` };\n  }\n}\n\nconst TRIP_TOOLS: OpenAI.Chat.Completions.ChatCompletionTool[] = [\n  {\n    type: \"function\",\n    function: {\n      name: \"search_flights\",\n      strict: true,\n      description:\n        \"Search for available flights. Call this when you have origin, destination, dates, and passenger count.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          origin: {\n            type: \"string\",\n            description: \"Departure city name (e.g., Rome, Milan, London)\",\n          },\n          destination: {\n            type: \"string\",\n            description: \"Destination city name (e.g., Barcelona, Ibiza, Prague)\",\n          },\n          departure_date: {\n            type: \"string\",\n            description: \"Departure date in YYYY-MM-DD format\",\n          },\n          return_date: {\n            type: \"string\",\n            description: \"Return date in YYYY-MM-DD format\",\n          },\n          passengers: {\n            type: [\"integer\", \"null\"],\n            description: \"Number of passengers/travelers\",\n          },\n        },\n        required: [\"origin\", \"destination\", \"departure_date\", \"return_date\", \"passengers\"],\n        additionalProperties: false\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"search_hotels\",\n      strict: true,\n      description:\n        \"Search for available hotels. Call this when you have destination, check-in date, check-out date, and number of guests.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          destination: {\n            type: \"string\",\n            description: \"Destination city name (e.g., Barcelona, Rome, Prague)\",\n          },\n          check_in_date: {\n            type: \"string\",\n            description: \"Check-in date in YYYY-MM-DD format\",\n          },\n          check_out_date: {\n            type: \"string\",\n            description: \"Check-out date in YYYY-MM-DD format\",\n          },\n          guests: {\n            type: [\"integer\", \"null\"],\n            description: \"Number of guests/travelers\",\n          },\n        },\n        required: [\"destination\", \"check_in_date\", \"check_out_date\", \"guests\"],\n        additionalProperties: false,\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"select_flight\",\n      description:\n        \"Select a specific flight when the user chooses from the available options\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          flight_number: {\n            type: \"integer\",\n            description: \"The flight option number (1, 2, or 3)\",\n          },\n        },\n        required: [\"flight_number\"],\n      },\n    },\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"unlock_checkout\",\n      description:\n        \"Unlock the checkout button when the user confirms they want to proceed with booking\",\n      parameters: {\n        type: \"object\",\n        properties: {},\n        required: [],\n      },\n    },\n  },\n];\n\nconst SHARED_SYSTEM_PROMPT = (() => {\n  const today = new Date().toISOString().slice(0, 10);\n  return `Today is ${today}.\n\nDESTINATIONS: Rome, Ibiza, Barcelona, Prague, Budapest, Krakow, Amsterdam, Berlin, Lisbon, Palma de Mallorca\n\nRULES:\n- NEVER assume departure city. Always ask if not stated.\n- NEVER mention date formats. Accept natural language dates (\"June 10-14\", \"next weekend\", \"primo weekend di luglio\") and convert to YYYY-MM-DD internally. When user says a month without a year, use the NEXT occurrence of that month (never a past date).\n- Ask only for missing info: departure city, destination, dates, passengers. Keep it short and natural.\n- As soon as you have origin, destination, dates and passengers: call search_flights IMMEDIATELY. Do NOT confirm details, do NOT say \"let me check\", do NOT output any text — just call the tool silently.\n- NEVER output text alongside a tool call. When calling a tool, output ONLY the tool call with zero accompanying text.\n- Concise: 2-3 sentences max. Friendly startup tone. No jargon.\n- Focus ONLY on flights. No activities, experiences, or hotels.\n\nTOOLS:\n- search_flights: needs origin, destination, departure_date, return_date, passengers. All dates MUST be today or in the future (YYYY-MM-DD).\n- search_hotels: needs destination, check_in_date, check_out_date, guests.\n- select_flight: when user picks a flight option.\n- unlock_checkout: when user confirms booking. Flights go through external checkout — never say booking is completed.\n\nWhen showing flights, list top options (1,2,3) with date/time, airline, flight number. Ask which one they prefer.`;\n})();\n\nconst BYEBRO_SYSTEM_PROMPT = `You are the official assistant of ByeBro, part of the BYEBI app. Your task is to help plan bachelor party trips by finding REAL FLIGHTS. ALWAYS respond in the language the user writes in.\n\n${SHARED_SYSTEM_PROMPT}`;\n\nconst BYEBRIDE_SYSTEM_PROMPT = `You are the official assistant of ByeBride, part of the BYEBI app. Your task is to help plan bachelorette party trips by finding REAL FLIGHTS. ALWAYS respond in the language the user writes in.\n\n${SHARED_SYSTEM_PROMPT}`;\n\nfunction buildContextualPrompt(context: ChatContext): string {\n  const basePrompt =\n    context.partyType === \"bachelorette\"\n      ? BYEBRIDE_SYSTEM_PROMPT\n      : BYEBRO_SYSTEM_PROMPT;\n  let contextualPrompt = basePrompt;\n\n  if (context.origin && context.originCityName) {\n    contextualPrompt += `\\n\\nDEPARTURE CITY: ${context.originCityName} (airport code: ${context.origin})`;\n  }\n\n  if (context.selectedDestination) {\n    contextualPrompt += `\\n\\nSELECTED DESTINATION: ${context.selectedDestination.toUpperCase()}`;\n\n    if (context.tripDetails) {\n      contextualPrompt += `\\nTRIP DETAILS:`;\n      if (context.tripDetails.people > 0)\n        contextualPrompt += `\\n- People: ${context.tripDetails.people}`;\n      if (context.tripDetails.days > 0)\n        contextualPrompt += `\\n- Days: ${context.tripDetails.days}`;\n      if (context.tripDetails.adventureType)\n        contextualPrompt += `\\n- Type: ${context.tripDetails.adventureType}`;\n    }\n  }\n\n  if (context.flights && context.flights.length > 0) {\n    const originCity = context.originCityName;\n    contextualPrompt += `\\n\\nAVAILABLE REAL FLIGHTS (from ${originCity} to ${context.selectedDestination}):`;\n    contextualPrompt += `\\nThese are REAL flights with updated prices. Present them to the user and ask which one they prefer.\\n`;\n    context.flights.forEach((f, idx) => {\n      const depDate = new Date(f.departure_at).toLocaleDateString(\"en-US\", {\n        day: \"numeric\",\n        month: \"long\",\n        year: \"numeric\",\n      });\n      const depTime = new Date(f.departure_at).toLocaleTimeString(\"en-US\", {\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n      const retDate = new Date(f.return_at).toLocaleDateString(\"en-US\", {\n        day: \"numeric\",\n        month: \"long\",\n        year: \"numeric\",\n      });\n      const retTime = new Date(f.return_at).toLocaleTimeString(\"en-US\", {\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n\n      contextualPrompt += `${idx + 1}. Departure: ${depDate} at ${depTime}\\n`;\n      contextualPrompt += `   Return: ${retDate} at ${retTime}\\n`;\n      contextualPrompt += `   Airline: ${f.airline}\\n`;\n      contextualPrompt += `   Flight no. ${f.flight_number}\\n\\n`;\n      if (f.checkoutUrl) {\n        contextualPrompt += `   Checkout link: ${f.checkoutUrl}\\n\\n`;\n      }\n    });\n    contextualPrompt += `\\nWhen the user chooses a flight (e.g., \"the 2nd one\", \"I'll take the first\", \"flight 3\"), call select_flight with the flight number.\\n`;\n  }\n\n  return contextualPrompt;\n}\n\nexport async function createOpenAIChatCompletion(\n  userMessage: string,\n  context: ChatContext,\n  conversationHistory: ChatMessage[] = [],\n): Promise<{ content: string; toolCalls: ToolCall[] }> {\n  try {\n    const contextualPrompt = buildContextualPrompt(context);\n\n    const messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [\n      { role: \"system\", content: contextualPrompt },\n      ...conversationHistory.map((msg) => ({\n        role: msg.role as \"system\" | \"user\" | \"assistant\",\n        content: msg.content,\n      })),\n      { role: \"user\", content: userMessage },\n    ];\n\n    const chatCompletion = await openai.chat.completions.create({\n      messages,\n      model: \"gpt-4o-mini\",\n      tools: TRIP_TOOLS,\n      tool_choice: \"auto\",\n    });\n\n    const message = chatCompletion.choices[0]?.message;\n    const content = message?.content || \"\";\n    const toolCalls: ToolCall[] = [];\n\n    if (message?.tool_calls) {\n      for (const tc of message.tool_calls) {\n        try {\n          toolCalls.push({\n            name: tc.function.name,\n            arguments: JSON.parse(tc.function.arguments || \"{}\"),\n          });\n        } catch (e) {\n          console.error(\"Error parsing tool call arguments:\", e);\n        }\n      }\n    }\n\n    const { validToolCalls, clarification } = validateToolCalls(toolCalls);\n    let finalContent = content;\n    if (clarification) {\n      finalContent = finalContent.trim()\n        ? `${finalContent}\\n\\n${clarification}`\n        : clarification;\n    }\n\n    // If no content was returned, generate a quick follow-up without a second API call\n    if (!finalContent.trim() && validToolCalls.length > 0 && !clarification) {\n      finalContent = generateFollowUpMessage(validToolCalls, context);\n    }\n\n    return { content: finalContent, toolCalls: validToolCalls };\n  } catch (error) {\n    console.error(\"OpenAI API error:\", error);\n    throw new Error(\"Error communicating with OpenAI\");\n  }\n}\n\nexport async function* streamOpenAIChatCompletion(\n  userMessage: string,\n  context: ChatContext,\n  conversationHistory: ChatMessage[] = [],\n): AsyncGenerator<StreamChunk, void, unknown> {\n  try {\n    const contextualPrompt = buildContextualPrompt(context);\n\n    const messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [\n      { role: \"system\", content: contextualPrompt },\n      ...conversationHistory.map((msg) => ({\n        role: msg.role as \"system\" | \"user\" | \"assistant\",\n        content: msg.content,\n      })),\n      { role: \"user\", content: userMessage },\n    ];\n\n    const stream = await openai.chat.completions.create({\n      messages,\n      model: \"gpt-4o-mini\",\n      stream: true,\n      tools: TRIP_TOOLS,\n      tool_choice: \"auto\",\n    });\n\n    const toolCallsBuffer: Map<number, { name: string; arguments: string }> =\n      new Map();\n    let hasContent = false;\n    const collectedToolCalls: ToolCall[] = [];\n    let pendingClarification: string | null = null;\n\n    for await (const chunk of stream) {\n      const delta = chunk.choices[0]?.delta;\n\n      if (delta?.content) {\n        hasContent = true;\n        yield { type: \"content\", content: delta.content };\n      }\n\n      if (delta?.tool_calls) {\n        for (const tc of delta.tool_calls) {\n          const idx = tc.index;\n          if (!toolCallsBuffer.has(idx)) {\n            toolCallsBuffer.set(idx, { name: \"\", arguments: \"\" });\n          }\n          const buffer = toolCallsBuffer.get(idx)!;\n          if (tc.function?.name) {\n            buffer.name = tc.function.name;\n          }\n          if (tc.function?.arguments) {\n            buffer.arguments += tc.function.arguments;\n          }\n        }\n      }\n\n      if (\n        chunk.choices[0]?.finish_reason === \"tool_calls\" ||\n        chunk.choices[0]?.finish_reason === \"stop\"\n      ) {\n        const entries = Array.from(toolCallsBuffer.entries());\n        for (const [, buffer] of entries) {\n          if (buffer.name) {\n            try {\n              const args = buffer.arguments ? JSON.parse(buffer.arguments) : {};\n              const toolCall = { name: buffer.name, arguments: args };\n              const validation = validateToolCall(toolCall);\n              if (validation.valid) {\n                collectedToolCalls.push(toolCall);\n                yield { type: \"tool_call\", toolCall };\n              } else if (!pendingClarification && validation.message) {\n                pendingClarification = validation.message;\n              }\n            } catch (e) {\n              console.error(\"Error parsing streamed tool call:\", e);\n            }\n          }\n        }\n        toolCallsBuffer.clear();\n      }\n    }\n\n    // If the model didn't produce any text content, generate a quick follow-up\n    // without making another API call (which would defeat the purpose of streaming)\n    if (!hasContent) {\n      if (pendingClarification) {\n        yield { type: \"content\", content: pendingClarification };\n      } else if (collectedToolCalls.length > 0) {\n        // Use local follow-up generation instead of a second API call\n        const fallbackContent = generateFollowUpMessage(collectedToolCalls, context);\n        yield { type: \"content\", content: fallbackContent };\n      }\n    }\n  } catch (error) {\n    console.error(\"OpenAI streaming error:\", error);\n    yield {\n      type: \"content\",\n      content:\n        \"Sorry, there was a problem with the streaming. Please try again!\",\n    };\n  }\n}\n\nfunction generateFollowUpMessage(\n  toolCalls: ToolCall[],\n  context: ChatContext,\n): string {\n  if (context.flights && context.flights.length > 0) {\n    const originCity = context.originCityName;\n    const flightOptions = context.flights\n      .slice(0, 3)\n      .map((f, idx) => {\n        const depDate = new Date(f.departure_at).toLocaleDateString(\"en-US\", {\n          day: \"numeric\",\n          month: \"long\",\n          year: \"numeric\",\n        });\n        const depTime = new Date(f.departure_at).toLocaleTimeString(\"en-US\", {\n          hour: \"2-digit\",\n          minute: \"2-digit\",\n        });\n        const retDate = new Date(f.return_at).toLocaleDateString(\"en-US\", {\n          day: \"numeric\",\n          month: \"long\",\n          year: \"numeric\",\n        });\n        const retTime = new Date(f.return_at).toLocaleTimeString(\"en-US\", {\n          hour: \"2-digit\",\n          minute: \"2-digit\",\n        });\n        const link = f.checkoutUrl ? `\\n   Link: ${f.checkoutUrl}` : \"\";\n\n        return `${idx + 1}) ${originCity} → ${context.selectedDestination}: ${depDate} ${depTime} / Return ${retDate} ${retTime} (${f.airline} Flight ${f.flight_number})${link}`;\n      })\n      .join(\"\\n\");\n\n    return `Here are the best flight options I found:\\n${flightOptions}\\n\\nWhich one would you like?`;\n  }\n\n  const toolNames = new Set(toolCalls.map((tc) => tc.name));\n  if (toolNames.has(\"search_flights\")) {\n    return \"Searching for the best flights for you...\";\n  }\n\n  return \"Got it! Anything else you'd like to share?\";\n}\n\nfunction detectUserLanguage(context: ChatContext, conversationHistory: ChatMessage[] = []): string {\n  const lastUserMsg = [...conversationHistory].reverse().find(m => m.role === \"user\");\n  if (!lastUserMsg) return \"en\";\n  const text = lastUserMsg.content.toLowerCase();\n  const itPatterns = /\\b(ciao|voglio|andare|siamo|partiamo|dal|al|persone|voli|quando|dove|prenota|perfetto|procedi)\\b/;\n  const esPatterns = /\\b(hola|quiero|somos|salimos|del|personas|vuelos|cuando|donde|reservar|perfecto)\\b/;\n  if (itPatterns.test(text)) return \"it\";\n  if (esPatterns.test(text)) return \"es\";\n  return \"en\";\n}\n\ninterface LocalStrings {\n  noFlightsError: (o: string, d: string) => string;\n  noFlights: (o: string, d: string) => string;\n  flightsHeader: (o: string, d: string) => string;\n  direct: string;\n  stop: (n: number) => string;\n  dep: string;\n  ret: string;\n  whichOne: string;\n  perPersonNote: (n: number) => string;\n  flightSelected: string;\n  checkout: string;\n}\n\nconst STRINGS: Record<string, LocalStrings> = {\n  it: {\n    noFlightsError: (o, d) => `Non sono riuscito a trovare voli da ${o} a ${d}. Vuoi provare date diverse?`,\n    noFlights: (o, d) => `Nessun volo disponibile da ${o} a ${d} per quelle date. Prova con date diverse o un'altra destinazione?`,\n    flightsHeader: (o, d) => `Ecco i migliori voli da **${o}** a **${d}**:\\n\\n`,\n    direct: \"diretto\",\n    stop: (n) => `${n} scal${n > 1 ? \"i\" : \"o\"}`,\n    dep: \"Partenza\",\n    ret: \"Ritorno\",\n    whichOne: \"Quale preferisci?\",\n    perPersonNote: (n) => `\\n> I prezzi sono **per persona**. Per ${n} partecipanti, moltiplica il prezzo x${n}.\\n\\n`,\n    flightSelected: \"Perfetto, volo selezionato! Vuoi procedere con la prenotazione?\",\n    checkout: \"Ottimo! Ti porto al checkout per completare la prenotazione.\",\n  },\n  en: {\n    noFlightsError: (o, d) => `Couldn't find flights from ${o} to ${d}. Want to try different dates?`,\n    noFlights: (o, d) => `No flights available from ${o} to ${d} for those dates. Try different dates or another destination?`,\n    flightsHeader: (o, d) => `Here are the best flights from **${o}** to **${d}**:\\n\\n`,\n    direct: \"direct\",\n    stop: (n) => `${n} stop${n > 1 ? \"s\" : \"\"}`,\n    dep: \"Departure\",\n    ret: \"Return\",\n    whichOne: \"Which one do you prefer?\",\n    perPersonNote: (n) => `\\n> Prices are **per person**. For ${n} travelers, multiply the price x${n}.\\n\\n`,\n    flightSelected: \"Flight selected! Ready to proceed with booking?\",\n    checkout: \"Taking you to checkout to complete the booking.\",\n  },\n  es: {\n    noFlightsError: (o, d) => `No encontré vuelos de ${o} a ${d}. ¿Quieres probar otras fechas?`,\n    noFlights: (o, d) => `No hay vuelos disponibles de ${o} a ${d} para esas fechas. ¿Pruebas con otras fechas u otro destino?`,\n    flightsHeader: (o, d) => `Aquí están los mejores vuelos de **${o}** a **${d}**:\\n\\n`,\n    direct: \"directo\",\n    stop: (n) => `${n} escala${n > 1 ? \"s\" : \"\"}`,\n    dep: \"Salida\",\n    ret: \"Regreso\",\n    whichOne: \"¿Cuál prefieres?\",\n    perPersonNote: (n) => `\\n> Los precios son **por persona**. Para ${n} viajeros, multiplica el precio x${n}.\\n\\n`,\n    flightSelected: \"¡Vuelo seleccionado! ¿Quieres proceder con la reserva?\",\n    checkout: \"¡Genial! Te llevo al checkout para completar la reserva.\",\n  },\n};\n\nfunction generateLocalToolResponse(\n  toolResults: Array<{ name: string; result: Record<string, unknown>; args: Record<string, unknown> }>,\n  context: ChatContext,\n  conversationHistory: ChatMessage[] = [],\n): string | null {\n  const lang = detectUserLanguage(context, conversationHistory);\n  const s = STRINGS[lang] || STRINGS.en;\n\n  for (const { name, result, args } of toolResults) {\n    switch (name) {\n      case \"search_flights\": {\n        const flights = result.flights as any[] | undefined;\n        const origin = (args.origin as string) || context.originCityName || \"\";\n        const destination = (args.destination as string) || context.selectedDestination || \"\";\n        const originalPassengers = args._originalPassengers as number | undefined;\n\n        if (!flights || flights.length === 0) {\n          return result.error ? s.noFlightsError(origin, destination) : s.noFlights(origin, destination);\n        }\n\n        const locale = lang === \"it\" ? \"it-IT\" : lang === \"es\" ? \"es-ES\" : \"en-US\";\n        const formatDT = (iso: string) => {\n          const d = new Date(iso);\n          return d.toLocaleDateString(locale, { day: \"numeric\", month: \"long\" }) +\n            \" \" + d.toLocaleTimeString(locale, { hour: \"2-digit\", minute: \"2-digit\" });\n        };\n\n        let msg = s.flightsHeader(origin, destination);\n        if (originalPassengers && originalPassengers > 9) {\n          msg += s.perPersonNote(originalPassengers);\n        }\n        flights.slice(0, 3).forEach((f: any, idx: number) => {\n          const dep = f.departure_at ? formatDT(f.departure_at) : \"N/A\";\n          const ret = f.return_at ? formatDT(f.return_at) : \"N/A\";\n          const stopsLabel = f.stops > 0 ? ` (${s.stop(f.stops)})` : ` (${s.direct})`;\n          const flightNum = f.flight_number ? ` #${f.flight_number}` : \"\";\n          msg += `**${idx + 1}.** ${f.airline}${flightNum}${stopsLabel} — ${f.price}€\\n`;\n          msg += `   ${s.dep}: ${dep} / ${s.ret}: ${ret}\\n\\n`;\n        });\n        msg += s.whichOne;\n        return msg;\n      }\n\n      case \"select_flight\":\n        return s.flightSelected;\n\n      case \"unlock_checkout\":\n        return s.checkout;\n    }\n  }\n  return null;\n}\n\n/**\n * New streaming function that implements the proper OpenAI function calling loop.\n * Instead of hard-coding follow-up messages, this function:\n * 1. Streams the initial response\n * 2. When tool calls are received, executes them\n * 3. Sends tool results back to OpenAI\n * 4. Continues the conversation naturally\n */\nexport async function* streamOpenAIChatCompletionWithTools(\n  userMessage: string,\n  context: ChatContext,\n  conversationHistory: ChatMessage[] = [],\n): AsyncGenerator<StreamChunk, void, unknown> {\n  const totalStart = Date.now();\n  try {\n    const contextualPrompt = buildContextualPrompt(context);\n\n    // Build initial messages array\n    const messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [\n      { role: \"system\", content: contextualPrompt },\n      ...conversationHistory.map((msg) => ({\n        role: msg.role as \"system\" | \"user\" | \"assistant\",\n        content: msg.content,\n      })),\n      { role: \"user\", content: userMessage },\n    ];\n\n    const systemPromptLength = contextualPrompt.length;\n    const historyLength = conversationHistory.length;\n    const totalChars = messages.reduce((sum, m) => sum + (typeof m.content === \"string\" ? m.content.length : 0), 0);\n    console.log(`⏱️ [STREAM] Start | system_prompt=${systemPromptLength} chars | history=${historyLength} msgs | total_chars=${totalChars}`);\n\n    // Tool loop: keep calling OpenAI until we get a response without tool calls\n    let iteration = 0;\n    while (true) {\n      iteration++;\n      const apiStart = Date.now();\n      console.log(`⏱️ [STREAM] OpenAI API call #${iteration} starting...`);\n\n      const stream = await openai.chat.completions.create({\n        messages,\n        model: \"gpt-4o-mini\",\n        stream: true,\n        tools: TRIP_TOOLS,\n        tool_choice: \"auto\",\n      });\n\n      const firstChunkStart = Date.now();\n      console.log(`⏱️ [STREAM] Stream created in ${firstChunkStart - apiStart}ms, waiting for first chunk...`);\n\n      let assistantContent = \"\";\n      const toolCallsBuffer: Map<number, { id: string; name: string; arguments: string }> =\n        new Map();\n      let firstChunkReceived = false;\n      let hasToolCalls = false;\n      const contentBuffer: string[] = [];\n\n      for await (const chunk of stream) {\n        if (!firstChunkReceived) {\n          console.log(`⏱️ [STREAM] First chunk received in ${Date.now() - firstChunkStart}ms (total since API call: ${Date.now() - apiStart}ms)`);\n          firstChunkReceived = true;\n        }\n        const delta = chunk.choices[0]?.delta;\n\n        if (delta?.content) {\n          assistantContent += delta.content;\n          contentBuffer.push(delta.content);\n        }\n\n        if (delta?.tool_calls) {\n          hasToolCalls = true;\n          for (const tc of delta.tool_calls) {\n            const idx = tc.index;\n            if (!toolCallsBuffer.has(idx)) {\n              toolCallsBuffer.set(idx, { id: \"\", name: \"\", arguments: \"\" });\n            }\n            const buffer = toolCallsBuffer.get(idx)!;\n            if (tc.id) buffer.id = tc.id;\n            if (tc.function?.name) buffer.name = tc.function.name;\n            if (tc.function?.arguments) buffer.arguments += tc.function.arguments;\n          }\n        }\n      }\n\n      if (!hasToolCalls && contentBuffer.length > 0) {\n        for (const chunk of contentBuffer) {\n          yield { type: \"content\", content: chunk };\n        }\n      } else if (hasToolCalls && assistantContent) {\n        console.log(`⏱️ [STREAM] Discarded filler text before tool call: \"${assistantContent.slice(0, 80)}...\"`);\n      }\n\n      const streamDone = Date.now();\n      console.log(`⏱️ [STREAM] Stream #${iteration} fully consumed in ${streamDone - apiStart}ms`);\n\n      // Finalize tool calls from buffer\n      const toolCalls: Array<{ id: string; name: string; arguments: string }> = [];\n      for (const [, buffer] of toolCallsBuffer.entries()) {\n        if (buffer.name && buffer.id) {\n          toolCalls.push(buffer);\n        }\n      }\n\n      console.log(`⏱️ [STREAM] Tool calls: [${toolCalls.map(tc => tc.name).join(\", \")}] | content=${assistantContent.length} chars`);\n\n      // If no tool calls, we're done - exit the loop\n      if (toolCalls.length === 0) {\n        console.log(`⏱️ [STREAM] No tool calls, done. Total: ${Date.now() - totalStart}ms`);\n        break;\n      }\n\n      // Add assistant message with tool calls to history\n      messages.push({\n        role: \"assistant\",\n        content: assistantContent || null,\n        tool_calls: toolCalls.map(tc => ({\n          id: tc.id,\n          type: \"function\" as const,\n          function: { name: tc.name, arguments: tc.arguments }\n        }))\n      });\n\n      // Execute each tool and collect results\n      let canShortCircuit = true;\n      const toolResults: Array<{ name: string; result: Record<string, unknown>; args: Record<string, unknown> }> = [];\n\n      for (const toolCall of toolCalls) {\n        let args: Record<string, unknown>;\n        try {\n          args = JSON.parse(toolCall.arguments || \"{}\");\n        } catch {\n          args = {};\n        }\n\n        const validation = validateToolCall({ name: toolCall.name, arguments: args });\n        if (!validation.valid) {\n          messages.push({\n            role: \"tool\",\n            tool_call_id: toolCall.id,\n            content: JSON.stringify({ error: validation.message })\n          });\n          canShortCircuit = false;\n          continue;\n        }\n\n        yield { type: \"tool_call\", toolCall: { name: toolCall.name, arguments: args } };\n\n        const toolStart = Date.now();\n        const result = await executeToolCall(toolCall.name, args, context);\n        console.log(`⏱️ [STREAM] Tool \"${toolCall.name}\" executed in ${Date.now() - toolStart}ms`);\n\n        yield { type: \"tool_result\", name: toolCall.name, result };\n        toolResults.push({ name: toolCall.name, result, args });\n\n        messages.push({\n          role: \"tool\",\n          tool_call_id: toolCall.id,\n          content: JSON.stringify(result)\n        });\n      }\n\n      // Short-circuit: generate local response for search tools to avoid a second OpenAI call (~3-8s saved)\n      const searchToolNames = new Set([\"search_flights\", \"select_flight\", \"unlock_checkout\"]);\n      const allToolsAreSimple = canShortCircuit && toolResults.every(t => searchToolNames.has(t.name));\n\n      if (allToolsAreSimple && toolResults.length > 0) {\n        const localResponse = generateLocalToolResponse(toolResults, context, conversationHistory);\n        if (localResponse) {\n          console.log(`⏱️ [STREAM] Short-circuiting with local response (saved ~5-8s). Total: ${Date.now() - totalStart}ms`);\n          yield { type: \"content\", content: localResponse };\n          break;\n        }\n      }\n\n      console.log(`⏱️ [STREAM] Needs followup via OpenAI. Elapsed: ${Date.now() - totalStart}ms`);\n    }\n  } catch (error) {\n    console.error(\"OpenAI streaming error:\", error);\n    yield {\n      type: \"content\",\n      content: \"Sorry, there was a problem. Please try again!\",\n    };\n  }\n}\n\n","path":null,"size_bytes":46387,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/lib/performance.ts":{"content":"/**\n * Utility per migliorare le performance dell'applicazione\n */\n\n/**\n * Funzione debounce per limitare la frequenza di esecuzione di una funzione\n */\nexport function debounce<T extends (...args: any[]) => any>(\n  func: T,\n  wait: number\n): (...args: Parameters<T>) => void {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  \n  return function(...args: Parameters<T>) {\n    const later = () => {\n      timeout = null;\n      func(...args);\n    };\n    \n    if (timeout) clearTimeout(timeout);\n    timeout = setTimeout(later, wait);\n  };\n}\n\n/**\n * Funzione per limitare il frame rate (throttle) di un'operazione\n */\nexport function throttle<T extends (...args: any[]) => any>(\n  func: T,\n  limit: number\n): (...args: Parameters<T>) => void {\n  let inThrottle = false;\n  let lastFunc: ReturnType<typeof setTimeout>;\n  let lastRan: number;\n  \n  return function(...args: Parameters<T>) {\n    if (!inThrottle) {\n      func(...args);\n      lastRan = Date.now();\n      inThrottle = true;\n      \n      setTimeout(() => {\n        inThrottle = false;\n      }, limit);\n    } else {\n      clearTimeout(lastFunc);\n      lastFunc = setTimeout(() => {\n        if (Date.now() - lastRan >= limit) {\n          func(...args);\n          lastRan = Date.now();\n        }\n      }, limit - (Date.now() - lastRan));\n    }\n  };\n}\n\n/**\n * Hook per l'intersezione di elementi - utile per il lazy loading\n */\nexport function useIsVisible(element: HTMLElement | null): boolean {\n  if (!element || typeof IntersectionObserver !== 'function') return true;\n  \n  let visible = false;\n  const observer = new IntersectionObserver((entries) => {\n    visible = entries[0].isIntersecting;\n  });\n  \n  observer.observe(element);\n  \n  return visible;\n}\n\n/**\n * Ottimizza le immagini con dimensioni specifiche\n */\nexport function optimizeImageUrl(\n  url: string, \n  width: number, \n  height: number, \n  quality: number = 80\n): string {\n  if (!url) return '';\n  \n  // Se l'URL è un data URI, lo restituiamo così com'è\n  if (url.startsWith('data:')) {\n    return url;\n  }\n  \n  // Se è già un'immagine ottimizzata (come Unsplash), aggiungiamo i parametri di dimensione\n  if (url.includes('unsplash.com')) {\n    // Verifica se l'URL contiene già parametri di dimensione\n    if (url.includes('&w=') || url.includes('&h=')) {\n      return url;\n    }\n    \n    // Aggiungi i parametri di dimensione e qualità\n    const separator = url.includes('?') ? '&' : '?';\n    return `${url}${separator}w=${width}&h=${height}&auto=format&q=${quality}&fit=crop`;\n  }\n  \n  // Per le immagini di altri servizi che supportano dimensioni nell'URL\n  if (url.includes('images.pexels.com') || url.includes('pixabay.com')) {\n    // Verifica se l'URL contiene già parametri di dimensione\n    if (url.includes('&w=') || url.includes('&h=') || url.includes('&size=')) {\n      return url;\n    }\n    \n    // Aggiungi i parametri di dimensione e qualità\n    const separator = url.includes('?') ? '&' : '?';\n    return `${url}${separator}w=${width}&h=${height}&auto=compress&q=${quality}`;\n  }\n  \n  // Per le immagini senza supporto per parametri di dimensione\n  return url;\n}\n\n/**\n * Precarica le immagini in background\n */\nexport function preloadImage(src: string): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.onload = () => resolve(img);\n    img.onerror = reject;\n    img.src = src;\n  });\n}\n\n/**\n * Applica la tecnica del CSS containment per ottimizzare il rendering\n */\nexport function applyContainment(element: HTMLElement, type: 'strict' | 'content' | 'size' | 'layout' | 'paint' = 'content'): void {\n  if (!element) return;\n  \n  element.style.contain = type;\n}","path":null,"size_bytes":3676,"size_tokens":null},"server/routes.ts":{"content":"import express, { type Express, Request, Response, NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { \n  insertUserSchema, \n  insertTripSchema, \n  insertExpenseGroupSchema, \n  insertExpenseSchema \n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { fromZodError } from \"zod-validation-error\";\nimport { generateItinerary } from \"./services/openai\";\nimport { setupAuth } from \"./auth\";\nimport { registerZapierRoutes } from \"./zapier-integration\";\nimport { imageSearchService } from \"./services/image-search\";\nimport { searchFlights } from \"./services/amadeus-flights\";\nimport { cityToIata, iataToCity } from \"./services/cityMapping\";\nimport { searchHotels, bookHotel } from \"./services/amadeus-hotels\";\n\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Setup authentication\n  setupAuth(app);\n\n  // Authorization middleware\n  const isAuthenticated = (req: Request, res: Response, next: NextFunction) => {\n    if (req.isAuthenticated()) {\n      return next();\n    }\n    res.status(401).json({ message: \"Authentication required\" });\n  };\n\n  app.post(\"/api/users/:id/premium\", isAuthenticated, async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { isPremium } = req.body;\n      \n      if (typeof isPremium !== 'boolean') {\n        return res.status(400).json({ message: \"isPremium must be a boolean\" });\n      }\n      \n      const updatedUser = await storage.updateUserPremiumStatus(id, isPremium);\n      \n      if (!updatedUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Don't return password in response\n      const { password, ...userWithoutPassword } = updatedUser;\n      \n      return res.status(200).json(userWithoutPassword);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n });\n\n  // Trip routes\n  app.post(\"/api/trips\", isAuthenticated, async (req: Request, res: Response) => {\n    try {\n      const tripData = insertTripSchema.parse(req.body);\n      const trip = await storage.createTrip(tripData);\n      return res.status(201).json(trip);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: fromZodError(error).message });\n      }\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.get(\"/api/trips/user/:userId\", async (req: Request, res: Response) => {\n    try {\n      const userId = parseInt(req.params.userId);\n      const trips = await storage.getTripsByUserId(userId);\n      return res.status(200).json(trips);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.get(\"/api/trips/:id/itineraries\", async (req: Request, res: Response) => {\n    try {\n      const tripId = parseInt(req.params.id);\n      const trip = await storage.getTrip(tripId);\n      \n      if (!trip) {\n        return res.status(404).json({ message: \"Trip not found\" });\n      }\n      \n      // Mock itineraries - SOLO in development\n      if (process.env.NODE_ENV === \"production\") {\n        return res.status(501).json({ message: \"Real itinerary generation not implemented yet\" });\n      }\n      \n      const mockItinerary1 = {\n        tripId,\n        name: \"Amsterdam Adventure\",\n        description: \"Experience the best of Amsterdam's nightlife and culture\",\n        duration: \"3 Nights, 4 Days\",\n        price: 650,\n        image: \"https://images.unsplash.com/photo-1534570122623-99e8378a9aa7?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&h=400&q=80\",\n        rating: \"4.5\",\n        highlights: [\n          \"Red Light District night tour with local guide\",\n          \"Heineken Experience with beer tasting\",\n          \"Canal cruise with open bar\",\n          \"VIP access to top nightclubs\"\n        ],\n        includes: [\"Flights\", \"Accommodation\", \"Activities\", \"Custom Merch\"]\n      };\n      \n      const mockItinerary2 = {\n        tripId,\n        name: \"Prague Party\",\n        description: \"Historic sites by day, epic parties by night\",\n        duration: \"4 Nights, 5 Days\",\n        price: 580,\n        image: \"https://images.unsplash.com/photo-1583422409516-2895a77efded?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&h=400&q=80\",\n        rating: \"4.0\",\n        highlights: [\n          \"Beer spa experience with unlimited beer\",\n          \"Pub crawl through historic Old Town\",\n          \"Traditional Czech dinner with folk show\",\n          \"Party boat cruise on Vltava River\"\n        ],\n        includes: [\"Flights\", \"Accommodation\", \"Activities\", \"Custom Merch\"]\n      };\n      \n      // Create the itineraries\n      const itinerary1 = await storage.createItinerary(mockItinerary1);\n      const itinerary2 = await storage.createItinerary(mockItinerary2);\n      \n      return res.status(200).json([itinerary1, itinerary2]);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // Destination routes\n  app.get(\"/api/destinations\", async (req: Request, res: Response) => {\n    try {\n      const destinations = await storage.getAllDestinations();\n      return res.status(200).json(destinations);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // Experience routes\n  app.get(\"/api/experiences\", async (req: Request, res: Response) => {\n    try {\n      const experiences = await storage.getAllExperiences();\n      return res.status(200).json(experiences);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // Blog post routes\n  app.get(\"/api/blog-posts\", async (req: Request, res: Response) => {\n    try {\n      const { premium } = req.query;\n      let blogPosts;\n      \n      if (premium === 'true') {\n        blogPosts = await storage.getAllBlogPosts();\n      } else {\n        blogPosts = await storage.getFreeBlogPosts();\n      }\n      \n      return res.status(200).json(blogPosts);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // Merchandise routes\n  app.get(\"/api/merchandise\", async (req: Request, res: Response) => {\n    try {\n      const { type } = req.query;\n      let merchandiseItems;\n      \n      if (type) {\n        merchandiseItems = await storage.getMerchandiseByType(type as string);\n      } else {\n        merchandiseItems = await storage.getAllMerchandise();\n      }\n      \n      return res.status(200).json(merchandiseItems);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // SplittaBro - Expense Group routes\n  app.post(\"/api/expense-groups\", async (req: Request, res: Response) => {\n    try {\n      const groupData = insertExpenseGroupSchema.parse(req.body);\n      const group = await storage.createExpenseGroup(groupData);\n      return res.status(201).json(group);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: fromZodError(error).message });\n      }\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.get(\"/api/trips/:tripId/expense-groups\", async (req: Request, res: Response) => {\n    try {\n      const tripId = parseInt(req.params.tripId);\n      const trip = await storage.getTrip(tripId);\n      \n      if (!trip) {\n        return res.status(404).json({ message: \"Trip not found\" });\n      }\n      \n      const expenseGroups = await storage.getExpenseGroupsByTripId(tripId);\n      return res.status(200).json(expenseGroups);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // Get all expense groups (for SplittaBro standalone use)\n  app.get(\"/api/expense-groups\", async (req: Request, res: Response) => {\n    try {\n      // Get all expense groups\n      const allGroups = await storage.getAllExpenseGroups();\n      return res.status(200).json(allGroups);\n    } catch (error) {\n      console.error(\"Error fetching expense groups:\", error);\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.get(\"/api/expense-groups/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const group = await storage.getExpenseGroup(id);\n      \n      if (!group) {\n        return res.status(404).json({ message: \"Expense group not found\" });\n      }\n      \n      return res.status(200).json(group);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // SplittaBro - Expense routes\n  app.post(\"/api/expenses\", async (req: Request, res: Response) => {\n    try {\n      const expenseData = insertExpenseSchema.parse(req.body);\n      const expense = await storage.createExpense(expenseData);\n      return res.status(201).json(expense);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: fromZodError(error).message });\n      }\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.get(\"/api/expense-groups/:groupId/expenses\", async (req: Request, res: Response) => {\n    try {\n      const groupId = parseInt(req.params.groupId);\n      const group = await storage.getExpenseGroup(groupId);\n      \n      if (!group) {\n        return res.status(404).json({ message: \"Expense group not found\" });\n      }\n      \n      const expenses = await storage.getExpensesByGroupId(groupId);\n      return res.status(200).json(expenses);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.get(\"/api/expenses/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const expense = await storage.getExpense(id);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      return res.status(200).json(expense);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.put(\"/api/expenses/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updateData = req.body;\n      \n      const updatedExpense = await storage.updateExpense(id, updateData);\n      \n      if (!updatedExpense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      return res.status(200).json(updatedExpense);\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  app.delete(\"/api/expenses/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const result = await storage.deleteExpense(id);\n      \n      if (!result) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      return res.status(200).json({ message: \"Expense deleted successfully\" });\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error\" });\n    }\n  });\n\n  // Zapier AI-powered itinerary generation\n  app.post(\"/api/generate-itinerary\", async (req: Request, res: Response) => {\n    try {\n      // Schema per validare i dati in arrivo dal frontend\n      const zapierItinerarySchema = z.object({\n        citta: z.string().min(1, \"Città è richiesta\"),\n        date: z.object({\n          startDate: z.string(),\n          endDate: z.string()\n        }),\n        persone: z.number().int().min(1, \"Numero persone deve essere almeno 1\"),\n        interessi: z.array(z.string()).optional().default([]),\n        budget: z.enum([\"economico\", \"medio\", \"alto\"]).optional().default(\"medio\"),\n        esperienze: z.array(z.string()).optional().default([])\n      });\n      \n      const requestData = zapierItinerarySchema.parse(req.body);\n      \n      // Prepara i dati per Zapier webhook\n      const zapierPayload = {\n        destination: requestData.citta,\n        startDate: requestData.date.startDate,\n        endDate: requestData.date.endDate,\n        groupSize: requestData.persone,\n        budget: requestData.budget,\n        interests: requestData.interessi,\n        experiences: requestData.esperienze,\n        timestamp: new Date().toISOString(),\n        source: \"ByeBro OneClick Assistant\"\n      };\n      \n      // Invia i dati a Zapier webhook (se configurato)\n      let zapierResponse = null;\n      const zapierWebhookUrl = process.env.ZAPIER_WEBHOOK_URL;\n      \n      if (zapierWebhookUrl) {\n        try {\n          console.log(\"Sending data to Zapier webhook:\", zapierPayload);\n          \n          const response = await fetch(zapierWebhookUrl, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(zapierPayload)\n          });\n          \n          if (response.ok) {\n            zapierResponse = await response.json();\n            console.log(\"Zapier response received:\", zapierResponse);\n          } else {\n            console.error(\"Zapier webhook error:\", response.status, response.statusText);\n          }\n        } catch (error) {\n          console.error(\"Error calling Zapier webhook:\", error);\n        }\n      }\n      \n      // Se Zapier ha restituito un itinerario, usalo; altrimenti usa fallback\n      let itineraryContent = \"Itinerario personalizzato in generazione...\";\n      \n      if (zapierResponse && zapierResponse.itinerary) {\n        itineraryContent = zapierResponse.itinerary;\n      } else {\n        // Fallback: genera un itinerario di base\n        const duration = Math.ceil(\n          (new Date(requestData.date.endDate).getTime() - new Date(requestData.date.startDate).getTime()) \n          / (1000 * 60 * 60 * 24)\n        );\n        \n        itineraryContent = `🎉 Addio al Celibato a ${requestData.citta}\n        \n📅 Durata: ${duration} giorni per ${requestData.persone} persone\n💰 Budget: ${requestData.budget}\n🎯 Interessi: ${requestData.interessi.join(', ') || 'Divertimento generale'}\n\n📋 Itinerario personalizzato:\nStiamo elaborando il vostro itinerario perfetto con ChatGPT tramite Zapier...\n\n⏰ L'itinerario dettagliato arriverà a breve!`;\n      }\n      \n      // Crea un itinerario nel storage per persistenza\n      const itineraryToSave = {\n        tripId: req.body.tripId || 0,\n        name: `Addio al Celibato a ${requestData.citta}`,\n        description: itineraryContent,\n        duration: `${Math.ceil((new Date(requestData.date.endDate).getTime() - new Date(requestData.date.startDate).getTime()) / (1000 * 60 * 60 * 24))} giorni`,\n        price: requestData.budget === \"economico\" ? 299 : requestData.budget === \"medio\" ? 499 : 799,\n        image: `https://images.unsplash.com/photo-1469474968028-56623f02e42e?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&h=300&q=80`,\n        rating: \"5.0\",\n        highlights: [`${requestData.persone} persone`, `Budget ${requestData.budget}`, `Destinazione: ${requestData.citta}`],\n        includes: [\"Itinerario AI personalizzato\", \"Consigli locali\", \"Pianificazione ottimizzata\"]\n      };\n      \n      const savedItinerary = await storage.createItinerary(itineraryToSave);\n      \n      return res.status(200).json({\n        success: true,\n        itinerary: savedItinerary,\n        aiContent: itineraryContent,\n        zapierProcessed: !!zapierResponse,\n        message: zapierResponse ? \"Itinerario generato con AI\" : \"Itinerario in elaborazione tramite Zapier\"\n      });\n      \n    } catch (error: any) {\n      console.error(\"Error generating itinerary:\", error);\n      \n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ \n          message: \"Invalid itinerary parameters\", \n          errors: fromZodError(error).message \n        });\n      }\n      \n      return res.status(500).json({ \n        message: \"Failed to generate itinerary\",\n        error: error.message || String(error)\n      });\n    }\n  });\n\n  // Generated Itinerary routes (OneClick Assistant)\n  // Usa la mappatura centralizzata da cityMapping.ts (importata via aviasales.ts)\n\n  app.post(\"/api/generated-itineraries\", async (req: Request, res: Response) => {\n    try {\n      const { destination, startDate, endDate, participants, eventType, selectedExperiences } = req.body;\n      \n      if (!destination || !startDate || !endDate || !participants || !eventType) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      // Get user ID if authenticated\n      const userId = (req.user as any)?.id;\n\n      // Map destination to IATA code for flight search (using centralized mapping)\n      const destIATA = cityToIata(destination);\n      \n      // Search for flights (assuming origin is always Rome for now)\n      let flights = null;\n      if (destIATA) {\n        try {\n          const { searchCheapestFlights } = await import(\"./services/aviasales\");\n          const flightData = await searchCheapestFlights({\n            origin: 'ROM',\n            destination: destIATA,\n            departDate: startDate,\n            currency: 'EUR'\n          });\n          \n          // Parse flight data\n          const destCode = Object.keys(flightData.data)[0];\n          const offersObj = flightData.data[destCode] || {};\n          const offers = Object.values(offersObj as any)\n            .sort((a: any, b: any) => a.price - b.price)\n            .slice(0, 3)\n            .map((o: any) => ({\n              airline: o.airline,\n              price: o.price,\n              departureAt: o.departure_at,\n              returnAt: o.return_at,\n              flightNumber: o.flight_number\n            }));\n          \n          flights = offers.length > 0 ? offers[0] : null;\n        } catch (error) {\n          console.error(\"Flight search failed:\", error);\n        }\n      }\n\n      // Generate hotel recommendation (Mock hotel data)\n      const hotel = {\n        name: `Hotel Premium ${destination}`,\n        rating: 4.5,\n        pricePerNight: participants > 4 ? 150 : 100,\n        address: `Centro ${destination}` \n      };\n\n      // Generate daily activities based on selected experiences (Mock)\n  \n      const dailyActivities = Array.from({ length: Math.ceil((new Date(endDate).getTime() - new Date(startDate).getTime()) / (1000 * 60 * 60 * 24)) }, (_, i) => ({\n        day: i + 1,\n        activities: selectedExperiences?.slice(0, 2) || ['Esplorazione città', 'Vita notturna']\n      }));\n\n      // Calculate total price (using mock prices)\n      const flightPrice = flights ? flights.price * participants : 200 * participants;\n      const hotelPrice = hotel.pricePerNight * dailyActivities.length;\n      const activitiesPrice = dailyActivities.length * 150 * participants;\n      const totalPrice = flightPrice + hotelPrice + activitiesPrice;\n\n      // Save itinerary\n      const itinerary = await storage.createGeneratedItinerary({\n        userId,\n        destination,\n        startDate,\n        endDate,\n        participants,\n        eventType,\n        selectedExperiences: selectedExperiences || [],\n        flights,\n        hotel,\n        dailyActivities,\n        totalPrice,\n        status: \"draft\"\n      });\n\n      res.json(itinerary);\n    } catch (error) {\n      console.error(\"Error creating itinerary:\", error);\n      res.status(500).json({ error: \"Failed to create itinerary\" });\n    }\n  });\n\n  app.get(\"/api/generated-itineraries/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const itinerary = await storage.getGeneratedItinerary(id);\n      \n      if (!itinerary) {\n        return res.status(404).json({ error: \"Itinerary not found\" });\n      }\n\n      res.json(itinerary);\n    } catch (error) {\n      console.error(\"Error fetching itinerary:\", error);\n      res.status(500).json({ error: \"Failed to fetch itinerary\" });\n    }\n  });\n\n  // Register Zapier integration routes\n  registerZapierRoutes(app);\n\n  // Image Search API routes\n  app.get(\"/api/images/search\", async (req: Request, res: Response) => {\n    try {\n      const query = req.query.query as string;\n      const limit = parseInt(req.query.limit as string) || 10;\n      \n      if (!query) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Query parameter is required\" \n        });\n      }\n\n      const result = await imageSearchService.searchImages(query, limit);\n      return res.status(200).json(result);\n    } catch (error) {\n      console.error(\"Error in image search:\", error);\n      return res.status(500).json({ \n        success: false, \n        message: \"Internal server error\" \n      });\n    }\n  });\n\n  app.get(\"/api/images/destinations/:destination\", async (req: Request, res: Response) => {\n    try {\n      const destination = req.params.destination;\n      const count = parseInt(req.query.count as string) || 10;\n      \n      const result = await imageSearchService.searchDestinationImages(destination, count);\n      return res.status(200).json(result);\n    } catch (error) {\n      console.error(\"Error in destination image search:\", error);\n      return res.status(500).json({ \n        success: false, \n        message: \"Internal server error\" \n      });\n    }\n  });\n\n  app.get(\"/api/images/test\", async (req: Request, res: Response) => {\n    try {\n      const result = await imageSearchService.searchBarcelonaImages();\n      return res.status(200).json({\n        test: \"Barcelona aerial images\",\n        ...result\n      });\n    } catch (error) {\n      console.error(\"Error in image test:\", error);\n      return res.status(500).json({ \n        success: false, \n        message: \"Internal server error\" \n      });\n    }\n  });\n\n  // OpenAI Streaming Chat endpoint (with tool calls support)\n  app.post(\"/api/chat/openai-stream\", async (req: Request, res: Response) => {\n    try {\n      const { message, selectedDestination, tripDetails, conversationHistory, partyType, originCity } = req.body;\n\n      if (!process.env.OPENAI_API_KEY) {\n        return res.status(400).json({ \n          success: false, \n          error: \"OpenAI API key not configured\" \n        });\n      }\n\n      res.setHeader('Content-Type', 'text/event-stream');\n      res.setHeader('Cache-Control', 'no-cache');\n      res.setHeader('Connection', 'keep-alive');\n\n      const originIata = originCity ? (cityToIata(originCity) || \"\") : \"\";\n      const originCityName = originIata ? iataToCity(originIata) : \"\";\n\n      // Debug log only in development\n      if (process.env.NODE_ENV !== \"production\") {\n        console.log(\"🔍 OPENAI-STREAM:\", { selectedDestination, partyType, originCity });\n      }\n\n      const { streamOpenAIChatCompletionWithTools } = await import('./services/openai');\n\n      const context = {\n        selectedDestination,\n        tripDetails,\n        partyType: partyType || 'bachelor',\n        origin: originIata,\n        originCityName,\n      };\n\n      // Use the new tool-loop streaming function that properly executes tools\n      // and feeds results back to OpenAI for natural conversation continuation\n      for await (const chunk of streamOpenAIChatCompletionWithTools(message, context, conversationHistory || [])) {\n        if (chunk.type === \"content\") {\n          res.write(`data: ${JSON.stringify({ content: chunk.content })}\\n\\n`);\n        } else if (chunk.type === \"tool_call\") {\n          res.write(`data: ${JSON.stringify({ tool_call: chunk.toolCall })}\\n\\n`);\n        } else if (chunk.type === \"tool_result\") {\n          // Send tool results to frontend for state updates (e.g., showing flight cards)\n          res.write(`data: ${JSON.stringify({ tool_result: { name: chunk.name, result: chunk.result } })}\\n\\n`);\n        }\n      }\n\n      res.write(`data: ${JSON.stringify({ done: true })}\\n\\n`);\n      res.end();\n\n    } catch (error: any) {\n      console.error('OpenAI Streaming Error:', error);\n      res.write(`data: ${JSON.stringify({ error: error.message })}\\n\\n`);\n      res.end();\n    }\n  });\n\n  // OneClick Assistant chat endpoint (Fallback to OpenAI)\n  app.post(\"/api/chat/assistant\", async (req: Request, res: Response) => {\n    try {\n      const { message, selectedDestination, tripDetails, conversationState } = req.body;\n      \n      if (!process.env.OPENAI_API_KEY) {\n        return res.json({ \n          success: false, \n          error: \"OpenAI API key not configured\" \n        });\n      }\n\n      // Import OpenAI service\n      const { generateAssistantResponse } = await import('./services/openai');\n      \n      const result = await generateAssistantResponse({\n        userMessage: message,\n        selectedDestination,\n        tripDetails,\n        conversationState\n      });\n\n      res.json({\n        success: true,\n        response: result.response,\n        updatedTripDetails: result.updatedTripDetails,\n        updatedConversationState: result.updatedConversationState,\n        selectedDestination: result.selectedDestination\n      });\n\n    } catch (error: any) {\n      console.error('OpenAI Assistant Error:', error);\n      res.json({ \n        success: false, \n        error: error.message \n      });\n    }\n  });\n\n  // Amadeus Hotels - test ping endpoint (development only)\n  app.get(\"/api/hotels/test-ping\", (req: Request, res: Response) => {\n    if (process.env.NODE_ENV === \"production\") {\n      return res.status(403).json({ error: \"Test endpoint disabled in production\" });\n    }\n    res.json({ ok: true, message: \"Hotels route is alive\" });\n  });\n\n  // Amadeus Hotels - search endpoint\n  app.get(\"/api/hotels/search\", async (req: Request, res: Response) => {\n    try {\n      const { cityCode, checkInDate, checkOutDate, adults, currency } = req.query;\n\n      if (!cityCode || !checkInDate || !checkOutDate || !adults) {\n        return res.status(400).json({\n          error: \"cityCode, checkInDate, checkOutDate and adults are required\",\n        });\n      }\n\n      const hotels = await searchHotels({\n        cityCode: String(cityCode),\n        checkInDate: String(checkInDate),\n        checkOutDate: String(checkOutDate),\n        adults: Number(adults),\n        currency: currency ? String(currency) : \"EUR\",\n      });\n\n      return res.json({\n        cityCode,\n        checkInDate,\n        checkOutDate,\n        adults,\n        currency: currency || \"EUR\",\n        hotels,\n      });\n    } catch (err: any) {\n      console.error(\"Amadeus hotel search error:\", err.response?.data || err.message);\n      return res.status(500).json({\n        error: \"Hotel search failed\",\n        details: err.response?.data || err.message,\n      });\n    }\n  });\n\n  // Amadeus Hotels - booking endpoint (solo IN_APP)\n  app.post(\"/api/hotels/book\", async (req: Request, res: Response) => {\n    try {\n      const { offerId, guest } = req.body;\n\n      if (!offerId || !guest?.firstName || !guest?.lastName || !guest?.email) {\n        return res.status(400).json({\n          error: \"offerId, guest.firstName, guest.lastName, guest.email sono obbligatori\",\n        });\n      }\n\n      const result = await bookHotel({ offerId, guest });\n\n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      return res.json(result);\n    } catch (err: any) {\n      console.error(\"Hotel booking error:\", err.response?.data || err.message);\n      return res.status(500).json({\n        error: \"Booking failed\",\n        details: err.message,\n      });\n    }\n  });\n\n  // Flights search endpoint con checkoutUrl reali\n  app.get(\"/api/flights/search\", async (req: Request, res: Response) => {\n    try {\n      const { origin, destination, departDate, returnDate, passengers, currency } = req.query;\n\n      console.log(\"🔍 /api/flights/search called with:\", { origin, destination, departDate, returnDate, passengers });\n\n      if (!origin || !destination) {\n        return res.status(400).json({\n          error: \"origin e destination sono obbligatori\",\n        });\n      }\n\n      // Helper to extract IATA code from strings like \"Fiumicino (FCO)\" or just use cityToIata\n      const extractIata = (input: string): string => {\n        // First try to extract IATA from parentheses, e.g., \"Fiumicino (FCO)\" -> \"FCO\"\n        const parenMatch = input.match(/\\(([A-Z]{3})\\)/i);\n        if (parenMatch) {\n          return parenMatch[1].toUpperCase();\n        }\n        // Then try cityToIata lookup\n        const mapped = cityToIata(input);\n        if (mapped) {\n          return mapped;\n        }\n        // Finally, if it looks like a 3-letter code already, use it\n        if (/^[A-Z]{3}$/i.test(input.trim())) {\n          return input.trim().toUpperCase();\n        }\n        // Last resort: take first 3 characters\n        return input.substring(0, 3).toUpperCase();\n      };\n\n      const originIata = extractIata(String(origin));\n      const destIata = extractIata(String(destination));\n\n      console.log(\"✈️ Resolved IATA codes:\", { originIata, destIata });\n\n      let numAdults = passengers ? parseInt(String(passengers), 10) : 1;\n      if (numAdults > 9) {\n        console.log(`👥 /api/flights/search: capping passengers ${numAdults} → 1 (Amadeus max 9)`);\n        numAdults = 1;\n      }\n\n      const flightResults = await searchFlights({\n        originCode: originIata,\n        destinationCode: destIata,\n        departureDate: departDate ? String(departDate) : \"\",\n        returnDate: returnDate ? String(returnDate) : undefined,\n        adults: numAdults,\n        currency: currency ? String(currency) : \"EUR\",\n      });\n\n      console.log(\"📦 Amadeus returned\", flightResults.length, \"flights\");\n\n      // Transform to match expected client format + add Aviasales checkout URLs\n      const flights = flightResults\n        .slice(0, 5)\n        .map((f, idx) => {\n          const depDate = f.outbound[0]?.departure.at?.slice(0, 10) || String(departDate);\n          const retDate = f.inbound?.[0]?.departure.at?.slice(0, 10) || String(returnDate) || depDate;\n          const depDay = depDate.slice(8, 10);\n          const depMonth = depDate.slice(5, 7);\n          const retDay = retDate.slice(8, 10);\n          const retMonth = retDate.slice(5, 7);\n\n          const checkoutUrl = `https://www.aviasales.com/search/${originIata}${depDay}${depMonth}${destIata}${retDay}${retMonth}${numAdults}?marker=${process.env.AVIASALES_PARTNER_ID || \"byebi\"}`;\n\n          return {\n            flightId: `flight-${idx + 1}`,\n            airline: f.airlines.join(\", \"),\n            price: f.price,\n            currency: f.currency,\n            departureAt: f.outbound[0]?.departure.at,\n            returnAt: f.inbound?.[0]?.departure.at,\n            stops: f.stops,\n            duration: f.totalDuration,\n            direct: f.stops === 0,\n            bookingFlow: \"REDIRECT\" as const,\n            checkoutUrl,\n          };\n        });\n\n      return res.json({\n        origin: originIata,\n        destination: destIata,\n        departDate,\n        flights,\n      });\n    } catch (err: any) {\n      console.error(\"Flight search error:\", err.response?.data || err.message);\n      return res.status(500).json({\n        error: \"Flight search failed\",\n        details: err.message,\n      });\n    }\n  });\n\n  const httpServer = createServer(app);\n\n  return httpServer;\n}\n","path":null,"size_bytes":31147,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\nexport default function NotFound() {\n  const { t } = useTranslation();\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">{t('notFound.title')}</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            {t('notFound.desc')}\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":784,"size_tokens":null},"client/src/hooks/use-infinite-scroll.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from 'react';\nimport { throttle } from '@/lib/performance';\n\ninterface InfiniteScrollOptions {\n  /** Numero di elementi da caricare per pagina */\n  pageSize?: number;\n  /** Threshold per caricare altri elementi prima di raggiungere la fine della lista (pixel) */\n  threshold?: number;\n  /** Delay in ms per throttle della funzione di scroll */\n  throttleDelay?: number;\n  /** Se true, carica automaticamente nuovi dati quando l'utente è vicino alla fine della lista */\n  autoLoad?: boolean;\n}\n\n/**\n * Hook per implementare infinite scroll in modo ottimizzato\n * \n * @param totalItems Numero totale di items disponibili\n * @param options Opzioni di configurazione\n * @returns Oggetto con visibleItems, hasMore, loadMore, containerRef\n */\nexport function useInfiniteScroll<T>(\n  items: T[],\n  options: InfiniteScrollOptions = {}\n) {\n  const {\n    pageSize = 10,\n    threshold = 200,\n    throttleDelay = 200,\n    autoLoad = true,\n  } = options;\n\n  const [visibleItemsCount, setVisibleItemsCount] = useState(pageSize);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const observer = useRef<IntersectionObserver | null>(null);\n  const loadingRef = useRef<HTMLDivElement>(null);\n\n  // Calcola se ci sono altri elementi da caricare\n  const hasMore = visibleItemsCount < items.length;\n\n  // Carica più elementi\n  const loadMore = useCallback(() => {\n    if (hasMore) {\n      setVisibleItemsCount(prev => Math.min(prev + pageSize, items.length));\n    }\n  }, [hasMore, items.length, pageSize]);\n\n  // Throttle della funzione loadMore per evitare chiamate eccessive\n  const throttledLoadMore = throttle(loadMore, throttleDelay);\n\n  // Usiamo IntersectionObserver per rilevare quando siamo vicini alla fine della lista\n  useEffect(() => {\n    if (autoLoad && loadingRef.current) {\n      observer.current = new IntersectionObserver(\n        entries => {\n          const target = entries[0];\n          if (target.isIntersecting && hasMore) {\n            throttledLoadMore();\n          }\n        },\n        {\n          root: null,\n          rootMargin: `0px 0px ${threshold}px 0px`,\n          threshold: 0.1,\n        }\n      );\n\n      observer.current.observe(loadingRef.current);\n\n      return () => {\n        if (observer.current && loadingRef.current) {\n          observer.current.unobserve(loadingRef.current);\n        }\n      };\n    }\n  }, [hasMore, throttledLoadMore, threshold, autoLoad]);\n\n  // Calcola gli elementi visibili\n  const visibleItems = items.slice(0, visibleItemsCount);\n\n  return {\n    visibleItems,\n    hasMore,\n    loadMore: throttledLoadMore,\n    containerRef,\n    loadingRef,\n  };\n}\n\ninterface VirtualListOptions {\n  /** Altezza approssimativa di ogni item in pixel */\n  itemHeight?: number;\n  /** Numero di elementi di overscan (elementi renderizzati ma non visibili) */\n  overscan?: number;\n}\n\n/**\n * Hook per implementare virtual list (windowing) per liste molto lunghe\n * Rende solo gli elementi visibili nella viewport + overscan\n */\nexport function useVirtualList<T>(\n  items: T[],\n  options: VirtualListOptions = {}\n) {\n  const { \n    itemHeight = 50, \n    overscan = 3 \n  } = options;\n  \n  const [visibleRange, setVisibleRange] = useState({ start: 0, end: 10 });\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  // Calcola l'intervallo di elementi visibili basato sullo scroll\n  const calculateVisibleRange = useCallback(\n    throttle(() => {\n      if (!containerRef.current) return;\n\n      const { scrollTop, clientHeight } = containerRef.current;\n      \n      // Calcola gli indici di inizio e fine\n      let start = Math.floor(scrollTop / itemHeight) - overscan;\n      let end = Math.ceil((scrollTop + clientHeight) / itemHeight) + overscan;\n      \n      // Assicurati che gli indici siano nell'intervallo corretto\n      start = Math.max(0, start);\n      end = Math.min(items.length, end);\n      \n      setVisibleRange({ start, end });\n    }, 100),\n    [items.length, itemHeight, overscan]\n  );\n\n  // Aggiungi event listener per lo scroll\n  useEffect(() => {\n    const container = containerRef.current;\n    if (container) {\n      container.addEventListener('scroll', calculateVisibleRange, { passive: true });\n      // Calcola l'intervallo iniziale\n      calculateVisibleRange();\n      \n      return () => {\n        container.removeEventListener('scroll', calculateVisibleRange);\n      };\n    }\n  }, [calculateVisibleRange]);\n\n  // Elementi visibili e spaziatori\n  const visibleItems = items.slice(visibleRange.start, visibleRange.end);\n  const totalHeight = items.length * itemHeight;\n  const offsetY = visibleRange.start * itemHeight;\n\n  return {\n    containerRef,\n    visibleItems,\n    totalHeight,\n    offsetY,\n    itemHeight,\n  };\n}","path":null,"size_bytes":4727,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport NotFound from \"@/pages/not-found\";\nimport Home from \"@/pages/Home\";\nimport HomeBride from \"@/pages/HomeBride\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport SecretBlogPage from \"@/pages/SecretBlogPage\";\nimport MerchandisePage from \"@/pages/MerchandisePage\";\nimport Itinerary from \"@/pages/Itinerary\";\nimport Checkout from \"@/pages/Checkout\";\nimport SplittaBroPage from \"@/pages/SplittaBroPage\";\nimport SplittaBridePage from \"@/pages/SplittaBridePage\";\nimport DestinationsPage from \"@/pages/DestinationsPage\";\nimport ExperiencesPage from \"@/pages/ExperiencesPage\";\nimport OneClickPackagePage from \"@/pages/OneClickPackagePage\";\nimport ZapierWebhooksPage from \"@/pages/ZapierWebhooksPage\";\nimport ImageTestPage from \"@/pages/ImageTestPage\";\nimport AuthPage from \"@/pages/auth-page\";\nimport { AuthProvider } from \"@/hooks/use-auth\";\nimport { ProtectedRoute } from \"@/lib/protected-route\";\nimport { lazy, Suspense, useState, useEffect } from \"react\";\nimport PerformanceOptimizer from \"@/lib/performance-optimizer\";\nimport BrandSelection from \"@/components/BrandSelection\";\nimport { LanguageProvider } from \"@/contexts/LanguageContext\";\n\nfunction Router() {\n  const [selectedBrand, setSelectedBrand] = useState<'byebro' | 'byebride' | null>(null);\n\n  useEffect(() => {\n    const savedBrand = localStorage.getItem('selectedBrand') as 'byebro' | 'byebride' | null;\n    if (savedBrand) {\n      setSelectedBrand(savedBrand);\n    }\n  }, []);\n\n  const handleBrandSelection = (brand: 'byebro' | 'byebride') => {\n    setSelectedBrand(brand);\n    localStorage.setItem('selectedBrand', brand);\n  };\n\n  if (!selectedBrand) {\n    return <BrandSelection onSelectBrand={handleBrandSelection} />;\n  }\n\n  const HomePage = selectedBrand === 'byebride' ? HomeBride : Home;\n  const SplittaPage = selectedBrand === 'byebride' ? SplittaBridePage : SplittaBroPage;\n\n  return (\n    <Switch>\n      <Route path=\"/\" component={HomePage} />\n      <ProtectedRoute path=\"/dashboard\" component={Dashboard} />\n      <Route path=\"/destinations\" component={DestinationsPage} />\n      <Route path=\"/experiences\" component={ExperiencesPage} />\n      <ProtectedRoute path=\"/secret-blog\" component={SecretBlogPage} />\n      <Route path=\"/merchandise\" component={MerchandisePage} />\n      <Route path=\"/itinerary\" component={Itinerary} />\n      <Route path=\"/checkout\" component={Checkout} />\n      <Route path=\"/splitta-bro\" component={SplittaPage} />\n      <Route path=\"/splitta-bride\" component={SplittaPage} />\n      <Route path=\"/one-click-package\" component={OneClickPackagePage} />\n      <Route path=\"/image-test\" component={ImageTestPage} />\n      <Route path=\"/zapier-webhooks\" component={ZapierWebhooksPage} />\n      <Route path=\"/auth\" component={AuthPage} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <AuthProvider>\n        <LanguageProvider>\n          <TooltipProvider>\n            <Toaster />\n            <PerformanceOptimizer />\n            <Suspense fallback={\n              <div className=\"flex items-center justify-center min-h-screen\">\n                <div className=\"animate-pulse text-xl font-semibold\">Loading...</div>\n              </div>\n            }>\n              <Router />\n            </Suspense>\n          </TooltipProvider>\n        </LanguageProvider>\n      </AuthProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":3686,"size_tokens":null},"client/src/components/TripPlanningForm.tsx":{"content":"import React, { useState, useEffect, useRef } from \"react\";\nimport { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Destination, Experience } from \"@shared/schema\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { format } from \"date-fns\";\nimport { useLocation } from \"wouter\";\nimport ReactCountryFlag from \"react-country-flag\";\n\nconst formSchema = z.object({\n  name: z.string().min(2, \"Trip name must be at least 2 characters\"),\n  participants: z.number().min(1, \"Must have at least 1 participant\").max(30, \"Maximum 30 participants\"),\n  startDate: z.string().nonempty(\"Start date is required\"),\n  endDate: z.string().nonempty(\"End date is required\"),\n  departureCity: z.string().nonempty(\"Please select a departure city\"),\n  destinations: z.array(z.string()).nonempty(\"Select at least one destination\"),\n  experienceType: z.string().nonempty(\"Please select an experience type\"),\n  budget: z.number().min(200, \"Minimum budget is €200\").max(2000, \"Maximum budget is €2000\"),\n  activities: z.array(z.string()).nonempty(\"Select at least one activity\"),\n  specialRequests: z.string().optional(),\n  includeMerch: z.boolean().default(false),\n}).refine((data) => {\n  // Verifica che la data di fine sia successiva alla data di inizio\n  if (!data.startDate || !data.endDate) return true;\n  const start = new Date(data.startDate);\n  const end = new Date(data.endDate);\n  return end >= start;\n}, {\n  message: \"End date must be after start date\",\n  path: [\"endDate\"]\n});\n\ntype FormValues = z.infer<typeof formSchema>;\n\n// Lista di città europee per l'autocompletamento\nconst europeanCities = [\n  // Italia\n  \"Roma\", \"Milano\", \"Napoli\", \"Torino\", \"Palermo\", \"Genova\", \"Bologna\", \"Firenze\", \"Bari\", \"Catania\", \"Venezia\", \"Verona\",\n  // Germania  \n  \"Berlin\", \"Hamburg\", \"Munich\", \"Cologne\", \"Frankfurt\", \"Stuttgart\", \"Düsseldorf\", \"Leipzig\", \"Dortmund\", \"Essen\", \"Bremen\", \"Dresden\",\n  // Francia\n  \"Paris\", \"Marseille\", \"Lyon\", \"Toulouse\", \"Nice\", \"Nantes\", \"Strasbourg\", \"Montpellier\", \"Bordeaux\", \"Lille\", \"Rennes\", \"Reims\",\n  // Spagna\n  \"Madrid\", \"Barcelona\", \"Valencia\", \"Seville\", \"Zaragoza\", \"Málaga\", \"Murcia\", \"Palma\", \"Las Palmas\", \"Bilbao\", \"Alicante\", \"Córdoba\",\n  // Regno Unito\n  \"London\", \"Birmingham\", \"Manchester\", \"Glasgow\", \"Liverpool\", \"Bristol\", \"Sheffield\", \"Leeds\", \"Edinburgh\", \"Leicester\", \"Coventry\", \"Cardiff\",\n  // Paesi Bassi\n  \"Amsterdam\", \"Rotterdam\", \"The Hague\", \"Utrecht\", \"Eindhoven\", \"Tilburg\", \"Groningen\", \"Almere\", \"Breda\", \"Nijmegen\", \"Apeldoorn\", \"Haarlem\",\n  // Belgio\n  \"Brussels\", \"Antwerp\", \"Ghent\", \"Charleroi\", \"Liège\", \"Bruges\", \"Namur\", \"Leuven\", \"Mons\", \"Aalst\", \"Mechelen\", \"Hasselt\",\n  // Portogallo\n  \"Lisbon\", \"Porto\", \"Amadora\", \"Braga\", \"Coimbra\", \"Funchal\", \"Setúbal\", \"Aveiro\", \"Évora\", \"Faro\", \"Guimarães\", \"Viseu\",\n  // Svizzera\n  \"Zurich\", \"Geneva\", \"Basel\", \"Bern\", \"Lausanne\", \"Lucerne\", \"St. Gallen\", \"Lugano\", \"Biel\", \"Thun\", \"Köniz\", \"Winterthur\",\n  // Austria\n  \"Vienna\", \"Graz\", \"Linz\", \"Salzburg\", \"Innsbruck\", \"Klagenfurt\", \"Villach\", \"Wels\", \"Dornbirn\", \"Wiener Neustadt\", \"Feldkirch\", \"Bregenz\",\n  // Repubblica Ceca\n  \"Prague\", \"Brno\", \"Ostrava\", \"Plzeň\", \"Liberec\", \"Olomouc\", \"České Budějovice\", \"Hradec Králové\", \"Ústí nad Labem\", \"Pardubice\",\n  // Polonia\n  \"Warsaw\", \"Kraków\", \"Łódź\", \"Wrocław\", \"Poznań\", \"Gdańsk\", \"Szczecin\", \"Bydgoszcz\", \"Lublin\", \"Katowice\", \"Białystok\", \"Gdynia\",\n  // Svezia\n  \"Stockholm\", \"Gothenburg\", \"Malmö\", \"Uppsala\", \"Västerås\", \"Örebro\", \"Linköping\", \"Helsingborg\", \"Norrköping\", \"Jönköping\", \"Lund\", \"Umeå\",\n  // Norvegia\n  \"Oslo\", \"Bergen\", \"Trondheim\", \"Stavanger\", \"Drammen\", \"Fredrikstad\", \"Kristiansand\", \"Sandnes\", \"Tromsø\", \"Sarpsborg\", \"Skien\", \"Ålesund\",\n  // Danimarca\n  \"Copenhagen\", \"Aarhus\", \"Odense\", \"Aalborg\", \"Frederiksberg\", \"Esbjerg\", \"Randers\", \"Kolding\", \"Horsens\", \"Vejle\", \"Roskilde\", \"Herning\",\n  // Finlandia\n  \"Helsinki\", \"Espoo\", \"Tampere\", \"Vantaa\", \"Oulu\", \"Turku\", \"Jyväskylä\", \"Lahti\", \"Kuopio\", \"Kouvola\", \"Pori\", \"Joensuu\",\n  // Irlanda\n  \"Dublin\", \"Cork\", \"Limerick\", \"Galway\", \"Waterford\", \"Drogheda\", \"Dundalk\", \"Swords\", \"Bray\", \"Navan\", \"Ennis\", \"Kilkenny\",\n  // Grecia\n  \"Athens\", \"Thessaloniki\", \"Patras\", \"Heraklion\", \"Larissa\", \"Volos\", \"Ioannina\", \"Chania\", \"Chalcis\", \"Agrinio\", \"Katerini\", \"Trikala\"\n];\n\nconst activities = [\n  { value: \"nightclubs\", label: \"Nightclubs\" },\n  { value: \"barCrawl\", label: \"Bar Crawl\" },\n  { value: \"waterSports\", label: \"Water Sports\" },\n  { value: \"breweryTours\", label: \"Brewery Tours\" },\n  { value: \"sightseeing\", label: \"Sightseeing\" },\n  { value: \"foodTours\", label: \"Food Tours\" },\n  { value: \"sportsEvents\", label: \"Sports Events\" },\n  { value: \"boatParties\", label: \"Boat Parties\" },\n  { value: \"casinoNight\", label: \"Casino Night\" },\n];\n\n// Funzione per convertire il nome del paese in codice ISO\nconst getCountryCode = (country: string): string => {\n  // Mappatura dei nomi dei paesi con i loro codici ISO\n  const countryMap: Record<string, string> = {\n    \"Netherlands\": \"NL\",\n    \"Germany\": \"DE\",\n    \"Spain\": \"ES\",\n    \"Italy\": \"IT\",\n    \"France\": \"FR\",\n    \"United Kingdom\": \"GB\",\n    \"Czech Republic\": \"CZ\",\n    \"Croatia\": \"HR\",\n    \"Poland\": \"PL\",\n    \"Belgium\": \"BE\",\n    \"Portugal\": \"PT\",\n    \"Greece\": \"GR\",\n    \"Sweden\": \"SE\",\n    \"Denmark\": \"DK\",\n    \"Austria\": \"AT\",\n    \"Hungary\": \"HU\",\n    \"Ireland\": \"IE\",\n    \"Switzerland\": \"CH\"\n  };\n  \n  return countryMap[country] || \"EU\"; // Usa l'UE come fallback\n};\n\nexport default function TripPlanningForm() {\n  const [step, setStep] = useState(1);\n  const [budgetDisplay, setBudgetDisplay] = useState(\"800\");\n  const [citySearchTerm, setCitySearchTerm] = useState(\"\");\n  const [filteredCities, setFilteredCities] = useState<string[]>([]);\n  const [showCityDropdown, setShowCityDropdown] = useState(false);\n  const formRef = useRef<HTMLDivElement>(null);\n  const cityDropdownRef = useRef<HTMLDivElement>(null);\n  const { toast } = useToast();\n  const { user, isAuthenticated } = useAuth();\n  const [location, setLocation] = useLocation();\n\n  // Fetch destinations and experience types\n  const { data: destinations } = useQuery<Destination[]>({\n    queryKey: [\"/api/destinations\"],\n  });\n\n  const { data: experiences } = useQuery<Experience[]>({\n    queryKey: [\"/api/experiences\"],\n  });\n\n  // Form setup with default values to avoid validation issues\n  const form = useForm<FormValues>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      name: \"Bachelor Party Trip\",\n      participants: 6,\n      startDate: format(new Date(), \"yyyy-MM-dd\"),\n      endDate: format(new Date(new Date().setDate(new Date().getDate() + 3)), \"yyyy-MM-dd\"),\n      departureCity: \"Berlin\",\n      destinations: destinations && destinations.length > 0 ? [`${destinations[0].name}, ${destinations[0].country}`] : [\"Rome, Italy\"],\n      experienceType: experiences && experiences.length > 0 ? experiences[0].name : \"The Ultimate BroNight\",\n      budget: 800,\n      activities: [\"nightclubs\", \"barCrawl\"],\n      specialRequests: \"\",\n      includeMerch: false,\n    },\n  });\n\n  // Handle form progress\n  const goToNextStep = () => {\n    if (step === 1) {\n      const basicFields = [\"name\", \"participants\", \"startDate\", \"endDate\", \"departureCity\"];\n      const basicValid = basicFields.every(fieldName => \n        !form.formState.errors[fieldName as keyof FormValues]);\n      \n      if (basicValid) {\n        setStep(2);\n      } else {\n        toast({\n          title: \"Missing information\",\n          description: \"Please fill in all required fields\",\n          variant: \"destructive\",\n        });\n      }\n    } else if (step === 2) {\n      const detailFields = [\"destinations\", \"experienceType\", \"budget\"];\n      const detailsValid = detailFields.every(fieldName => \n        !form.formState.errors[fieldName as keyof FormValues]);\n      \n      if (detailsValid) {\n        setStep(3);\n      } else {\n        toast({\n          title: \"Missing information\",\n          description: \"Please fill in all required fields\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  };\n\n  const goToPreviousStep = () => {\n    if (step > 1) {\n      setStep(step - 1);\n    }\n  };\n\n  // Handle form submission\n  const onSubmit = async (data: FormValues) => {\n    try {\n      // Visualizza un messaggio di debug per controllare i dati inviati\n      console.log(\"Form submitted with data:\", data);\n      \n      toast({\n        title: \"Form submitted\",\n        description: \"Processing your request...\",\n      });\n      \n      // Se l'utente è autenticato, salviamo il viaggio nel database\n      let tripId = 0;\n      \n      if (isAuthenticated && user) {\n        console.log(\"User is authenticated, saving trip to database\");\n        const tripData = {\n          ...data,\n          userId: user.id\n        };\n        \n        const response = await apiRequest(\"POST\", \"/api/trips\", tripData);\n        const trip = await response.json();\n        tripId = trip.id;\n        \n        toast({\n          title: \"Trip saved!\",\n          description: \"Your trip has been created. Generating itineraries with AI...\",\n        });\n        \n        // Invalidate queries to refetch data\n        queryClient.invalidateQueries({ queryKey: [`/api/trips/user/${user.id}`] });\n      } else {\n        console.log(\"User is not authenticated, proceeding with itinerary generation only\");\n        // Utente non autenticato, possiamo comunque generare l'itinerario\n        toast({\n          title: \"Generating itinerary\",\n          description: \"Creating your itinerary. Note: login to save this trip for future reference.\",\n        });\n      }\n      \n      // Calcola il numero di giorni dalla data di inizio e fine\n      const startDate = new Date(data.startDate);\n      const endDate = new Date(data.endDate);\n      const tripDays = Math.max(1, Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1);\n      \n      // Usa OpenAI per generare un itinerario personalizzato\n      const primaryDestination = data.destinations[0].split(', ')[0]; // Prende la prima destinazione\n      const country = data.destinations[0].split(', ')[1]; // Prende il paese della prima destinazione\n      \n      // Determina il budget in base al valore scelto\n      let budgetLevel: \"budget\" | \"standard\" | \"luxury\" = \"standard\";\n      if (data.budget < 500) budgetLevel = \"budget\";\n      else if (data.budget > 1200) budgetLevel = \"luxury\";\n      \n      console.log(\"Budget level determined:\", budgetLevel);\n      \n      // Prepara i dati per la generazione dell'itinerario\n      // Se per qualche motivo il paese è undefined, impostiamo \"Spain\" come valore predefinito per evitare errori\n      const itineraryRequest = {\n        tripId, // Usa l'ID del viaggio salvato o 0 se non autenticato\n        userId: user?.id, // Potrebbe essere undefined se non autenticato\n        destination: primaryDestination,\n        country: country || \"Spain\",  // Assicuriamoci che il country non sia mai undefined\n        days: tripDays,\n        groupSize: data.participants,\n        budget: budgetLevel,\n        interests: data.activities,\n        theme: data.experienceType\n      };\n      \n      console.log(\"Sending itinerary request:\", JSON.stringify(itineraryRequest));\n      \n      try {\n        // Mostra un toast per informare l'utente che l'IA sta generando l'itinerario\n        toast({\n          title: \"AI Planning\",\n          description: \"Our AI is crafting the perfect bachelor party based on your preferences. This might take a moment...\",\n        });\n        \n        // Chiamata all'API per generare l'itinerario con OpenAI\n        const response = await apiRequest(\"POST\", \"/api/generate-itinerary\", itineraryRequest);\n        const result = await response.json();\n        \n        // Save TripContext to localStorage (same for authenticated and guest)\n        localStorage.setItem('currentItinerary', JSON.stringify({\n          destination: result.destination || primaryDestination,\n          origin: data.departureCity || 'Italia',\n          startDate: data.startDate,\n          endDate: data.endDate,\n          people: data.participants,\n          aviasalesCheckoutUrl: '',\n          flightLabel: `${data.departureCity || 'Italia'} → ${primaryDestination}`,\n          itineraryData: result\n        }));\n        \n        if (isAuthenticated && tripId > 0) {\n          // Invalida la cache per i nuovi itinerari solo se l'utente è autenticato\n          queryClient.invalidateQueries({ queryKey: [`/api/trips/${tripId}/itineraries`] });\n        }\n        \n        if (!isAuthenticated) {\n          toast({\n            title: \"Itinerary Generated Successfully!\",\n            description: \"Create an account to save this itinerary for future reference!\",\n            variant: \"default\",\n          });\n        }\n        \n        // Navigate to unified itinerary page\n        setLocation(`/itinerary`);\n      } catch (err) {\n        console.error(\"Error generating AI itinerary:\", err);\n        \n        // Nel caso in cui ci sia un problema con l'API OpenAI, il server dovrebbe comunque ritornare\n        // un itinerario di fallback. Se arriviamo qui, c'è un problema con la richiesta stessa.\n        try {\n          // Se l'errore è un oggetto JSON, proviamo a visualizzare il messaggio di errore\n          if (err instanceof Error) {\n            console.error(\"Error message:\", err.message);\n          }\n          \n          if (err instanceof Response) {\n            const responseText = await err.text();\n            console.error(\"Server response:\", responseText);\n          }\n        } catch (parseErr) {\n          console.error(\"Error parsing error response:\", parseErr);\n        }\n        \n        toast({\n          title: \"Error Generating Itinerary\",\n          description: \"There was a problem creating your itinerary. The system will try to use a fallback template instead.\",\n          variant: \"destructive\",\n        });\n        \n        // Salva fallback in currentItinerary e naviga alla pagina unica\n        localStorage.setItem('currentItinerary', JSON.stringify({\n          destination: primaryDestination,\n          origin: data.departureCity || 'Italia',\n          startDate: data.startDate,\n          endDate: data.endDate,\n          people: data.participants,\n          aviasalesCheckoutUrl: '',\n          flightLabel: `${data.departureCity || 'Italia'} → ${primaryDestination}`,\n          itineraryData: {\n            title: \"Bachelor Party in \" + primaryDestination,\n            destination: primaryDestination + \", \" + (country || \"Spain\"),\n            summary: \"A customized experience that matches your preferences.\",\n            days: [],\n            tips: [\"Stay hydrated\", \"Plan transportation in advance\", \"Keep your group together\"],\n            estimatedTotalCost: \"$500-$1000 per person\"\n          }\n        }));\n        \n        setLocation(`/itinerary`);\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"There was a problem saving your trip. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Update budget display when slider changes\n  useEffect(() => {\n    const budgetValue = form.watch(\"budget\");\n    setBudgetDisplay(budgetValue.toString());\n  }, [form.watch(\"budget\")]);\n\n  // Gestisci la ricerca delle città\n  const handleCitySearch = (value: string) => {\n    setCitySearchTerm(value);\n    \n    if (value.length < 2) {\n      setFilteredCities([]);\n      setShowCityDropdown(false);\n      return;\n    }\n    \n    const matches = europeanCities.filter(city => \n      city.toLowerCase().includes(value.toLowerCase())\n    ).slice(0, 5); // Mostra solo i primi 5 risultati\n    \n    setFilteredCities(matches);\n    setShowCityDropdown(matches.length > 0);\n  };\n  \n  // Seleziona una città dalla lista\n  const selectCity = (city: string) => {\n    form.setValue(\"departureCity\", city);\n    setCitySearchTerm(city);\n    setShowCityDropdown(false);\n  };\n  \n  // Chiudi il dropdown quando si clicca al di fuori\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (cityDropdownRef.current && !cityDropdownRef.current.contains(event.target as Node)) {\n        setShowCityDropdown(false);\n      }\n    };\n    \n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, []);\n  \n  // Verifica validità della città selezionata\n  useEffect(() => {\n    // Controlla se la città inserita è nella lista\n    const cityValue = form.watch(\"departureCity\");\n    if (cityValue && !europeanCities.includes(cityValue)) {\n      form.setError(\"departureCity\", {\n        type: \"manual\",\n        message: \"Please select a valid city from the list\"\n      });\n    } else {\n      form.clearErrors(\"departureCity\");\n    }\n  }, [form.watch(\"departureCity\")]);\n  \n  // Scroll to top of form when changing steps\n  useEffect(() => {\n    if (formRef.current) {\n      formRef.current.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n    }\n  }, [step]);\n\n  // Define step indicators based on current step\n  const stepOneActive = step >= 1;\n  const stepTwoActive = step >= 2;\n  const stepThreeActive = step >= 3;\n  const progressOneTwo = step >= 2 ? \"100%\" : \"0%\";\n  const progressTwoThree = step >= 3 ? \"100%\" : \"0%\";\n\n  return (\n    <section id=\"trip-planning\" className=\"py-16 bg-white\" ref={formRef}>\n      <div className=\"container mx-auto px-4\">\n        <div className=\"max-w-4xl mx-auto\">\n          <div className=\"text-center mb-10\">\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">Plan Your Trip</h2>\n            <p className=\"text-gray-600\">Tell us what you're looking for and we'll create the perfect bachelor party itinerary.</p>\n          </div>\n          \n          <div className=\"bg-white shadow-xl rounded-xl overflow-hidden\">\n            {/* Progress Steps */}\n            <div className=\"bg-gray-50 p-4 border-b\">\n              <div className=\"flex justify-between\">\n                <div className=\"flex flex-col items-center\">\n                  <div className={`w-8 h-8 rounded-full ${stepOneActive ? 'bg-red-600' : 'bg-gray-300'} text-white flex items-center justify-center font-bold`}>1</div>\n                  <span className=\"text-xs mt-1 font-medium\">Basics</span>\n                </div>\n                <div className=\"w-full max-w-[80px] flex items-center\">\n                  <div className=\"h-1 w-full bg-gray-300 rounded\">\n                    <div className=\"h-1 w-full bg-red-600 rounded transition-all duration-300\" style={{ width: progressOneTwo }}></div>\n                  </div>\n                </div>\n                <div className=\"flex flex-col items-center\">\n                  <div className={`w-8 h-8 rounded-full ${stepTwoActive ? 'bg-red-600' : 'bg-gray-300'} text-white flex items-center justify-center font-bold`}>2</div>\n                  <span className={`text-xs mt-1 font-medium ${stepTwoActive ? 'text-dark' : 'text-gray-500'}`}>Details</span>\n                </div>\n                <div className=\"w-full max-w-[80px] flex items-center\">\n                  <div className=\"h-1 w-full bg-gray-300 rounded\">\n                    <div className=\"h-1 bg-red-600 rounded transition-all duration-300\" style={{ width: progressTwoThree }}></div>\n                  </div>\n                </div>\n                <div className=\"flex flex-col items-center\">\n                  <div className={`w-8 h-8 rounded-full ${stepThreeActive ? 'bg-red-600' : 'bg-gray-300'} text-white flex items-center justify-center font-bold`}>3</div>\n                  <span className={`text-xs mt-1 font-medium ${stepThreeActive ? 'text-dark' : 'text-gray-500'}`}>Activities</span>\n                </div>\n              </div>\n            </div>\n            \n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit, (errors) => {\n                console.error('Form validation failed with errors:', errors);\n                toast({\n                  title: \"Form Validation Failed\",\n                  description: \"Please check the form for errors and try again.\",\n                  variant: \"destructive\",\n                });\n              })}>\n                {/* Step 1: Basics */}\n                {step === 1 && (\n                  <div className=\"p-6 [&_input]:bg-white\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Trip Name</FormLabel>\n                            <FormControl>\n                              <Input placeholder=\"Mike's Last Ride\" className=\"bg-white\" {...field} />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      \n                      <FormField\n                        control={form.control}\n                        name=\"participants\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Number of Participants</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"number\" \n                                min=\"1\" \n                                max=\"30\" \n                                placeholder=\"6\" \n                                className=\"bg-white\"\n                                {...field}\n                                onChange={e => field.onChange(Number(e.target.value))}\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"mb-6\">\n                      <FormLabel className=\"block text-sm font-medium text-gray-700 mb-2\">When are you planning to go?</FormLabel>\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={form.control}\n                          name=\"startDate\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"block text-xs text-gray-500 mb-1\">Start Date</FormLabel>\n                              <FormControl>\n                                <Input type=\"date\" {...field} />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        \n                        <FormField\n                          control={form.control}\n                          name=\"endDate\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel className=\"block text-xs text-gray-500 mb-1\">End Date</FormLabel>\n                              <FormControl>\n                                <Input type=\"date\" {...field} />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n                    </div>\n                    \n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"departureCity\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Where are you traveling from?</FormLabel>\n                            <div className=\"relative\" ref={cityDropdownRef}>\n                              <FormControl>\n                                <Input \n                                  placeholder=\"Type to search cities (e.g. 'Rome', 'Berlin')\" \n                                  value={citySearchTerm}\n                                  onChange={(e) => {\n                                    handleCitySearch(e.target.value);\n                                    field.onChange(e.target.value);\n                                  }}\n                                  onFocus={() => {\n                                    if (citySearchTerm.length >= 2) {\n                                      setShowCityDropdown(true);\n                                    }\n                                  }}\n                                  className=\"bg-white\"\n                                />\n                              </FormControl>\n                              \n                              {showCityDropdown && filteredCities.length > 0 && (\n                                <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto\">\n                                  <ul className=\"py-1\">\n                                    {filteredCities.map((city, index) => (\n                                      <li \n                                        key={index}\n                                        className=\"px-3 py-2 hover:bg-red-50 cursor-pointer\"\n                                        onClick={() => selectCity(city)}\n                                      >\n                                        {city}\n                                      </li>\n                                    ))}\n                                  </ul>\n                                </div>\n                              )}\n                            </div>\n                            <FormDescription>\n                              Please select from the available European cities\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"flex justify-end\">\n                      <Button \n                        type=\"button\" \n                        className=\"bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-accent\"\n                        onClick={goToNextStep}\n                      >\n                        Next Step\n                      </Button>\n                    </div>\n                  </div>\n                )}\n                \n                {/* Step 2: Details */}\n                {step === 2 && (\n                  <div className=\"p-6\">\n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"destinations\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel className=\"block text-sm font-medium text-gray-700 mb-2\">Destination Preferences</FormLabel>\n                            \n                            {(() => {\n                              // Raggruppa le destinazioni per paese\n                              const countriesMap = new Map<string, typeof destinations>();\n                              \n                              destinations?.forEach(destination => {\n                                if (!countriesMap.has(destination.country)) {\n                                  countriesMap.set(destination.country, []);\n                                }\n                                countriesMap.get(destination.country)?.push(destination);\n                              });\n                              \n                              // Converti la mappa in array per il rendering\n                              const countriesArray = Array.from(countriesMap.entries())\n                                .sort((a, b) => a[0].localeCompare(b[0])); // Ordina alfabeticamente per paese\n                              \n                              // Stato locale per il paese selezionato\n                              const [selectedCountry, setSelectedCountry] = React.useState<string | null>(null);\n                              \n                              return (\n                                <div className=\"space-y-6\">\n                                  {/* Selettore del paese */}\n                                  <div className=\"border border-gray-200 rounded-lg overflow-hidden\">\n                                    <h3 className=\"bg-gray-100 px-4 py-2 font-medium text-gray-700\">Seleziona un paese</h3>\n                                    <div className=\"p-4\">\n                                      <select\n                                        className=\"w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600\"\n                                        value={selectedCountry || \"\"}\n                                        onChange={(e) => setSelectedCountry(e.target.value || null)}\n                                      >\n                                        <option value=\"\">Seleziona un paese...</option>\n                                        {countriesArray.map(([country]) => (\n                                          <option key={country} value={country}>\n                                            {country}\n                                          </option>\n                                        ))}\n                                      </select>\n                                    </div>\n                                  </div>\n                                  \n                                  {/* Mostra le città solo se un paese è selezionato */}\n                                  {selectedCountry && (\n                                    <div className=\"border border-gray-200 rounded-lg overflow-hidden\">\n                                      <h3 className=\"bg-gray-100 px-4 py-2 font-medium text-gray-700\">Città in {selectedCountry}</h3>\n                                      <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 p-4\">\n                                        {(countriesMap.get(selectedCountry) || []).map((destination) => (\n                                          <div key={destination.id} className=\"relative\">\n                                            <input \n                                              type=\"checkbox\" \n                                              id={`dest-${destination.id}`} \n                                              className=\"peer absolute opacity-0 w-0 h-0\"\n                                              value={destination.name}\n                                              checked={field.value?.includes(destination.name)}\n                                              onChange={(e) => {\n                                                const value = e.target.value;\n                                                const newValues = e.target.checked\n                                                  ? [...(field.value || []), value]\n                                                  : (field.value || []).filter(v => v !== value);\n                                                field.onChange(newValues);\n                                              }}\n                                            />\n                                            <label \n                                              htmlFor={`dest-${destination.id}`} \n                                              className=\"flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition-all hover:border-primary peer-checked:border-red-600 peer-checked:bg-white text-black peer-checked:text-red-600\"\n                                            >\n\n                                              <div className=\"flex items-center\">\n                                                <ReactCountryFlag countryCode={getCountryCode(selectedCountry)} svg style={{marginRight: '8px'}} />\n                                                <span>{destination.name}</span>\n                                              </div>\n                                            </label>\n                                          </div>\n                                        ))}\n                                      </div>\n                                    </div>\n                                  )}\n                                  \n                                  {/* Mostra un elenco di destinazioni selezionate */}\n                                  {field.value && field.value.length > 0 && (\n                                    <div className=\"border border-gray-200 rounded-lg overflow-hidden\">\n                                      <h3 className=\"bg-gray-100 px-4 py-2 font-medium text-gray-700\">Destinazioni selezionate</h3>\n                                      <div className=\"p-4\">\n                                        <div className=\"flex flex-wrap gap-2\">\n                                          {field.value.map(destName => (\n                                            <div key={destName} className=\"bg-white text-red-600 border border-gray-300 px-3 py-1 rounded-full text-sm flex items-center\">\n                                              <span>{destName}</span>\n                                              <button \n                                                type=\"button\"\n                                                className=\"ml-2 focus:outline-none\"\n                                                onClick={() => {\n                                                  const newValues = field.value?.filter(v => v !== destName) || [];\n                                                  field.onChange(newValues);\n                                                }}\n                                              >\n                                                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                                                </svg>\n                                              </button>\n                                            </div>\n                                          ))}\n                                        </div>\n                                      </div>\n                                    </div>\n                                  )}\n                                </div>\n                              );\n                            })()}\n                            \n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"experienceType\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel className=\"block text-sm font-medium text-gray-700 mb-2\">Experience Type</FormLabel>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                              {experiences?.map((experience) => (\n                                <div key={experience.id} className=\"relative\">\n                                  <input \n                                    type=\"radio\" \n                                    id={`exp-${experience.id}`} \n                                    name=\"experienceType\"\n                                    className=\"peer absolute opacity-0 w-0 h-0\"\n                                    value={experience.name}\n                                    checked={field.value === experience.name}\n                                    onChange={() => field.onChange(experience.name)}\n                                  />\n                                  <label \n                                    htmlFor={`exp-${experience.id}`} \n                                    className=\"flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer transition-all hover:border-primary peer-checked:border-red-600 peer-checked:bg-white text-black peer-checked:text-red-600\"\n                                  >\n\n                                    <div>\n                                      <span className=\"font-medium block\">{experience.name}</span>\n                                      <span className=\"text-gray-500 text-sm\">{experience.description}</span>\n                                    </div>\n                                  </label>\n                                </div>\n                              ))}\n                            </div>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"budget\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel className=\"block text-sm font-medium text-gray-700 mb-2\">Budget Range (per person)</FormLabel>\n                            <div className=\"px-3\">\n                              <FormControl>\n                                <Slider\n                                  min={200}\n                                  max={2000}\n                                  step={100}\n                                  defaultValue={[field.value]}\n                                  onValueChange={(value) => field.onChange(value[0])}\n                                />\n                              </FormControl>\n                              <div className=\"flex justify-between text-xs text-gray-500 mt-2\">\n                                <span>€200</span>\n                                <span>€2000+</span>\n                              </div>\n                              <div className=\"text-center mt-2\">\n                                <span className=\"text-sm font-medium\">Selected: €{budgetDisplay}</span>\n                              </div>\n                            </div>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"flex justify-between\">\n                      <Button \n                        type=\"button\" \n                        variant=\"outline\"\n                        className=\"border border-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg hover:bg-gray-50\"\n                        onClick={goToPreviousStep}\n                      >\n                        Back\n                      </Button>\n                      <Button \n                        type=\"button\" \n                        className=\"bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-accent\"\n                        onClick={goToNextStep}\n                      >\n                        Next Step\n                      </Button>\n                    </div>\n                  </div>\n                )}\n                \n                {/* Step 3: Activities */}\n                {step === 3 && (\n                  <div className=\"p-6\">\n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"activities\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel className=\"block text-sm font-medium text-gray-700 mb-2\">Activity Preferences</FormLabel>\n                            <FormDescription className=\"text-gray-500 text-sm mb-3\">Select the activities you're interested in (select all that apply)</FormDescription>\n                            \n                            <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3\">\n                              {activities.map((activity) => (\n                                <div key={activity.value} className=\"relative\">\n                                  <input \n                                    type=\"checkbox\" \n                                    id={`act-${activity.value}`} \n                                    className=\"peer absolute opacity-0 w-0 h-0\"\n                                    value={activity.value}\n                                    checked={field.value?.includes(activity.value)}\n                                    onChange={(e) => {\n                                      const value = e.target.value;\n                                      const newValues = e.target.checked\n                                        ? [...(field.value || []), value]\n                                        : (field.value || []).filter(v => v !== value);\n                                      field.onChange(newValues);\n                                    }}\n                                  />\n                                  <label \n                                    htmlFor={`act-${activity.value}`} \n                                    className=\"flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition-all hover:border-primary peer-checked:border-red-600 peer-checked:bg-white text-black peer-checked:text-red-600\"\n                                  >\n\n                                    <div>\n                                      <span className=\"font-medium block\">{activity.label}</span>\n                                    </div>\n                                  </label>\n                                </div>\n                              ))}\n                            </div>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"specialRequests\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Special Requests</FormLabel>\n                            <FormControl>\n                              <Textarea \n                                rows={3} \n                                placeholder=\"Any specific requests or things to avoid?\" \n                                {...field} \n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"mb-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"includeMerch\"\n                        render={({ field }) => (\n                          <FormItem className=\"flex items-start space-x-2\">\n                            <FormControl>\n                              <input \n                                type=\"checkbox\" \n                                className=\"h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded mt-1\"\n                                checked={field.value}\n                                onChange={field.onChange}\n                              />\n                            </FormControl>\n                            <div>\n                              <FormLabel>Include custom t-shirts for all participants</FormLabel>\n                              <FormDescription className=\"text-xs text-gray-500 mt-1\">\n                                Each participant will receive a custom t-shirt with your trip design\n                              </FormDescription>\n                            </div>\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    \n                    <div className=\"flex justify-between\">\n                      <Button \n                        type=\"button\" \n                        variant=\"outline\"\n                        className=\"border border-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg hover:bg-gray-50\"\n                        onClick={goToPreviousStep}\n                      >\n                        Back\n                      </Button>\n                      <Button \n                        type=\"submit\" \n                        className=\"bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700\"\n                      >\n                        Generate Itinerary\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </form>\n            </Form>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":45922,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/pages/ZapierWebhooksPage.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Loader2, Trash, Plus, ExternalLink } from 'lucide-react';\nimport { Link } from 'wouter';\n\ninterface Webhook {\n  id: string;\n  url: string;\n  event: string;\n  active: boolean;\n  created: Date;\n}\n\nexport default function ZapierWebhooksPage() {\n  const [newWebhookUrl, setNewWebhookUrl] = useState('');\n  const [newWebhookEvent, setNewWebhookEvent] = useState('package_created');\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // Fetch webhooks\n  const { \n    data: webhooks = [], \n    isLoading,\n    error \n  } = useQuery<Webhook[]>({\n    queryKey: ['/api/zapier/webhooks'],\n    staleTime: 30000,\n  });\n  \n  // Add webhook mutation\n  const addWebhookMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest('POST', '/api/zapier/webhooks', {\n        url: newWebhookUrl,\n        event: newWebhookEvent\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/zapier/webhooks'] });\n      setNewWebhookUrl('');\n      toast({\n        title: 'Webhook aggiunto',\n        description: 'Il webhook Zapier è stato aggiunto con successo',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Errore',\n        description: 'Non è stato possibile aggiungere il webhook Zapier',\n        variant: 'destructive',\n      });\n    }\n  });\n  \n  // Delete webhook mutation\n  const deleteWebhookMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest('DELETE', `/api/zapier/webhooks/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/zapier/webhooks'] });\n      toast({\n        title: 'Webhook eliminato',\n        description: 'Il webhook Zapier è stato eliminato con successo',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Errore',\n        description: 'Non è stato possibile eliminare il webhook Zapier',\n        variant: 'destructive',\n      });\n    }\n  });\n  \n  // Handle form submission\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newWebhookUrl) {\n      toast({\n        title: 'URL mancante',\n        description: 'Inserisci l\\'URL del webhook Zapier',\n        variant: 'destructive',\n      });\n      return;\n    }\n    addWebhookMutation.mutate();\n  };\n  \n  return (\n    <div className=\"container mx-auto py-8\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Integrazione Zapier</h1>\n          <p className=\"text-gray-500\">Gestisci i webhook per l'integrazione con Zapier</p>\n        </div>\n        <Link href=\"/\">\n          <Button variant=\"outline\">Torna alla Home</Button>\n        </Link>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <div className=\"md:col-span-1\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Nuovo Webhook</CardTitle>\n              <CardDescription>\n                Aggiungi un nuovo webhook Zapier per automatizzare le operazioni\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"webhook-url\">URL del Webhook Zapier</Label>\n                  <Input\n                    id=\"webhook-url\"\n                    placeholder=\"https://hooks.zapier.com/...\"\n                    value={newWebhookUrl}\n                    onChange={(e) => setNewWebhookUrl(e.target.value)}\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"webhook-event\">Evento</Label>\n                  <Select\n                    value={newWebhookEvent}\n                    onValueChange={setNewWebhookEvent}\n                  >\n                    <SelectTrigger id=\"webhook-event\">\n                      <SelectValue placeholder=\"Seleziona un evento\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"package_created\">Creazione Pacchetto</SelectItem>\n                      <SelectItem value=\"purchase_completed\">Acquisto Completato</SelectItem>\n                      <SelectItem value=\"quote_requested\">Richiesta Preventivo</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </form>\n            </CardContent>\n            <CardFooter>\n              <Button \n                className=\"w-full bg-red-600 hover:bg-red-700\"\n                onClick={handleSubmit}\n                disabled={addWebhookMutation.isPending}\n              >\n                {addWebhookMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Aggiunta in corso...\n                  </>\n                ) : (\n                  <>\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    Aggiungi Webhook\n                  </>\n                )}\n              </Button>\n            </CardFooter>\n          </Card>\n          \n          <Card className=\"mt-6\">\n            <CardHeader>\n              <CardTitle>Informazioni</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm\">\n              <p>\n                <strong>Cos'è Zapier?</strong> Zapier è una piattaforma di automazione che collega le tue app e servizi preferiti, permettendoti di automatizzare attività ripetitive senza scrivere codice.\n              </p>\n              <p>\n                <strong>Come funziona?</strong> ByeBro invia dati a Zapier quando si verificano determinati eventi. Zapier può quindi eseguire azioni automatiche in base a questi eventi.\n              </p>\n              <p>\n                <strong>Esempi di automazione:</strong>\n              </p>\n              <ul className=\"list-disc pl-5 space-y-1\">\n                <li>Invia email di conferma quando viene completato un acquisto</li>\n                <li>Aggiungi eventi al calendario quando viene creato un pacchetto</li>\n                <li>Salva i dati dei clienti in un CRM</li>\n                <li>Crea promemoria in Slack</li>\n              </ul>\n              \n              <a \n                href=\"https://zapier.com/apps/webhooks/integrations\" \n                target=\"_blank\" \n                rel=\"noopener noreferrer\"\n                className=\"flex items-center text-blue-600 hover:underline\"\n              >\n                <ExternalLink className=\"h-4 w-4 mr-1\" />\n                Scopri di più su Zapier\n              </a>\n            </CardContent>\n          </Card>\n        </div>\n        \n        <div className=\"md:col-span-2\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Webhook Attivi</CardTitle>\n              <CardDescription>\n                Gestisci i webhook configurati per l'integrazione con Zapier\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"flex justify-center items-center py-8\">\n                  <Loader2 className=\"h-8 w-8 animate-spin text-gray-400\" />\n                </div>\n              ) : error ? (\n                <div className=\"text-center py-8 text-red-500\">\n                  Si è verificato un errore nel caricamento dei webhook\n                </div>\n              ) : webhooks.length === 0 ? (\n                <div className=\"text-center py-8 text-gray-500\">\n                  <p>Non ci sono webhook configurati</p>\n                  <p className=\"mt-2 text-sm\">Aggiungi un nuovo webhook per iniziare a utilizzare l'integrazione con Zapier</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {webhooks.map((webhook) => (\n                    <div \n                      key={webhook.id}\n                      className=\"border rounded-lg p-4 flex items-center justify-between\"\n                    >\n                      <div>\n                        <div className=\"flex items-center space-x-2\">\n                          <span \n                            className={`w-2 h-2 rounded-full ${webhook.active ? 'bg-green-500' : 'bg-gray-400'}`}\n                          />\n                          <h3 className=\"font-semibold\">\n                            {webhook.event === 'package_created' && 'Creazione Pacchetto'}\n                            {webhook.event === 'purchase_completed' && 'Acquisto Completato'}\n                            {webhook.event === 'quote_requested' && 'Richiesta Preventivo'}\n                          </h3>\n                        </div>\n                        <p className=\"text-sm text-gray-500 mt-1 truncate max-w-md\">\n                          {webhook.url}\n                        </p>\n                        <p className=\"text-xs text-gray-400 mt-1\">\n                          Creato il: {new Date(webhook.created).toLocaleDateString()}\n                        </p>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => deleteWebhookMutation.mutate(webhook.id)}\n                        disabled={deleteWebhookMutation.isPending}\n                      >\n                        {deleteWebhookMutation.variables === webhook.id && deleteWebhookMutation.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          <Trash className=\"h-4 w-4 text-red-500\" />\n                        )}\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n          \n          <Card className=\"mt-6\">\n            <CardHeader>\n              <CardTitle>Eventi Disponibili</CardTitle>\n              <CardDescription>\n                Questi sono gli eventi che possono attivare un webhook Zapier\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"border rounded-lg p-4\">\n                  <h3 className=\"font-semibold\">Creazione Pacchetto (package_created)</h3>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Inviato quando un utente crea un nuovo pacchetto personalizzato.\n                  </p>\n                  <div className=\"mt-2 p-2 bg-gray-100 rounded text-xs font-mono overflow-x-auto\">\n                    {`{\n  \"event\": \"package_created\",\n  \"data\": {\n    \"packageId\": \"12345\",\n    \"userId\": \"user_123\",\n    \"destination\": \"Amsterdam\",\n    \"startDate\": \"2025-06-15\",\n    \"endDate\": \"2025-06-18\",\n    \"items\": [...],\n    \"totalPrice\": 349.95\n  },\n  \"timestamp\": \"2025-05-09T12:34:56.789Z\"\n}`}\n                  </div>\n                </div>\n                \n                <div className=\"border rounded-lg p-4\">\n                  <h3 className=\"font-semibold\">Acquisto Completato (purchase_completed)</h3>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Inviato quando un utente completa l'acquisto di un pacchetto.\n                  </p>\n                  <div className=\"mt-2 p-2 bg-gray-100 rounded text-xs font-mono overflow-x-auto\">\n                    {`{\n  \"event\": \"purchase_completed\",\n  \"data\": {\n    \"packageId\": \"12345\",\n    \"userId\": \"user_123\",\n    \"userEmail\": \"user@example.com\",\n    \"items\": [...],\n    \"totalPrice\": 349.95,\n    \"purchaseDate\": \"2025-05-09T12:34:56.789Z\"\n  },\n  \"timestamp\": \"2025-05-09T12:34:56.789Z\"\n}`}\n                  </div>\n                </div>\n                \n                <div className=\"border rounded-lg p-4\">\n                  <h3 className=\"font-semibold\">Richiesta Preventivo (quote_requested)</h3>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Inviato quando un utente richiede un preventivo personalizzato.\n                  </p>\n                  <div className=\"mt-2 p-2 bg-gray-100 rounded text-xs font-mono overflow-x-auto\">\n                    {`{\n  \"event\": \"quote_requested\",\n  \"data\": {\n    \"userId\": \"user_123\",\n    \"userEmail\": \"user@example.com\",\n    \"destination\": \"Amsterdam\",\n    \"startDate\": \"2025-06-15\",\n    \"endDate\": \"2025-06-18\",\n    \"groupSize\": 6,\n    \"budget\": \"standard\",\n    \"preferences\": [...]\n  },\n  \"timestamp\": \"2025-05-09T12:34:56.789Z\"\n}`}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":13298,"size_tokens":null},"client/src/components/FeaturedDestinations.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Destination } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Star, StarHalf } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { memo, useCallback } from \"react\";\nimport OptimizedImage from \"@/components/ui/optimized-image\";\nimport { throttle } from \"@/lib/performance\";\n\n// Ottimizzati i singoli componenti per evitare re-rendering\nconst DestinationCard = memo(({ destination, onExplore }: { \n  destination: Destination, \n  onExplore: (id: number) => void \n}) => {\n  // Memorizziamo la funzione di callback\n  const handleExplore = useCallback(() => {\n    onExplore(destination.id);\n  }, [destination.id, onExplore]);\n\n  // Helper function to render rating stars\n  const renderRatingStars = (rating: string) => {\n    const ratingNum = parseFloat(rating);\n    const fullStars = Math.floor(ratingNum);\n    const hasHalfStar = ratingNum % 1 >= 0.5;\n    const stars = [];\n\n    for (let i = 0; i < fullStars; i++) {\n      stars.push(<Star key={`full-${i}`} className=\"fill-yellow-400 text-yellow-400 h-4 w-4\" />);\n    }\n\n    if (hasHalfStar) {\n      stars.push(<StarHalf key=\"half\" className=\"fill-yellow-400 text-yellow-400 h-4 w-4\" />);\n    }\n\n    return stars;\n  };\n\n  return (\n    <div className=\"rounded-xl overflow-hidden shadow-lg group bg-black\">\n      <div className=\"relative h-64 overflow-hidden\">\n        <OptimizedImage \n          src={destination.image} \n          alt={`${destination.name} - ${destination.country}`} \n          width={400}\n          height={300}\n          className=\"w-full h-full object-cover transition duration-500 group-hover:scale-110\"\n          loadingMode=\"lazy\"\n        />\n        <div className=\"absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/70 to-transparent\">\n          <h3 className=\"text-white text-xl font-bold font-poppins\">{destination.name}</h3>\n          <p className=\"text-white text-sm\">{destination.country}</p>\n        </div>\n      </div>\n      <div className=\"p-4\">\n        <div className=\"flex items-center mb-2\">\n          {destination.tags?.map((tag, index) => (\n            <span \n              key={index} \n              className={`${\n                index === 0 ? 'bg-red-900 text-white' : \n                index === 1 ? 'bg-gray-800 text-white' : \n                'bg-red-900 text-white'\n              } text-xs px-2 py-1 rounded-full font-medium ${index > 0 ? 'ml-2' : ''}`}\n            >\n              {tag}\n            </span>\n          ))}\n        </div>\n        <p className=\"text-gray-300 text-sm mb-4 line-clamp-2\">{destination.description}</p>\n        <div className=\"flex justify-between items-center\">\n          <div className=\"flex items-center\">\n            <div className=\"text-yellow-400 flex\">\n              {renderRatingStars(destination.rating)}\n            </div>\n            <span className=\"text-gray-300 ml-1 text-sm\">{destination.rating} ({destination.reviewCount})</span>\n          </div>\n          <Button\n            variant=\"ghost\"\n            className=\"text-red-600 hover:text-red-700 font-medium\"\n            onClick={handleExplore}\n          >\n            Explore\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n});\n\nDestinationCard.displayName = \"DestinationCard\";\n\ntype Brand = 'bro' | 'bride';\n\ninterface FeaturedDestinationsProps {\n  brand?: Brand;\n}\n\nconst COPY = {\n  bro: {\n    subtitle: \"Top picks for your unforgettable bachelor party\"\n  },\n  bride: {\n    subtitle: \"Top picks for your unforgettable bachelorette party\"\n  }\n};\n\n// Componente principale ottimizzato\nconst FeaturedDestinations = memo(function FeaturedDestinations({ brand = 'bro' }: FeaturedDestinationsProps) {\n  const { data: destinations, isLoading, error } = useQuery<Destination[]>({\n    queryKey: [\"/api/destinations\"],\n  });\n  \n  const copy = COPY[brand];\n  \n  // Throttle della funzione di navigazione\n  const handleExplore = useCallback(throttle(() => {\n    window.location.href = \"/destinations\";\n  }, 300), []);\n\n  if (isLoading) {\n    return (\n      <section className=\"py-16 bg-white\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex justify-between items-end mb-8\">\n            <div>\n              <Skeleton className=\"h-10 w-64\" />\n              <Skeleton className=\"h-5 w-48 mt-2\" />\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"rounded-xl overflow-hidden shadow-lg\">\n                <Skeleton className=\"h-64 w-full\" />\n                <div className=\"p-4\">\n                  <Skeleton className=\"h-6 w-24 mb-2\" />\n                  <Skeleton className=\"h-4 w-full mb-4\" />\n                  <div className=\"flex justify-between items-center\">\n                    <Skeleton className=\"h-4 w-20\" />\n                    <Skeleton className=\"h-4 w-16\" />\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (error) {\n    return (\n      <section className=\"py-16 bg-white\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center\">\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3\">Popular Destinations</h2>\n            <p className=\"text-red-500\">Error loading destinations. Please try again later.</p>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"py-16 bg-gray-900\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"flex justify-between items-end mb-8\">\n          <div>\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins text-white\">Popular Destinations</h2>\n            <p className=\"text-gray-300 mt-2\">{copy.subtitle}</p>\n          </div>\n          <Link href=\"/destinations\" className=\"text-red-600 hover:text-red-700 font-medium hidden md:block\">\n            View all destinations\n          </Link>\n        </div>\n        \n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8\">\n          {destinations?.slice(0, 3).map((destination) => (\n            <DestinationCard \n              key={destination.id} \n              destination={destination} \n              onExplore={handleExplore}\n            />\n          ))}\n        </div>\n        \n        <div className=\"mt-8 text-center md:hidden\">\n          <Link href=\"/destinations\" className=\"text-red-600 hover:text-red-700 font-medium\">\n            View all destinations\n          </Link>\n        </div>\n      </div>\n    </section>\n  );\n});\n\nexport default FeaturedDestinations;","path":null,"size_bytes":6760,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey[0] as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: true, // Ricarica quando la finestra torna in focus\n      staleTime: 300000, // 5 minuti di cache\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1440,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/Footer.tsx":{"content":"import { Link } from \"wouter\";\nimport { FaFacebookF, FaTwitter, FaInstagram, FaTiktok } from \"react-icons/fa\";\nimport { Mail, Phone, MapPin } from \"lucide-react\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\nexport default function Footer() {\n  const { t } = useTranslation();\n  return (\n    <footer className=\"bg-dark text-gray-300 py-12\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-8\">\n          <div>\n            <Link href=\"/\" className=\"text-white font-poppins font-bold text-2xl mb-4 block\">\n              <span className=\"text-white\">Bye</span><span className=\"text-primary\">Bro</span>\n            </Link>\n            <p className=\"text-gray-400 mb-4\">{t('footer.tagline')}</p>\n            <div className=\"flex space-x-4\">\n              <a href=\"#\" className=\"text-gray-400 hover:text-white transition\">\n                <FaFacebookF />\n              </a>\n              <a href=\"#\" className=\"text-gray-400 hover:text-white transition\">\n                <FaTwitter />\n              </a>\n              <a href=\"#\" className=\"text-gray-400 hover:text-white transition\">\n                <FaInstagram />\n              </a>\n              <a href=\"#\" className=\"text-gray-400 hover:text-white transition\">\n                <FaTiktok />\n              </a>\n            </div>\n          </div>\n          \n          <div>\n            <h4 className=\"text-white font-bold text-lg mb-4\">{t('footer.quickLinks')}</h4>\n            <ul className=\"space-y-2\">\n              <li>\n                <Link href=\"/\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('header.howItWorks')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/destinations\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('header.destinations')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/experiences\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('header.experiences')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/secret-blog\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('header.secretBlog')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/merchandise\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('footer.customMerch')}\n                </Link>\n              </li>\n            </ul>\n          </div>\n          \n          <div>\n            <h4 className=\"text-white font-bold text-lg mb-4\">{t('footer.support')}</h4>\n            <ul className=\"space-y-2\">\n              <li>\n                <Link href=\"/faq\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('footer.faqs')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/contact\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('footer.contactUs')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/privacy\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('footer.privacyPolicy')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/terms\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('footer.termsOfService')}\n                </Link>\n              </li>\n              <li>\n                <Link href=\"/refunds\" className=\"text-gray-400 hover:text-white transition\">\n                  {t('footer.refundPolicy')}\n                </Link>\n              </li>\n            </ul>\n          </div>\n          \n          <div>\n            <h4 className=\"text-white font-bold text-lg mb-4\">{t('footer.contact')}</h4>\n            <ul className=\"space-y-2\">\n              <li className=\"flex items-start\">\n                <Mail className=\"text-primary mt-1 mr-3 h-4 w-4\" />\n                <span>support@byebro.com</span>\n              </li>\n              <li className=\"flex items-start\">\n                <Phone className=\"text-primary mt-1 mr-3 h-4 w-4\" />\n                <span>+1 (888) 123-4567</span>\n              </li>\n              <li className=\"flex items-start\">\n                <MapPin className=\"text-primary mt-1 mr-3 h-4 w-4\" />\n                <span>123 Party Street, Amsterdam, Netherlands</span>\n              </li>\n            </ul>\n          </div>\n        </div>\n        \n        <div className=\"border-t border-gray-800 mt-12 pt-8 text-center\">\n          <p className=\"text-gray-500\">{t('footer.copyright', { year: new Date().getFullYear().toString() })}</p>\n        </div>\n      </div>\n    </footer>\n  );\n}\n","path":null,"size_bytes":4780,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ActivitySuggestions.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { z } from 'zod';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Loader2, Music, Ship, Utensils, PartyPopper, Car, Waves, Flame, Beer, MapPin } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\nconst activityFormSchema = z.object({\n  destination: z.string().min(1, \"Seleziona una destinazione\"),\n  startDate: z.string().min(1, \"Inserisci la data di inizio\"),\n  endDate: z.string().min(1, \"Inserisci la data di fine\"),\n});\n\ntype ActivityFormValues = z.infer<typeof activityFormSchema>;\n\ninterface ActivitySuggestion {\n  name: string;\n  description: string;\n  icon: string;\n  venues: string[];\n}\n\nconst iconMap: { [key: string]: any } = {\n  music: Music,\n  ship: Ship,\n  utensils: Utensils,\n  party: PartyPopper,\n  car: Car,\n  waves: Waves,\n  flame: Flame,\n  beer: Beer,\n  mappin: MapPin,\n};\n\nexport default function ActivitySuggestions() {\n  const [isLoading, setIsLoading] = useState(false);\n  const [suggestions, setSuggestions] = useState<ActivitySuggestion[]>([]);\n  const { toast } = useToast();\n\n  const form = useForm<ActivityFormValues>({\n    resolver: zodResolver(activityFormSchema),\n    defaultValues: {\n      destination: '',\n      startDate: '',\n      endDate: '',\n    },\n  });\n\n  const onSubmit = async (data: ActivityFormValues) => {\n    setIsLoading(true);\n    setSuggestions([]);\n\n    try {\n      const response = await fetch('/api/chat/activity-suggestions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(data),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to get suggestions');\n      }\n\n      const result = await response.json();\n      setSuggestions(result.suggestions || []);\n    } catch (error) {\n      console.error('Error getting activity suggestions:', error);\n      toast({\n        title: 'Error',\n        description: 'Unable to get activity suggestions. Please try again.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const destinations = [\n    'Roma',\n    'Ibiza',\n    'Barcellona',\n    'Praga',\n    'Budapest',\n    'Cracovia',\n    'Amsterdam',\n    'Berlino',\n    'Lisbona',\n    'Palma de Mallorca',\n  ];\n\n  return (\n    <section className=\"py-16 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold mb-4\">\n            Activity Ideas Generator\n          </h2>\n          <p className=\"text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto\">\n            Get personalized activity suggestions for your bachelor/bachelorette party\n          </p>\n        </div>\n\n        <div className=\"max-w-4xl mx-auto\">\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <CardTitle>Where and when?</CardTitle>\n              <CardDescription>\n                Select your destination and dates to get customized activity ideas\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"destination\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Destination</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-destination\">\n                                <SelectValue placeholder=\"Select city\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {destinations.map((dest) => (\n                                <SelectItem key={dest} value={dest}>\n                                  {dest}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"startDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Start Date</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"date\"\n                              {...field}\n                              data-testid=\"input-start-date\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"endDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>End Date</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"date\"\n                              {...field}\n                              data-testid=\"input-end-date\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full bg-red-600 hover:bg-red-700\"\n                    disabled={isLoading}\n                    data-testid=\"button-generate-ideas\"\n                  >\n                    {isLoading ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Generating ideas...\n                      </>\n                    ) : (\n                      'Get Activity Ideas'\n                    )}\n                  </Button>\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n\n          {suggestions.length > 0 && (\n            <div>\n              <h3 className=\"text-2xl font-bold mb-6 text-center\">\n                Suggested Activities\n              </h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                {suggestions.map((activity, index) => {\n                  const IconComponent = iconMap[activity.icon] || PartyPopper;\n                  return (\n                    <Card\n                      key={index}\n                      className=\"hover:shadow-lg transition-shadow duration-300 border-2 hover:border-red-500\"\n                      data-testid={`card-activity-${index}`}\n                    >\n                      <CardHeader>\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <div className=\"p-3 bg-red-100 dark:bg-red-900 rounded-lg\">\n                            <IconComponent className=\"w-6 h-6 text-red-600 dark:text-red-400\" />\n                          </div>\n                          <CardTitle className=\"text-lg\">{activity.name}</CardTitle>\n                        </div>\n                        <CardDescription>{activity.description}</CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        {activity.venues && activity.venues.length > 0 && (\n                          <div>\n                            <p className=\"text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300\">\n                              Recommended venues:\n                            </p>\n                            <ul className=\"space-y-1\">\n                              {activity.venues.map((venue, vIndex) => (\n                                <li\n                                  key={vIndex}\n                                  className=\"text-sm text-gray-600 dark:text-gray-400 flex items-start gap-2\"\n                                >\n                                  <span className=\"text-red-500 mt-1\">•</span>\n                                  <span>{venue}</span>\n                                </li>\n                              ))}\n                            </ul>\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":9392,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/auth.ts":{"content":"import passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport { Express } from \"express\";\nimport session from \"express-session\";\nimport { scrypt, randomBytes, timingSafeEqual } from \"crypto\";\nimport { promisify } from \"util\";\nimport { storage } from \"./storage\";\nimport { User as SelectUser } from \"@shared/schema\";\nimport createMemoryStore from \"memorystore\";\n\n// Extend Express.User interface to include our User type\ndeclare global {\n  namespace Express {\n    interface User extends SelectUser {}\n  }\n}\n\nconst MemoryStore = createMemoryStore(session);\nconst scryptAsync = promisify(scrypt);\n\n// Utility functions for password hashing and comparison\nasync function hashPassword(password: string) {\n  const salt = randomBytes(16).toString(\"hex\");\n  const buf = (await scryptAsync(password, salt, 64)) as Buffer;\n  return `${buf.toString(\"hex\")}.${salt}`;\n}\n\nasync function comparePasswords(supplied: string, stored: string) {\n  const [hashed, salt] = stored.split(\".\");\n  const hashedBuf = Buffer.from(hashed, \"hex\");\n  const suppliedBuf = (await scryptAsync(supplied, salt, 64)) as Buffer;\n  return timingSafeEqual(hashedBuf, suppliedBuf);\n}\n\nexport function setupAuth(app: Express) {\n  // Generate a secure random string for session secret (or use env variable in production)\n  const sessionSecret = process.env.SESSION_SECRET || randomBytes(32).toString(\"hex\");\n  \n  const sessionSettings: session.SessionOptions = {\n    secret: sessionSecret,\n    resave: false,\n    saveUninitialized: false,\n    store: new MemoryStore({\n      checkPeriod: 86400000 // Prune expired entries every 24h\n    }),\n    cookie: {\n      maxAge: 24 * 60 * 60 * 1000, // 24 hours\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"lax\"\n    }\n  };\n\n  app.set(\"trust proxy\", 1);\n  app.use(session(sessionSettings));\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  // Configure local strategy\n  passport.use(\n    new LocalStrategy(async (username, password, done) => {\n      try {\n        // Try to find user by username\n        let user = await storage.getUserByUsername(username);\n        \n        // If not found by username, try email\n        if (!user) {\n          user = await storage.getUserByEmail(username); // Allow login with email too\n        }\n        \n        if (!user) {\n          return done(null, false, { message: \"Incorrect username or password\" });\n        }\n        \n        // Check password\n        const passwordMatch = await comparePasswords(password, user.password);\n        if (!passwordMatch) {\n          return done(null, false, { message: \"Incorrect username or password\" });\n        }\n        \n        return done(null, user);\n      } catch (error) {\n        return done(error);\n      }\n    }),\n  );\n\n  // Set up serialization/deserialization for sessions\n  passport.serializeUser((user, done) => done(null, user.id));\n  \n  passport.deserializeUser(async (id: number, done) => {\n    try {\n      const user = await storage.getUser(id);\n      if (!user) {\n        return done(null, false);\n      }\n      done(null, user);\n    } catch (error) {\n      done(error);\n    }\n  });\n\n  // Registration route\n  app.post(\"/api/register\", async (req, res, next) => {\n    try {\n      const { username, email, password } = req.body;\n      \n      // Basic validation\n      if (!username || !email || !password) {\n        return res.status(400).json({ message: \"All fields are required\" });\n      }\n      \n      // Check if username already exists\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(400).json({ message: \"Username already exists\" });\n      }\n      \n      // Check if email already exists\n      const existingEmail = await storage.getUserByEmail(email);\n      if (existingEmail) {\n        return res.status(400).json({ message: \"Email already exists\" });\n      }\n      \n      // Hash password and create user\n      const hashedPassword = await hashPassword(password);\n      const user = await storage.createUser({\n        ...req.body,\n        password: hashedPassword\n      });\n      \n      // Log user in after registration\n      req.login(user, (err) => {\n        if (err) return next(err);\n        \n        // Don't return password in response\n        const { password, ...userWithoutPassword } = user;\n        \n        return res.status(201).json(userWithoutPassword);\n      });\n    } catch (error) {\n      return res.status(500).json({ message: \"Server error during registration\" });\n    }\n  });\n\n  // Login route\n  app.post(\"/api/login\", (req, res, next) => {\n    passport.authenticate(\"local\", (err, user, info) => {\n      if (err) return next(err);\n      \n      if (!user) {\n        return res.status(401).json({ \n          message: info?.message || \"Authentication failed\" \n        });\n      }\n      \n      req.login(user, (err) => {\n        if (err) return next(err);\n        \n        // Don't return password in response\n        const { password, ...userWithoutPassword } = user;\n        \n        return res.status(200).json(userWithoutPassword);\n      });\n    })(req, res, next);\n  });\n\n  // Logout route\n  app.post(\"/api/logout\", (req, res, next) => {\n    req.logout((err) => {\n      if (err) return next(err);\n      res.status(200).json({ message: \"Logged out successfully\" });\n    });\n  });\n\n  // Get current user route\n  app.get(\"/api/user\", (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"Not authenticated\" });\n    }\n    \n    // Don't return password in response\n    const { password, ...userWithoutPassword } = req.user;\n    \n    res.status(200).json(userWithoutPassword);\n  });\n}","path":null,"size_bytes":5722,"size_tokens":null},"client/src/components/HeroSection.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { useState } from \"react\";\nimport { Send, MessageCircle } from \"lucide-react\";\nimport ChatDialogCompact from \"./ChatDialogCompact\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\nexport default function HeroSection() {\n  const { t } = useTranslation();\n  const [chatInput, setChatInput] = useState(\"\");\n  const [chatDialogOpen, setChatDialogOpen] = useState(false);\n  const [initialChatMessage, setInitialChatMessage] = useState<string | undefined>(undefined);\n\n  const handleChatSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (chatInput.trim()) {\n      setInitialChatMessage(chatInput.trim());\n      setChatInput('');\n      setChatDialogOpen(true);\n    }\n  };\n\n  return (\n    <>\n      <section className=\"relative py-16 md:py-24 bg-cover bg-center bg-no-repeat\" style={{ backgroundImage: \"url('https://images.pexels.com/photos/7270934/pexels-photo-7270934.jpeg?auto=compress&cs=tinysrgb&h=650&w=940')\" }}>\n        <div className=\"absolute inset-0 bg-gradient-to-r from-black to-red-900 bg-opacity-75 mix-blend-multiply\"></div>\n        <div className=\"container mx-auto px-4 relative z-10\">\n          <div className=\"max-w-2xl mx-auto\">\n            <h1 className=\"text-white font-bold text-4xl md:text-5xl mb-3 leading-tight text-center\">\n              {t('hero.bro.title')}\n            </h1>\n            <p className=\"text-white text-lg mb-10 text-center max-w-3xl mx-auto\">\n              {t('hero.bro.subtitle')}\n            </p>\n\n            <div className=\"bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <MessageCircle className=\"w-6 h-6 text-red-400\" />\n                <h3 className=\"text-white font-bold text-xl\">{t('hero.bro.chatTitle')}</h3>\n              </div>\n              \n              <p className=\"text-white/80 text-sm mb-4\">\n                {t('hero.bro.chatSubtitle')}\n              </p>\n              \n              <form onSubmit={handleChatSubmit} className=\"space-y-3\">\n                <Input\n                  type=\"text\"\n                  placeholder={t('hero.bro.placeholder')}\n                  value={chatInput}\n                  onChange={(e) => setChatInput(e.target.value)}\n                  className=\"bg-white/95 border-white/30 text-gray-900 placeholder:text-gray-500 focus:ring-2 focus:ring-red-500\"\n                  data-testid=\"input-hero-chat\"\n                />\n                <Button \n                  type=\"submit\"\n                  className=\"w-full bg-red-600 hover:bg-red-700 text-white font-semibold transition-all duration-200 flex items-center justify-center gap-2\"\n                  data-testid=\"button-chat-submit\"\n                >\n                  <Send className=\"w-4 h-4\" />\n                  {t('hero.bro.startChat')}\n                </Button>\n              </form>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <ChatDialogCompact \n        open={chatDialogOpen} \n        onOpenChange={setChatDialogOpen}\n        initialMessage={initialChatMessage}\n      />\n    </>\n  );\n}\n","path":null,"size_bytes":3196,"size_tokens":null},"client/src/pages/Home.tsx":{"content":"import Header from \"@/components/Header\";\nimport HeroSection from \"@/components/HeroSection\";\nimport HowItWorks from \"@/components/HowItWorks\";\nimport FeaturedDestinations from \"@/components/FeaturedDestinations\";\nimport ExperienceTypes from \"@/components/ExperienceTypes\";\nimport SecretBlog from \"@/components/SecretBlog\";\nimport PremiumFeatures from \"@/components/PremiumFeatures\";\nimport Testimonials from \"@/components/Testimonials\";\nimport Newsletter from \"@/components/Newsletter\";\nimport Footer from \"@/components/Footer\";\n\nexport default function Home() {\n  return (\n    <div className=\"min-h-screen flex flex-col\">\n      <Header />\n      \n      <main className=\"flex-grow\">\n        {/* Hero Section with Integrated Activity Ideas & Chat */}\n        <HeroSection />\n        \n        {/* How It Works */}\n        <HowItWorks brand=\"bro\" />\n        \n        {/* Featured Destinations */}\n        <FeaturedDestinations brand=\"bro\" />\n        \n        {/* Experience Types */}\n        <ExperienceTypes brand=\"bro\" />\n        \n        {/* Secret Blog */}\n        <SecretBlog brand=\"bro\" />\n        \n        {/* Premium Features */}\n        <PremiumFeatures brand=\"bro\" />\n        \n        {/* Testimonials */}\n        <Testimonials brand=\"bro\" />\n        \n        {/* Newsletter */}\n        <Newsletter />\n      </main>\n      \n      <Footer />\n    </div>\n  );\n}\n","path":null,"size_bytes":1365,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"server/services/image-search.ts":{"content":"interface ImageResult {\n  id: string;\n  url: string;\n  thumbnail: string;\n  description: string;\n  tags: string[];\n}\n\ninterface ImageSearchResponse {\n  success: boolean;\n  images: ImageResult[];\n  message?: string;\n}\n\nexport class ImageSearchService {\n  private apiKey: string;\n  private provider: 'unsplash' | 'pexels' | 'fallback';\n\n  constructor() {\n    this.apiKey = process.env.IMAGE_SEARCH_API_KEY || '';\n    // Determina provider basato su formato chiave o test\n    this.provider = 'fallback';\n  }\n\n  /**\n   * Cerca immagini usando l'API fornita dall'utente\n   */\n  async searchImages(query: string, limit: number = 10): Promise<ImageSearchResponse> {\n    try {\n      if (!this.apiKey) {\n        return {\n          success: false,\n          images: [],\n          message: 'API key non configurata per la ricerca immagini'\n        };\n      }\n\n      console.log(`Cercando immagini per: ${query}`);\n      console.log(`API Key presente: ${this.apiKey.substring(0, 10)}...`);\n\n      // Prima prova Pexels API\n      let response: Response;\n      try {\n        const pexelsUrl = `https://api.pexels.com/v1/search`;\n        const params = new URLSearchParams({\n          query: query,\n          per_page: limit.toString()\n        });\n\n        response = await fetch(`${pexelsUrl}?${params}`, {\n          method: 'GET',\n          headers: {\n            'Authorization': this.apiKey,\n            'Accept': 'application/json'\n          }\n        });\n\n        if (response.ok) {\n          const data = await response.json();\n          console.log('Pexels API successful');\n          \n          if (data.photos && Array.isArray(data.photos)) {\n            const images: ImageResult[] = data.photos.map((item: any) => ({\n              id: item.id.toString(),\n              url: item.src?.large || item.src?.original || '',\n              thumbnail: item.src?.medium || item.src?.small || '',\n              description: item.alt || '',\n              tags: []\n            }));\n\n            return {\n              success: true,\n              images: images,\n              message: `Trovate ${images.length} immagini da Pexels`\n            };\n          }\n        } else {\n          console.log('Pexels failed, trying Unsplash...');\n        }\n      } catch (error) {\n        console.log('Pexels error, trying Unsplash...', error);\n      }\n\n      // Se Pexels fallisce, prova Unsplash\n      const unsplashUrl = `https://api.unsplash.com/search/photos`;\n      const unsplashParams = new URLSearchParams({\n        query: query,\n        per_page: limit.toString(),\n        client_id: this.apiKey\n      });\n\n      response = await fetch(`${unsplashUrl}?${unsplashParams}`, {\n        method: 'GET',\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json'\n        }\n      });\n\n      console.log(`Response status: ${response.status}`);\n      console.log(`Response headers:`, Object.fromEntries(response.headers.entries()));\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`Unsplash API Error: ${response.status} - ${errorText}`);\n        \n        // Se entrambi falliscono, restituisce immagini di fallback\n        return this.getFallbackImages(query);\n      }\n\n      const data = await response.json();\n      console.log('Unsplash API successful');\n\n      if (!data.results || !Array.isArray(data.results)) {\n        return this.getFallbackImages(query);\n      }\n\n      const images: ImageResult[] = data.results.map((item: any) => ({\n        id: item.id,\n        url: item.urls?.regular || item.urls?.small || '',\n        thumbnail: item.urls?.thumb || item.urls?.small || '',\n        description: item.description || item.alt_description || '',\n        tags: item.tags ? item.tags.map((tag: any) => tag.title || tag.name || '') : []\n      }));\n\n      return {\n        success: true,\n        images: images,\n        message: `Trovate ${images.length} immagini da Unsplash`\n      };\n\n    } catch (error) {\n      console.error('Errore nella ricerca immagini:', error);\n      return this.getFallbackImages(query);\n    }\n  }\n\n  /**\n   * Fornisce immagini di fallback quando le API non funzionano\n   */\n  private getFallbackImages(query: string): ImageSearchResponse {\n    const fallbackImages: ImageResult[] = [];\n    \n    if (query.toLowerCase().includes('barcelona') || query.toLowerCase().includes('barcellona')) {\n      fallbackImages.push({\n        id: 'barcelona-fallback-1',\n        url: 'https://images.unsplash.com/photo-1544738413-433b2b94e57e?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&h=600&q=80',\n        thumbnail: 'https://images.unsplash.com/photo-1544738413-433b2b94e57e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&h=300&q=80',\n        description: 'Barcelona aerial view with Sagrada Familia',\n        tags: ['barcelona', 'sagrada familia', 'aerial', 'city']\n      });\n    } else {\n      // Immagini generiche di viaggio\n      fallbackImages.push({\n        id: 'travel-fallback-1',\n        url: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&h=600&q=80',\n        thumbnail: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=300&q=80',\n        description: 'Beautiful travel destination',\n        tags: ['travel', 'destination', 'city']\n      });\n    }\n\n    return {\n      success: true,\n      images: fallbackImages,\n      message: 'Immagini di fallback fornite - configura IMAGE_SEARCH_API_KEY per API dinamiche'\n    };\n  }\n\n  /**\n   * Cerca immagini specifiche per Barcellona con vista aerea e Sagrada Familia\n   */\n  async searchBarcelonaImages(): Promise<ImageSearchResponse> {\n    // Prova la ricerca dinamica prima\n    const result = await this.searchImages('Barcelona aerial view Sagrada Familia', 5);\n    if (result.success && result.images.length > 0) {\n      return result;\n    }\n\n    // Se l'API fallisce, restituisci immagine specifica di Barcellona dall'alto\n    return {\n      success: true,\n      images: [{\n        id: 'barcelona-aerial-sagrada',\n        url: 'https://images.unsplash.com/photo-1544738413-433b2b94e57e?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&h=600&q=80',\n        thumbnail: 'https://images.unsplash.com/photo-1544738413-433b2b94e57e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&h=300&q=80',\n        description: 'Barcelona aerial view with Sagrada Familia - Perfect for bachelor party planning',\n        tags: ['barcelona', 'sagrada familia', 'aerial view', 'cityscape']\n      }],\n      message: 'Immagine specifica di Barcellona dall\\'alto fornita'\n    };\n  }\n\n  /**\n   * Cerca immagini per una destinazione specifica\n   */\n  async searchDestinationImages(destination: string, count: number = 10): Promise<ImageSearchResponse> {\n    if (destination.toLowerCase().includes('barcellona') || destination.toLowerCase().includes('barcelona')) {\n      return this.searchBarcelonaImages();\n    }\n\n    return this.searchImages(`${destination} travel destination`, count);\n  }\n}\n\nexport const imageSearchService = new ImageSearchService();","path":null,"size_bytes":7067,"size_tokens":null},"client/src/pages/SecretBlogPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { BlogPost } from \"@shared/schema\";\nimport Header from \"@/components/Header\";\nimport Footer from \"@/components/Footer\";\nimport PremiumFeatures from \"@/components/PremiumFeatures\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Lock, Star, MessageSquare, Send } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function SecretBlogPage() {\n  const { isAuthenticated, user } = useAuth();\n  const isPremium = user?.isPremium || false;\n  const [newPostContent, setNewPostContent] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: blogPosts, isLoading, error } = useQuery<BlogPost[]>({\n    queryKey: [\"/api/blog-posts\", { premium: isPremium }],\n  });\n\n  const handleSubmitPost = () => {\n    if (!isAuthenticated) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please login to share your story.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!isPremium) {\n      toast({\n        title: \"Premium feature\",\n        description: \"Upgrade to premium to share your own secret stories.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!newPostContent.trim()) {\n      toast({\n        title: \"Empty post\",\n        description: \"Please write something before submitting.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    toast({\n      title: \"Story submitted\",\n      description: \"Your story has been submitted for review. It will be published soon!\",\n    });\n    \n    setNewPostContent(\"\");\n  };\n\n  return (\n    <div className=\"min-h-screen flex flex-col bg-light\">\n      <Header />\n      \n      <main className=\"flex-grow\">\n        <div className=\"bg-primary text-white py-16\">\n          <div className=\"container mx-auto px-4 text-center\">\n            <h1 className=\"text-4xl font-bold font-poppins mb-4\">Secret Blog</h1>\n            <p className=\"max-w-2xl mx-auto\">Real, anonymous stories from bachelor parties around Europe. Learn from others' experiences and share your own.</p>\n          </div>\n        </div>\n        \n        <div className=\"container mx-auto px-4 py-10\">\n          <Tabs defaultValue=\"popular\" className=\"w-full\">\n            <div className=\"flex justify-between items-center mb-6\">\n              <TabsList>\n                <TabsTrigger value=\"popular\"><Star className=\"mr-2 h-4 w-4\" /> Popular Stories</TabsTrigger>\n                <TabsTrigger value=\"newest\"><MessageSquare className=\"mr-2 h-4 w-4\" /> Newest Stories</TabsTrigger>\n              </TabsList>\n              \n              {!isPremium && (\n                <div className=\"hidden md:block\">\n                  <Button \n                    variant=\"outline\" \n                    className=\"border-primary text-primary hover:bg-primary hover:text-white\"\n                    onClick={() => document.getElementById('premium-features')?.scrollIntoView({ behavior: 'smooth' })}\n                  >\n                    Unlock Premium Access\n                  </Button>\n                </div>\n              )}\n            </div>\n            \n            <TabsContent value=\"popular\">\n              {isLoading ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10\">\n                  {[1, 2, 3, 4, 5, 6].map((i) => (\n                    <Card key={i} className=\"overflow-hidden\">\n                      <Skeleton className=\"h-40 w-full\" />\n                      <CardHeader>\n                        <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                      </CardHeader>\n                      <CardContent>\n                        <Skeleton className=\"h-4 w-full mb-2\" />\n                        <Skeleton className=\"h-4 w-full mb-2\" />\n                        <Skeleton className=\"h-4 w-3/4\" />\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : error ? (\n                <div className=\"text-center py-10\">\n                  <p className=\"text-red-500\">Error loading blog posts. Please try again later.</p>\n                </div>\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10\">\n                  {blogPosts?.map((post) => (\n                    <Card key={post.id} className=\"overflow-hidden\">\n                      <div className=\"relative\">\n                        <img \n                          src={post.image} \n                          alt={post.title} \n                          className=\"w-full h-40 object-cover\" \n                        />\n                        <div className=\"absolute top-2 left-2\">\n                          {post.isPremium ? (\n                            <span className=\"bg-primary text-white text-xs px-2 py-1 rounded-full font-medium\">Premium</span>\n                          ) : (\n                            <span className=\"bg-green-500 text-white text-xs px-2 py-1 rounded-full font-medium\">Free</span>\n                          )}\n                        </div>\n                        \n                        {post.isPremium && !isPremium && (\n                          <div className=\"absolute inset-0 bg-black/60 flex items-center justify-center\">\n                            <Lock className=\"text-white h-10 w-10\" />\n                          </div>\n                        )}\n                      </div>\n                      \n                      <CardHeader>\n                        <CardTitle>{post.title}</CardTitle>\n                      </CardHeader>\n                      \n                      <CardContent>\n                        <p className=\"text-gray-600 line-clamp-3\">{post.content}</p>\n                      </CardContent>\n                      \n                      <CardFooter className=\"flex justify-between\">\n                        <div className=\"flex items-center\">\n                          <div className=\"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-2\">\n                            <i className=\"fas fa-user text-gray-500\"></i>\n                          </div>\n                          <span className=\"text-sm text-gray-600\">Anonymous</span>\n                        </div>\n                        \n                        <Button variant=\"ghost\" className=\"text-primary hover:text-accent\">\n                          Read More\n                        </Button>\n                      </CardFooter>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </TabsContent>\n            \n            <TabsContent value=\"newest\">\n              {/* This would normally contain different content, but for simplicity, we'll show the same content */}\n              {isLoading ? (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10\">\n                  {[1, 2, 3, 4, 5, 6].map((i) => (\n                    <Card key={i} className=\"overflow-hidden\">\n                      <Skeleton className=\"h-40 w-full\" />\n                      <CardHeader>\n                        <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                      </CardHeader>\n                      <CardContent>\n                        <Skeleton className=\"h-4 w-full mb-2\" />\n                        <Skeleton className=\"h-4 w-full mb-2\" />\n                        <Skeleton className=\"h-4 w-3/4\" />\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10\">\n                  {/* We would typically sort by date here */}\n                  {blogPosts?.map((post) => (\n                    <Card key={post.id} className=\"overflow-hidden\">\n                      <div className=\"relative\">\n                        <img \n                          src={post.image} \n                          alt={post.title} \n                          className=\"w-full h-40 object-cover\" \n                        />\n                        <div className=\"absolute top-2 left-2\">\n                          {post.isPremium ? (\n                            <span className=\"bg-primary text-white text-xs px-2 py-1 rounded-full font-medium\">Premium</span>\n                          ) : (\n                            <span className=\"bg-green-500 text-white text-xs px-2 py-1 rounded-full font-medium\">Free</span>\n                          )}\n                        </div>\n                        \n                        {post.isPremium && !isPremium && (\n                          <div className=\"absolute inset-0 bg-black/60 flex items-center justify-center\">\n                            <Lock className=\"text-white h-10 w-10\" />\n                          </div>\n                        )}\n                      </div>\n                      \n                      <CardHeader>\n                        <CardTitle>{post.title}</CardTitle>\n                      </CardHeader>\n                      \n                      <CardContent>\n                        <p className=\"text-gray-600 line-clamp-3\">{post.content}</p>\n                      </CardContent>\n                      \n                      <CardFooter className=\"flex justify-between\">\n                        <div className=\"flex items-center\">\n                          <div className=\"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-2\">\n                            <i className=\"fas fa-user text-gray-500\"></i>\n                          </div>\n                          <span className=\"text-sm text-gray-600\">Anonymous</span>\n                        </div>\n                        \n                        <Button variant=\"ghost\" className=\"text-primary hover:text-accent\">\n                          Read More\n                        </Button>\n                      </CardFooter>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </TabsContent>\n          </Tabs>\n          \n          {/* Share Your Story Section */}\n          <div className=\"mt-10 p-6 bg-white rounded-lg shadow-md\">\n            <h2 className=\"text-2xl font-bold font-poppins mb-4\">Share Your Story</h2>\n            <p className=\"text-gray-600 mb-4\">\n              {isPremium \n                ? \"Share your anonymous bachelor party experiences with the community.\" \n                : \"Upgrade to premium to share your own story and read unlimited secret blogs.\"}\n            </p>\n            \n            <div className=\"relative\">\n              {!isPremium && (\n                <div className=\"absolute inset-0 bg-gray-200/70 backdrop-blur-sm rounded-lg flex flex-col items-center justify-center z-10\">\n                  <Lock className=\"text-primary h-10 w-10 mb-3\" />\n                  <p className=\"text-gray-800 font-medium mb-3\">Premium Members Only</p>\n                  <Button \n                    className=\"bg-primary hover:bg-accent\"\n                    onClick={() => document.getElementById('premium-features')?.scrollIntoView({ behavior: 'smooth' })}\n                  >\n                    Upgrade to Share\n                  </Button>\n                </div>\n              )}\n              \n              <Textarea \n                placeholder=\"Share your wildest (anonymous) bachelor party story...\"\n                className=\"min-h-[150px] mb-4\"\n                value={newPostContent}\n                onChange={(e) => setNewPostContent(e.target.value)}\n              />\n              \n              <div className=\"flex justify-end\">\n                <Button \n                  className=\"bg-primary hover:bg-accent\"\n                  onClick={handleSubmitPost}\n                >\n                  <Send className=\"mr-2 h-4 w-4\" />\n                  Submit Anonymously\n                </Button>\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        {/* Premium Features Section */}\n        {!isPremium && (\n          <div id=\"premium-features\">\n            <PremiumFeatures />\n          </div>\n        )}\n      </main>\n      \n      <Footer />\n    </div>\n  );\n}\n","path":null,"size_bytes":12534,"size_tokens":null},"client/src/pages/ImageTestPage.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface ImageSearchResult {\n  id: string;\n  url: string;\n  thumbnail: string;\n  title: string;\n  description?: string;\n  width?: number;\n  height?: number;\n  source?: string;\n}\n\ninterface ImageSearchResponse {\n  success: boolean;\n  images: ImageSearchResult[];\n  total: number;\n  message?: string;\n}\n\nexport default function ImageTestPage() {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [results, setResults] = useState<ImageSearchResult[]>([]);\n  const [apiStatus, setApiStatus] = useState<string>('');\n  const { toast } = useToast();\n\n  const testApiConnection = async () => {\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('GET', '/api/images/test');\n      const result = await response.json();\n      \n      setApiStatus(result.success ? '✅ Connesso' : '❌ Errore');\n      \n      toast({\n        title: result.success ? \"API Funzionante\" : \"Errore API\",\n        description: result.message,\n        variant: result.success ? \"default\" : \"destructive\",\n      });\n    } catch (error: any) {\n      setApiStatus('❌ Errore di connessione');\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile testare l'API\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const searchImages = async () => {\n    if (!searchQuery.trim()) {\n      toast({\n        title: \"Query vuota\",\n        description: \"Inserisci una query di ricerca\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('GET', `/api/images/search?query=${encodeURIComponent(searchQuery)}&limit=12`);\n      const result: ImageSearchResponse = await response.json();\n      \n      if (result.success) {\n        setResults(result.images);\n        toast({\n          title: \"Ricerca completata\",\n          description: `Trovate ${result.images.length} immagini`,\n        });\n      } else {\n        toast({\n          title: \"Errore ricerca\",\n          description: result.message || \"Errore sconosciuto\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Errore\",\n        description: \"Errore durante la ricerca\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const searchDestinationImages = async (destination: string) => {\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('GET', `/api/images/destinations/${destination}?count=8`);\n      const result: ImageSearchResponse = await response.json();\n      \n      if (result.success) {\n        setResults(result.images);\n        toast({\n          title: `Immagini per ${destination}`,\n          description: `Trovate ${result.images.length} immagini`,\n        });\n      } else {\n        toast({\n          title: \"Errore ricerca\",\n          description: result.message || \"Errore sconosciuto\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Errore\",\n        description: \"Errore durante la ricerca destinazione\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-orange-50 to-red-100 p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        <Card className=\"mb-8\">\n          <CardHeader>\n            <CardTitle className=\"text-2xl font-bold text-center\">\n              🔍 Test API Ricerca Immagini\n            </CardTitle>\n            <CardDescription className=\"text-center\">\n              Test dell'integrazione con l'API per la ricerca di immagini\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Test connessione API */}\n            <div className=\"flex items-center gap-4\">\n              <Button \n                onClick={testApiConnection}\n                disabled={isLoading}\n                variant=\"outline\"\n              >\n                Test Connessione API\n              </Button>\n              <span className=\"text-sm font-medium\">{apiStatus}</span>\n            </div>\n\n            {/* Ricerca generale */}\n            <div className=\"flex gap-2\">\n              <Input\n                placeholder=\"Cerca immagini (es: 'ibiza beach')\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                onKeyPress={(e) => e.key === 'Enter' && searchImages()}\n              />\n              <Button \n                onClick={searchImages}\n                disabled={isLoading || !searchQuery.trim()}\n              >\n                Cerca\n              </Button>\n            </div>\n\n            {/* Ricerca destinazioni */}\n            <div className=\"flex flex-wrap gap-2\">\n              <span className=\"text-sm font-medium\">Test destinazioni:</span>\n              {['Ibiza', 'Roma', 'Barcellona', 'Amsterdam'].map((dest) => (\n                <Button\n                  key={dest}\n                  variant=\"secondary\"\n                  size=\"sm\"\n                  onClick={() => searchDestinationImages(dest)}\n                  disabled={isLoading}\n                >\n                  {dest}\n                </Button>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Risultati ricerca */}\n        {results.length > 0 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Risultati Ricerca ({results.length} immagini)</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                {results.map((image) => (\n                  <div key={image.id} className=\"space-y-2\">\n                    <img\n                      src={image.thumbnail || image.url}\n                      alt={image.title}\n                      className=\"w-full h-32 object-cover rounded-lg shadow-sm hover:shadow-md transition-shadow\"\n                      loading=\"lazy\"\n                    />\n                    <div className=\"text-xs space-y-1\">\n                      <p className=\"font-medium line-clamp-2\">{image.title}</p>\n                      {image.description && (\n                        <p className=\"text-gray-600 line-clamp-1\">{image.description}</p>\n                      )}\n                      <p className=\"text-gray-500\">\n                        {image.width}x{image.height} • {image.source}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Loading state */}\n        {isLoading && (\n          <div className=\"text-center py-8\">\n            <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4\" />\n            <p className=\"text-gray-600\">Ricerca in corso...</p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":7393,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ExperienceTypes.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Experience } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ArrowRight } from \"lucide-react\";\n\ntype Brand = 'bro' | 'bride';\n\ninterface ExperienceTypesProps {\n  brand?: Brand;\n}\n\nconst COPY = {\n  bro: {\n    title: \"Choose Your Experience\",\n    subtitle: \"From adrenaline-pumping adventures to relaxing getaways, we've got the perfect experience for every bachelor party.\"\n  },\n  bride: {\n    title: \"Choose Your Experience\",\n    subtitle: \"From adrenaline-pumping adventures to relaxing getaways, we've got the perfect experience for every bachelorette party.\"\n  }\n};\n\nconst EXPERIENCE_NAME_MAP: Record<string, string> = {\n  \"The Ultimate BroNight\": \"The Ultimate BrideNight\",\n  \"My Olympic Bro\": \"My Olympic Bride\",\n  \"Chill and Feel the Bro\": \"Chill and Feel the Bride\",\n  \"The Wild Broventure\": \"The Wild Brideventure\"\n};\n\nexport default function ExperienceTypes({ brand = 'bro' }: ExperienceTypesProps) {\n  const { data: experiences, isLoading, error } = useQuery<Experience[]>({\n    queryKey: [\"/api/experiences\"],\n  });\n  \n  const copy = COPY[brand];\n  const mappedExperiences = experiences?.map(exp => ({\n    ...exp,\n    name: brand === 'bride' && EXPERIENCE_NAME_MAP[exp.name] ? EXPERIENCE_NAME_MAP[exp.name] : exp.name\n  }));\n\n  if (isLoading) {\n    return (\n      <section className=\"py-16 bg-black\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center mb-12\">\n            <Skeleton className=\"h-10 w-64 mx-auto\" />\n            <Skeleton className=\"h-5 w-96 mx-auto mt-3\" />\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {[1, 2, 3, 4].map((i) => (\n              <div key={i} className=\"bg-gray-900 rounded-xl overflow-hidden shadow-md\">\n                <Skeleton className=\"h-48 w-full\" />\n                <div className=\"p-4\">\n                  <Skeleton className=\"h-6 w-36 mb-4\" />\n                  <Skeleton className=\"h-4 w-full mb-4\" />\n                  <Skeleton className=\"h-4 w-24\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (error) {\n    return (\n      <section className=\"py-16 bg-black\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center\">\n            <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3 text-white\">Choose Your Experience</h2>\n            <p className=\"text-red-500\">Error loading experiences. Please try again later.</p>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"py-16 bg-black\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-3xl md:text-4xl font-bold font-poppins mb-3 text-white\">{copy.title}</h2>\n          <p className=\"text-gray-300 max-w-3xl mx-auto\">{copy.subtitle}</p>\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n          {mappedExperiences?.map((experience) => (\n            <div key={experience.id} className=\"bg-gray-900 rounded-xl overflow-hidden shadow-md group hover:shadow-lg transition duration-300\">\n              <div className=\"relative h-48 overflow-hidden\">\n                <img \n                  src={experience.image} \n                  alt={experience.name} \n                  className=\"w-full h-full object-cover transition duration-500 group-hover:scale-110\" \n                />\n                <div className=\"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end\">\n                  <div className=\"p-4\">\n                    <h3 className=\"text-white text-xl font-bold font-poppins\">{experience.name}</h3>\n                  </div>\n                </div>\n              </div>\n              <div className=\"p-4\">\n                <p className=\"text-gray-300 text-sm\">{experience.description}</p>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":4173,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5742,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/pages/SplittaBroFixed.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Plus, Users, Trash2, Share, Calculator, Euro } from \"lucide-react\";\n\nconst createGroupSchema = z.object({\n  name: z.string().min(1, \"Il nome del gruppo è obbligatorio\"),\n  participants: z.array(z.string().min(1, \"Nome obbligatorio\")).min(2, \"Servono almeno 2 partecipanti\")\n});\n\nconst expenseSchema = z.object({\n  description: z.string().min(1, \"Descrizione obbligatoria\"),\n  amount: z.number().min(0.01, \"Importo deve essere maggiore di 0\"),\n  paidBy: z.string().min(1, \"Seleziona chi ha pagato\"),\n  category: z.string().min(1, \"Categoria obbligatoria\"),\n  date: z.string()\n});\n\nexport default function SplittaBroFixed() {\n  const [selectedGroup, setSelectedGroup] = useState<number | null>(null);\n  const [showCreateGroupDialog, setShowCreateGroupDialog] = useState(false);\n  const [showExpenseDialog, setShowExpenseDialog] = useState(false);\n  const [participants, setParticipants] = useState<string[]>([\"\", \"\"]);\n  const { toast } = useToast();\n\n  const groupForm = useForm({\n    resolver: zodResolver(createGroupSchema),\n    defaultValues: {\n      name: \"\",\n      participants: [\"\", \"\"]\n    }\n  });\n\n  const expenseForm = useForm({\n    resolver: zodResolver(expenseSchema),\n    defaultValues: {\n      description: \"\",\n      amount: 0,\n      paidBy: \"\",\n      category: \"Cibo\",\n      date: new Date().toISOString().split('T')[0],\n    },\n  });\n\n  const { data: groups = [] } = useQuery({\n    queryKey: ['/api/expense-groups'],\n    queryFn: async () => {\n      const response = await apiRequest(\"GET\", \"/api/expense-groups\");\n      return await response.json();\n    }\n  });\n\n  const { data: expenses = [] } = useQuery({\n    queryKey: ['/api/expense-groups', selectedGroup, 'expenses'],\n    queryFn: async () => {\n      if (!selectedGroup) return [];\n      const response = await apiRequest(\"GET\", `/api/expense-groups/${selectedGroup}/expenses`);\n      return await response.json();\n    },\n    enabled: !!selectedGroup\n  });\n\n  const createGroup = useMutation({\n    mutationFn: async (data: any) => {\n      const validParticipants = data.participants.filter((p: string) => p.trim() !== \"\");\n      \n      const groupData = {\n        name: data.name.trim(),\n        participants: validParticipants.map((name: string) => ({ name: name.trim() })),\n        tripId: 0\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/expense-groups\", groupData);\n      return await response.json();\n    },\n    onSuccess: (group) => {\n      setSelectedGroup(group.id);\n      setShowCreateGroupDialog(false);\n      groupForm.reset();\n      setParticipants([\"\", \"\"]);\n      toast({\n        title: \"Gruppo creato!\",\n        description: `Il gruppo \"${group.name}\" è stato creato.`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups'] });\n    }\n  });\n\n  const createExpense = useMutation({\n    mutationFn: async (data: any) => {\n      if (!selectedGroup) throw new Error(\"Nessun gruppo selezionato\");\n      \n      const group = groups.find((g: any) => g.id === selectedGroup);\n      if (!group) throw new Error(\"Gruppo non trovato\");\n\n      const sharePerPerson = Math.round((data.amount * 100) / group.participants.length);\n      const remainder = (data.amount * 100) - (sharePerPerson * group.participants.length);\n      \n      const splitWith = group.participants.map((participant: any, index: number) => ({\n        name: participant.name,\n        share: index === group.participants.length - 1 ? sharePerPerson + remainder : sharePerPerson\n      }));\n\n      const expenseData = {\n        groupId: selectedGroup,\n        description: data.description,\n        amount: Math.round(data.amount * 100),\n        paidBy: data.paidBy,\n        splitWith,\n        category: data.category,\n        date: data.date\n      };\n\n      const response = await apiRequest(\"POST\", \"/api/expenses\", expenseData);\n      return await response.json();\n    },\n    onSuccess: () => {\n      setShowExpenseDialog(false);\n      expenseForm.reset();\n      toast({\n        title: \"Spesa aggiunta!\",\n        description: \"La spesa è stata registrata nel gruppo.\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/expense-groups', selectedGroup, 'expenses'] });\n    }\n  });\n\n  const addParticipant = () => {\n    setParticipants([...participants, \"\"]);\n    groupForm.setValue(\"participants\", [...participants, \"\"]);\n  };\n\n  const removeParticipant = (index: number) => {\n    if (participants.length > 2) {\n      const updated = participants.filter((_, i) => i !== index);\n      setParticipants(updated);\n      groupForm.setValue(\"participants\", updated);\n    }\n  };\n\n  const updateParticipant = (index: number, name: string) => {\n    const updated = [...participants];\n    updated[index] = name;\n    setParticipants(updated);\n    groupForm.setValue(\"participants\", updated);\n  };\n\n  const calculateBalances = () => {\n    if (!selectedGroup) return [];\n    \n    const group = groups.find((g: any) => g.id === selectedGroup);\n    if (!group) return [];\n\n    const balances: Record<string, { paid: number; owed: number; balance: number }> = {};\n    \n    group.participants.forEach((participant: any) => {\n      balances[participant.name] = { paid: 0, owed: 0, balance: 0 };\n    });\n\n    expenses.forEach((expense: any) => {\n      const paidBy = expense.paidBy;\n      const amount = expense.amount;\n      \n      if (balances[paidBy]) {\n        balances[paidBy].paid += amount;\n      }\n      \n      if (expense.splitWith && Array.isArray(expense.splitWith)) {\n        expense.splitWith.forEach((split: any) => {\n          if (split && split.name && balances[split.name]) {\n            balances[split.name].owed += (split.share || 0);\n          }\n        });\n      }\n    });\n    \n    Object.keys(balances).forEach(person => {\n      if (balances[person]) {\n        balances[person].balance = balances[person].paid - balances[person].owed;\n      }\n    });\n\n    return Object.entries(balances).map(([name, balance]) => ({ name, ...balance }));\n  };\n\n  const shareGroup = () => {\n    if (!selectedGroup) return;\n    \n    const group = groups.find((g: any) => g.id === selectedGroup);\n    if (!group) return;\n\n    const balances = calculateBalances();\n    const totalAmount = expenses.reduce((sum: number, expense: any) => sum + expense.amount, 0);\n    \n    let message = `🧾 *SplittaBro - ${group.name}*\\n\\n`;\n    message += `💰 *Totale spese:* €${(totalAmount / 100).toFixed(2)}\\n`;\n    message += `👥 *Partecipanti:* ${group.participants.map((p: any) => p.name).join(', ')}\\n\\n`;\n    \n    message += `*📊 Bilanci:*\\n`;\n    balances.forEach(balance => {\n      const status = balance.balance > 0.01 ? '✅ In credito' : \n                    balance.balance < -0.01 ? '❌ Deve pagare' : '✅ In pari';\n      message += `• ${balance.name}: €${(balance.balance / 100).toFixed(2)} ${status}\\n`;\n    });\n    \n    message += `\\n🔗 Accedi al gruppo: ${window.location.href}`;\n    \n    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;\n    window.open(whatsappUrl, '_blank');\n  };\n\n  const formatAmount = (amount: number) => `€${(amount / 100).toFixed(2)}`;\n\n  const selectedGroupData = groups.find((g: any) => g.id === selectedGroup);\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 py-8\">\n      <div className=\"container mx-auto px-4 max-w-6xl\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-2\">SplittaBro</h1>\n          <p className=\"text-xl text-gray-600\">Dividi le spese con i tuoi amici</p>\n        </div>\n\n        {groups.length === 0 ? (\n          <Card className=\"max-w-md mx-auto\">\n            <CardHeader className=\"text-center\">\n              <div className=\"w-16 h-16 bg-red-600 text-white rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Users className=\"h-8 w-8\" />\n              </div>\n              <CardTitle>Benvenuto in SplittaBro!</CardTitle>\n              <CardDescription>\n                Crea il tuo primo gruppo per iniziare a dividere le spese con i tuoi amici\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Dialog open={showCreateGroupDialog} onOpenChange={setShowCreateGroupDialog}>\n                <DialogTrigger asChild>\n                  <Button className=\"w-full bg-red-600 hover:bg-red-700\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Crea il tuo primo gruppo\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-w-md\">\n                  <DialogHeader>\n                    <DialogTitle>Crea nuovo gruppo</DialogTitle>\n                    <DialogDescription>\n                      Aggiungi i tuoi amici per iniziare a dividere le spese\n                    </DialogDescription>\n                  </DialogHeader>\n                  \n                  <form onSubmit={groupForm.handleSubmit((data) => createGroup.mutate(data))} className=\"space-y-4\">\n                    <div>\n                      <Label>Nome del gruppo</Label>\n                      <Input \n                        {...groupForm.register(\"name\")} \n                        placeholder=\"es. Viaggio Amsterdam, Cena gruppo...\"\n                      />\n                      {groupForm.formState.errors.name && (\n                        <p className=\"text-red-500 text-sm mt-1\">{groupForm.formState.errors.name.message}</p>\n                      )}\n                    </div>\n\n                    <div>\n                      <Label>Partecipanti</Label>\n                      <div className=\"space-y-2\">\n                        {participants.map((participant, index) => (\n                          <div key={index} className=\"flex gap-2\">\n                            <Input\n                              value={participant}\n                              onChange={(e) => updateParticipant(index, e.target.value)}\n                              placeholder={`Nome partecipante ${index + 1}`}\n                            />\n                            {participants.length > 2 && (\n                              <Button\n                                type=\"button\"\n                                variant=\"outline\"\n                                size=\"icon\"\n                                onClick={() => removeParticipant(index)}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={addParticipant}\n                        className=\"w-full mt-2\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Aggiungi partecipante\n                      </Button>\n                    </div>\n\n                    <DialogFooter>\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setShowCreateGroupDialog(false)}>\n                        Annulla\n                      </Button>\n                      <Button type=\"submit\" disabled={createGroup.isPending} className=\"bg-red-600 hover:bg-red-700\">\n                        {createGroup.isPending ? \"Creando...\" : \"Crea gruppo\"}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n            <div className=\"lg:col-span-1\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <CardTitle className=\"text-lg\">I tuoi gruppi</CardTitle>\n                  <Dialog open={showCreateGroupDialog} onOpenChange={setShowCreateGroupDialog}>\n                    <DialogTrigger asChild>\n                      <Button size=\"sm\" className=\"bg-red-600 hover:bg-red-700\">\n                        <Plus className=\"h-4 w-4\" />\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent className=\"max-w-md\">\n                      <DialogHeader>\n                        <DialogTitle>Crea nuovo gruppo</DialogTitle>\n                        <DialogDescription>\n                          Aggiungi i tuoi amici per iniziare a dividere le spese\n                        </DialogDescription>\n                      </DialogHeader>\n                      \n                      <form onSubmit={groupForm.handleSubmit((data) => createGroup.mutate(data))} className=\"space-y-4\">\n                        <div>\n                          <Label>Nome del gruppo</Label>\n                          <Input \n                            {...groupForm.register(\"name\")} \n                            placeholder=\"es. Viaggio Amsterdam, Cena gruppo...\"\n                          />\n                        </div>\n\n                        <div>\n                          <Label>Partecipanti</Label>\n                          <div className=\"space-y-2\">\n                            {participants.map((participant, index) => (\n                              <div key={index} className=\"flex gap-2\">\n                                <Input\n                                  value={participant}\n                                  onChange={(e) => updateParticipant(index, e.target.value)}\n                                  placeholder={`Nome partecipante ${index + 1}`}\n                                />\n                                {participants.length > 2 && (\n                                  <Button\n                                    type=\"button\"\n                                    variant=\"outline\"\n                                    size=\"icon\"\n                                    onClick={() => removeParticipant(index)}\n                                  >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                  </Button>\n                                )}\n                              </div>\n                            ))}\n                          </div>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            onClick={addParticipant}\n                            className=\"w-full mt-2\"\n                          >\n                            <Plus className=\"h-4 w-4 mr-2\" />\n                            Aggiungi partecipante\n                          </Button>\n                        </div>\n\n                        <DialogFooter>\n                          <Button type=\"button\" variant=\"outline\" onClick={() => setShowCreateGroupDialog(false)}>\n                            Annulla\n                          </Button>\n                          <Button type=\"submit\" disabled={createGroup.isPending} className=\"bg-red-600 hover:bg-red-700\">\n                            {createGroup.isPending ? \"Creando...\" : \"Crea gruppo\"}\n                          </Button>\n                        </DialogFooter>\n                      </form>\n                    </DialogContent>\n                  </Dialog>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-2\">\n                    {groups.map((group: any) => (\n                      <div\n                        key={group.id}\n                        className={`p-3 rounded-lg cursor-pointer transition-colors ${\n                          selectedGroup === group.id\n                            ? \"bg-red-100 border-2 border-red-300\"\n                            : \"bg-gray-100 hover:bg-gray-200\"\n                        }`}\n                        onClick={() => setSelectedGroup(group.id)}\n                      >\n                        <div className=\"font-medium text-sm\">{group.name}</div>\n                        <div className=\"text-xs text-gray-500\">{group.participants.length} partecipanti</div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            {selectedGroup && selectedGroupData && (\n              <div className=\"lg:col-span-3 space-y-6\">\n                <Card>\n                  <CardHeader className=\"flex flex-row items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Users className=\"h-5 w-5\" />\n                        {selectedGroupData.name}\n                      </CardTitle>\n                      <CardDescription>\n                        {selectedGroupData.participants.length} partecipanti • {expenses.length} spese\n                      </CardDescription>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button variant=\"outline\" onClick={shareGroup}>\n                        <Share className=\"h-4 w-4 mr-2\" />\n                        Condividi su WhatsApp\n                      </Button>\n                      <Dialog open={showExpenseDialog} onOpenChange={setShowExpenseDialog}>\n                        <DialogTrigger asChild>\n                          <Button className=\"bg-red-600 hover:bg-red-700\">\n                            <Plus className=\"h-4 w-4 mr-2\" />\n                            Aggiungi spesa\n                          </Button>\n                        </DialogTrigger>\n                        <DialogContent className=\"max-w-md\">\n                          <DialogHeader>\n                            <DialogTitle>Nuova spesa</DialogTitle>\n                            <DialogDescription>\n                              Aggiungi una spesa al gruppo {selectedGroupData.name}\n                            </DialogDescription>\n                          </DialogHeader>\n                          \n                          <form onSubmit={expenseForm.handleSubmit((data) => createExpense.mutate(data))} className=\"space-y-6\">\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label className=\"text-base font-medium\">Descrizione della spesa</Label>\n                                <Input \n                                  {...expenseForm.register(\"description\")} \n                                  placeholder=\"Inserisci descrizione (es. Cena al ristorante)\" \n                                  className=\"text-lg\"\n                                />\n                              </div>\n\n                              <div>\n                                <Label className=\"text-base font-medium\">Importo totale</Label>\n                                <div className=\"relative\">\n                                  <span className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg\">€</span>\n                                  <Input \n                                    type=\"number\" \n                                    step=\"0.01\" \n                                    {...expenseForm.register(\"amount\", { valueAsNumber: true })} \n                                    placeholder=\"0.00\"\n                                    className=\"text-lg pl-8\"\n                                  />\n                                </div>\n                              </div>\n                            </div>\n\n                            <div>\n                              <Label className=\"text-base font-medium\">Pagato da</Label>\n                              <Select onValueChange={(value) => expenseForm.setValue(\"paidBy\", value)}>\n                                <SelectTrigger className=\"text-lg\">\n                                  <SelectValue placeholder=\"Seleziona chi ha pagato\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {selectedGroupData.participants.map((p: any) => (\n                                    <SelectItem key={p.name} value={p.name}>\n                                      <div className=\"flex items-center gap-2\">\n                                        <div className=\"w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold\">\n                                          {p.name.charAt(0)}\n                                        </div>\n                                        {p.name}\n                                      </div>\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-4\">\n                              <div>\n                                <Label className=\"text-base font-medium\">Categoria</Label>\n                                <Select onValueChange={(value) => expenseForm.setValue(\"category\", value)} defaultValue=\"Cibo\">\n                                  <SelectTrigger>\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"Cibo\">🍽️ Cibo & Ristoranti</SelectItem>\n                                    <SelectItem value=\"Trasporto\">🚗 Trasporto</SelectItem>\n                                    <SelectItem value=\"Alloggio\">🏨 Alloggio</SelectItem>\n                                    <SelectItem value=\"Attività\">🎯 Attività & Divertimento</SelectItem>\n                                    <SelectItem value=\"Bevande\">🍺 Bevande & Locali</SelectItem>\n                                    <SelectItem value=\"Shopping\">🛍️ Shopping</SelectItem>\n                                    <SelectItem value=\"Altro\">📝 Altro</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n\n                              <div>\n                                <Label className=\"text-base font-medium\">Data</Label>\n                                <Input type=\"date\" {...expenseForm.register(\"date\")} />\n                              </div>\n                            </div>\n\n                            <DialogFooter className=\"mt-6\">\n                              <Button type=\"button\" variant=\"outline\" onClick={() => setShowExpenseDialog(false)}>\n                                Annulla\n                              </Button>\n                              <Button \n                                type=\"submit\" \n                                disabled={createExpense.isPending}\n                                className=\"bg-green-600 hover:bg-green-700\"\n                              >\n                                {createExpense.isPending ? \"Salvando...\" : \"Salva spesa\"}\n                              </Button>\n                            </DialogFooter>\n                          </form>\n                        </DialogContent>\n                      </Dialog>\n                    </div>\n                  </CardHeader>\n                </Card>\n\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                  <div className=\"lg:col-span-2\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Euro className=\"h-5 w-5\" />\n                          Spese del gruppo\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        {expenses.length > 0 ? (\n                          <div className=\"space-y-3\">\n                            {expenses.map((expense: any) => (\n                              <div key={expense.id} className=\"p-4 border rounded-lg bg-white\">\n                                <div className=\"flex items-center justify-between mb-2\">\n                                  <div className=\"flex items-center gap-3\">\n                                    <Badge variant=\"outline\">{expense.category}</Badge>\n                                    <div>\n                                      <div className=\"font-medium\">{expense.description}</div>\n                                      <div className=\"text-sm text-gray-500\">\n                                        Pagato da {expense.paidBy} • {new Date(expense.date).toLocaleDateString()}\n                                      </div>\n                                    </div>\n                                  </div>\n                                  <div className=\"text-right\">\n                                    <div className=\"text-lg font-bold text-gray-900\">\n                                      {formatAmount(expense.amount)}\n                                    </div>\n                                  </div>\n                                </div>\n                                \n                                <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-gray-600 bg-gray-50 rounded p-2\">\n                                  {expense.splitWith && Array.isArray(expense.splitWith) ? expense.splitWith.map((split: any, index: number) => (\n                                    <div key={index} className=\"flex justify-between\">\n                                      <span>{split.name}:</span>\n                                      <span className=\"font-medium\">{formatAmount(split.share)}</span>\n                                    </div>\n                                  )) : (\n                                    <div className=\"text-gray-500\">Nessuna divisione disponibile</div>\n                                  )}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className=\"text-center py-8 text-gray-500\">\n                            Nessuna spesa registrata\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <div className=\"space-y-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Calculator className=\"h-5 w-5\" />\n                          Bilanci\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          {calculateBalances().map((balance, index) => (\n                            <div key={index} className={`flex items-center justify-between p-4 rounded-lg transition-all hover:shadow-md ${\n                              balance.balance > 0.01\n                                ? \"bg-green-50 border border-green-200\" \n                                : balance.balance < -0.01\n                                  ? \"bg-red-50 border border-red-200\" \n                                  : \"bg-gray-50 border border-gray-200\"\n                            }`}>\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"w-12 h-12 bg-red-600 text-white rounded-full flex items-center justify-center font-bold text-lg\">\n                                  {balance.name.charAt(0).toUpperCase()}\n                                </div>\n                                <div className=\"flex flex-col\">\n                                  <span className=\"font-semibold text-lg\">{balance.name}</span>\n                                  <div className=\"text-sm text-gray-500\">\n                                    Ha pagato {formatAmount(balance.paid)} • Deve {formatAmount(balance.owed)}\n                                  </div>\n                                </div>\n                              </div>\n                              <div className=\"text-right\">\n                                <div className={`text-2xl font-bold ${\n                                  balance.balance > 0.01\n                                    ? \"text-green-600\" \n                                    : balance.balance < -0.01\n                                      ? \"text-red-600\" \n                                      : \"text-gray-600\"\n                                }`}>\n                                  {balance.balance > 0.01 ? \"+\" : \"\"}{formatAmount(balance.balance)}\n                                </div>\n                                <div className={`text-sm font-medium ${\n                                  balance.balance > 0.01\n                                    ? \"text-green-600\" \n                                    : balance.balance < -0.01\n                                      ? \"text-red-600\" \n                                      : \"text-gray-600\"\n                                }`}>\n                                  {balance.balance > 0.01 ? \"In credito\" : \n                                   balance.balance < -0.01 ? \"Deve pagare\" : \"In pari\"}\n                                </div>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":30457,"size_tokens":null},"client/src/pages/MerchandisePage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Merchandise } from \"@shared/schema\";\nimport Header from \"@/components/Header\";\nimport Footer from \"@/components/Footer\";\nimport CustomMerchandise from \"@/components/CustomMerchandise\";\nimport Newsletter from \"@/components/Newsletter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardFooter } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ShoppingBag, Heart, ShoppingCart } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient } from \"@/lib/queryClient\";\n\nexport default function MerchandisePage() {\n  const [cart, setCart] = useState<Array<{ id: number; quantity: number }>>([]);\n  const { toast } = useToast();\n\n  // Funzione helper per aggiungere il cache buster alle URL delle immagini\n  const getCacheBustedImageUrl = (url: string) => {\n    return `${url}?t=${Date.now()}`;\n  };\n  \n  // Aggiungiamo un useEffect per invalidare la cache all'avvio del componente\n  useEffect(() => {\n    // Invalida la cache della query\n    queryClient.invalidateQueries({ queryKey: [\"/api/merchandise\"] });\n  }, []);\n\n  const { data: merchandise, isLoading, error } = useQuery<Merchandise[]>({\n    queryKey: [\"/api/merchandise\"],\n    staleTime: 0, // Non usare la cache\n    refetchOnMount: true, // Forza il refresh quando il componente viene montato\n  });\n\n  const handleAddToCart = (id: number) => {\n    const existingItemIndex = cart.findIndex(item => item.id === id);\n    \n    if (existingItemIndex >= 0) {\n      const newCart = [...cart];\n      newCart[existingItemIndex].quantity += 1;\n      setCart(newCart);\n    } else {\n      setCart([...cart, { id, quantity: 1 }]);\n    }\n    \n    toast({\n      title: \"Added to cart\",\n      description: \"Item has been added to your cart.\",\n    });\n  };\n\n  // Group merchandise by type\n  const groupedMerchandise = merchandise?.reduce((acc, item) => {\n    if (!acc[item.type]) {\n      acc[item.type] = [];\n    }\n    acc[item.type].push(item);\n    return acc;\n  }, {} as Record<string, Merchandise[]>) || {};\n\n  // Get unique types for tabs\n  const types = Object.keys(groupedMerchandise);\n\n  return (\n    <div className=\"min-h-screen flex flex-col bg-light\">\n      <Header />\n      \n      <main className=\"flex-grow\">\n        <div className=\"bg-primary text-white py-16\">\n          <div className=\"container mx-auto px-4 text-center\">\n            <h1 className=\"text-4xl font-bold font-poppins mb-4\">Custom Bachelor Party Merchandise</h1>\n            <p className=\"max-w-2xl mx-auto\">Create personalized gear for the whole crew. Make your bachelor party unforgettable with custom t-shirts, caps, and more.</p>\n          </div>\n        </div>\n        \n        <div className=\"container mx-auto px-4 py-10\">\n          {/* Shopping Cart Badge */}\n          <div className=\"flex justify-end mb-6\">\n            <Button variant=\"outline\" className=\"relative\">\n              <ShoppingCart className=\"h-5 w-5 mr-2\" />\n              <span>Cart</span>\n              {cart.length > 0 && (\n                <span className=\"absolute -top-2 -right-2 bg-primary text-white text-xs w-5 h-5 rounded-full flex items-center justify-center\">\n                  {cart.reduce((sum, item) => sum + item.quantity, 0)}\n                </span>\n              )}\n            </Button>\n          </div>\n          \n          {/* Product Categories */}\n          {isLoading ? (\n            <div className=\"mb-12\">\n              <Skeleton className=\"h-10 w-64 mb-6\" />\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6\">\n                {[1, 2, 3, 4].map((i) => (\n                  <Card key={i} className=\"overflow-hidden\">\n                    <Skeleton className=\"h-64 w-full\" />\n                    <CardContent className=\"p-4\">\n                      <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                      <Skeleton className=\"h-4 w-full mb-4\" />\n                      <Skeleton className=\"h-5 w-20\" />\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </div>\n          ) : error ? (\n            <div className=\"text-center py-10\">\n              <p className=\"text-red-500\">Error loading merchandise. Please try again later.</p>\n            </div>\n          ) : types.length > 0 ? (\n            <Tabs defaultValue={types[0]} className=\"mb-12\">\n              <TabsList className=\"mb-6\">\n                {types.map((type) => (\n                  <TabsTrigger key={type} value={type} className=\"capitalize\">\n                    {type}s\n                  </TabsTrigger>\n                ))}\n              </TabsList>\n              \n              {types.map((type) => (\n                <TabsContent key={type} value={type}>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6\">\n                    {groupedMerchandise[type].map((item) => (\n                      <Card key={item.id} className=\"overflow-hidden group\">\n                        <div className=\"relative h-64 overflow-hidden\">\n                          <img \n                            src={getCacheBustedImageUrl(item.image)} \n                            alt={item.name} \n                            className=\"w-full h-full object-cover transition duration-500 group-hover:scale-105\" \n                          />\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"absolute top-2 right-2 bg-white/80 text-gray-600 hover:text-primary hover:bg-white\"\n                          >\n                            <Heart className=\"h-5 w-5\" />\n                          </Button>\n                        </div>\n                        <CardContent className=\"p-4\">\n                          <h3 className=\"font-bold text-lg mb-1\">{item.name}</h3>\n                          <p className=\"text-gray-600 text-sm mb-3\">{item.description}</p>\n                          <p className=\"text-primary font-bold\">€{(item.price / 100).toFixed(2)}</p>\n                        </CardContent>\n                        <CardFooter className=\"pt-0 pb-4 px-4\">\n                          <Button \n                            className=\"w-full bg-primary hover:bg-accent\"\n                            onClick={() => handleAddToCart(item.id)}\n                          >\n                            <ShoppingBag className=\"mr-2 h-4 w-4\" />\n                            Add to Cart\n                          </Button>\n                        </CardFooter>\n                      </Card>\n                    ))}\n                  </div>\n                </TabsContent>\n              ))}\n            </Tabs>\n          ) : (\n            <div className=\"text-center py-10\">\n              <p>No merchandise found. Please check back later.</p>\n            </div>\n          )}\n        </div>\n        \n        {/* Custom Merchandise Section */}\n        <CustomMerchandise />\n        \n        {/* Newsletter */}\n        <Newsletter />\n      </main>\n      \n      <Footer />\n    </div>\n  );\n}\n","path":null,"size_bytes":7252,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/pages/OneClickPackagePage.tsx":{"content":"import { useState } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { Separator } from '@/components/ui/separator';\nimport OneClickAssistant from '@/components/OneClickAssistant';\nimport { MessageSquare, Package, ShoppingBag, Info } from 'lucide-react';\n\nexport default function OneClickPackagePage() {\n  const [activeTab, setActiveTab] = useState<string>('assistant');\n\n  return (\n    <div className=\"container mx-auto py-8\">\n      <div className=\"flex flex-col md:flex-row gap-8\">\n        {/* Pannello principale */}\n        <div className=\"w-full md:w-8/12\">\n          <Card className=\"mb-6 border-red-600 bg-black text-white\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"text-3xl font-bold text-white\">\n                    <span className=\"text-white\">Bye</span><span className=\"text-red-600\">Bro</span> One Click\n                  </CardTitle>\n                  <CardDescription className=\"text-gray-300\">\n                    Crea e acquista il pacchetto addio al celibato perfetto con un solo clic\n                  </CardDescription>\n                </div>\n                <div className=\"hidden md:block\">\n                  <img \n                    src=\"https://images.unsplash.com/photo-1513956589380-bad6acb9b9d4?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1074&q=80\" \n                    alt=\"ByeBro One Click\" \n                    className=\"h-16 w-16 object-cover rounded-full ring-2 ring-red-600\"\n                  />\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <Tabs value={activeTab} onValueChange={setActiveTab} className=\"text-white\">\n                <TabsList className=\"grid grid-cols-2 mb-8 bg-gray-900\">\n                  <TabsTrigger value=\"assistant\" className=\"flex items-center space-x-2 data-[state=active]:bg-red-600 data-[state=active]:text-white\">\n                    <MessageSquare className=\"h-4 w-4\" />\n                    <span>Assistente ByeBro</span>\n                  </TabsTrigger>\n                  <TabsTrigger value=\"packages\" className=\"flex items-center space-x-2 data-[state=active]:bg-red-600 data-[state=active]:text-white\">\n                    <Package className=\"h-4 w-4\" />\n                    <span>I tuoi pacchetti</span>\n                  </TabsTrigger>\n                </TabsList>\n                \n                <TabsContent value=\"assistant\" className=\"h-full\">\n                  <OneClickAssistant />\n                </TabsContent>\n                \n                <TabsContent value=\"packages\">\n                  <div className=\"space-y-6\">\n                    <div className=\"bg-gray-900 text-white rounded-lg p-6 text-center\">\n                      <div className=\"flex flex-col items-center justify-center space-y-4\">\n                        <Package className=\"h-16 w-16 text-red-500\" />\n                        <h3 className=\"text-xl font-bold text-white\">Nessun pacchetto acquistato</h3>\n                        <p className=\"text-gray-300\">\n                          Non hai ancora acquistato nessun pacchetto ByeBro. Usa l'assistente per creare il tuo primo pacchetto!\n                        </p>\n                        <Button \n                          onClick={() => setActiveTab('assistant')}\n                          className=\"bg-red-600 hover:bg-red-700 text-white\"\n                        >\n                          Crea il tuo primo pacchetto\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </TabsContent>\n              </Tabs>\n            </CardContent>\n          </Card>\n        </div>\n        \n        {/* Pannello laterale */}\n        <div className=\"w-full md:w-4/12 space-y-6\">\n          <Card className=\"border-red-600 bg-black text-white\">\n            <CardHeader>\n              <CardTitle className=\"text-xl text-white\">Come funziona</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"flex items-start space-x-3\">\n                  <div className=\"flex-shrink-0 bg-red-900 rounded-full p-2\">\n                    <MessageSquare className=\"h-5 w-5 text-red-500\" />\n                  </div>\n                  <div>\n                    <h4 className=\"font-bold text-white\">1. Parla con l'assistente</h4>\n                    <p className=\"text-sm text-gray-300\">\n                      Descrivi la tua destinazione ideale, le date e le preferenze per l'addio al celibato.\n                    </p>\n                  </div>\n                </div>\n                \n                <div className=\"flex items-start space-x-3\">\n                  <div className=\"flex-shrink-0 bg-red-900 rounded-full p-2\">\n                    <Package className=\"h-5 w-5 text-red-500\" />\n                  </div>\n                  <div>\n                    <h4 className=\"font-bold text-white\">2. Personalizza il pacchetto</h4>\n                    <p className=\"text-sm text-gray-300\">\n                      Ricevi un pacchetto personalizzato con voli, hotel, ristoranti e attività. Seleziona le opzioni che preferisci.\n                    </p>\n                  </div>\n                </div>\n                \n                <div className=\"flex items-start space-x-3\">\n                  <div className=\"flex-shrink-0 bg-red-900 rounded-full p-2\">\n                    <ShoppingBag className=\"h-5 w-5 text-red-500\" />\n                  </div>\n                  <div>\n                    <h4 className=\"font-bold text-white\">3. Acquista con un clic</h4>\n                    <p className=\"text-sm text-gray-300\">\n                      Completa l'acquisto dell'intero pacchetto con un solo clic. Niente più prenotazioni multiple!\n                    </p>\n                  </div>\n                </div>\n              </div>\n              \n              <Separator className=\"my-4 bg-red-800\" />\n              \n              <div className=\"rounded-lg bg-red-900 p-4 flex items-start space-x-3\">\n                <div className=\"flex-shrink-0\">\n                  <Info className=\"h-5 w-5 text-red-500\" />\n                </div>\n                <div>\n                  <h4 className=\"font-bold text-white\">Nota</h4>\n                  <p className=\"text-sm text-gray-300\">\n                    Tutti i pacchetti includono una garanzia di rimborso di 24 ore e assistenza dedicata durante tutto il viaggio.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card className=\"border-red-600 bg-black text-white\">\n            <CardHeader>\n              <CardTitle className=\"text-xl text-white\">Destinazioni popolari</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-start border-red-600 text-white hover:bg-red-900 hover:text-white hover:border-red-500\"\n                  onClick={() => {\n                    setActiveTab('assistant');\n                  }}\n                >\n                  Amsterdam, Paesi Bassi\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-start border-red-600 text-white hover:bg-red-900 hover:text-white hover:border-red-500\"\n                  onClick={() => {\n                    setActiveTab('assistant');\n                  }}\n                >\n                  Berlino, Germania\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-start border-red-600 text-white hover:bg-red-900 hover:text-white hover:border-red-500\"\n                  onClick={() => {\n                    setActiveTab('assistant');\n                  }}\n                >\n                  Praga, Repubblica Ceca\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-start border-red-600 text-white hover:bg-red-900 hover:text-white hover:border-red-500\"\n                  onClick={() => {\n                    setActiveTab('assistant');\n                  }}\n                >\n                  Budapest, Ungheria\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full justify-start border-red-600 text-white hover:bg-red-900 hover:text-white hover:border-red-500\"\n                  onClick={() => {\n                    setActiveTab('assistant');\n                  }}\n                >\n                  Barcellona, Spagna\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":9171,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/hooks/use-auth.tsx":{"content":"import { createContext, ReactNode, useContext, useState, useEffect } from \"react\";\nimport {\n  useQuery,\n  useMutation,\n  UseMutationResult,\n} from \"@tanstack/react-query\";\nimport { User } from \"@shared/schema\";\nimport { getQueryFn, apiRequest, queryClient } from \"../lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\n// Type definitions\ntype AuthContextType = {\n  user: User | null;\n  isLoading: boolean;\n  error: Error | null;\n  isAuthenticated: boolean;\n  loginMutation: UseMutationResult<User, Error, LoginData>;\n  logoutMutation: UseMutationResult<void, Error, void>;\n  registerMutation: UseMutationResult<User, Error, RegisterData>;\n};\n\ntype LoginData = {\n  username: string;\n  password: string;\n};\n\ntype RegisterData = {\n  username: string;\n  email: string;\n  password: string;\n  fullName?: string;\n};\n\n// Create context\nexport const AuthContext = createContext<AuthContextType | null>(null);\n\n// Provider component\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const { toast } = useToast();\n  const [isInitialized, setIsInitialized] = useState(false);\n\n  // Get current user\n  const {\n    data: user,\n    error,\n    isLoading,\n    refetch,\n  } = useQuery<User | null, Error>({\n    queryKey: [\"/api/user\"],\n    queryFn: getQueryFn({ on401: \"returnNull\" }),\n    enabled: isInitialized,\n    // Ensure we always have null rather than undefined for proper typing\n    select: (data) => data || null,\n  });\n\n  // Initialize auth state\n  useEffect(() => {\n    setIsInitialized(true);\n  }, []);\n\n  // Login mutation\n  const loginMutation = useMutation({\n    mutationFn: async (credentials: LoginData) => {\n      const res = await apiRequest(\"POST\", \"/api/login\", credentials);\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || \"Login failed\");\n      }\n      return await res.json();\n    },\n    onSuccess: (user: User) => {\n      queryClient.setQueryData([\"/api/user\"], user);\n      toast({\n        title: \"Login successful\",\n        description: `Welcome back, ${user.username}!`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Login failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Register mutation\n  const registerMutation = useMutation({\n    mutationFn: async (userData: RegisterData) => {\n      const res = await apiRequest(\"POST\", \"/api/register\", userData);\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || \"Registration failed\");\n      }\n      return await res.json();\n    },\n    onSuccess: (user: User) => {\n      queryClient.setQueryData([\"/api/user\"], user);\n      toast({\n        title: \"Registration successful\",\n        description: `Welcome, ${user.username}!`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Registration failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Logout mutation\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/logout\");\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || \"Logout failed\");\n      }\n    },\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/user\"], null);\n      toast({\n        title: \"Logged out\",\n        description: \"You have been logged out successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Logout failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Determine if user is authenticated\n  const isAuthenticated = !!user;\n\n  // Create a properly typed context value\n  const contextValue: AuthContextType = {\n    user,\n    isLoading,\n    error,\n    isAuthenticated,\n    loginMutation,\n    logoutMutation,\n    registerMutation,\n  };\n\n  return (\n    <AuthContext.Provider value={contextValue}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\n// Custom hook to use the auth context\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}","path":null,"size_bytes":4297,"size_tokens":null},"client/src/pages/HomeBride.tsx":{"content":"import Header from \"@/components/Header\";\nimport HeroSectionBride from \"@/components/HeroSectionBride\";\nimport HowItWorks from \"@/components/HowItWorks\";\nimport FeaturedDestinations from \"@/components/FeaturedDestinations\";\nimport ExperienceTypes from \"@/components/ExperienceTypes\";\nimport SecretBlog from \"@/components/SecretBlog\";\nimport PremiumFeatures from \"@/components/PremiumFeatures\";\nimport Testimonials from \"@/components/Testimonials\";\nimport Newsletter from \"@/components/Newsletter\";\nimport Footer from \"@/components/Footer\";\n\nexport default function HomeBride() {\n  return (\n    <div className=\"min-h-screen flex flex-col\">\n      <Header />\n      \n      <main className=\"flex-grow\">\n        <HeroSectionBride />\n        <HowItWorks brand=\"bride\" />\n        <FeaturedDestinations brand=\"bride\" />\n        <ExperienceTypes brand=\"bride\" />\n        <SecretBlog brand=\"bride\" />\n        <PremiumFeatures brand=\"bride\" />\n        <Testimonials brand=\"bride\" />\n        <Newsletter />\n      </main>\n      \n      <Footer />\n    </div>\n  );\n}\n","path":null,"size_bytes":1050,"size_tokens":null},"client/src/components/HeroSectionBride.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { useState } from \"react\";\nimport { Send, MessageCircle } from \"lucide-react\";\nimport ChatDialogCompactBride from \"./ChatDialogCompactBride\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\nexport default function HeroSectionBride() {\n  const { t } = useTranslation();\n  const [chatInput, setChatInput] = useState(\"\");\n  const [chatDialogOpen, setChatDialogOpen] = useState(false);\n  const [initialChatMessage, setInitialChatMessage] = useState<string | undefined>(undefined);\n\n  const handleChatSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (chatInput.trim()) {\n      setInitialChatMessage(chatInput.trim());\n      setChatInput('');\n      setChatDialogOpen(true);\n    }\n  };\n\n  return (\n    <>\n      <section className=\"relative py-16 md:py-24 bg-cover bg-center bg-no-repeat\" style={{ backgroundImage: \"url('https://images.pexels.com/photos/1024993/pexels-photo-1024993.jpeg?auto=compress&cs=tinysrgb&h=650&w=940')\" }}>\n        <div className=\"absolute inset-0 bg-gradient-to-r from-black to-pink-900 bg-opacity-75 mix-blend-multiply\"></div>\n        <div className=\"container mx-auto px-4 relative z-10\">\n          <div className=\"max-w-2xl mx-auto\">\n            <h1 className=\"text-white font-bold text-4xl md:text-5xl mb-3 leading-tight text-center\">\n              {t('hero.bride.title')}\n            </h1>\n            <p className=\"text-white text-lg mb-10 text-center max-w-3xl mx-auto\">\n              {t('hero.bride.subtitle')}\n            </p>\n\n            <div className=\"bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <MessageCircle className=\"w-6 h-6 text-pink-400\" />\n                <h3 className=\"text-white font-bold text-xl\">{t('hero.bride.chatTitle')}</h3>\n              </div>\n              \n              <p className=\"text-white/80 text-sm mb-4\">\n                {t('hero.bride.chatSubtitle')}\n              </p>\n              \n              <form onSubmit={handleChatSubmit} className=\"space-y-3\">\n                <Input\n                  type=\"text\"\n                  placeholder={t('hero.bride.placeholder')}\n                  value={chatInput}\n                  onChange={(e) => setChatInput(e.target.value)}\n                  className=\"bg-white/95 border-white/30 text-gray-900 placeholder:text-gray-500 focus:ring-2 focus:ring-pink-500\"\n                  data-testid=\"input-hero-chat-bride\"\n                />\n                <Button \n                  type=\"submit\"\n                  className=\"w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold transition-all duration-200 flex items-center justify-center gap-2\"\n                  data-testid=\"button-chat-submit-bride\"\n                >\n                  <Send className=\"w-4 h-4\" />\n                  {t('hero.bride.startChat')}\n                </Button>\n              </form>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <ChatDialogCompactBride \n        open={chatDialogOpen} \n        onOpenChange={setChatDialogOpen}\n        initialMessage={initialChatMessage}\n      />\n    </>\n  );\n}\n","path":null,"size_bytes":3245,"size_tokens":null},"client/src/components/ChatDialogCompactBride.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { z } from 'zod';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { useLocation } from 'wouter';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Loader2, Send, Heart, User, Sparkles } from 'lucide-react';\nimport { normalizeFutureTripDate, calculateTripDays, isValidDateRange, formatFlightDateTime, formatDateRangeIT } from '@shared/dateUtils';\nimport { buildAviasalesUrl, getCityIata } from '@/lib/aviasales';\n\nconst messageSchema = z.object({\n  message: z.string().min(1, \"Message cannot be empty\"),\n});\n\ntype MessageFormValues = z.infer<typeof messageSchema>;\n\ninterface ChatMessage {\n  id: string;\n  content: string;\n  sender: 'user' | 'assistant';\n  timestamp: Date;\n}\n\ninterface TripDetails {\n  people: number;\n  days: number;\n  startDate: string;\n  endDate: string;\n  adventureType: string;\n  interests: string[];\n  budget: string;\n}\n\ninterface ConversationState {\n  selectedDestination: string;\n  tripDetails: TripDetails;\n  partyType: string;\n}\n\ninterface FlightInfo {\n  id?: number;\n  airline: string;\n  departure_at: string;\n  return_at: string;\n  flight_number: number;\n  origin?: string;\n  destination?: string;\n  checkoutUrl?: string;\n}\n\ninterface SelectedFlightData {\n  flightIndex: number;\n  airline: string;\n  departure_at: string;\n  return_at: string;\n  flight_number: number;\n  originCity: string;\n  destinationCity: string;\n  checkoutUrl?: string;\n}\n\ninterface ChatDialogCompactBrideProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  initialMessage?: string;\n}\n\nexport default function ChatDialogCompactBride({ open, onOpenChange, initialMessage }: ChatDialogCompactBrideProps) {\n  const [, setLocation] = useLocation();\n  const [messages, setMessages] = useState<ChatMessage[]>([\n    {\n      id: '1',\n      content: 'Ciao! 💕 Dove vuoi andare per il tuo addio al nubilato? Dimmi la città e ti creo un pacchetto personalizzato perfetto per te e le tue amiche!',\n      sender: 'assistant',\n      timestamp: new Date(),\n    },\n  ]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [loadingMessage, setLoadingMessage] = useState<string | null>(null);\n  const [showGenerateButton, setShowGenerateButton] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\n  const messagesRef = useRef<ChatMessage[]>([]);\n  const [flights, setFlights] = useState<FlightInfo[]>([]);\n  const flightsRef = useRef<FlightInfo[]>([]);\n  const [originCity, setOriginCity] = useState<string>('');\n  const originCityRef = useRef<string>('');\n  const [selectedFlight, setSelectedFlight] = useState<SelectedFlightData | null>(null);\n  const [pendingFlightSelection, setPendingFlightSelection] = useState<number | null>(null);\n  const conversationStateRef = useRef<ConversationState>({\n    selectedDestination: '',\n    tripDetails: {\n      people: 0,\n      days: 0,\n      startDate: '',\n      endDate: '',\n      adventureType: '',\n      interests: [],\n      budget: 'medio'\n    },\n    partyType: 'bachelorette'\n  });\n  \n  const [conversationState, setConversationState] = useState<ConversationState>({\n    selectedDestination: '',\n    tripDetails: {\n      people: 0,\n      days: 0,\n      startDate: '',\n      endDate: '',\n      adventureType: '',\n      interests: [],\n      budget: 'medio'\n    },\n    partyType: 'bachelorette'\n  });\n\n  const form = useForm<MessageFormValues>({\n    resolver: zodResolver(messageSchema),\n    defaultValues: {\n      message: '',\n    },\n  });\n\n  const scrollToBottom = useCallback(() => {\n    if (scrollContainerRef.current) {\n      scrollContainerRef.current.scrollTo({\n        top: scrollContainerRef.current.scrollHeight,\n        behavior: 'smooth'\n      });\n    }\n  }, []);\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  useEffect(() => {\n    messagesRef.current = messages;\n  }, [messages]);\n\n  useEffect(() => {\n    flightsRef.current = flights;\n  }, [flights]);\n\n  useEffect(() => {\n    originCityRef.current = originCity;\n  }, [originCity]);\n\n  useEffect(() => {\n    conversationStateRef.current = conversationState;\n  }, [conversationState]);\n\n  const sendChatRequest = async (message: string, addUserMessage: boolean) => {\n    if (isLoading) return;\n    const trimmedMessage = message.trim();\n    if (addUserMessage && !trimmedMessage) return;\n\n    if (addUserMessage) {\n      const userMessage: ChatMessage = {\n        id: Date.now().toString(),\n        content: trimmedMessage,\n        sender: 'user',\n        timestamp: new Date()\n      };\n      setMessages((prev) => [...prev, userMessage]);\n    }\n\n    setIsLoading(true);\n\n    try {\n      const conversationHistory = messagesRef.current.map((msg) => ({\n        role: msg.sender === 'user' ? 'user' : 'assistant',\n        content: msg.content\n      }));\n\n      const currentState = conversationStateRef.current;\n      const payload = {\n        message: trimmedMessage,\n        selectedDestination: currentState.selectedDestination,\n        tripDetails: currentState.tripDetails,\n        conversationHistory,\n        partyType: currentState.partyType,\n        originCity: originCityRef.current\n      };\n      console.log('🔍 OPENAI STREAM PAYLOAD:', payload);\n\n      const response = await fetch('/api/chat/openai-stream', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(payload)\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to get response');\n      }\n\n      const assistantMessageId = (Date.now() + 1).toString();\n      const placeholderMessage: ChatMessage = {\n        id: assistantMessageId,\n        content: '',\n        sender: 'assistant',\n        timestamp: new Date()\n      };\n\n      setMessages((prev) => [...prev, placeholderMessage]);\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      let accumulatedContent = '';\n\n      if (reader) {\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) break;\n\n          const chunk = decoder.decode(value);\n          const lines = chunk.split('\\n');\n\n          for (const line of lines) {\n            if (line.startsWith('data: ')) {\n              try {\n                const jsonData = JSON.parse(line.slice(6));\n\n                if (jsonData.error) {\n                  throw new Error(jsonData.error);\n                }\n\n                if (jsonData.tool_call) {\n                  // Show loading message for long-running tools\n                  if (jsonData.tool_call.name === 'search_flights') {\n                    setLoadingMessage('Searching for flights...');\n                  } else if (jsonData.tool_call.name === 'search_hotels') {\n                    setLoadingMessage('Searching for hotels...');\n                  } else if (jsonData.tool_call.name === 'select_flight') {\n                    setLoadingMessage('Selecting your flight...');\n                  } else if (jsonData.tool_call.name === 'unlock_checkout') {\n                    setLoadingMessage('Preparing checkout...');\n                  }\n                  handleToolCall(jsonData.tool_call);\n                }\n\n                if (jsonData.tool_result) {\n                  // Clear loading message when tool completes\n                  setLoadingMessage(null);\n                }\n\n                if (jsonData.done) {\n                  break;\n                }\n\n                if (jsonData.content) {\n                  accumulatedContent += jsonData.content;\n\n                  setMessages((prev) =>\n                    prev.map((msg) =>\n                      msg.id === assistantMessageId\n                        ? { ...msg, content: accumulatedContent }\n                        : msg\n                    )\n                  );\n                }\n              } catch (e) {\n                console.error('Error parsing SSE data:', e);\n              }\n            }\n          }\n        }\n      }\n\n      setIsLoading(false);\n      setLoadingMessage(null);\n    } catch (error) {\n      console.error('Chat error:', error);\n\n      setMessages((prev) => prev.filter((msg) => msg.content !== ''));\n\n      const errorMessage: ChatMessage = {\n        id: (Date.now() + 1).toString(),\n        content: \"Mi dispiace, c'è stato un problema. Riprova!\",\n        sender: 'assistant',\n        timestamp: new Date()\n      };\n\n      setMessages((prev) => [...prev, errorMessage]);\n      setLoadingMessage(null);\n      setIsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    if (pendingFlightSelection !== null && flights.length > 0) {\n      const flightNum = pendingFlightSelection;\n      if (flightNum >= 1 && flightNum <= flights.length) {\n        const flight = flights[flightNum - 1];\n        if (flight) {\n          const flightData: SelectedFlightData = {\n            flightIndex: flightNum,\n            airline: flight.airline,\n            departure_at: flight.departure_at,\n            return_at: flight.return_at,\n            flight_number: flight.flight_number,\n            originCity: originCity || 'Roma',\n            destinationCity: conversationState.selectedDestination,\n            checkoutUrl: flight.checkoutUrl\n          };\n          console.log(`✈️ Processing pending flight selection ${flightNum}:`, flightData);\n          setSelectedFlight(flightData);\n          localStorage.setItem('selectedFlight', JSON.stringify(flightData));\n          setShowGenerateButton(true);\n        }\n      }\n      setPendingFlightSelection(null);\n    }\n  }, [flights, pendingFlightSelection, originCity, conversationState.selectedDestination]);\n\n  useEffect(() => {\n    if (initialMessage && open) {\n      form.setValue('message', initialMessage);\n      setTimeout(() => {\n        form.handleSubmit(onSubmit)();\n      }, 300);\n    }\n  }, [initialMessage, open]);\n\n  useEffect(() => {\n    if (conversationState.selectedDestination && \n        conversationState.tripDetails.people > 0 && \n        conversationState.tripDetails.startDate) {\n      saveCurrentItinerary();\n    }\n  }, [conversationState, flights, originCity, selectedFlight]);\n\n  const formatDateRange = (startDate: string, endDate: string): string => {\n    return formatDateRangeIT(startDate, endDate) || `${startDate} - ${endDate}`;\n  };\n\n  const saveCurrentItinerary = () => {\n    const { selectedDestination, tripDetails } = conversationState;\n    \n    if (!selectedDestination || tripDetails.people <= 0) {\n      return;\n    }\n\n    const dateStr = tripDetails.startDate && tripDetails.endDate \n      ? formatDateRange(tripDetails.startDate, tripDetails.endDate)\n      : 'Date da definire';\n\n    // Use user-selected origin city, fallback to stored origin or default\n    const userOriginCity = originCity || 'Roma';\n    \n    console.log(\"✈️ FLIGHT DATA:\", { \n      selectedFlight, \n      originCity: userOriginCity, \n      flightsAvailable: flights.length \n    });\n\n    // Use selected flight if available, otherwise first flight, otherwise fallback\n    let flightItem;\n    if (selectedFlight) {\n      flightItem = {\n        id: 'flight-selected',\n        type: 'flight' as const,\n        name: `${selectedFlight.airline} - ${selectedFlight.originCity} → ${selectedFlight.destinationCity}`,\n        description: `Volo da ${selectedFlight.originCity}`,\n        details: [\n          `Volo: ${selectedFlight.flight_number}`,\n          'Bagaglio a mano incluso'\n        ]\n      };\n    } else if (flights.length > 0) {\n      const firstFlight = flights[0];\n      flightItem = {\n        id: 'flight-dynamic-1',\n        type: 'flight' as const,\n        name: `${firstFlight.airline} - ${userOriginCity} → ${selectedDestination}`,\n        description: `Volo da ${userOriginCity}`,\n        details: [\n          `Volo: ${firstFlight.flight_number}`,\n          'Bagaglio a mano incluso'\n        ]\n      };\n    } else {\n      flightItem = {\n        id: 'flight-fallback',\n        type: 'flight' as const,\n        name: `Volo ${userOriginCity} → ${selectedDestination}`,\n        description: `Volo diretto da ${userOriginCity}`,\n        details: [\n          'Bagaglio a mano incluso'\n        ]\n      };\n    }\n\n    const carItems = [\n      {\n        id: 'car-dynamic-1',\n        type: 'car' as const,\n        name: 'Mini Cooper o simile',\n        description: 'Auto compatta stilosa',\n        price: 55,\n        details: [\n          `${tripDetails.days || 3} giorni`,\n          'Assicurazione base inclusa',\n          'Chilometraggio illimitato',\n          'Ritiro aeroporto'\n        ]\n      }\n    ];\n\n    const activityItems = tripDetails.interests.length > 0 \n      ? tripDetails.interests.slice(0, 4).map((interest, idx) => ({\n          id: `activity-dynamic-${idx + 1}`,\n          type: 'activity' as const,\n          name: interest,\n          description: `Esperienza a ${selectedDestination}`,\n          price: 40 + (idx * 15),\n          details: [\n            'Durata: 3-4 ore',\n            'Guida inclusa',\n            'Prenotazione garantita'\n          ]\n        }))\n      : [\n          {\n            id: 'activity-dynamic-1',\n            type: 'activity' as const,\n            name: 'Spa Day & Prosecco',\n            description: 'Relax e bollicine',\n            price: 85,\n            details: ['Massaggio incluso', 'Prosecco illimitato', 'Accesso piscina']\n          },\n          {\n            id: 'activity-dynamic-2',\n            type: 'activity' as const,\n            name: 'Cocktail Class',\n            description: 'Corso di mixology',\n            price: 45,\n            details: ['3 cocktail creati', 'Aperitivo finale', 'Ricette da portare a casa']\n          }\n        ];\n\n    // Build Aviasales URL using user's dates (not flight API dates)\n    const originIata = getCityIata(userOriginCity) || 'FCO';\n    const destIata = getCityIata(selectedDestination);\n    \n    // Build URL with user dates, fallback to existing flight checkoutUrl if helper fails\n    let aviasalesUrl = buildAviasalesUrl({\n      originIata,\n      destinationIata: destIata || selectedDestination.substring(0, 3).toUpperCase(),\n      departDate: tripDetails.startDate,\n      returnDate: tripDetails.endDate,\n      adults: tripDetails.people || 2\n    });\n    \n    // Fallback to flight's checkoutUrl if helper returned null\n    if (!aviasalesUrl && selectedFlight?.checkoutUrl) {\n      console.log('⚠️ buildAviasalesUrl returned null, using flight checkoutUrl fallback');\n      aviasalesUrl = selectedFlight.checkoutUrl;\n    }\n    \n    console.log('🔗 Aviasales URL built with user dates:', {\n      startDate: tripDetails.startDate,\n      endDate: tripDetails.endDate,\n      url: aviasalesUrl\n    });\n\n    const currentItinerary = {\n      destination: selectedDestination,\n      origin: userOriginCity,\n      dates: dateStr,\n      people: tripDetails.people,\n      startDate: tripDetails.startDate,\n      endDate: tripDetails.endDate,\n      days: tripDetails.days,\n      partyType: conversationState.partyType,\n      originCity: userOriginCity,\n      selectedFlight: selectedFlight,\n      aviasalesCheckoutUrl: aviasalesUrl || selectedFlight?.checkoutUrl || '',\n      flightLabel: selectedFlight \n        ? `${selectedFlight.airline} - ${selectedFlight.originCity} → ${selectedFlight.destinationCity}` \n        : `${userOriginCity} → ${selectedDestination}`,\n      flights: [flightItem],\n      cars: carItems,\n      activities: activityItems\n    };\n\n    localStorage.setItem('currentItinerary', JSON.stringify(currentItinerary));\n    if (selectedFlight) {\n      localStorage.setItem('selectedFlight', JSON.stringify(selectedFlight));\n    }\n    console.log('💾 Saved currentItinerary to localStorage:', currentItinerary);\n  };\n\n  interface ToolCallData {\n    name: string;\n    arguments: Record<string, any>;\n  }\n\n  const handleToolCall = (toolCall: ToolCallData) => {\n    console.log(`🔧 Tool call received: ${toolCall.name}`, toolCall.arguments);\n\n    switch (toolCall.name) {\n      case \"search_flights\": {\n        const {\n          origin,\n          destination,\n          departure_date,\n          return_date,\n          passengers,\n        } = toolCall.arguments;\n        const currentState = conversationStateRef.current;\n        const currentOrigin = originCityRef.current;\n\n        // Extract structured state from search_flights arguments\n        if (destination) {\n          setConversationState(prev => {\n            const next = { ...prev, selectedDestination: destination };\n            conversationStateRef.current = next;\n            return next;\n          });\n        }\n        if (origin) {\n          setOriginCity(origin);\n          originCityRef.current = origin;\n        }\n        if (departure_date && return_date) {\n          const normalizedStart = normalizeFutureTripDate(departure_date);\n          const normalizedEnd = normalizeFutureTripDate(return_date);\n          if (normalizedStart && normalizedEnd && isValidDateRange(normalizedStart, normalizedEnd)) {\n            const days = calculateTripDays(normalizedStart, normalizedEnd);\n            setConversationState(prev => {\n              const next = {\n                ...prev,\n                tripDetails: {\n                  ...prev.tripDetails,\n                  startDate: normalizedStart,\n                  endDate: normalizedEnd,\n                  days,\n                },\n              };\n              conversationStateRef.current = next;\n              return next;\n            });\n          }\n        }\n        if (typeof passengers === \"number\" && passengers > 0) {\n          setConversationState(prev => {\n            const next = {\n              ...prev,\n              tripDetails: {\n                ...prev.tripDetails,\n                people: passengers,\n              },\n            };\n            conversationStateRef.current = next;\n            return next;\n          });\n        }\n\n        // Use tool arguments or fall back to conversation state\n        const searchOrigin = origin || currentOrigin || \"Rome\";\n        const searchDestination =\n          destination || currentState.selectedDestination;\n        const searchDepartDate =\n          departure_date || currentState.tripDetails.startDate;\n        const searchReturnDate =\n          return_date || currentState.tripDetails.endDate;\n        const searchPassengers =\n          passengers || currentState.tripDetails.people || 2;\n\n        if (searchOrigin && searchDestination && searchDepartDate) {\n          (async () => {\n            try {\n              const params = new URLSearchParams({\n                origin: searchOrigin,\n                destination: searchDestination,\n                departDate: searchDepartDate,\n                returnDate: searchReturnDate || searchDepartDate,\n                passengers: String(searchPassengers),\n              });\n              console.log(\"✈️ Searching flights with params:\", Object.fromEntries(params));\n              const res = await fetch(`/api/flights/search?${params}`);\n              const data = await res.json();\n              if (data.flights && Array.isArray(data.flights)) {\n                console.log(\"✈️ Flight search results:\", data.flights);\n                setFlights(data.flights);\n                flightsRef.current = data.flights;\n              }\n            } catch (err) {\n              console.error(\"Flight search failed:\", err);\n            }\n          })();\n        }\n        break;\n      }\n\n      case \"select_flight\":\n        const flightNum = toolCall.arguments.flight_number;\n        if (typeof flightNum === \"number\" && flightNum >= 1) {\n          if (flights.length > 0 && flightNum <= flights.length) {\n            const flight = flights[flightNum - 1];\n            if (flight) {\n              const flightData: SelectedFlightData = {\n                flightIndex: flightNum,\n                airline: flight.airline,\n                departure_at: flight.departure_at,\n                return_at: flight.return_at,\n                flight_number: flight.flight_number,\n                originCity: originCity || 'Roma',\n                destinationCity: conversationState.selectedDestination,\n                checkoutUrl: flight.checkoutUrl\n              };\n              console.log(`✈️ User selected flight ${flightNum}:`, flightData);\n              setSelectedFlight(flightData);\n              localStorage.setItem('selectedFlight', JSON.stringify(flightData));\n              setShowGenerateButton(true);\n            }\n          } else {\n            console.log(`✈️ Storing pending flight selection: ${flightNum}`);\n            setPendingFlightSelection(flightNum);\n          }\n        }\n        break;\n\n      case \"unlock_checkout\":\n        console.log('🔓 Checkout unlocked - saving and navigating to checkout');\n        saveCurrentItinerary();\n        try {\n          const savedData = localStorage.getItem('currentItinerary');\n          if (savedData) {\n            const itinerary = JSON.parse(savedData);\n            itinerary.checkoutApproved = true;\n            localStorage.setItem('currentItinerary', JSON.stringify(itinerary));\n            console.log('✅ checkoutApproved flag saved, navigating to /checkout');\n          }\n        } catch (e) {\n          console.warn('Failed to update checkoutApproved flag:', e);\n        }\n        onOpenChange(false);\n        setLocation('/checkout');\n        break;\n    }\n  };\n\n  const onSubmit = async (data: MessageFormValues) => {\n    if (isLoading) return;\n    form.reset();\n    await sendChatRequest(data.message, true);\n  };\n\n  const handleGenerateItinerary = () => {\n    saveCurrentItinerary();\n    onOpenChange(false);\n    setLocation('/itinerary');\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[85vh] flex flex-col p-0\">\n        <DialogHeader className=\"px-6 pt-6 pb-4 border-b\">\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Heart className=\"w-6 h-6 text-pink-600\" />\n            ByeBride Chat Assistant\n            {conversationState.selectedDestination && (\n              <span className=\"text-sm font-normal text-gray-500 ml-2\">\n                → {conversationState.selectedDestination}\n              </span>\n            )}\n          </DialogTitle>\n        </DialogHeader>\n\n        <div ref={scrollContainerRef} className=\"flex-1 px-6 py-4 overflow-y-auto\">\n          <div className=\"space-y-4\">\n            {messages.filter(msg => msg.content && msg.content.trim()).map((message) => (\n              <div\n                key={message.id}\n                className={`flex gap-3 ${\n                  message.sender === 'user' ? 'flex-row-reverse' : 'flex-row'\n                }`}\n              >\n                <Avatar className=\"w-8 h-8\">\n                  <AvatarFallback className={message.sender === 'user' ? 'bg-purple-500' : 'bg-pink-500'}>\n                    {message.sender === 'user' ? <User className=\"w-4 h-4 text-white\" /> : <Heart className=\"w-4 h-4 text-white\" />}\n                  </AvatarFallback>\n                </Avatar>\n                <div\n                  className={`max-w-[75%] rounded-lg px-4 py-2 ${\n                    message.sender === 'user'\n                      ? 'bg-purple-500 text-white'\n                      : 'bg-gradient-to-br from-pink-50 to-pink-100 text-gray-900 border border-pink-200'\n                  }`}\n                >\n                  <p className=\"text-sm whitespace-pre-wrap\">{message.content}</p>\n                </div>\n              </div>\n            ))}\n            {isLoading && (\n              <div className=\"flex gap-3\">\n                <Avatar className=\"w-8 h-8\">\n                  <AvatarFallback className=\"bg-pink-500\">\n                    <Heart className=\"w-4 h-4 text-white\" />\n                  </AvatarFallback>\n                </Avatar>\n                <div className=\"bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-2 flex items-center gap-2\">\n                  <Loader2 className=\"w-4 h-4 animate-spin text-gray-600\" />\n                  {loadingMessage && (\n                    <span className=\"text-sm text-gray-600 dark:text-gray-400\">\n                      {loadingMessage}\n                    </span>\n                  )}\n                </div>\n              </div>\n            )}\n            <div ref={messagesEndRef} />\n          </div>\n        </div>\n\n        <div className=\"px-6 py-4 border-t space-y-3\">\n          {showGenerateButton && (\n            <Button\n              onClick={handleGenerateItinerary}\n              className=\"w-full bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white font-semibold py-6 shadow-lg\"\n              data-testid=\"button-generate-itinerary-bride\"\n            >\n              <Sparkles className=\"w-5 h-5 mr-2\" />\n              Genera Itinerario Completo\n            </Button>\n          )}\n          \n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"flex gap-2\">\n            <Input\n              {...form.register('message')}\n              placeholder=\"Type your message...\"\n              className=\"flex-1\"\n              disabled={isLoading}\n              data-testid=\"input-chat-message-bride\"\n            />\n            <Button\n              type=\"submit\"\n              disabled={isLoading}\n              className=\"bg-pink-600 hover:bg-pink-700\"\n              data-testid=\"button-send-message-bride\"\n            >\n              {isLoading ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                <Send className=\"w-4 h-4\" />\n              )}\n            </Button>\n          </form>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":25935,"size_tokens":null},"client/src/components/ActivityIdeasCompact.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { z } from 'zod';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Loader2, Music, Ship, Utensils, PartyPopper, Car, Waves, Flame, Beer, MapPin, Lightbulb } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\nconst activityFormSchema = z.object({\n  destination: z.string().min(1, \"Select a destination\"),\n  month: z.string().min(1, \"Select a month\"),\n});\n\ntype ActivityFormValues = z.infer<typeof activityFormSchema>;\n\ninterface ActivitySuggestion {\n  name: string;\n  description: string;\n  icon: string;\n  venues: string[];\n}\n\nconst iconMap: { [key: string]: any } = {\n  music: Music,\n  ship: Ship,\n  utensils: Utensils,\n  party: PartyPopper,\n  car: Car,\n  waves: Waves,\n  flame: Flame,\n  beer: Beer,\n  mappin: MapPin,\n};\n\nconst destinations = [\n  'Roma',\n  'Ibiza',\n  'Barcellona',\n  'Praga',\n  'Budapest',\n  'Cracovia',\n  'Amsterdam',\n  'Berlino',\n  'Lisbona',\n  'Palma de Mallorca',\n];\n\nconst months = [\n  'January',\n  'February',\n  'March',\n  'April',\n  'May',\n  'June',\n  'July',\n  'August',\n  'September',\n  'October',\n  'November',\n  'December',\n];\n\nexport default function ActivityIdeasCompact() {\n  const [isLoading, setIsLoading] = useState(false);\n  const [suggestions, setSuggestions] = useState<ActivitySuggestion[]>([]);\n  const [showResults, setShowResults] = useState(false);\n  const { toast } = useToast();\n\n  const form = useForm<ActivityFormValues>({\n    resolver: zodResolver(activityFormSchema),\n    defaultValues: {\n      destination: '',\n      month: '',\n    },\n  });\n\n  const onSubmit = async (data: ActivityFormValues) => {\n    setIsLoading(true);\n    setSuggestions([]);\n\n    try {\n      // Create fake dates for the API (using the selected month)\n      const year = new Date().getFullYear();\n      const monthIndex = months.indexOf(data.month);\n      const startDate = `${year}-${String(monthIndex + 1).padStart(2, '0')}-01`;\n      const endDate = `${year}-${String(monthIndex + 1).padStart(2, '0')}-28`;\n\n      const response = await fetch('/api/chat/activity-suggestions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          destination: data.destination,\n          startDate,\n          endDate,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to get suggestions');\n      }\n\n      const result = await response.json();\n      setSuggestions(result.suggestions || []);\n      setShowResults(true);\n    } catch (error) {\n      console.error('Error getting activity suggestions:', error);\n      toast({\n        title: 'Error',\n        description: 'Unable to get activity suggestions. Please try again.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <>\n      <div className=\"bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg p-5\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <Lightbulb className=\"w-5 h-5 text-yellow-300\" />\n          <h3 className=\"text-white font-bold text-lg\">Get Trip Ideas</h3>\n        </div>\n        \n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-3\">\n            <FormField\n              control={form.control}\n              name=\"destination\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-white text-sm\">Destination</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger \n                        className=\"bg-white/95 border-white/30 text-gray-900\"\n                        data-testid=\"select-destination-compact\"\n                      >\n                        <SelectValue placeholder=\"Select city\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {destinations.map((dest) => (\n                        <SelectItem key={dest} value={dest}>\n                          {dest}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage className=\"text-red-200\" />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"month\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-white text-sm\">Travel Month</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger \n                        className=\"bg-white/95 border-white/30 text-gray-900\"\n                        data-testid=\"select-month-compact\"\n                      >\n                        <SelectValue placeholder=\"Select month\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {months.map((month) => (\n                        <SelectItem key={month} value={month}>\n                          {month}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage className=\"text-red-200\" />\n                </FormItem>\n              )}\n            />\n\n            <Button\n              type=\"submit\"\n              className=\"w-full bg-red-600 hover:bg-red-700 text-white font-semibold\"\n              disabled={isLoading}\n              data-testid=\"button-generate-compact\"\n            >\n              {isLoading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Generating...\n                </>\n              ) : (\n                'Get Activity Ideas'\n              )}\n            </Button>\n          </form>\n        </Form>\n      </div>\n\n      <Dialog open={showResults} onOpenChange={setShowResults}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"text-2xl font-bold\">\n              Activity Ideas for {form.getValues('destination')}\n            </DialogTitle>\n          </DialogHeader>\n          \n          {suggestions.length > 0 && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4\">\n              {suggestions.map((activity, index) => {\n                const IconComponent = iconMap[activity.icon] || PartyPopper;\n                return (\n                  <Card\n                    key={index}\n                    className=\"hover:shadow-lg transition-shadow duration-300 border-2 hover:border-red-500\"\n                    data-testid={`card-activity-compact-${index}`}\n                  >\n                    <CardHeader>\n                      <div className=\"flex items-center gap-3 mb-2\">\n                        <div className=\"p-3 bg-red-100 dark:bg-red-900 rounded-lg\">\n                          <IconComponent className=\"w-5 h-5 text-red-600 dark:text-red-400\" />\n                        </div>\n                        <CardTitle className=\"text-base\">{activity.name}</CardTitle>\n                      </div>\n                      <CardDescription className=\"text-sm\">{activity.description}</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      {activity.venues && activity.venues.length > 0 && (\n                        <div>\n                          <p className=\"text-xs font-semibold mb-2 text-gray-700 dark:text-gray-300\">\n                            Recommended venues:\n                          </p>\n                          <ul className=\"space-y-1\">\n                            {activity.venues.map((venue, vIndex) => (\n                              <li\n                                key={vIndex}\n                                className=\"text-xs text-gray-600 dark:text-gray-400 flex items-start gap-2\"\n                              >\n                                <span className=\"text-red-500 mt-0.5\">•</span>\n                                <span>{venue}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","path":null,"size_bytes":9116,"size_tokens":null},"client/src/components/ActivityIdeasCompactBride.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { z } from 'zod';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { Button } from '@/components/ui/button';\nimport { Form, FormControl, FormField, FormItem } from '@/components/ui/form';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Sparkles, Loader2, Music, Ship, Utensils, PartyPopper, Car, Waves, Flame, Beer, MapPin } from 'lucide-react';\nimport { Card, CardContent } from '@/components/ui/card';\n\nconst activityFormSchema = z.object({\n  destination: z.string().min(1, \"Please select a destination\"),\n  month: z.string().min(1, \"Please select a month\"),\n});\n\ntype ActivityFormValues = z.infer<typeof activityFormSchema>;\n\nconst DESTINATIONS = [\n  \"Roma\", \"Ibiza\", \"Barcellona\", \"Praga\", \"Budapest\", \n  \"Cracovia\", \"Amsterdam\", \"Berlino\", \"Lisbona\", \"Palma de Mallorca\"\n];\n\nconst MONTHS = [\n  \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n  \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n];\n\nconst iconMap: { [key: string]: any } = {\n  music: Music,\n  ship: Ship,\n  utensils: Utensils,\n  party: PartyPopper,\n  car: Car,\n  waves: Waves,\n  flame: Flame,\n  beer: Beer,\n  mappin: MapPin,\n};\n\ninterface Activity {\n  title: string;\n  description: string;\n  icon: string;\n}\n\nexport default function ActivityIdeasCompactBride() {\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [suggestions, setSuggestions] = useState<Activity[]>([]);\n  const [dialogOpen, setDialogOpen] = useState(false);\n\n  const form = useForm<ActivityFormValues>({\n    resolver: zodResolver(activityFormSchema),\n    defaultValues: {\n      destination: '',\n      month: '',\n    },\n  });\n\n  const onSubmit = async (data: ActivityFormValues) => {\n    setIsGenerating(true);\n    setSuggestions([]);\n\n    try {\n      const response = await fetch('/api/chat/activity-suggestions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          destination: data.destination,\n          month: data.month,\n          partyType: 'bachelorette'\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to generate suggestions');\n      }\n\n      const result = await response.json();\n      \n      if (result.activities && Array.isArray(result.activities)) {\n        setSuggestions(result.activities);\n        setDialogOpen(true);\n      }\n    } catch (error) {\n      console.error('Error generating suggestions:', error);\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  return (\n    <>\n      <div className=\"bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg p-5\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <Sparkles className=\"w-5 h-5 text-pink-300\" />\n          <h3 className=\"text-white font-bold text-lg\">Activity Ideas</h3>\n        </div>\n        \n        <p className=\"text-white/80 text-sm mb-4\">\n          Get AI-powered activity suggestions instantly\n        </p>\n        \n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-3\">\n            <FormField\n              control={form.control}\n              name=\"destination\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormControl>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <SelectTrigger className=\"bg-white/95 border-white/30 text-gray-900 focus:ring-2 focus:ring-pink-500\" data-testid=\"select-destination-bride\">\n                        <SelectValue placeholder=\"Select destination\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {DESTINATIONS.map((dest) => (\n                          <SelectItem key={dest} value={dest}>\n                            {dest}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </FormControl>\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"month\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormControl>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <SelectTrigger className=\"bg-white/95 border-white/30 text-gray-900 focus:ring-2 focus:ring-pink-500\" data-testid=\"select-month-bride\">\n                        <SelectValue placeholder=\"Select month\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {MONTHS.map((month) => (\n                          <SelectItem key={month} value={month}>\n                            {month}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </FormControl>\n                </FormItem>\n              )}\n            />\n\n            <Button \n              type=\"submit\"\n              className=\"w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold transition-all duration-200 flex items-center justify-center gap-2\"\n              disabled={isGenerating}\n              data-testid=\"button-generate-ideas-bride\"\n            >\n              {isGenerating ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  Generating...\n                </>\n              ) : (\n                <>\n                  <Sparkles className=\"w-4 h-4\" />\n                  Get Ideas\n                </>\n              )}\n            </Button>\n          </form>\n        </Form>\n      </div>\n\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent className=\"max-w-3xl max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-2xl\">\n              <Sparkles className=\"w-6 h-6 text-pink-600\" />\n              Activity Suggestions for {form.getValues('destination')}\n            </DialogTitle>\n          </DialogHeader>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4\">\n            {suggestions.map((activity, index) => {\n              const IconComponent = iconMap[activity.icon] || MapPin;\n              return (\n                <Card key={index} className=\"border-pink-200 hover:shadow-lg transition-shadow\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"bg-pink-100 p-2 rounded-lg\">\n                        <IconComponent className=\"w-5 h-5 text-pink-600\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-semibold text-gray-900 mb-1\">{activity.title}</h3>\n                        <p className=\"text-sm text-gray-600\">{activity.description}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","path":null,"size_bytes":7373,"size_tokens":null},"client/src/components/ChatDialogCompact.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Loader2, Send, Bot, User, Sparkles, Beer } from \"lucide-react\";\nimport byebiLogo from \"@assets/Bb logo_1763313858570.png\";\nimport {\n  normalizeFutureTripDate,\n  calculateTripDays,\n  isValidDateRange,\n  formatFlightDateTime,\n  formatDateRangeIT,\n} from \"@shared/dateUtils\";\nimport { buildAviasalesUrl, getCityIata } from \"@/lib/aviasales\";\n\nconst messageSchema = z.object({\n  message: z.string().min(1, \"Message cannot be empty\"),\n});\n\ntype MessageFormValues = z.infer<typeof messageSchema>;\n\ninterface ChatMessage {\n  id: string;\n  content: string;\n  sender: \"user\" | \"assistant\";\n  timestamp: Date;\n}\n\ninterface TripDetails {\n  people: number;\n  days: number;\n  startDate: string;\n  endDate: string;\n  adventureType: string;\n  interests: string[];\n  budget: string;\n}\n\ninterface ConversationState {\n  selectedDestination: string;\n  tripDetails: TripDetails;\n  partyType: string;\n}\n\ninterface FlightInfo {\n  id?: number;\n  airline: string;\n  departure_at: string;\n  return_at: string;\n  flight_number: number;\n  origin?: string;\n  destination?: string;\n  checkoutUrl?: string;\n}\n\ninterface SelectedFlightData {\n  flightIndex: number;\n  airline: string;\n  departure_at: string;\n  return_at: string;\n  flight_number: number;\n  originCity: string;\n  destinationCity: string;\n  checkoutUrl?: string;\n}\n\ninterface ChatDialogCompactProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  initialMessage?: string;\n}\n\nexport default function ChatDialogCompact({\n  open,\n  onOpenChange,\n  initialMessage,\n}: ChatDialogCompactProps) {\n  const [, setLocation] = useLocation();\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [loadingMessage, setLoadingMessage] = useState<string | null>(null);\n  const [showGenerateButton, setShowGenerateButton] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\n  const messagesRef = useRef<ChatMessage[]>([]);\n  const [flights, setFlights] = useState<FlightInfo[]>([]);\n  const flightsRef = useRef<FlightInfo[]>([]);\n  const [originCity, setOriginCity] = useState<string>(\"\");\n  const originCityRef = useRef<string>(\"\");\n  const [selectedFlight, setSelectedFlight] =\n    useState<SelectedFlightData | null>(null);\n  const [pendingFlightSelection, setPendingFlightSelection] = useState<\n    number | null\n  >(null);\n  const conversationStateRef = useRef<ConversationState>({\n    selectedDestination: \"\",\n    tripDetails: {\n      people: 0,\n      days: 0,\n      startDate: \"\",\n      endDate: \"\",\n      adventureType: \"\",\n      interests: [],\n      budget: \"medio\",\n    },\n    partyType: \"bachelor\",\n  });\n\n  const [conversationState, setConversationState] = useState<ConversationState>(\n    {\n      selectedDestination: \"\",\n      tripDetails: {\n        people: 0,\n        days: 0,\n        startDate: \"\",\n        endDate: \"\",\n        adventureType: \"\",\n        interests: [],\n        budget: \"medio\",\n      },\n      partyType: \"bachelor\",\n    },\n  );\n\n  const form = useForm<MessageFormValues>({\n    resolver: zodResolver(messageSchema),\n    defaultValues: {\n      message: \"\",\n    },\n  });\n\n  const scrollToBottom = useCallback(() => {\n    if (scrollContainerRef.current) {\n      scrollContainerRef.current.scrollTo({\n        top: scrollContainerRef.current.scrollHeight,\n        behavior: \"smooth\",\n      });\n    }\n  }, []);\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  useEffect(() => {\n    messagesRef.current = messages;\n  }, [messages]);\n\n  useEffect(() => {\n    flightsRef.current = flights;\n  }, [flights]);\n\n  useEffect(() => {\n    originCityRef.current = originCity;\n  }, [originCity]);\n\n  useEffect(() => {\n    conversationStateRef.current = conversationState;\n  }, [conversationState]);\n\n  const sendChatRequest = async (message: string, addUserMessage: boolean) => {\n    if (isLoading) return;\n    const trimmedMessage = message.trim();\n    if (addUserMessage && !trimmedMessage) return;\n\n    if (addUserMessage) {\n      const userMessage: ChatMessage = {\n        id: Date.now().toString(),\n        content: trimmedMessage,\n        sender: \"user\",\n        timestamp: new Date(),\n      };\n      setMessages((prev) => [...prev, userMessage]);\n    }\n\n    setIsLoading(true);\n    setLoadingMessage(\"Thinking...\");\n\n    try {\n      const conversationHistory = messagesRef.current.map((msg) => ({\n        role: msg.sender === \"user\" ? \"user\" : \"assistant\",\n        content: msg.content,\n      }));\n\n      const currentState = conversationStateRef.current;\n      const payload = {\n        message: trimmedMessage,\n        selectedDestination: currentState.selectedDestination,\n        tripDetails: currentState.tripDetails,\n        conversationHistory,\n        partyType: currentState.partyType,\n        originCity: originCityRef.current,\n      };\n      console.log(\"🔍 OPENAI STREAM PAYLOAD:\", payload);\n\n      const response = await fetch(\"/api/chat/openai-stream\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to get response\");\n      }\n\n      const assistantMessageId = (Date.now() + 1).toString();\n      const placeholderMessage: ChatMessage = {\n        id: assistantMessageId,\n        content: \"\",\n        sender: \"assistant\",\n        timestamp: new Date(),\n      };\n\n      setMessages((prev) => [...prev, placeholderMessage]);\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      let accumulatedContent = \"\";\n\n      if (reader) {\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) break;\n\n          const chunk = decoder.decode(value);\n          const lines = chunk.split(\"\\n\");\n\n          for (const line of lines) {\n            if (line.startsWith(\"data: \")) {\n              try {\n                const jsonData = JSON.parse(line.slice(6));\n\n                if (jsonData.error) {\n                  throw new Error(jsonData.error);\n                }\n\n                if (jsonData.tool_call) {\n                  // Show loading message based on tool type\n                  if (jsonData.tool_call.name === 'search_flights') {\n                    setLoadingMessage('Searching for the best flights...');\n                  } else if (jsonData.tool_call.name === 'search_hotels') {\n                    setLoadingMessage('Finding hotels for you...');\n                  } else if (jsonData.tool_call.name === 'select_flight') {\n                    setLoadingMessage('Selecting your flight...');\n                  } else if (jsonData.tool_call.name === 'unlock_checkout') {\n                    setLoadingMessage('Preparing checkout...');\n                  }\n                  handleToolCall(jsonData.tool_call);\n                }\n\n                if (jsonData.tool_result) {\n                  // Show a brief \"wrapping up\" message while OpenAI summarizes\n                  if (jsonData.tool_result.name === 'search_flights' || jsonData.tool_result.name === 'search_hotels') {\n                    setLoadingMessage('Preparing your results...');\n                  } else {\n                    setLoadingMessage(null);\n                  }\n                }\n\n                if (jsonData.done) {\n                  break;\n                }\n\n                if (jsonData.content) {\n                  // Clear loading message once content starts streaming\n                  if (!accumulatedContent) {\n                    setLoadingMessage(null);\n                  }\n                  accumulatedContent += jsonData.content;\n\n                  setMessages((prev) =>\n                    prev.map((msg) =>\n                      msg.id === assistantMessageId\n                        ? { ...msg, content: accumulatedContent }\n                        : msg,\n                    ),\n                  );\n                }\n              } catch (e) {\n                console.error(\"Error parsing SSE data:\", e);\n              }\n            }\n          }\n        }\n      }\n\n      setIsLoading(false);\n      setLoadingMessage(null);\n    } catch (error) {\n      console.error(\"Chat error:\", error);\n\n      setMessages((prev) => prev.filter((msg) => msg.content !== \"\"));\n\n      const errorMessage: ChatMessage = {\n        id: (Date.now() + 1).toString(),\n        content: \"Mi dispiace, c'è stato un problema. Riprova!\",\n        sender: \"assistant\",\n        timestamp: new Date(),\n      };\n\n      setMessages((prev) => [...prev, errorMessage]);\n      setIsLoading(false);\n      setLoadingMessage(null);\n    }\n  };\n\n  useEffect(() => {\n    if (pendingFlightSelection !== null && flights.length > 0) {\n      const flightNum = pendingFlightSelection;\n      if (flightNum >= 1 && flightNum <= flights.length) {\n        const flight = flights[flightNum - 1];\n        if (flight) {\n          const flightData: SelectedFlightData = {\n            flightIndex: flightNum,\n            airline: flight.airline,\n            departure_at: flight.departure_at,\n            return_at: flight.return_at,\n            flight_number: flight.flight_number,\n            originCity: originCity || \"Roma\",\n            destinationCity: conversationState.selectedDestination,\n            checkoutUrl: flight.checkoutUrl,\n          };\n          console.log(\n            `✈️ Processing pending flight selection ${flightNum}:`,\n            flightData,\n          );\n          setSelectedFlight(flightData);\n          localStorage.setItem(\"selectedFlight\", JSON.stringify(flightData));\n          setShowGenerateButton(true);\n        }\n      }\n      setPendingFlightSelection(null);\n    }\n  }, [\n    flights,\n    pendingFlightSelection,\n    originCity,\n    conversationState.selectedDestination,\n  ]);\n\n  useEffect(() => {\n    if (initialMessage && open) {\n      form.setValue(\"message\", initialMessage);\n      setTimeout(() => {\n        form.handleSubmit(onSubmit)();\n      }, 300);\n    }\n  }, [initialMessage, open]);\n\n  useEffect(() => {\n    if (\n      conversationState.selectedDestination &&\n      conversationState.tripDetails.people > 0 &&\n      conversationState.tripDetails.startDate\n    ) {\n      saveCurrentItinerary();\n    }\n  }, [conversationState, flights, originCity, selectedFlight]);\n\n  const formatDateRange = (startDate: string, endDate: string): string => {\n    return formatDateRangeIT(startDate, endDate) || `${startDate} - ${endDate}`;\n  };\n\n  const saveCurrentItinerary = () => {\n    const { selectedDestination, tripDetails } = conversationState;\n\n    if (!selectedDestination || tripDetails.people <= 0) {\n      return;\n    }\n\n    const dateStr =\n      tripDetails.startDate && tripDetails.endDate\n        ? formatDateRange(tripDetails.startDate, tripDetails.endDate)\n        : \"Date da definire\";\n\n    // Use user-selected origin city, fallback to stored origin or default\n    const userOriginCity = originCity || \"Roma\";\n\n    console.log(\"✈️ FLIGHT DATA:\", {\n      selectedFlight,\n      originCity: userOriginCity,\n      flightsAvailable: flights.length,\n    });\n\n    // Use selected flight if available, otherwise first flight, otherwise fallback\n    let flightItem;\n    if (selectedFlight) {\n      flightItem = {\n        id: \"flight-selected\",\n        type: \"flight\" as const,\n        name: `${selectedFlight.airline} - ${selectedFlight.originCity} → ${selectedFlight.destinationCity}`,\n        description: `Volo da ${selectedFlight.originCity}`,\n        details: [\n          `Volo: ${selectedFlight.flight_number}`,\n          \"Bagaglio a mano incluso\",\n        ],\n      };\n    } else if (flights.length > 0) {\n      const firstFlight = flights[0];\n      flightItem = {\n        id: \"flight-dynamic-1\",\n        type: \"flight\" as const,\n        name: `${firstFlight.airline} - ${userOriginCity} → ${selectedDestination}`,\n        description: `Volo da ${userOriginCity}`,\n        details: [\n          `Volo: ${firstFlight.flight_number}`,\n          \"Bagaglio a mano incluso\",\n        ],\n      };\n    } else {\n      flightItem = {\n        id: \"flight-fallback\",\n        type: \"flight\" as const,\n        name: `Volo ${userOriginCity} → ${selectedDestination}`,\n        description: `Volo diretto da ${userOriginCity}`,\n        details: [\"Bagaglio a mano incluso\"],\n      };\n    }\n\n    const carItems = [\n      {\n        id: \"car-dynamic-1\",\n        type: \"car\" as const,\n        name: \"Fiat 500 o simile\",\n        description: \"Auto compatta 4 posti\",\n        price: 45,\n        details: [\n          `${tripDetails.days || 3} giorni`,\n          \"Assicurazione base inclusa\",\n          \"Chilometraggio illimitato\",\n          \"Ritiro aeroporto\",\n        ],\n      },\n    ];\n\n    const activityItems =\n      tripDetails.interests.length > 0\n        ? tripDetails.interests.slice(0, 4).map((interest, idx) => ({\n            id: `activity-dynamic-${idx + 1}`,\n            type: \"activity\" as const,\n            name: interest,\n            description: `Esperienza a ${selectedDestination}`,\n            price: 45 + idx * 10,\n            details: [\n              \"Durata: 3-4 ore\",\n              \"Guida inclusa\",\n              \"Prenotazione garantita\",\n            ],\n          }))\n        : [\n            {\n              id: \"activity-dynamic-1\",\n              type: \"activity\" as const,\n              name: \"Boat Party con DJ\",\n              description: \"Festa in barca con open bar\",\n              price: 65,\n              details: [\n                \"5 ore di party\",\n                \"Open bar premium\",\n                \"DJ internazionale\",\n              ],\n            },\n            {\n              id: \"activity-dynamic-2\",\n              type: \"activity\" as const,\n              name: \"Tour Serale\",\n              description: \"Pub crawl guidato\",\n              price: 35,\n              details: [\n                \"4 locali inclusi\",\n                \"1 drink per locale\",\n                \"Guida locale\",\n              ],\n            },\n          ];\n\n    // Build Aviasales URL using user's dates (not flight API dates)\n    const originIata = getCityIata(userOriginCity) || \"FCO\";\n    const destIata = getCityIata(selectedDestination);\n\n    // Build URL with user dates, fallback to existing flight checkoutUrl if helper fails\n    let aviasalesUrl = buildAviasalesUrl({\n      originIata,\n      destinationIata:\n        destIata || selectedDestination.substring(0, 3).toUpperCase(),\n      departDate: tripDetails.startDate,\n      returnDate: tripDetails.endDate,\n      adults: tripDetails.people || 2,\n    });\n\n    // Fallback to flight's checkoutUrl if helper returned null\n    if (!aviasalesUrl && selectedFlight?.checkoutUrl) {\n      console.log(\n        \"⚠️ buildAviasalesUrl returned null, using flight checkoutUrl fallback\",\n      );\n      aviasalesUrl = selectedFlight.checkoutUrl;\n    }\n\n    console.log(\"🔗 Aviasales URL built with user dates:\", {\n      startDate: tripDetails.startDate,\n      endDate: tripDetails.endDate,\n      url: aviasalesUrl,\n    });\n\n    const currentItinerary = {\n      destination: selectedDestination,\n      origin: userOriginCity,\n      dates: dateStr,\n      people: tripDetails.people,\n      startDate: tripDetails.startDate,\n      endDate: tripDetails.endDate,\n      days: tripDetails.days,\n      partyType: conversationState.partyType,\n      originCity: userOriginCity,\n      selectedFlight: selectedFlight,\n      aviasalesCheckoutUrl: aviasalesUrl || selectedFlight?.checkoutUrl || \"\",\n      flightLabel: selectedFlight\n        ? `${selectedFlight.airline} - ${selectedFlight.originCity} → ${selectedFlight.destinationCity}`\n        : `${userOriginCity} → ${selectedDestination}`,\n      flights: [flightItem],\n      cars: carItems,\n      activities: activityItems,\n    };\n\n    localStorage.setItem(\"currentItinerary\", JSON.stringify(currentItinerary));\n    if (selectedFlight) {\n      localStorage.setItem(\"selectedFlight\", JSON.stringify(selectedFlight));\n    }\n    console.log(\"💾 Saved currentItinerary to localStorage:\", currentItinerary);\n  };\n\n  interface ToolCallData {\n    name: string;\n    arguments: Record<string, any>;\n  }\n\n  const handleToolCall = (toolCall: ToolCallData) => {\n    console.log(`🔧 Tool call received: ${toolCall.name}`, toolCall.arguments);\n\n    switch (toolCall.name) {\n      case \"search_flights\": {\n        const {\n          origin,\n          destination,\n          departure_date,\n          return_date,\n          passengers,\n        } = toolCall.arguments;\n        const currentState = conversationStateRef.current;\n        const currentOrigin = originCityRef.current;\n\n        // Extract structured state from search_flights arguments\n        if (destination) {\n          setConversationState((prev) => {\n            const next = { ...prev, selectedDestination: destination };\n            conversationStateRef.current = next;\n            return next;\n          });\n        }\n        if (origin) {\n          setOriginCity(origin);\n          originCityRef.current = origin;\n        }\n        if (departure_date && return_date) {\n          const normalizedStart = normalizeFutureTripDate(departure_date);\n          const normalizedEnd = normalizeFutureTripDate(return_date);\n          if (normalizedStart && normalizedEnd && isValidDateRange(normalizedStart, normalizedEnd)) {\n            const days = calculateTripDays(normalizedStart, normalizedEnd);\n            setConversationState((prev) => {\n              const next = {\n                ...prev,\n                tripDetails: {\n                  ...prev.tripDetails,\n                  startDate: normalizedStart,\n                  endDate: normalizedEnd,\n                  days,\n                },\n              };\n              conversationStateRef.current = next;\n              return next;\n            });\n          }\n        }\n        if (typeof passengers === \"number\" && passengers > 0) {\n          setConversationState((prev) => {\n            const next = {\n              ...prev,\n              tripDetails: {\n                ...prev.tripDetails,\n                people: passengers,\n              },\n            };\n            conversationStateRef.current = next;\n            return next;\n          });\n        }\n\n        // Use tool arguments or fall back to conversation state\n        const searchOrigin = origin || currentOrigin || \"Rome\";\n        const searchDestination =\n          destination || currentState.selectedDestination;\n        const searchDepartDate =\n          departure_date || currentState.tripDetails.startDate;\n        const searchReturnDate =\n          return_date || currentState.tripDetails.endDate;\n        const searchPassengers =\n          passengers || currentState.tripDetails.people || 2;\n\n        if (searchOrigin && searchDestination && searchDepartDate) {\n          (async () => {\n            try {\n              const params = new URLSearchParams({\n                origin: searchOrigin,\n                destination: searchDestination,\n                departDate: searchDepartDate,\n                returnDate: searchReturnDate || searchDepartDate,\n                passengers: String(searchPassengers),\n              });\n              console.log(\"✈️ Searching flights with params:\", Object.fromEntries(params));\n              const res = await fetch(`/api/flights/search?${params}`);\n              const data = await res.json();\n              if (data.flights && Array.isArray(data.flights)) {\n                console.log(\"✈️ Flight search results:\", data.flights);\n                setFlights(data.flights);\n                flightsRef.current = data.flights;\n              }\n            } catch (err) {\n              console.error(\"Flight search failed:\", err);\n            }\n          })();\n        }\n        break;\n      }\n\n      case \"select_flight\":\n        const flightNum = toolCall.arguments.flight_number;\n        if (typeof flightNum === \"number\" && flightNum >= 1) {\n          if (flights.length > 0 && flightNum <= flights.length) {\n            const flight = flights[flightNum - 1];\n            if (flight) {\n              const flightData: SelectedFlightData = {\n                flightIndex: flightNum,\n                airline: flight.airline,\n                departure_at: flight.departure_at,\n                return_at: flight.return_at,\n                flight_number: flight.flight_number,\n                originCity: originCity || \"Roma\",\n                destinationCity: conversationState.selectedDestination,\n                checkoutUrl: flight.checkoutUrl,\n              };\n              console.log(`✈️ User selected flight ${flightNum}:`, flightData);\n              setSelectedFlight(flightData);\n              localStorage.setItem(\"selectedFlight\", JSON.stringify(flightData));\n              setShowGenerateButton(true);\n            }\n          } else {\n            console.log(`✈️ Storing pending flight selection: ${flightNum}`);\n            setPendingFlightSelection(flightNum);\n          }\n        }\n        break;\n\n      case \"unlock_checkout\":\n        console.log(\n          \"🔓 Checkout unlocked - saving and navigating to checkout\",\n        );\n        saveCurrentItinerary();\n        try {\n          const savedData = localStorage.getItem(\"currentItinerary\");\n          if (savedData) {\n            const itinerary = JSON.parse(savedData);\n            itinerary.checkoutApproved = true;\n            localStorage.setItem(\"currentItinerary\", JSON.stringify(itinerary));\n            console.log(\"✅ checkoutApproved flag saved, navigating to /checkout\");\n          }\n        } catch (e) {\n          console.warn(\"Failed to update checkoutApproved flag:\", e);\n        }\n        onOpenChange(false);\n        setLocation(\"/checkout\");\n        break;\n    }\n  };\n\n  const onSubmit = async (data: MessageFormValues) => {\n    if (isLoading) return;\n    form.reset();\n    await sendChatRequest(data.message, true);\n  };\n\n  const handleGenerateItinerary = () => {\n    saveCurrentItinerary();\n    onOpenChange(false);\n    setLocation(\"/itinerary\");\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[85vh] flex flex-col p-0 bg-[#000000]\">\n        <DialogHeader className=\"px-6 pt-6 pb-4 border-b\">\n          <DialogTitle className=\"flex items-center gap-2 text-[#fa0006]\">\n            <Bot className=\"w-6 h-6 text-red-600\" />\n            ByeBro Chat Assistant\n            {conversationState.selectedDestination && (\n              <span className=\"text-sm font-normal text-gray-500 ml-2\">\n                → {conversationState.selectedDestination}\n              </span>\n            )}\n          </DialogTitle>\n        </DialogHeader>\n\n        <div\n          ref={scrollContainerRef}\n          className=\"flex-1 px-6 py-4 overflow-y-auto\"\n        >\n          <div className=\"space-y-4\">\n            {messages\n              .filter((msg) => msg.content && msg.content.trim())\n              .map((message) => (\n                <div\n                  key={message.id}\n                  className={`flex gap-3 ${\n                    message.sender === \"user\" ? \"flex-row-reverse\" : \"flex-row\"\n                  }`}\n                >\n                  <Avatar className=\"w-8 h-8\">\n                    {message.sender === \"user\" ? (\n                      <AvatarFallback className=\"bg-amber-500\">\n                        <Beer className=\"w-4 h-4 text-white\" />\n                      </AvatarFallback>\n                    ) : (\n                      <>\n                        <AvatarImage src={byebiLogo} alt=\"ByeBi\" />\n                        <AvatarFallback className=\"bg-red-500\">\n                          <Bot className=\"w-4 h-4 text-white\" />\n                        </AvatarFallback>\n                      </>\n                    )}\n                  </Avatar>\n                  <div\n                    className=\"max-w-[75%] rounded-lg px-4 py-2 bg-[#f5f5f5] text-[#000000]\"\n                  >\n                    <p className=\"text-sm whitespace-pre-wrap\">\n                      {message.content}\n                    </p>\n                  </div>\n                </div>\n              ))}\n            {isLoading && (\n              <div className=\"flex gap-3\">\n                <Avatar className=\"w-8 h-8\">\n                  <AvatarImage src={byebiLogo} alt=\"ByeBi\" />\n                  <AvatarFallback className=\"bg-red-500\">\n                    <Bot className=\"w-4 h-4 text-white\" />\n                  </AvatarFallback>\n                </Avatar>\n                <div className=\"bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-2 flex items-center gap-2\">\n                  <Loader2 className=\"w-4 h-4 animate-spin text-gray-600\" />\n                  {loadingMessage && (\n                    <span className=\"text-sm text-gray-600 dark:text-gray-400\">\n                      {loadingMessage}\n                    </span>\n                  )}\n                </div>\n              </div>\n            )}\n            <div ref={messagesEndRef} />\n          </div>\n        </div>\n\n        <div className=\"px-6 py-4 border-t space-y-3\">\n          {showGenerateButton && (\n            <Button\n              onClick={handleGenerateItinerary}\n              className=\"w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold py-6 shadow-lg\"\n              data-testid=\"button-generate-itinerary\"\n            >\n              <Sparkles className=\"w-5 h-5 mr-2\" />\n              Genera Itinerario Completo\n            </Button>\n          )}\n\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"flex gap-2\">\n            <Input\n              {...form.register(\"message\")}\n              placeholder=\"Type your message...\"\n              className=\"flex-1 bg-[#fafafa]\"\n              disabled={isLoading}\n              data-testid=\"input-chat-message\"\n            />\n            <Button\n              type=\"submit\"\n              disabled={isLoading}\n              className=\"bg-red-600 hover:bg-red-700\"\n              data-testid=\"button-send-message\"\n            >\n              {isLoading ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                <Send className=\"w-4 h-4\" />\n              )}\n            </Button>\n          </form>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":26861,"size_tokens":null},"client/src/components/BrandSelection.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { ArrowRight, Users, Heart } from \"lucide-react\";\nimport byebiLogo from \"@assets/Bb logo_1763313858570.png\";\nimport { useTranslation } from \"@/contexts/LanguageContext\";\n\ninterface BrandSelectionProps {\n  onSelectBrand: (brand: 'byebro' | 'byebride') => void;\n}\n\nexport default function BrandSelection({ onSelectBrand }: BrandSelectionProps) {\n  const { t } = useTranslation();\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 flex items-center justify-center px-4\">\n      <div className=\"max-w-4xl w-full\">\n        {/* ByeBi Logo */}\n        <div className=\"text-center mb-10 md:mb-14\">\n          <div className=\"flex justify-center\">\n            <img \n              src={byebiLogo} \n              alt=\"ByeBi Logo\" \n              className=\"w-auto h-40 md:h-48 lg:h-56 object-contain drop-shadow-2xl\"\n              style={{ \n                mixBlendMode: 'screen',\n                imageRendering: '-webkit-optimize-contrast',\n                filter: 'contrast(1.05) brightness(1.02)'\n              }}\n            />\n          </div>\n          <p className=\"text-gray-400 text-lg mt-6 font-light tracking-wide\">\n            {t('brand.subtitle')}\n          </p>\n        </div>\n\n        {/* Brand Selection Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\n          {/* ByeBro Card */}\n          <Card \n            className=\"group cursor-pointer overflow-hidden border-2 border-red-500/20 bg-gradient-to-br from-black to-red-950 hover:border-red-500 transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-red-500/50\"\n            onClick={() => onSelectBrand('byebro')}\n            data-testid=\"button-select-byebro\"\n          >\n            <CardContent className=\"p-8\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <Users className=\"w-12 h-12 text-red-500\" />\n                <ArrowRight className=\"w-6 h-6 text-red-500 group-hover:translate-x-2 transition-transform\" />\n              </div>\n              \n              <h2 className=\"text-4xl font-bold text-white mb-3\">\n                Bye<span className=\"text-red-500\">Bro</span>\n              </h2>\n              \n              <p className=\"text-gray-300 text-sm mb-6 leading-relaxed\">\n                {t('brand.bro.desc')}\n              </p>\n              \n              <div className=\"flex items-center gap-2 text-red-400 text-sm font-semibold\">\n                <span>{t('brand.bro.label')}</span>\n                <div className=\"h-px flex-1 bg-gradient-to-r from-red-500 to-transparent\"></div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* ByeBride Card */}\n          <Card \n            className=\"group cursor-pointer overflow-hidden border-2 border-pink-500/20 bg-gradient-to-br from-black to-pink-950 hover:border-pink-500 transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-pink-500/50\"\n            onClick={() => onSelectBrand('byebride')}\n            data-testid=\"button-select-byebride\"\n          >\n            <CardContent className=\"p-8\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <Heart className=\"w-12 h-12 text-pink-500\" />\n                <ArrowRight className=\"w-6 h-6 text-pink-500 group-hover:translate-x-2 transition-transform\" />\n              </div>\n              \n              <h2 className=\"text-4xl font-bold text-white mb-3\">\n                Bye<span className=\"text-pink-500\">Bride</span>\n              </h2>\n              \n              <p className=\"text-gray-300 text-sm mb-6 leading-relaxed\">\n                {t('brand.bride.desc')}\n              </p>\n              \n              <div className=\"flex items-center gap-2 text-pink-400 text-sm font-semibold\">\n                <span>{t('brand.bride.label')}</span>\n                <div className=\"h-px flex-1 bg-gradient-to-r from-pink-500 to-transparent\"></div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Footer */}\n        <div className=\"text-center mt-12\">\n          <p className=\"text-gray-500 text-sm\">\n            {t('brand.footer')}\n          </p>\n        </div>\n      </div>\n\n      <style>{`\n        @keyframes gradient {\n          0%, 100% { background-position: 0% 50%; }\n          50% { background-position: 100% 50%; }\n        }\n        .animate-gradient {\n          background-size: 200% 200%;\n          animation: gradient 3s ease infinite;\n        }\n      `}</style>\n    </div>\n  );\n}\n","path":null,"size_bytes":4590,"size_tokens":null},"client/src/components/SplittaBride.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogDescription } from '@/components/ui/dialog';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Separator } from '@/components/ui/separator';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Plus, Users, Receipt, DollarSign, User, Trash2, Edit, Calculator, ArrowRight, TrendingUp, Sparkles } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\n\ninterface ExpenseGroup {\n  id: number;\n  name: string;\n  description?: string;\n  members: string[];\n  totalAmount: number;\n  currency: string;\n  createdAt: string;\n}\n\ninterface Expense {\n  id: number;\n  groupId: number;\n  description: string;\n  amount: number;\n  paidBy: string;\n  splitBetween: string[];\n  category: string;\n  date: string;\n  receipt?: string;\n}\n\ninterface Settlement {\n  from: string;\n  to: string;\n  amount: number;\n}\n\nconst createGroupSchema = z.object({\n  name: z.string().min(1, 'Nome gruppo richiesto'),\n  description: z.string().optional(),\n  members: z.array(z.string()).min(1, 'Almeno un membro richiesto'),\n});\n\nconst createExpenseSchema = z.object({\n  description: z.string().min(1, 'Descrizione richiesta'),\n  amount: z.number().min(0.01, 'Importo deve essere maggiore di 0'),\n  paidBy: z.string().min(1, 'Chi ha pagato è richiesto'),\n  splitBetween: z.array(z.string()).min(1, 'Seleziona almeno una persona'),\n  category: z.string().min(1, 'Categoria richiesta'),\n  date: z.string().min(1, 'Data richiesta'),\n  splitEqually: z.boolean().optional(),\n});\n\ntype CreateGroupFormValues = z.infer<typeof createGroupSchema>;\ntype CreateExpenseFormValues = z.infer<typeof createExpenseSchema>;\n\nexport function SplittaBride() {\n  const [groups, setGroups] = useState<ExpenseGroup[]>([]);\n  const [expenses, setExpenses] = useState<Expense[]>([]);\n  const [selectedGroup, setSelectedGroup] = useState<ExpenseGroup | null>(null);\n  const [showCreateGroup, setShowCreateGroup] = useState(false);\n  const [showCreateExpense, setShowCreateExpense] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isCreatingGroup, setIsCreatingGroup] = useState(false);\n  const { toast } = useToast();\n  const [location, navigate] = useLocation();\n\n  const groupForm = useForm<CreateGroupFormValues>({\n    resolver: zodResolver(createGroupSchema),\n    defaultValues: {\n      name: '',\n      description: '',\n      members: [],\n    },\n  });\n\n  const [newMemberName, setNewMemberName] = useState('');\n\n  const expenseForm = useForm<CreateExpenseFormValues>({\n    resolver: zodResolver(createExpenseSchema),\n    defaultValues: {\n      description: '',\n      amount: 0,\n      paidBy: '',\n      splitBetween: [],\n      category: 'food',\n      date: new Date().toISOString().split('T')[0],\n      splitEqually: false,\n    },\n  });\n\n  useEffect(() => {\n    loadGroups();\n  }, []);\n\n  useEffect(() => {\n    if (selectedGroup) {\n      loadExpenses(selectedGroup.id);\n    }\n  }, [selectedGroup]);\n\n  const loadGroups = async () => {\n    try {\n      const response = await fetch('/api/expense-groups');\n      if (response.ok) {\n        const groupsData = await response.json();\n        setGroups(groupsData);\n      }\n    } catch (error) {\n      console.error('Errore caricamento gruppi:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const loadExpenses = async (groupId: number) => {\n    try {\n      const response = await fetch(`/api/expense-groups/${groupId}/expenses`);\n      if (response.ok) {\n        const expensesData = await response.json();\n        setExpenses(expensesData);\n      }\n    } catch (error) {\n      console.error('Errore caricamento spese:', error);\n    }\n  };\n\n  const onCreateGroup = async (data: CreateGroupFormValues) => {\n    setIsCreatingGroup(true);\n    \n    try {\n      const response = await fetch('/api/expense-groups', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: data.name,\n          description: data.description,\n          members: data.members,\n          currency: 'EUR',\n        }),\n      });\n\n      if (response.ok) {\n        const newGroup = await response.json();\n        setGroups(prev => [...prev, newGroup]);\n        setShowCreateGroup(false);\n        groupForm.reset({\n          name: '',\n          description: '',\n          members: [],\n        });\n        setNewMemberName('');\n        \n        // Redirect automatico al gruppo appena creato\n        setSelectedGroup(newGroup);\n        \n        toast({\n          title: \"✅ Gruppo creato con successo!\",\n          description: `${newGroup.name} è stato creato. Ora puoi aggiungere le spese.`,\n        });\n      } else {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.message || 'Errore nella creazione del gruppo');\n      }\n    } catch (error) {\n      console.error('Errore creazione gruppo:', error);\n      toast({\n        title: \"❌ Impossibile creare il gruppo\",\n        description: error instanceof Error \n          ? error.message \n          : \"Si è verificato un errore. Controlla la connessione e riprova più tardi.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsCreatingGroup(false);\n    }\n  };\n\n  const addMember = () => {\n    if (newMemberName.trim()) {\n      const currentMembers = groupForm.getValues('members') || [];\n      if (!currentMembers.includes(newMemberName.trim())) {\n        groupForm.setValue('members', [...currentMembers, newMemberName.trim()]);\n        setNewMemberName('');\n      }\n    }\n  };\n\n  const removeMember = (memberToRemove: string) => {\n    const currentMembers = groupForm.getValues('members') || [];\n    groupForm.setValue('members', currentMembers.filter(m => m !== memberToRemove));\n  };\n\n  const onCreateExpense = async (data: CreateExpenseFormValues) => {\n    if (!selectedGroup) return;\n\n    try {\n      const splitBetween = data.splitEqually ? selectedGroup.members : data.splitBetween;\n      \n      const response = await fetch('/api/expenses', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          groupId: selectedGroup.id,\n          description: data.description,\n          amount: Math.round(data.amount * 100),\n          paidBy: data.paidBy,\n          splitBetween: splitBetween,\n          category: data.category,\n          date: data.date,\n        }),\n      });\n\n      if (response.ok) {\n        const newExpense = await response.json();\n        setExpenses(prev => [...prev, newExpense]);\n        setShowCreateExpense(false);\n        expenseForm.reset({\n          description: '',\n          amount: 0,\n          paidBy: '',\n          splitBetween: [],\n          category: 'food',\n          date: new Date().toISOString().split('T')[0],\n          splitEqually: false,\n        });\n        \n        const groupTotal = [...expenses, newExpense].reduce((sum, exp) => sum + exp.amount, 0) / 100;\n        setGroups(prev => prev.map(g => \n          g.id === selectedGroup.id ? { ...g, totalAmount: groupTotal } : g\n        ));\n        \n        toast({\n          title: \"Spesa aggiunta!\",\n          description: \"La spesa è stata registrata con successo.\",\n        });\n      } else {\n        const errorData = await response.json();\n        console.error('Errore validazione:', errorData);\n        throw new Error('Errore nella creazione della spesa');\n      }\n    } catch (error) {\n      console.error('Errore creazione spesa:', error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiungere la spesa. Riprova.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const calculateSettlements = (group: ExpenseGroup, expenses: Expense[]): Settlement[] => {\n    if (!group || expenses.length === 0) return [];\n\n    const balances: { [member: string]: number } = {};\n    \n    group.members.forEach(member => {\n      balances[member] = 0;\n    });\n\n    expenses.forEach(expense => {\n      const amountPerPerson = expense.amount / expense.splitBetween.length;\n      balances[expense.paidBy] += expense.amount;\n      expense.splitBetween.forEach(member => {\n        balances[member] -= amountPerPerson;\n      });\n    });\n\n    const settlements: Settlement[] = [];\n    const creditors = Object.entries(balances).filter(([_, amount]) => amount > 0);\n    const debtors = Object.entries(balances).filter(([_, amount]) => amount < 0);\n\n    creditors.forEach(([creditor, creditAmount]) => {\n      debtors.forEach(([debtor, debtAmount]) => {\n        if (Math.abs(debtAmount) > 0.01 && creditAmount > 0.01) {\n          const settlementAmount = Math.min(creditAmount, Math.abs(debtAmount));\n          settlements.push({\n            from: debtor,\n            to: creditor,\n            amount: settlementAmount,\n          });\n          \n          balances[creditor] -= settlementAmount;\n          balances[debtor] += settlementAmount;\n        }\n      });\n    });\n\n    return settlements.filter(s => s.amount > 0.01);\n  };\n\n  const getCategoryIcon = (category: string) => {\n    const icons: { [key: string]: string } = {\n      food: '🍽️',\n      transport: '🚗',\n      accommodation: '🏨',\n      entertainment: '🎉',\n      shopping: '🛍️',\n      other: '📋',\n    };\n    return icons[category] || '📋';\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-black via-gray-900 to-black flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"relative w-16 h-16 mx-auto mb-4\">\n            <div className=\"absolute inset-0 rounded-full border-4 border-pink-600/30\"></div>\n            <div className=\"absolute inset-0 rounded-full border-4 border-pink-600 border-t-transparent animate-spin\"></div>\n          </div>\n          <p className=\"text-white text-lg\">Caricamento SplittaBride...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-black via-gray-900 to-black text-white\">\n      <div className=\"container mx-auto px-4 py-6 md:py-8\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row items-center justify-between mb-8 gap-4\">\n          <button\n            onClick={() => navigate('/')}\n            className=\"font-poppins font-bold text-xl md:text-2xl transform transition-transform hover:scale-105 cursor-pointer\"\n            data-testid=\"button-home\"\n          >\n            <span className=\"text-white\">Bye</span><span className=\"text-pink-600\">Bride</span>\n          </button>\n          <div className=\"text-center flex-1\">\n            <div className=\"flex items-center justify-center gap-3 mb-2\">\n              <Sparkles className=\"w-8 h-8 text-pink-500\" />\n              <h1 className=\"text-3xl md:text-5xl font-bold bg-gradient-to-r from-pink-500 via-pink-600 to-pink-500 bg-clip-text text-transparent\">\n                SplittaBride\n              </h1>\n              <Sparkles className=\"w-8 h-8 text-pink-500\" />\n            </div>\n            <p className=\"text-gray-400 text-sm md:text-base\">Dividi le spese del tuo addio al nubilato</p>\n          </div>\n          <div className=\"w-20 hidden md:block\"></div>\n        </div>\n\n        {!selectedGroup ? (\n          /* Vista Gruppi */\n          <div className=\"space-y-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n              <h2 className=\"text-2xl md:text-3xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent\">\n                I tuoi gruppi\n              </h2>\n              <Dialog open={showCreateGroup} onOpenChange={setShowCreateGroup}>\n                <DialogTrigger asChild>\n                  <Button \n                    className=\"bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white shadow-lg shadow-pink-500/30 w-full sm:w-auto\"\n                    data-testid=\"button-create-group\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Nuovo Gruppo\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"bg-gradient-to-br from-gray-900 to-black border border-pink-500/20 text-white max-w-md\">\n                  <DialogHeader>\n                    <DialogTitle className=\"text-white text-xl\">Crea Nuovo Gruppo</DialogTitle>\n                    <DialogDescription className=\"text-gray-400\">\n                      Crea un nuovo gruppo per dividere le spese del tuo addio al nubilato\n                    </DialogDescription>\n                  </DialogHeader>\n                  <form onSubmit={groupForm.handleSubmit(onCreateGroup)} className=\"space-y-4\">\n                    <div>\n                      <Label htmlFor=\"name\" className=\"text-white\">Nome Gruppo</Label>\n                      <Input\n                        id=\"name\"\n                        {...groupForm.register('name')}\n                        placeholder=\"es. Addio al Nubilato Sara\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-group-name\"\n                      />\n                      {groupForm.formState.errors.name && (\n                        <p className=\"text-pink-400 text-sm mt-1\">\n                          {groupForm.formState.errors.name.message}\n                        </p>\n                      )}\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"description\" className=\"text-white\">Descrizione (opzionale)</Label>\n                      <Textarea\n                        id=\"description\"\n                        {...groupForm.register('description')}\n                        placeholder=\"Descrizione del gruppo...\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-group-description\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-white\">Membri</Label>\n                      <div className=\"space-y-2 mt-2\">\n                        <div className=\"flex gap-2\">\n                          <Input\n                            value={newMemberName}\n                            onChange={(e) => setNewMemberName(e.target.value)}\n                            placeholder=\"Nome del membro\"\n                            className=\"bg-gray-800/50 border-gray-700 text-white flex-1\"\n                            onKeyPress={(e) => {\n                              if (e.key === 'Enter') {\n                                e.preventDefault();\n                                addMember();\n                              }\n                            }}\n                            data-testid=\"input-member-name\"\n                          />\n                          <Button\n                            type=\"button\"\n                            onClick={addMember}\n                            className=\"bg-pink-600 hover:bg-pink-700\"\n                            data-testid=\"button-add-member\"\n                          >\n                            <Plus className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        <ScrollArea className=\"max-h-32\">\n                          <div className=\"space-y-1\">\n                            {groupForm.watch('members')?.map((member, index) => (\n                              <div \n                                key={index} \n                                className=\"flex items-center justify-between bg-gradient-to-r from-pink-500/10 to-pink-600/10 px-3 py-2 rounded-lg border border-pink-500/30\"\n                                data-testid={`member-${index}`}\n                              >\n                                <span className=\"text-white text-sm font-medium\">{member}</span>\n                                <Button\n                                  type=\"button\"\n                                  onClick={() => removeMember(member)}\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"text-pink-400 hover:text-pink-300 hover:bg-pink-900/20 h-8 w-8 p-0\"\n                                  data-testid={`button-remove-member-${index}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4\" />\n                                </Button>\n                              </div>\n                            ))}\n                          </div>\n                        </ScrollArea>\n                        {groupForm.formState.errors.members && (\n                          <p className=\"text-pink-400 text-sm\">\n                            {groupForm.formState.errors.members.message}\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                    \n                    <DialogFooter>\n                      <Button \n                        type=\"submit\" \n                        disabled={isCreatingGroup}\n                        className=\"bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 w-full disabled:opacity-50 disabled:cursor-not-allowed\"\n                        data-testid=\"button-submit-group\"\n                      >\n                        {isCreatingGroup ? (\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div>\n                            Creazione in corso...\n                          </div>\n                        ) : (\n                          \"Crea Gruppo\"\n                        )}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            {groups.length === 0 ? (\n              <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-pink-500/20 backdrop-blur-sm\">\n                <CardContent className=\"text-center py-16\">\n                  <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4\">\n                    <Users className=\"h-10 w-10 text-pink-400\" />\n                  </div>\n                  <h3 className=\"text-2xl font-bold text-white mb-2\">Nessun gruppo ancora</h3>\n                  <p className=\"text-gray-400 mb-6 max-w-md mx-auto\">Crea il tuo primo gruppo per iniziare a dividere le spese del tuo addio al nubilato!</p>\n                  <Button\n                    onClick={() => setShowCreateGroup(true)}\n                    className=\"bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 shadow-lg shadow-pink-500/30\"\n                    data-testid=\"button-create-first-group\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Crea il primo gruppo\n                  </Button>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n                {groups.map((group) => (\n                  <Card\n                    key={group.id}\n                    className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 hover:border-pink-500 cursor-pointer transition-all hover:shadow-xl hover:shadow-pink-500/20 backdrop-blur-sm group\"\n                    onClick={() => setSelectedGroup(group)}\n                    data-testid={`group-card-${group.id}`}\n                  >\n                    <CardHeader>\n                      <div className=\"flex justify-between items-start\">\n                        <div className=\"flex-1\">\n                          <CardTitle className=\"text-white text-lg mb-1 group-hover:text-pink-400 transition-colors\">\n                            {group.name}\n                          </CardTitle>\n                          {group.description && (\n                            <p className=\"text-gray-400 text-sm\">{group.description}</p>\n                          )}\n                        </div>\n                        <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 px-3 py-1 rounded-lg border border-pink-500/30\">\n                          <p className=\"text-pink-400 font-bold text-sm\">€{(group.totalAmount || 0).toFixed(2)}</p>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"flex items-center text-gray-400 text-sm mb-3\">\n                        <Users className=\"h-4 w-4 mr-2 text-pink-400\" />\n                        {group.members.length} membri\n                      </div>\n                      <div className=\"flex flex-wrap gap-1.5\">\n                        {group.members.slice(0, 3).map((member) => (\n                          <Badge key={member} variant=\"secondary\" className=\"text-xs bg-gradient-to-r from-gray-800 to-gray-700 text-gray-300 border border-gray-600\">\n                            {member}\n                          </Badge>\n                        ))}\n                        {group.members.length > 3 && (\n                          <Badge variant=\"secondary\" className=\"text-xs bg-gradient-to-r from-pink-900/30 to-pink-800/30 text-pink-400 border border-pink-500/30\">\n                            +{group.members.length - 3}\n                          </Badge>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </div>\n        ) : (\n          /* Vista Dettaglio Gruppo */\n          <div className=\"space-y-6\">\n            <div className=\"flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full md:w-auto\">\n                <Button\n                  onClick={() => setSelectedGroup(null)}\n                  variant=\"outline\"\n                  className=\"border-gray-700 text-white hover:bg-pink-900/20 hover:border-pink-500 w-full sm:w-auto\"\n                  data-testid=\"button-back-to-groups\"\n                >\n                  ← Torna ai gruppi\n                </Button>\n                <div>\n                  <h2 className=\"text-2xl md:text-3xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent\">\n                    {selectedGroup.name}\n                  </h2>\n                  <div className=\"flex items-center gap-2 mt-1\">\n                    <TrendingUp className=\"w-4 h-4 text-pink-400\" />\n                    <p className=\"text-gray-400\">Totale: <span className=\"text-pink-400 font-bold\">€{(selectedGroup.totalAmount || 0).toFixed(2)}</span></p>\n                  </div>\n                </div>\n              </div>\n              <Dialog open={showCreateExpense} onOpenChange={setShowCreateExpense}>\n                <DialogTrigger asChild>\n                  <Button \n                    className=\"bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white shadow-lg shadow-pink-500/30 w-full md:w-auto\"\n                    data-testid=\"button-add-expense\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Aggiungi Spesa\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"bg-gradient-to-br from-gray-900 to-black border border-pink-500/20 text-white max-w-md max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle className=\"text-white text-xl\">Aggiungi Nuova Spesa</DialogTitle>\n                    <DialogDescription className=\"text-gray-400\">\n                      Registra una nuova spesa per il gruppo e seleziona chi deve partecipare alla divisione\n                    </DialogDescription>\n                  </DialogHeader>\n                  <form onSubmit={expenseForm.handleSubmit(onCreateExpense)} className=\"space-y-4\">\n                    <div>\n                      <Label htmlFor=\"description\" className=\"text-white\">Descrizione</Label>\n                      <Input\n                        id=\"description\"\n                        {...expenseForm.register('description')}\n                        placeholder=\"es. Spa e massaggio\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-expense-description\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"amount\" className=\"text-white\">Importo (€)</Label>\n                      <Input\n                        id=\"amount\"\n                        type=\"number\"\n                        step=\"0.01\"\n                        {...expenseForm.register('amount', { valueAsNumber: true })}\n                        placeholder=\"0.00\"\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-expense-amount\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"paidBy\" className=\"text-white\">Chi ha pagato</Label>\n                      <Select onValueChange={(value) => expenseForm.setValue('paidBy', value)}>\n                        <SelectTrigger className=\"bg-gray-800/50 border-gray-700 text-white mt-1\" data-testid=\"select-paid-by\">\n                          <SelectValue placeholder=\"Seleziona chi ha pagato\" className=\"text-white\" />\n                        </SelectTrigger>\n                        <SelectContent className=\"bg-gray-800 border-gray-700 text-white\">\n                          {selectedGroup.members.map((member) => (\n                            <SelectItem key={member} value={member} className=\"text-white focus:text-white\">\n                              {member}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-white\">Dividi tra</Label>\n                      <div className=\"space-y-2 mt-2\">\n                        <label className=\"flex items-center space-x-2 text-white p-2 rounded-lg bg-pink-500/10 border border-pink-500/30 cursor-pointer hover:bg-pink-500/20 transition-colors\">\n                          <input\n                            type=\"checkbox\"\n                            {...expenseForm.register('splitEqually')}\n                            onChange={(e) => {\n                              if (e.target.checked) {\n                                expenseForm.setValue('splitBetween', selectedGroup.members);\n                              } else {\n                                expenseForm.setValue('splitBetween', []);\n                              }\n                            }}\n                            className=\"rounded border-gray-600\"\n                            data-testid=\"checkbox-split-equally\"\n                          />\n                          <span className=\"text-sm font-medium\">Dividi equamente tra tutte</span>\n                        </label>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          {selectedGroup.members.map((member, idx) => (\n                            <label \n                              key={member} \n                              className=\"flex items-center space-x-2 text-white p-2 rounded-lg bg-gray-800/50 border border-gray-700 cursor-pointer hover:bg-gray-700/50 transition-colors\"\n                            >\n                              <input\n                                type=\"checkbox\"\n                                checked={expenseForm.watch('splitBetween')?.includes(member) || false}\n                                onChange={(e) => {\n                                  const currentSplit = expenseForm.getValues('splitBetween') || [];\n                                  if (e.target.checked) {\n                                    expenseForm.setValue('splitBetween', [...currentSplit, member]);\n                                  } else {\n                                    expenseForm.setValue('splitBetween', currentSplit.filter(m => m !== member));\n                                    expenseForm.setValue('splitEqually', false);\n                                  }\n                                }}\n                                className=\"rounded border-gray-600\"\n                                data-testid={`checkbox-split-member-${idx}`}\n                              />\n                              <span className=\"text-sm\">{member}</span>\n                            </label>\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"category\" className=\"text-white\">Categoria</Label>\n                      <Select onValueChange={(value) => expenseForm.setValue('category', value)} defaultValue=\"food\">\n                        <SelectTrigger className=\"bg-gray-800/50 border-gray-700 text-white mt-1\" data-testid=\"select-category\">\n                          <SelectValue placeholder=\"Seleziona categoria\" className=\"text-white\" />\n                        </SelectTrigger>\n                        <SelectContent className=\"bg-gray-800 border-gray-700 text-white\">\n                          <SelectItem value=\"food\" className=\"text-white focus:text-white\">🍽️ Cibo</SelectItem>\n                          <SelectItem value=\"transport\" className=\"text-white focus:text-white\">🚗 Trasporti</SelectItem>\n                          <SelectItem value=\"accommodation\" className=\"text-white focus:text-white\">🏨 Alloggio</SelectItem>\n                          <SelectItem value=\"entertainment\" className=\"text-white focus:text-white\">🎉 Divertimento</SelectItem>\n                          <SelectItem value=\"shopping\" className=\"text-white focus:text-white\">🛍️ Shopping</SelectItem>\n                          <SelectItem value=\"other\" className=\"text-white focus:text-white\">📋 Altro</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"date\" className=\"text-white\">Data</Label>\n                      <Input\n                        id=\"date\"\n                        type=\"date\"\n                        {...expenseForm.register('date')}\n                        className=\"bg-gray-800/50 border-gray-700 text-white mt-1\"\n                        data-testid=\"input-expense-date\"\n                      />\n                    </div>\n                    \n                    <DialogFooter>\n                      <Button \n                        type=\"submit\" \n                        className=\"bg-gradient-to-r from-pink-600 to-pink-700 hover:from-pink-700 hover:to-pink-800 w-full\"\n                        data-testid=\"button-submit-expense\"\n                      >\n                        Aggiungi Spesa\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"grid lg:grid-cols-3 gap-6\">\n              {/* Lista Spese */}\n              <div className=\"lg:col-span-2\">\n                <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 backdrop-blur-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-white flex items-center text-lg md:text-xl\">\n                      <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 p-2 rounded-lg mr-3\">\n                        <Receipt className=\"h-5 w-5 text-pink-400\" />\n                      </div>\n                      Spese ({expenses.length})\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {expenses.length === 0 ? (\n                      <div className=\"text-center py-12\">\n                        <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\">\n                          <Receipt className=\"h-8 w-8 text-pink-400\" />\n                        </div>\n                        <p className=\"text-gray-400\">Nessuna spesa ancora registrata</p>\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[500px] pr-4\">\n                        <div className=\"space-y-3\">\n                          {expenses.map((expense, idx) => (\n                            <div\n                              key={expense.id}\n                              className=\"p-4 bg-gradient-to-r from-gray-800/50 to-gray-700/30 rounded-xl border border-gray-700 hover:border-pink-500/50 transition-all group\"\n                              data-testid={`expense-${idx}`}\n                            >\n                              <div className=\"flex justify-between items-start mb-3\">\n                                <div className=\"flex items-start space-x-3 flex-1\">\n                                  <span className=\"text-2xl\">\n                                    {getCategoryIcon(expense.category)}\n                                  </span>\n                                  <div className=\"flex-1\">\n                                    <h4 className=\"font-semibold text-white group-hover:text-pink-400 transition-colors\">\n                                      {expense.description}\n                                    </h4>\n                                    <p className=\"text-sm text-gray-400 mt-1\">\n                                      Pagato da <span className=\"text-pink-400 font-medium\">{expense.paidBy}</span>\n                                    </p>\n                                  </div>\n                                </div>\n                                <div className=\"text-right ml-4\">\n                                  <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 px-3 py-1 rounded-lg border border-pink-500/30\">\n                                    <p className=\"font-bold text-pink-400\">€{(expense.amount / 100).toFixed(2)}</p>\n                                  </div>\n                                  <p className=\"text-xs text-gray-500 mt-1\">\n                                    {new Date(expense.date).toLocaleDateString('it-IT')}\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"flex flex-wrap gap-1.5 items-center\">\n                                <span className=\"text-xs text-gray-500\">Diviso tra:</span>\n                                {expense.splitBetween.map((member) => (\n                                  <Badge \n                                    key={member} \n                                    variant=\"secondary\" \n                                    className=\"text-xs bg-gradient-to-r from-gray-700 to-gray-600 text-gray-300 border border-gray-600\"\n                                  >\n                                    {member}\n                                  </Badge>\n                                ))}\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Sidebar */}\n              <div className=\"space-y-6\">\n                {/* Regolamenti */}\n                <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 backdrop-blur-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-white flex items-center text-lg\">\n                      <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 p-2 rounded-lg mr-3\">\n                        <Calculator className=\"h-5 w-5 text-pink-400\" />\n                      </div>\n                      Regolamenti\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {(() => {\n                      const settlements = calculateSettlements(selectedGroup, expenses);\n                      return settlements.length === 0 ? (\n                        <div className=\"text-center py-8\">\n                          <div className=\"bg-gradient-to-br from-green-500/20 to-green-600/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\">\n                            <DollarSign className=\"h-8 w-8 text-green-400\" />\n                          </div>\n                          <p className=\"text-gray-400 font-medium\">Tutti i conti sono in pari!</p>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {settlements.map((settlement, index) => (\n                            <div\n                              key={index}\n                              className=\"p-3 bg-gradient-to-r from-pink-500/10 to-pink-600/5 rounded-lg border border-pink-500/30\"\n                              data-testid={`settlement-${index}`}\n                            >\n                              <div className=\"flex items-center justify-between gap-2\">\n                                <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                                  <User className=\"h-4 w-4 text-gray-400 flex-shrink-0\" />\n                                  <span className=\"text-white font-medium truncate\">{settlement.from}</span>\n                                  <ArrowRight className=\"h-4 w-4 text-pink-400 flex-shrink-0\" />\n                                  <span className=\"text-white font-medium truncate\">{settlement.to}</span>\n                                </div>\n                                <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 px-2 py-1 rounded border border-pink-500/30 flex-shrink-0\">\n                                  <span className=\"font-bold text-pink-400 text-sm whitespace-nowrap\">\n                                    €{(settlement.amount / 100).toFixed(2)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      );\n                    })()}\n                  </CardContent>\n                </Card>\n\n                {/* Membri del gruppo */}\n                <Card className=\"bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-gray-700 backdrop-blur-sm\">\n                  <CardHeader>\n                    <CardTitle className=\"text-white flex items-center text-lg\">\n                      <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 p-2 rounded-lg mr-3\">\n                        <Users className=\"h-5 w-5 text-pink-400\" />\n                      </div>\n                      Membri ({selectedGroup.members.length})\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {selectedGroup.members.map((member, idx) => (\n                        <div\n                          key={member}\n                          className=\"flex items-center space-x-3 p-3 bg-gradient-to-r from-gray-800/50 to-gray-700/30 rounded-lg border border-gray-700 hover:border-pink-500/50 transition-all\"\n                          data-testid={`group-member-${idx}`}\n                        >\n                          <div className=\"bg-gradient-to-br from-pink-500/20 to-pink-600/10 p-2 rounded-full\">\n                            <User className=\"h-4 w-4 text-pink-400\" />\n                          </div>\n                          <span className=\"text-white font-medium\">{member}</span>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":41368,"size_tokens":null},"client/src/pages/Itinerary.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Plane, Calendar, Users, MapPin, ExternalLink, AlertCircle } from 'lucide-react';\nimport Header from '@/components/Header';\nimport { formatDateRangeIT } from '@shared/dateUtils';\nimport { GetYourGuideCta } from '@/components/GetYourGuideCta';\nimport { useTranslation } from '@/contexts/LanguageContext';\n\n/**\n * TripContext - The ONLY data structure used by the real flow\n * Populated by chatbot, read by Itinerary and Checkout\n */\ninterface TripContext {\n  origin: string;\n  destination: string;\n  startDate: string; // YYYY-MM-DD\n  endDate: string;   // YYYY-MM-DD\n  people: number;\n  aviasalesCheckoutUrl: string;\n  flightLabel?: string;\n}\n\nexport default function Itinerary() {\n  const [, setLocation] = useLocation();\n  const { t } = useTranslation();\n  const [tripContext, setTripContext] = useState<TripContext | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    // Read TripContext from localStorage - NO fallback mock data\n    const savedItinerary = localStorage.getItem('currentItinerary');\n    \n    if (!savedItinerary) {\n      setError(t('itinerary.noItineraryError'));\n      setIsLoading(false);\n      return;\n    }\n\n    try {\n      const parsed = JSON.parse(savedItinerary);\n      console.log('📦 Loaded TripContext from localStorage:', parsed);\n\n      // Validate required fields\n      if (!parsed.destination || !parsed.startDate || !parsed.endDate || !parsed.people) {\n        setError(t('itinerary.incompleteData'));\n        setIsLoading(false);\n        return;\n      }\n\n      // Build TripContext from saved data\n      const context: TripContext = {\n        origin: parsed.origin || parsed.originCity || '',\n        destination: parsed.destination,\n        startDate: parsed.startDate,\n        endDate: parsed.endDate,\n        people: parsed.people,\n        aviasalesCheckoutUrl: parsed.aviasalesCheckoutUrl || parsed.aviasalesUrl || '',\n        flightLabel: parsed.flightLabel || parsed.selectedFlight?.label || `${parsed.origin || 'Italia'} → ${parsed.destination}`\n      };\n\n      // Debug log for Aviasales URL (temporary - remove after verification)\n      console.log('🔍 DEBUG Itinerary - TripContext dates:', {\n        startDate: context.startDate,\n        endDate: context.endDate,\n        aviasalesCheckoutUrl: context.aviasalesCheckoutUrl\n      });\n      \n      setTripContext(context);\n    } catch (err) {\n      console.error('Error parsing TripContext:', err);\n      setError(t('itinerary.loadError'));\n    }\n    \n    setIsLoading(false);\n  }, []);\n\n  const handleContinue = () => {\n    // TripContext already in localStorage, just navigate\n    setLocation('/checkout');\n  };\n\n  const handleBackToChatbot = () => {\n    setLocation('/');\n  };\n\n  // Loading state\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-red-900 flex items-center justify-center\">\n        <div className=\"text-white text-xl\">{t('common.loading')}</div>\n      </div>\n    );\n  }\n\n  // Error state - no TripContext or invalid data\n  if (error || !tripContext) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-red-900\">\n        <Header />\n        <div className=\"container mx-auto px-4 py-16 max-w-2xl\">\n          <Card className=\"bg-gradient-to-br from-gray-800/90 to-gray-900/90 border-red-500/50\">\n            <CardHeader className=\"text-center\">\n              <div className=\"mx-auto mb-4 p-4 bg-red-500/20 rounded-full w-fit\">\n                <AlertCircle className=\"w-12 h-12 text-red-400\" />\n              </div>\n              <CardTitle className=\"text-2xl text-white\">{t('itinerary.noItinerary')}</CardTitle>\n            </CardHeader>\n            <CardContent className=\"text-center\">\n              <p className=\"text-gray-300 mb-6\">\n                {error || t('itinerary.mustPlan')}\n              </p>\n              <Button\n                onClick={handleBackToChatbot}\n                className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-8 py-3 text-lg\"\n                data-testid=\"button-back-chatbot\"\n              >\n                {t('itinerary.backToChatbot')}\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  // Format dates using safe string-based formatter\n  const formattedDates = formatDateRangeIT(tripContext.startDate, tripContext.endDate);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-red-900\">\n      <Header />\n      \n      {/* Hero Header */}\n      <div className=\"relative py-12 bg-gradient-to-r from-black/50 to-red-900/50 backdrop-blur-sm border-b border-white/10\">\n        <div className=\"container mx-auto px-4 max-w-4xl\">\n          <div className=\"text-center mb-6\">\n            <h1 className=\"text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-white via-red-200 to-red-400 bg-clip-text text-transparent\">\n              {t('itinerary.title', { destination: tripContext.destination })}\n            </h1>\n            <p className=\"text-white/80 text-lg\">{t('itinerary.subtitle')}</p>\n          </div>\n          \n          {/* Trip Info Pills */}\n          <div className=\"flex flex-wrap justify-center gap-4 text-white/90\">\n            <div className=\"flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20\">\n              <Calendar className=\"w-5 h-5 text-red-400\" />\n              <span className=\"font-medium\" data-testid=\"text-dates\">{formattedDates}</span>\n            </div>\n            <div className=\"flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20\">\n              <Users className=\"w-5 h-5 text-red-400\" />\n              <span className=\"font-medium\" data-testid=\"text-people\">{tripContext.people} {t('common.people')}</span>\n            </div>\n            <div className=\"flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20\">\n              <MapPin className=\"w-5 h-5 text-red-400\" />\n              <span className=\"font-medium\" data-testid=\"text-destination\">{tripContext.destination}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <div className=\"space-y-6\">\n          \n          {/* Flight Section - No prices, only Aviasales link */}\n          <section>\n            <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-3 text-white\">\n              <div className=\"p-2 bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg\">\n                <Plane className=\"w-6 h-6 text-white\" />\n              </div>\n              {t('itinerary.flight')}\n            </h2>\n            \n            <Card className=\"bg-gradient-to-br from-gray-800/90 to-gray-900/90 border-2 border-gray-600 hover:border-red-400 transition-all\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-start gap-3 flex-1\">\n                    <div className=\"p-3 rounded-xl bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg\">\n                      <Plane className=\"w-5 h-5\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg text-white font-bold\" data-testid=\"text-flight-label\">\n                        {tripContext.flightLabel || `${tripContext.origin} → ${tripContext.destination}`}\n                      </CardTitle>\n                      <p className=\"text-sm text-gray-300 mt-1\">\n                        {formattedDates} • {tripContext.people} {t('common.passengers')}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-sm text-gray-400 mb-4\">\n                  {t('itinerary.bookOnAviasales')}\n                </p>\n                \n                {tripContext.aviasalesCheckoutUrl && (\n                  <Button\n                    asChild\n                    className=\"w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white\"\n                    data-testid=\"button-aviasales\"\n                  >\n                    <a \n                      href={tripContext.aviasalesCheckoutUrl} \n                      target=\"_blank\" \n                      rel=\"noopener noreferrer\"\n                    >\n                      <Plane className=\"w-4 h-4 mr-2\" />\n                      {t('itinerary.goToAviasales')}\n                      <ExternalLink className=\"w-4 h-4 ml-2\" />\n                    </a>\n                  </Button>\n                )}\n              </CardContent>\n            </Card>\n            \n            <p className=\"text-sm text-white/60 mt-2 ml-1 bg-white/5 inline-block px-3 py-1 rounded-full\">\n              {t('itinerary.bookExternally')}\n            </p>\n          </section>\n\n          <GetYourGuideCta \n            destinationCity={tripContext.destination} \n            placement=\"itinerary\" \n          />\n\n        </div>\n\n        {/* Bottom CTA - Continua */}\n        <div className=\"sticky bottom-0 left-0 right-0 bg-gradient-to-r from-black/90 via-red-900/90 to-black/90 backdrop-blur-md border-t-2 border-red-500/50 shadow-2xl mt-12 p-6 rounded-t-3xl\">\n          <div className=\"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6\">\n            <div className=\"text-center md:text-left\">\n              <p className=\"text-white/70 text-sm\">{t('itinerary.nextStep')}</p>\n              <p className=\"text-xl text-white font-bold\">{t('itinerary.chooseHotel')}</p>\n            </div>\n            <Button\n              size=\"lg\"\n              className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-10 py-7 text-lg font-bold shadow-xl shadow-red-500/30 transform transition-all hover:scale-105\"\n              onClick={handleContinue}\n              data-testid=\"button-continue\"\n            >\n              {t('itinerary.continueToCheckout')}\n            </Button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10605,"size_tokens":null},"client/src/pages/Checkout.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Plane, Hotel, Calendar, Users, MapPin, ExternalLink, Loader2, AlertCircle } from 'lucide-react';\nimport Header from '@/components/Header';\nimport { formatDateRangeIT, calculateTripDays } from '@shared/dateUtils';\nimport { GetYourGuideCta } from '@/components/GetYourGuideCta';\nimport { getCityCode } from '@shared/cityMapping';\nimport { useTranslation } from '@/contexts/LanguageContext';\n\n/**\n * TripContext - The ONLY data structure used by the real flow\n * Must match Itinerary.tsx's TripContext\n */\ninterface TripContext {\n  origin: string;\n  destination: string;\n  startDate: string; // YYYY-MM-DD\n  endDate: string;   // YYYY-MM-DD\n  people: number;\n  aviasalesCheckoutUrl: string;\n  flightLabel?: string;\n  originCity?: string; // Legacy compatibility\n}\n\ninterface HotelData {\n  hotelId: string;\n  name: string;\n  stars?: string;\n  priceTotal: number;\n  currency: string;\n  offerId: string;\n  bookingFlow: 'IN_APP' | 'REDIRECT';\n  paymentPolicy: string;\n  checkInDate: string;\n  checkOutDate: string;\n  roomDescription?: string;\n}\n\n\nexport default function Checkout() {\n  const [, setLocation] = useLocation();\n  const { t } = useTranslation();\n  const [tripContext, setTripContext] = useState<TripContext | null>(null);\n  const [hotels, setHotels] = useState<HotelData[]>([]);\n  const [selectedHotel, setSelectedHotel] = useState<HotelData | null>(null);\n  const [loadingHotels, setLoadingHotels] = useState(true);\n  const [hotelError, setHotelError] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const data = localStorage.getItem('currentItinerary');\n    \n    if (!data) {\n      setLocation('/');\n      return;\n    }\n    \n    try {\n      const parsed = JSON.parse(data);\n      \n      // Build TripContext from saved data\n      const context: TripContext = {\n        origin: parsed.origin || parsed.originCity || '',\n        destination: parsed.destination,\n        startDate: parsed.startDate,\n        endDate: parsed.endDate,\n        people: parsed.people,\n        aviasalesCheckoutUrl: parsed.aviasalesCheckoutUrl || parsed.aviasalesUrl || '',\n        flightLabel: parsed.flightLabel || parsed.selectedFlight?.label || `${parsed.origin || parsed.originCity || 'Italia'} → ${parsed.destination}`,\n        originCity: parsed.originCity\n      };\n      \n      // Debug log for Aviasales URL (temporary - remove after verification)\n      console.log('🔍 DEBUG Checkout - TripContext dates:', {\n        startDate: context.startDate,\n        endDate: context.endDate,\n        aviasalesCheckoutUrl: context.aviasalesCheckoutUrl\n      });\n      \n      setTripContext(context);\n      \n      if (context.destination && context.startDate && context.endDate && context.people) {\n        fetchHotels(context);\n      }\n    } catch (err) {\n      console.error('Error parsing TripContext:', err);\n      setLocation('/');\n    }\n    \n    setIsLoading(false);\n  }, []);\n\n  const fetchHotels = async (context: TripContext) => {\n    setLoadingHotels(true);\n    setHotelError(null);\n    \n    try {\n      const cityCode = getCityCode(context.destination);\n      \n      if (!cityCode) {\n        if (import.meta.env.DEV) {\n          console.warn('[HOTEL-SEARCH] Unsupported destination:', context.destination);\n        }\n        setHotelError(t('checkout.unsupportedDest', { destination: context.destination }));\n        setLoadingHotels(false);\n        return;\n      }\n      \n      if (import.meta.env.DEV) {\n        console.log('[HOTEL-SEARCH] Request:', {\n          destinationCity: context.destination,\n          derivedCityCode: cityCode,\n          checkIn: context.startDate,\n          checkOut: context.endDate,\n          guests: context.people\n        });\n      }\n      \n      const params = new URLSearchParams({\n        cityCode,\n        checkInDate: context.startDate,\n        checkOutDate: context.endDate,\n        adults: String(context.people),\n        currency: 'EUR'\n      });\n      \n      const response = await fetch(`/api/hotels/search?${params}`);\n      const result = await response.json();\n      \n      if (import.meta.env.DEV) {\n        console.log('[HOTEL-SEARCH] Response:', {\n          count: result.hotels?.length || 0,\n          top3: result.hotels?.slice(0, 3).map((h: any) => h.name) || [],\n          priceRange: result.hotels?.length ? {\n            min: Math.min(...result.hotels.map((h: any) => h.priceTotal)),\n            max: Math.max(...result.hotels.map((h: any) => h.priceTotal))\n          } : null\n        });\n      }\n      \n      if (!response.ok) {\n        throw new Error(result.error || t('checkout.hotelSearchError'));\n      }\n      \n      if (result.hotels && result.hotels.length > 0) {\n        setHotels(result.hotels.slice(0, 5));\n      } else {\n        setHotelError(t('checkout.noHotelsForDates'));\n      }\n    } catch (error: any) {\n      console.error('Hotel fetch error:', error);\n      setHotelError(t('checkout.hotelLoadError', { error: error.message }));\n    } finally {\n      setLoadingHotels(false);\n    }\n  };\n\n  const getHotelBookingUrl = (hotel: HotelData): string => {\n    const hotelName = encodeURIComponent(hotel.name);\n    const city = encodeURIComponent(tripContext?.destination || '');\n    return `https://www.booking.com/searchresults.html?ss=${hotelName}+${city}&checkin=${hotel.checkInDate}&checkout=${hotel.checkOutDate}&group_adults=${tripContext?.people || 2}`;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-red-900 flex items-center justify-center\">\n        <div className=\"text-white text-xl\">{t('common.loading')}</div>\n      </div>\n    );\n  }\n\n  // Validate required TripContext fields\n  if (!tripContext || !tripContext.destination || !tripContext.startDate || !tripContext.endDate || !tripContext.people) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-red-900\">\n        <Header />\n        <div className=\"container mx-auto px-4 py-16 max-w-2xl\">\n          <Card className=\"bg-gradient-to-br from-gray-800/90 to-gray-900/90 border-red-500/50\">\n            <CardHeader className=\"text-center\">\n              <div className=\"mx-auto mb-4 p-4 bg-red-500/20 rounded-full w-fit\">\n                <AlertCircle className=\"w-12 h-12 text-red-400\" />\n              </div>\n              <CardTitle className=\"text-2xl text-white\">{t('checkout.missingData')}</CardTitle>\n            </CardHeader>\n            <CardContent className=\"text-center\">\n              <p className=\"text-gray-300 mb-6\">\n                {t('checkout.missingDataDesc')}\n              </p>\n              <Button\n                onClick={() => setLocation('/')}\n                className=\"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-8 py-3 text-lg\"\n                data-testid=\"button-back-chatbot\"\n              >\n                {t('itinerary.backToChatbot')}\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  // Calculate trip days from dates (safe - fields validated above)\n  const tripDays = calculateTripDays(tripContext.startDate, tripContext.endDate);\n  const formattedDates = formatDateRangeIT(tripContext.startDate, tripContext.endDate);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-red-900\">\n      <Header />\n      \n      {/* Hero Header */}\n      <div className=\"relative py-12 bg-gradient-to-r from-black/50 to-red-900/50 backdrop-blur-sm border-b border-white/10\">\n        <div className=\"container mx-auto px-4 max-w-4xl\">\n          <div className=\"text-center mb-6\">\n            <h1 className=\"text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-white via-red-200 to-red-400 bg-clip-text text-transparent\">\n              {t('checkout.title')}\n            </h1>\n            <p className=\"text-white/80 text-lg\">{t('checkout.subtitle')}</p>\n          </div>\n          \n          {/* Trip Info Pills */}\n          <div className=\"flex flex-wrap justify-center gap-4 text-white/90\">\n            <div className=\"flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20\">\n              <MapPin className=\"w-5 h-5 text-red-400\" />\n              <span className=\"font-medium\" data-testid=\"text-destination\">{tripContext.destination}</span>\n            </div>\n            <div className=\"flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20\">\n              <Calendar className=\"w-5 h-5 text-red-400\" />\n              <span className=\"font-medium\" data-testid=\"text-dates\">{formattedDates}</span>\n            </div>\n            <div className=\"flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20\">\n              <Users className=\"w-5 h-5 text-red-400\" />\n              <span className=\"font-medium\" data-testid=\"text-people\">{tripContext.people} {t('common.people')}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl space-y-6\">\n        \n        {/* Flight Section - Uses aviasalesCheckoutUrl directly */}\n        <Card className=\"bg-gradient-to-br from-gray-800/90 to-gray-900/90 backdrop-blur-sm border-2 border-green-500 shadow-xl\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-3 text-white text-xl\">\n              <div className=\"p-2 bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg\">\n                <Plane className=\"w-5 h-5 text-white\" />\n              </div>\n              {t('checkout.flight')}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"pb-4\">\n              <p className=\"font-semibold text-white text-lg\" data-testid=\"text-flight-label\">\n                {tripContext.flightLabel}\n              </p>\n              <p className=\"text-sm text-white/70 mt-1\">\n                {formattedDates} • {tripContext.people} {t('common.passengers')}\n              </p>\n            </div>\n            <p className=\"text-xs text-white/50 mb-3 italic\">\n              {t('checkout.bookOnAviasales')}\n            </p>\n            \n            {tripContext.aviasalesCheckoutUrl ? (\n              <Button \n                asChild\n                className=\"w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white\"\n                data-testid=\"button-book-flight\"\n              >\n                <a \n                  href={tripContext.aviasalesCheckoutUrl} \n                  target=\"_blank\" \n                  rel=\"noopener noreferrer\"\n                >\n                  <Plane className=\"w-4 h-4 mr-2\" />\n                  {t('checkout.goToAviasales')}\n                  <ExternalLink className=\"w-4 h-4 ml-2\" />\n                </a>\n              </Button>\n            ) : (\n              <p className=\"text-yellow-400 text-sm\">{t('checkout.flightUnavailable')}</p>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Hotel Selection */}\n        <Card className=\"bg-gradient-to-br from-gray-800/90 to-gray-900/90 backdrop-blur-sm border-2 border-gray-600 shadow-xl\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-3 text-white text-xl\">\n              <div className=\"p-2 bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg\">\n                <Hotel className=\"w-5 h-5 text-white\" />\n              </div>\n              {t('checkout.selectHotel')}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {loadingHotels ? (\n              <div className=\"flex flex-col items-center justify-center py-12\">\n                <Loader2 className=\"w-10 h-10 animate-spin text-red-400 mb-4\" />\n                <p className=\"text-white/70\">{t('checkout.loadingHotels')}</p>\n              </div>\n            ) : hotelError ? (\n              <div className=\"bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-4\">\n                <div className=\"flex items-start gap-3\">\n                  <AlertCircle className=\"w-5 h-5 text-yellow-400 mt-0.5 flex-shrink-0\" />\n                  <div>\n                    <p className=\"text-yellow-200 font-medium\">{t('checkout.noHotels')}</p>\n                    <p className=\"text-yellow-200/70 text-sm mt-1\">{hotelError}</p>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {hotels.map((hotel, index) => (\n                  <div \n                    key={hotel.hotelId}\n                    className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${\n                      selectedHotel?.hotelId === hotel.hotelId\n                        ? 'border-red-500 bg-red-500/20'\n                        : 'border-white/20 bg-white/5 hover:border-red-400'\n                    }`}\n                    onClick={() => setSelectedHotel(hotel)}\n                    data-testid={`hotel-option-${index + 1}`}\n                  >\n                    <div className=\"flex justify-between items-start\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2\">\n                          <p className=\"font-semibold text-white\">{hotel.name}</p>\n                          {hotel.stars && (\n                            <span className=\"text-yellow-400 text-sm\">{'⭐'.repeat(parseInt(hotel.stars))}</span>\n                          )}\n                        </div>\n                        <p className=\"text-sm text-white/70 mt-1\">{hotel.roomDescription || t('common.standardRoom')}</p>\n                        <p className=\"text-xs text-white/50 mt-1\">\n                          {hotel.checkInDate} → {hotel.checkOutDate} | {hotel.paymentPolicy}\n                        </p>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-bold text-red-400 text-xl\">€{hotel.priceTotal}</p>\n                        <p className=\"text-xs text-white/60\">{t('common.totalStay')}</p>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {selectedHotel && (\n              <Button \n                className=\"w-full mt-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white\"\n                onClick={() => window.open(getHotelBookingUrl(selectedHotel), '_blank')}\n                data-testid=\"button-book-hotel\"\n              >\n                <ExternalLink className=\"w-4 h-4 mr-2\" />\n                {t('checkout.bookOnBooking')}\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Hotel Summary */}\n        {selectedHotel && (\n          <Card className=\"bg-gradient-to-br from-gray-800/90 to-gray-900/90 backdrop-blur-sm border-2 border-red-500 shadow-2xl shadow-red-500/20\">\n            <CardContent className=\"pt-6\">\n              <div className=\"space-y-3\">\n                <div className=\"flex justify-between items-center text-white/80\">\n                  <span>{t('checkout.hotelNights', { nights: String(tripDays) })}</span>\n                  <span className=\"font-semibold text-white\">€{selectedHotel.priceTotal}</span>\n                </div>\n              </div>\n              <p className=\"text-center text-white/50 text-xs mt-4\">\n                {t('checkout.priceNote')}\n              </p>\n            </CardContent>\n          </Card>\n        )}\n\n        <GetYourGuideCta \n          destinationCity={tripContext.destination} \n          placement=\"checkout\" \n        />\n\n        {/* Navigation */}\n        <div className=\"flex flex-col md:flex-row gap-4\">\n          <Button\n            variant=\"outline\"\n            size=\"lg\"\n            className=\"flex-1 bg-white/10 border-white/20 text-white hover:bg-white/20 backdrop-blur-sm\"\n            onClick={() => setLocation('/itinerary')}\n            data-testid=\"button-back-itinerary\"\n          >\n            {t('checkout.backToItinerary')}\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"lg\"\n            className=\"flex-1 bg-white/10 border-white/20 text-white hover:bg-white/20 backdrop-blur-sm\"\n            onClick={() => setLocation('/')}\n            data-testid=\"button-back-home\"\n          >\n            {t('checkout.backToHome')}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":16769,"size_tokens":null},"client/src/pages/SplittaBridePage.tsx":{"content":"import { SplittaBride } from '@/components/SplittaBride';\n\nexport default function SplittaBridePage() {\n  return <SplittaBride />;\n}","path":null,"size_bytes":132,"size_tokens":null},"server/routes/aviasales.ts":{"content":"// server/routes/aviasales.ts\nimport { Router } from \"express\";\nimport { searchCheapestFlights } from \"../services/aviasales\";\n\nconst router = Router();\n\nrouter.get(\"/search\", async (req, res) => {\n  try {\n    const { origin, destination, departDate, currency } = req.query;\n\n    if (!origin || !destination) {\n      return res.status(400).json({ error: \"origin and destination required\" });\n    }\n\n    const raw = await searchCheapestFlights({\n      origin: String(origin),\n      destination: String(destination),\n      departDate: departDate ? String(departDate) : undefined,\n      currency: currency ? String(currency) : \"EUR\",\n    });\n\n    // raw ha la forma { data: { BCN: { \"0\": {...}, \"1\": {...} } }, currency, success }\n    const destCode = Object.keys(raw.data)[0];\n    const offersObj = raw.data[destCode] || {};\n\n    const offers = Object.values(offersObj as any)\n      .sort((a: any, b: any) => a.price - b.price)\n      .slice(0, 3) // prendi le 3 più economiche\n      .map((o: any, idx: number) => ({\n        id: idx,\n        airline: o.airline,\n        price: o.price,\n        departureAt: o.departure_at,\n        returnAt: o.return_at,\n        flightNumber: o.flight_number,\n      }));\n\n    return res.json({\n      origin,\n      destination: destCode,\n      currency: raw.currency,\n      offers,\n    });\n  } catch (err) {\n    console.error(\"Aviasales API error\", err);\n    res.status(500).json({ error: \"Flight search failed\" });\n  }\n});\n\nexport default router;\n","path":null,"size_bytes":1478,"size_tokens":null},"server/services/aviasales.ts":{"content":"// server/services/aviasales.ts\nimport axios from \"axios\";\nimport { cityToIata, CITY_TO_IATA } from \"./cityMapping\";\n\n// Re-export for backwards compatibility\nexport { cityToIata, CITY_TO_IATA };\n\nconst API_TOKEN = process.env.AVIASALES_API_TOKEN;\nconst PARTNER_ID = process.env.AVIASALES_PARTNER_ID;\n\nif (!API_TOKEN || !PARTNER_ID) {\n  console.error(\"Missing Aviasales credentials in env variables\");\n}\n\nexport async function searchCheapestFlights(params: {\n  origin: string;       // IATA, es. \"ROM\"\n  destination: string;  // IATA, es. \"BCN\"\n  departDate?: string;  // \"2026-07-05\" (opzionale per v1/prices/cheap)\n  currency?: string;    // \"EUR\"\n}) {\n  const { origin, destination, departDate, currency = \"EUR\" } = params;\n\n  const requestParams = {\n    origin,\n    destination,\n    depart_date: departDate,\n    token: API_TOKEN,\n    currency,\n  };\n\n  console.log(\"🔍 Aviasales API request:\", {\n    url: \"https://api.travelpayouts.com/v1/prices/cheap\",\n    params: { ...requestParams, token: API_TOKEN ? \"[REDACTED]\" : \"MISSING\" }\n  });\n\n  try {\n    const res = await axios.get(\n      \"https://api.travelpayouts.com/v1/prices/cheap\",\n      { params: requestParams }\n    );\n\n    console.log(\"📦 Aviasales API response status:\", res.status);\n    console.log(\"📦 Aviasales API response data:\", JSON.stringify(res.data, null, 2));\n\n    return res.data;\n  } catch (error: any) {\n    console.error(\"❌ Aviasales API error:\", {\n      status: error.response?.status,\n      data: error.response?.data,\n      message: error.message\n    });\n    throw error;\n  }\n}\n","path":null,"size_bytes":1564,"size_tokens":null},"server/services/amadeus-hotels.ts":{"content":"// server/services/amadeus-hotels.ts\nimport axios from \"axios\";\n\ntype SearchHotelsParams = {\n  cityCode: string;      // es. \"BCN\"\n  checkInDate: string;   // es. \"2026-07-05\"\n  checkOutDate: string;  // es. \"2026-07-08\"\n  adults: number;        // 1-9\n  currency?: string;     // es. \"EUR\"\n};\n\nexport type BookingFlow = \"IN_APP\" | \"REDIRECT\";\nexport type PaymentPolicy = \"PAY_AT_HOTEL\" | \"PREPAY\" | \"DEPOSIT\" | \"UNKNOWN\";\n\nexport type HotelResult = {\n  hotelId: string;\n  name: string;\n  stars?: string;\n  latitude?: number;\n  longitude?: number;\n  priceTotal: number;\n  currency: string;\n  offerId: string;\n  bookingFlow: BookingFlow;\n  paymentPolicy: PaymentPolicy;\n  checkInDate: string;\n  checkOutDate: string;\n  roomDescription?: string;\n};\n\n// In produzione: NODE_ENV è l'unica fonte di verità per mock/debug\n// AMADEUS_ENV serve solo per selezionare le credenziali API\nconst isProd = process.env.NODE_ENV === \"production\";\nconst useAmadeusLive = process.env.AMADEUS_ENV === \"production\";\n\nconst AMADEUS_API_KEY = useAmadeusLive\n  ? process.env.AMADEUS_API_KEY_LIVE\n  : process.env.AMADEUS_API_KEY_TEST;\n\nconst AMADEUS_API_SECRET = useAmadeusLive\n  ? process.env.AMADEUS_API_SECRET_LIVE\n  : process.env.AMADEUS_API_SECRET_TEST;\n\nif (!AMADEUS_API_KEY || !AMADEUS_API_SECRET) {\n  console.error(\n    `[Amadeus Hotels] Missing credentials for ${useAmadeusLive ? \"LIVE\" : \"TEST\"} environment`\n  );\n}\n\nconst AMADEUS_BASE_URL = useAmadeusLive\n  ? \"https://api.amadeus.com\"\n  : \"https://test.api.amadeus.com\";\n\nlet tokenCache: { token: string | null; expiresAt: number } = {\n  token: null,\n  expiresAt: 0,\n};\n\nasync function getAmadeusToken(): Promise<string> {\n  // se il token è ancora valido, riusalo\n  if (tokenCache.token && tokenCache.expiresAt > Date.now() + 10_000) {\n    return tokenCache.token;\n  }\n\n  if (!AMADEUS_API_KEY || !AMADEUS_API_SECRET) {\n    throw new Error(\"Amadeus credentials are not configured\");\n  }\n\n  const body = new URLSearchParams({\n    grant_type: \"client_credentials\",\n    client_id: AMADEUS_API_KEY,\n    client_secret: AMADEUS_API_SECRET,\n  });\n\n  const resp = await axios.post(\n    `${AMADEUS_BASE_URL}/v1/security/oauth2/token`,\n    body,\n    {\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n    }\n  );\n\n  const accessToken = resp.data.access_token as string;\n  const expiresIn = resp.data.expires_in as number; // seconds\n\n  tokenCache = {\n    token: accessToken,\n    // un filo prima della scadenza reale\n    expiresAt: Date.now() + (expiresIn - 60) * 1000,\n  };\n\n  return accessToken;\n}\n\n/**\n * Flusso ufficiale:\n * 1) Hotel List API: /v1/reference-data/locations/hotels/by-city -> hotelIds\n * 2) Hotel Search API V3: /v3/shopping/hotel-offers -> prezzi/offerte\n */\nexport async function searchHotels(\n  params: SearchHotelsParams\n): Promise<HotelResult[]> {\n  const {\n    cityCode,\n    checkInDate,\n    checkOutDate,\n    adults,\n    currency = \"EUR\",\n  } = params;\n\n  const token = await getAmadeusToken();\n\n  // STEP 1: lista hotel per città (hotelIds)\n  const hotelListResp = await axios.get(\n    `${AMADEUS_BASE_URL}/v1/reference-data/locations/hotels/by-city`,\n    {\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n      params: {\n        cityCode,\n        radius: 20,\n        radiusUnit: \"KM\",\n      },\n    }\n  );\n\n  const hotelIds: string[] =\n    hotelListResp.data?.data\n      ?.map((h: any) => h.hotelId)\n      .filter((id: any) => !!id)\n      .slice(0, 30) || []; // limita per non bruciare chiamate\n\n  if (!hotelIds.length) {\n    // In produzione NON mockiamo, ritorniamo vuoto\n    if (isProd) {\n      return [];\n    }\n\n    // In sandbox possiamo restituire qualcosa di finto per testare la UI\n    return [\n      {\n        hotelId: \"MOCK1\",\n        name: `${cityCode} Test Hotel`,\n        stars: \"3\",\n        priceTotal: 100,\n        currency,\n        offerId: \"MOCK_OFFER_1\",\n        bookingFlow: \"IN_APP\" as BookingFlow,\n        paymentPolicy: \"PAY_AT_HOTEL\" as PaymentPolicy,\n        checkInDate,\n        checkOutDate,\n        roomDescription: \"Standard Double Room\",\n      },\n      {\n        hotelId: \"MOCK2\",\n        name: `${cityCode} Party Hostel`,\n        stars: \"2\",\n        priceTotal: 60,\n        currency,\n        offerId: \"MOCK_OFFER_2\",\n        bookingFlow: \"REDIRECT\" as BookingFlow,\n        paymentPolicy: \"PREPAY\" as PaymentPolicy,\n        checkInDate,\n        checkOutDate,\n        roomDescription: \"Shared Dormitory\",\n      },\n    ];\n  }\n\n  // STEP 2: offerte reali per quei hotelIds\n  const offersResp = await axios.get(\n    `${AMADEUS_BASE_URL}/v3/shopping/hotel-offers`,\n    {\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n      params: {\n        hotelIds: hotelIds.join(\",\"),\n        adults,\n        checkInDate,\n        checkOutDate,\n        currency,\n      },\n    }\n  );\n\n  const data = offersResp.data?.data || [];\n\n  const MIN_PRICE_PER_NIGHT = 10;\n  const MAX_PRICE_PER_NIGHT = 800;\n\n  const checkInDateObj = new Date(checkInDate);\n  const checkOutDateObj = new Date(checkOutDate);\n  const nights = Math.max(1, Math.ceil((checkOutDateObj.getTime() - checkInDateObj.getTime()) / (1000 * 60 * 60 * 24)));\n\n  const results: HotelResult[] = data\n    .map((item: any) => {\n      const offer = item.offers?.[0];\n      if (!offer) return null;\n\n      const paymentPolicy = determinePaymentPolicy(offer);\n      const bookingFlow: BookingFlow = paymentPolicy === \"PAY_AT_HOTEL\" ? \"IN_APP\" : \"REDIRECT\";\n\n      return {\n        hotelId: item.hotel?.hotelId ?? item.hotelId,\n        name: item.hotel?.name ?? \"Unknown hotel\",\n        stars: item.hotel?.rating,\n        latitude: item.hotel?.geoCode?.latitude,\n        longitude: item.hotel?.geoCode?.longitude,\n        priceTotal: Number(offer.price.total),\n        currency: offer.price.currency || currency,\n        offerId: offer.id,\n        bookingFlow,\n        paymentPolicy,\n        checkInDate: offer.checkInDate || checkInDate,\n        checkOutDate: offer.checkOutDate || checkOutDate,\n        roomDescription: offer.room?.description?.text || offer.room?.typeEstimated?.category,\n      } as HotelResult;\n    })\n    .filter((x: HotelResult | null) => x !== null && !Number.isNaN(x!.priceTotal) && x!.offerId);\n\n  const filteredResults = results.filter((hotel) => {\n    const pricePerNight = hotel.priceTotal / nights;\n    if (pricePerNight < MIN_PRICE_PER_NIGHT || pricePerNight > MAX_PRICE_PER_NIGHT) {\n      if (!isProd) {\n        console.log(`[HOTEL-FILTER] Excluded outlier: ${hotel.name} - €${pricePerNight.toFixed(2)}/night (total €${hotel.priceTotal} for ${nights} nights)`);\n      }\n      return false;\n    }\n    return true;\n  });\n\n  if (!isProd) {\n    console.log('[HOTEL-RESULTS]', {\n      cityCode,\n      nights,\n      totalFromAPI: results.length,\n      afterPriceFilter: filteredResults.length,\n      top3: filteredResults.slice(0, 3).map(h => ({ name: h.name, perNight: (h.priceTotal / nights).toFixed(2) })),\n      priceRangePerNight: filteredResults.length ? {\n        min: (Math.min(...filteredResults.map(h => h.priceTotal)) / nights).toFixed(2),\n        max: (Math.max(...filteredResults.map(h => h.priceTotal)) / nights).toFixed(2)\n      } : null\n    });\n  }\n\n  return filteredResults;\n}\n\n/**\n * Determina la policy di pagamento dall'offerta Amadeus\n */\nfunction determinePaymentPolicy(offer: any): PaymentPolicy {\n  const policies = offer.policies;\n  if (!policies) return \"UNKNOWN\";\n\n  // Controlla paymentType\n  const paymentType = policies.paymentType?.toLowerCase();\n  if (paymentType === \"deposit\") return \"DEPOSIT\";\n  if (paymentType === \"guarantee\") return \"PREPAY\";\n\n  // Controlla se è pay at hotel (nessun pagamento anticipato richiesto)\n  const guarantee = policies.guarantee;\n  const deposit = policies.deposit;\n  \n  // Se non ci sono requisiti di garanzia/deposito, è PAY_AT_HOTEL\n  if (!guarantee && !deposit) return \"PAY_AT_HOTEL\";\n  \n  // CORREZIONE: Se richiede carta di credito come garanzia, NON è IN_APP\n  // L'utente deve inserire la carta, quindi è REDIRECT\n  if (guarantee?.acceptedPayments?.methods?.includes(\"CREDIT_CARD\")) {\n    return \"PREPAY\"; // Richiede carta = REDIRECT\n  }\n\n  // Se c'è deposito, è DEPOSIT o PREPAY\n  if (deposit) {\n    const amount = parseFloat(deposit.amount || \"0\");\n    if (amount > 0) return \"DEPOSIT\";\n  }\n\n  return \"PREPAY\";\n}\n\n// ========== HOTEL BOOKING ==========\n\nexport type BookHotelParams = {\n  offerId: string;\n  guest: {\n    firstName: string;\n    lastName: string;\n    email: string;\n    phone?: string;\n  };\n};\n\nexport type BookingResult = {\n  success: boolean;\n  confirmationId?: string;\n  bookingId?: string;\n  status?: string;\n  hotelName?: string;\n  checkInDate?: string;\n  checkOutDate?: string;\n  totalPrice?: number;\n  currency?: string;\n  error?: string;\n};\n\n/**\n * Prenota un hotel tramite Amadeus Hotel Booking API\n * SOLO per offerte IN_APP (PAY_AT_HOTEL)\n */\nexport async function bookHotel(params: BookHotelParams): Promise<BookingResult> {\n  const { offerId, guest } = params;\n\n  // Mock booking per sandbox\n  if (!isProd && offerId.startsWith(\"MOCK_\")) {\n    return {\n      success: true,\n      confirmationId: `MOCK-CONF-${Date.now()}`,\n      bookingId: `MOCK-BOOK-${Date.now()}`,\n      status: \"CONFIRMED\",\n      hotelName: \"Mock Hotel\",\n      error: undefined,\n    };\n  }\n\n  try {\n    const token = await getAmadeusToken();\n\n    // Prima verifichiamo che l'offerta sia ancora disponibile\n    const offerCheckResp = await axios.get(\n      `${AMADEUS_BASE_URL}/v3/shopping/hotel-offers/${offerId}`,\n      {\n        headers: {\n          Authorization: `Bearer ${token}`,\n        },\n      }\n    );\n\n    const offerData = offerCheckResp.data?.data;\n    if (!offerData) {\n      return {\n        success: false,\n        error: \"Offerta non più disponibile o scaduta\",\n      };\n    }\n\n    // Verifica che sia PAY_AT_HOTEL\n    const paymentPolicy = determinePaymentPolicy(offerData.offers?.[0] || {});\n    if (paymentPolicy !== \"PAY_AT_HOTEL\") {\n      return {\n        success: false,\n        error: \"Questa offerta richiede pagamento anticipato. Usa il checkout esterno.\",\n      };\n    }\n\n    // Procedi con la prenotazione PAY_AT_HOTEL (NO carta richiesta)\n    const bookingResp = await axios.post(\n      `${AMADEUS_BASE_URL}/v2/booking/hotel-orders`,\n      {\n        data: {\n          type: \"hotel-order\",\n          guests: [\n            {\n              tid: 1,\n              title: \"MR\",\n              firstName: guest.firstName,\n              lastName: guest.lastName,\n              phone: guest.phone || \"+39000000000\",\n              email: guest.email,\n            },\n          ],\n          rooms: [\n            {\n              guestIds: [1],\n              offerId: offerId,\n            },\n          ],\n        },\n      },\n      {\n        headers: {\n          Authorization: `Bearer ${token}`,\n          \"Content-Type\": \"application/json\",\n        },\n      }\n    );\n\n    const bookingData = bookingResp.data?.data?.[0];\n    \n    if (!bookingData) {\n      return {\n        success: false,\n        error: \"Errore nella creazione della prenotazione\",\n      };\n    }\n\n    return {\n      success: true,\n      confirmationId: bookingData.associatedRecords?.[0]?.reference || bookingData.id,\n      bookingId: bookingData.id,\n      status: \"CONFIRMED\",\n      hotelName: bookingData.hotel?.name,\n      checkInDate: bookingData.hotelBookings?.[0]?.checkInDate,\n      checkOutDate: bookingData.hotelBookings?.[0]?.checkOutDate,\n      totalPrice: parseFloat(bookingData.hotelBookings?.[0]?.price?.total || \"0\"),\n      currency: bookingData.hotelBookings?.[0]?.price?.currency,\n    };\n  } catch (error: any) {\n    console.error(\"[Amadeus Booking Error]\", error.response?.status, error.response?.data);\n    \n    // Gestione errori specifici\n    const amadeusError = error.response?.data?.errors?.[0];\n    if (amadeusError) {\n      if (amadeusError.code === 38196) {\n        return { success: false, error: \"Offerta scaduta o non disponibile\" };\n      }\n      if (amadeusError.code === 36803) {\n        return { success: false, error: \"Il prezzo è cambiato. Riprova la ricerca.\" };\n      }\n      if (amadeusError.code === 38199) {\n        return { success: false, error: \"Nessuna disponibilità per queste date\" };\n      }\n      return { success: false, error: amadeusError.detail || amadeusError.title };\n    }\n\n    return {\n      success: false,\n      error: \"Errore durante la prenotazione. Riprova più tardi.\",\n    };\n  }\n}\n","path":null,"size_bytes":12440,"size_tokens":null},"server/services/cityMapping.ts":{"content":"// Unified city → IATA code mapping\n// All cities can be used as both origins and destinations\n// Organized by country for easy maintenance\n\nexport const CITY_TO_IATA: Record<string, string> = {\n  // ===== ITALY =====\n  \"roma\": \"ROM\",\n  \"rome\": \"ROM\",\n  \"fiumicino\": \"FCO\",  // Rome Fiumicino airport\n  \"ciampino\": \"CIA\",   // Rome Ciampino airport\n  \"milano\": \"MIL\",\n  \"milan\": \"MIL\",\n  \"malpensa\": \"MXP\",   // Milan Malpensa airport\n  \"linate\": \"LIN\",     // Milan Linate airport\n  \"bergamo\": \"BGY\",    // Milan Bergamo/Orio al Serio\n  \"orio al serio\": \"BGY\",\n  \"napoli\": \"NAP\",\n  \"naples\": \"NAP\",\n  \"torino\": \"TRN\",\n  \"turin\": \"TRN\",\n  \"venezia\": \"VCE\",\n  \"venice\": \"VCE\",\n  \"bologna\": \"BLQ\",\n  \"firenze\": \"FLR\",\n  \"florence\": \"FLR\",\n  \"bari\": \"BRI\",\n  \"catania\": \"CTA\",\n  \"palermo\": \"PMO\",\n  \"verona\": \"VRN\",\n  \"pisa\": \"PSA\",\n  \"genova\": \"GOA\",\n  \"genoa\": \"GOA\",\n  \"brindisi\": \"BDS\",\n  \"olbia\": \"OLB\",\n  \"cagliari\": \"CAG\",\n  \"alghero\": \"AHO\",\n\n  // ===== SPAIN =====\n  \"madrid\": \"MAD\",\n  \"barcellona\": \"BCN\",\n  \"barcelona\": \"BCN\",\n  \"ibiza\": \"IBZ\",\n  \"palma de mallorca\": \"PMI\",\n  \"palma\": \"PMI\",\n  \"mallorca\": \"PMI\",\n  \"valencia\": \"VLC\",\n  \"siviglia\": \"SVQ\",\n  \"seville\": \"SVQ\",\n  \"malaga\": \"AGP\",\n  \"bilbao\": \"BIO\",\n  \"alicante\": \"ALC\",\n  \"tenerife\": \"TFS\",\n  \"gran canaria\": \"LPA\",\n  \"las palmas\": \"LPA\",\n\n  // ===== FRANCE =====\n  \"parigi\": \"PAR\",\n  \"paris\": \"PAR\",\n  \"nizza\": \"NCE\",\n  \"nice\": \"NCE\",\n  \"lione\": \"LYS\",\n  \"lyon\": \"LYS\",\n  \"marsiglia\": \"MRS\",\n  \"marseille\": \"MRS\",\n  \"tolosa\": \"TLS\",\n  \"toulouse\": \"TLS\",\n  \"bordeaux\": \"BOD\",\n  \"nantes\": \"NTE\",\n  \"strasburgo\": \"SXB\",\n  \"strasbourg\": \"SXB\",\n\n  // ===== GERMANY =====\n  \"berlino\": \"BER\",\n  \"berlin\": \"BER\",\n  \"monaco di baviera\": \"MUC\",\n  \"munich\": \"MUC\",\n  \"munchen\": \"MUC\",\n  \"francoforte\": \"FRA\",\n  \"frankfurt\": \"FRA\",\n  \"amburgo\": \"HAM\",\n  \"hamburg\": \"HAM\",\n  \"dusseldorf\": \"DUS\",\n  \"düsseldorf\": \"DUS\",\n  \"colonia\": \"CGN\",\n  \"cologne\": \"CGN\",\n  \"koln\": \"CGN\",\n  \"stoccarda\": \"STR\",\n  \"stuttgart\": \"STR\",\n  \"hannover\": \"HAJ\",\n  \"hanover\": \"HAJ\",\n  \"norimberga\": \"NUE\",\n  \"nuremberg\": \"NUE\",\n\n  // ===== UNITED KINGDOM =====\n  \"londra\": \"LON\",\n  \"london\": \"LON\",\n  \"manchester\": \"MAN\",\n  \"birmingham\": \"BHX\",\n  \"edimburgo\": \"EDI\",\n  \"edinburgh\": \"EDI\",\n  \"glasgow\": \"GLA\",\n  \"bristol\": \"BRS\",\n  \"liverpool\": \"LPL\",\n  \"newcastle\": \"NCL\",\n  \"belfast\": \"BFS\",\n  \"leeds\": \"LBA\",\n\n  // ===== NETHERLANDS =====\n  \"amsterdam\": \"AMS\",\n  \"rotterdam\": \"RTM\",\n  \"eindhoven\": \"EIN\",\n\n  // ===== BELGIUM =====\n  \"bruxelles\": \"BRU\",\n  \"brussels\": \"BRU\",\n  \"anversa\": \"ANR\",\n  \"antwerp\": \"ANR\",\n\n  // ===== PORTUGAL =====\n  \"lisbona\": \"LIS\",\n  \"lisbon\": \"LIS\",\n  \"lisboa\": \"LIS\",\n  \"porto\": \"OPO\",\n  \"faro\": \"FAO\",\n\n  // ===== POLAND =====\n  \"varsavia\": \"WAW\",\n  \"warsaw\": \"WAW\",\n  \"cracovia\": \"KRK\",\n  \"krakow\": \"KRK\",\n  \"cracow\": \"KRK\",\n  \"danzica\": \"GDN\",\n  \"gdansk\": \"GDN\",\n  \"breslavia\": \"WRO\",\n  \"wroclaw\": \"WRO\",\n  \"poznan\": \"POZ\",\n\n  // ===== CZECH REPUBLIC =====\n  \"praga\": \"PRG\",\n  \"prague\": \"PRG\",\n  \"brno\": \"BRQ\",\n\n  // ===== HUNGARY =====\n  \"budapest\": \"BUD\",\n\n  // ===== AUSTRIA =====\n  \"vienna\": \"VIE\",\n  \"wien\": \"VIE\",\n  \"salisburgo\": \"SZG\",\n  \"salzburg\": \"SZG\",\n  \"innsbruck\": \"INN\",\n\n  // ===== SWITZERLAND =====\n  \"zurigo\": \"ZRH\",\n  \"zurich\": \"ZRH\",\n  \"zürich\": \"ZRH\",\n  \"ginevra\": \"GVA\",\n  \"geneva\": \"GVA\",\n  \"basilea\": \"BSL\",\n  \"basel\": \"BSL\",\n\n  // ===== IRELAND =====\n  \"dublino\": \"DUB\",\n  \"dublin\": \"DUB\",\n  \"cork\": \"ORK\",\n\n  // ===== SCANDINAVIA =====\n  \"copenaghen\": \"CPH\",\n  \"copenhagen\": \"CPH\",\n  \"stoccolma\": \"ARN\",\n  \"stockholm\": \"ARN\",\n  \"oslo\": \"OSL\",\n  \"helsinki\": \"HEL\",\n  \"goteborg\": \"GOT\",\n  \"gothenburg\": \"GOT\",\n  \"malmo\": \"MMX\",\n\n  // ===== GREECE =====\n  \"atene\": \"ATH\",\n  \"athens\": \"ATH\",\n  \"salonicco\": \"SKG\",\n  \"thessaloniki\": \"SKG\",\n  \"santorini\": \"JTR\",\n  \"mykonos\": \"JMK\",\n  \"creta\": \"HER\",\n  \"crete\": \"HER\",\n  \"heraklion\": \"HER\",\n  \"rodi\": \"RHO\",\n  \"rhodes\": \"RHO\",\n  \"corfù\": \"CFU\",\n  \"corfu\": \"CFU\",\n\n  // ===== CROATIA =====\n  \"zagabria\": \"ZAG\",\n  \"zagreb\": \"ZAG\",\n  \"spalato\": \"SPU\",\n  \"split\": \"SPU\",\n  \"dubrovnik\": \"DBV\",\n\n  // ===== OTHER EUROPEAN =====\n  \"bucarest\": \"OTP\",\n  \"bucharest\": \"OTP\",\n  \"sofia\": \"SOF\",\n  \"belgrado\": \"BEG\",\n  \"belgrade\": \"BEG\",\n  \"lubiana\": \"LJU\",\n  \"ljubljana\": \"LJU\",\n  \"bratislava\": \"BTS\",\n  \"tallin\": \"TLL\",\n  \"tallinn\": \"TLL\",\n  \"riga\": \"RIX\",\n  \"vilnius\": \"VNO\",\n  \"malta\": \"MLA\",\n  \"la valletta\": \"MLA\",\n  \"valletta\": \"MLA\",\n  \"reykjavik\": \"KEF\",\n  \"cipro\": \"LCA\",\n  \"cyprus\": \"LCA\",\n  \"larnaca\": \"LCA\"\n};\n\n// IATA → city name mapping (for display purposes)\nexport const IATA_TO_CITY: Record<string, string> = {\n  // Italy\n  \"ROM\": \"Roma\",\n  \"FCO\": \"Roma Fiumicino\",\n  \"CIA\": \"Roma Ciampino\",\n  \"MIL\": \"Milano\",\n  \"MXP\": \"Milano Malpensa\",\n  \"LIN\": \"Milano Linate\",\n  \"BGY\": \"Bergamo\",\n  \"NAP\": \"Napoli\",\n  \"TRN\": \"Torino\",\n  \"VCE\": \"Venezia\",\n  \"BLQ\": \"Bologna\",\n  \"FLR\": \"Firenze\",\n  \"BRI\": \"Bari\",\n  \"CTA\": \"Catania\",\n  \"PMO\": \"Palermo\",\n  \"VRN\": \"Verona\",\n  \"PSA\": \"Pisa\",\n  \"GOA\": \"Genova\",\n  \"BDS\": \"Brindisi\",\n  \"OLB\": \"Olbia\",\n  \"CAG\": \"Cagliari\",\n  \"AHO\": \"Alghero\",\n\n  // Spain\n  \"MAD\": \"Madrid\",\n  \"BCN\": \"Barcelona\",\n  \"IBZ\": \"Ibiza\",\n  \"PMI\": \"Palma de Mallorca\",\n  \"VLC\": \"Valencia\",\n  \"SVQ\": \"Seville\",\n  \"AGP\": \"Malaga\",\n  \"BIO\": \"Bilbao\",\n  \"ALC\": \"Alicante\",\n  \"TFS\": \"Tenerife\",\n  \"LPA\": \"Gran Canaria\",\n\n  // France\n  \"PAR\": \"Paris\",\n  \"NCE\": \"Nice\",\n  \"LYS\": \"Lyon\",\n  \"MRS\": \"Marseille\",\n  \"TLS\": \"Toulouse\",\n  \"BOD\": \"Bordeaux\",\n  \"NTE\": \"Nantes\",\n  \"SXB\": \"Strasbourg\",\n\n  // Germany\n  \"BER\": \"Berlin\",\n  \"MUC\": \"Munich\",\n  \"FRA\": \"Frankfurt\",\n  \"HAM\": \"Hamburg\",\n  \"DUS\": \"Düsseldorf\",\n  \"CGN\": \"Cologne\",\n  \"STR\": \"Stuttgart\",\n  \"HAJ\": \"Hanover\",\n  \"NUE\": \"Nuremberg\",\n\n  // United Kingdom\n  \"LON\": \"London\",\n  \"MAN\": \"Manchester\",\n  \"BHX\": \"Birmingham\",\n  \"EDI\": \"Edinburgh\",\n  \"GLA\": \"Glasgow\",\n  \"BRS\": \"Bristol\",\n  \"LPL\": \"Liverpool\",\n  \"NCL\": \"Newcastle\",\n  \"BFS\": \"Belfast\",\n  \"LBA\": \"Leeds\",\n\n  // Netherlands\n  \"AMS\": \"Amsterdam\",\n  \"RTM\": \"Rotterdam\",\n  \"EIN\": \"Eindhoven\",\n\n  // Belgium\n  \"BRU\": \"Brussels\",\n  \"ANR\": \"Antwerp\",\n\n  // Portugal\n  \"LIS\": \"Lisbon\",\n  \"OPO\": \"Porto\",\n  \"FAO\": \"Faro\",\n\n  // Poland\n  \"WAW\": \"Warsaw\",\n  \"KRK\": \"Krakow\",\n  \"GDN\": \"Gdansk\",\n  \"WRO\": \"Wroclaw\",\n  \"POZ\": \"Poznan\",\n\n  // Czech Republic\n  \"PRG\": \"Prague\",\n  \"BRQ\": \"Brno\",\n\n  // Hungary\n  \"BUD\": \"Budapest\",\n\n  // Austria\n  \"VIE\": \"Vienna\",\n  \"SZG\": \"Salzburg\",\n  \"INN\": \"Innsbruck\",\n\n  // Switzerland\n  \"ZRH\": \"Zurich\",\n  \"GVA\": \"Geneva\",\n  \"BSL\": \"Basel\",\n\n  // Ireland\n  \"DUB\": \"Dublin\",\n  \"ORK\": \"Cork\",\n\n  // Scandinavia\n  \"CPH\": \"Copenhagen\",\n  \"ARN\": \"Stockholm\",\n  \"OSL\": \"Oslo\",\n  \"HEL\": \"Helsinki\",\n  \"GOT\": \"Gothenburg\",\n  \"MMX\": \"Malmo\",\n\n  // Greece\n  \"ATH\": \"Athens\",\n  \"SKG\": \"Thessaloniki\",\n  \"JTR\": \"Santorini\",\n  \"JMK\": \"Mykonos\",\n  \"HER\": \"Heraklion\",\n  \"RHO\": \"Rhodes\",\n  \"CFU\": \"Corfu\",\n\n  // Croatia\n  \"ZAG\": \"Zagreb\",\n  \"SPU\": \"Split\",\n  \"DBV\": \"Dubrovnik\",\n\n  // Other European\n  \"OTP\": \"Bucharest\",\n  \"SOF\": \"Sofia\",\n  \"BEG\": \"Belgrade\",\n  \"LJU\": \"Ljubljana\",\n  \"BTS\": \"Bratislava\",\n  \"TLL\": \"Tallinn\",\n  \"RIX\": \"Riga\",\n  \"VNO\": \"Vilnius\",\n  \"MLA\": \"Malta\",\n  \"KEF\": \"Reykjavik\",\n  \"LCA\": \"Larnaca\"\n};\n\nexport function cityToIata(cityName: string | undefined | null): string | null {\n  if (!cityName) return null;\n  const normalized = cityName.toLowerCase().trim();\n  return CITY_TO_IATA[normalized] || null;\n}\n\nexport function iataToCity(iataCode: string | undefined | null): string {\n  if (!iataCode) return \"Unknown\";\n  return IATA_TO_CITY[iataCode.toUpperCase()] || iataCode;\n}\n\n// Get list of all available cities for autocomplete/dropdown\nexport function getAllCities(): string[] {\n  return Object.values(IATA_TO_CITY).sort();\n}\n\n// Get list of all IATA codes\nexport function getAllIataCodes(): string[] {\n  return Object.keys(IATA_TO_CITY);\n}\n","path":null,"size_bytes":7758,"size_tokens":null},"server/routes/amadeus-debug.ts":{"content":"import express from \"express\";\nimport axios from \"axios\";\n\nconst router = express.Router();\n\nconst isProd =\n  process.env.AMADEUS_ENV === \"production\" ||\n  process.env.NODE_ENV === \"production\";\n\nconst BASE_URL = isProd\n  ? \"https://api.amadeus.com\"\n  : \"https://test.api.amadeus.com\";\n\nrouter.get(\"/api/amadeus/debug\", async (req, res) => {\n  // Block access in production for security\n  if (process.env.NODE_ENV === \"production\") {\n    return res.status(403).json({ error: \"Debug endpoint disabled in production\" });\n  }\n  \n  try {\n    const key = isProd\n      ? process.env.AMADEUS_API_KEY_LIVE\n      : process.env.AMADEUS_API_KEY_TEST;\n\n    const secret = isProd\n      ? process.env.AMADEUS_API_SECRET_LIVE\n      : process.env.AMADEUS_API_SECRET_TEST;\n\n    if (!key || !secret) {\n      return res.status(500).json({\n        ok: false,\n        error: \"Missing Amadeus credentials\",\n        env: process.env.AMADEUS_ENV,\n      });\n    }\n\n    const body = new URLSearchParams({\n      grant_type: \"client_credentials\",\n      client_id: key,\n      client_secret: secret,\n    });\n\n    const tokenResp = await axios.post(\n      `${BASE_URL}/v1/security/oauth2/token`,\n      body,\n      { headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" } }\n    );\n\n    res.json({\n      ok: true,\n      environment: isProd ? \"LIVE\" : \"TEST\",\n      baseUrl: BASE_URL,\n      tokenExpiresIn: tokenResp.data.expires_in,\n    });\n  } catch (err: any) {\n    res.status(500).json({\n      ok: false,\n      message: \"Amadeus auth failed\",\n      status: err.response?.status,\n      data: err.response?.data,\n    });\n  }\n});\n\nexport default router;\n","path":null,"size_bytes":1631,"size_tokens":null},"attached_assets/content-1764067287572.md":{"content":"![Namecheap banner](https://img.sedoparking.com/templates/images/hero_nc.svg)\n\nThis domain has recently been registered with Namecheap.\n\n\n# context.flights\n\nThis webpage was generated by the domain owner using [Sedo Domain Parking](https://www.sedo.com/services/parking.php3). Disclaimer: Sedo maintains no relationship with third party advertisers. Reference to any specific service or trade mark is not controlled by Sedo nor does it constitute or imply its association, endorsement or recommendation.\n\n\n[Privacy Policy](https://www.context.flights/#)","path":null,"size_bytes":553,"size_tokens":null},"shared/dateUtils.test.ts":{"content":"import { describe, it, expect } from 'vitest';\nimport {\n  normalizeTripDate,\n  normalizeFutureTripDate,\n  calculateTripDays,\n  isValidDateRange,\n  formatDateIT,\n  extractDateOnly,\n  formatFlightDateTime,\n  formatDateRangeIT,\n} from './dateUtils';\n\ndescribe('normalizeTripDate', () => {\n  describe('ISO format (YYYY-MM-DD)', () => {\n    it('returns valid ISO dates unchanged', () => {\n      expect(normalizeTripDate('2026-01-20')).toBe('2026-01-20');\n      expect(normalizeTripDate('2026-12-31')).toBe('2026-12-31');\n    });\n\n    it('rejects invalid ISO dates', () => {\n      expect(normalizeTripDate('2026-13-01')).toBeNull(); // invalid month\n      expect(normalizeTripDate('2026-01-32')).toBeNull(); // invalid day\n      expect(normalizeTripDate('2026-02-30')).toBeNull(); // Feb 30 doesn't exist\n    });\n\n    it('handles leap years correctly', () => {\n      expect(normalizeTripDate('2024-02-29')).toBe('2024-02-29'); // leap year\n      expect(normalizeTripDate('2025-02-29')).toBeNull(); // not a leap year\n      expect(normalizeTripDate('2028-02-29')).toBe('2028-02-29'); // leap year\n    });\n  });\n\n  describe('European format (DD/MM/YYYY or DD-MM-YYYY)', () => {\n    it('converts DD/MM/YYYY to ISO format', () => {\n      expect(normalizeTripDate('20/01/2026')).toBe('2026-01-20');\n      expect(normalizeTripDate('31/12/2026')).toBe('2026-12-31');\n      expect(normalizeTripDate('1/1/2026')).toBe('2026-01-01');\n    });\n\n    it('converts DD-MM-YYYY to ISO format', () => {\n      expect(normalizeTripDate('20-01-2026')).toBe('2026-01-20');\n      expect(normalizeTripDate('31-12-2026')).toBe('2026-12-31');\n    });\n\n    it('rejects invalid European format dates', () => {\n      expect(normalizeTripDate('32/01/2026')).toBeNull(); // invalid day\n      expect(normalizeTripDate('01/13/2026')).toBeNull(); // invalid month\n      expect(normalizeTripDate('29/02/2025')).toBeNull(); // not a leap year\n    });\n  });\n\n  describe('short format (DD/MM or DD-MM)', () => {\n    it('infers year for short format dates', () => {\n      const result = normalizeTripDate('15/06');\n      expect(result).toMatch(/^\\d{4}-06-15$/);\n    });\n\n    it('converts DD-MM format', () => {\n      const result = normalizeTripDate('15-06');\n      expect(result).toMatch(/^\\d{4}-06-15$/);\n    });\n  });\n\n  describe('edge cases', () => {\n    it('returns null for empty/invalid input', () => {\n      expect(normalizeTripDate('')).toBeNull();\n      expect(normalizeTripDate('invalid')).toBeNull();\n      expect(normalizeTripDate('abc/def/ghij')).toBeNull();\n    });\n\n    it('handles whitespace', () => {\n      expect(normalizeTripDate('  2026-01-20  ')).toBe('2026-01-20');\n      expect(normalizeTripDate('  20/01/2026  ')).toBe('2026-01-20');\n    });\n\n    it('rejects years outside valid range', () => {\n      expect(normalizeTripDate('2023-01-20')).toBeNull(); // too old\n      expect(normalizeTripDate('2101-01-20')).toBeNull(); // too far future\n    });\n  });\n});\n\ndescribe('normalizeFutureTripDate', () => {\n  it('returns future dates unchanged', () => {\n    expect(normalizeFutureTripDate('2099-12-31')).toBe('2099-12-31');\n  });\n\n  it('returns null for invalid dates', () => {\n    expect(normalizeFutureTripDate('invalid')).toBeNull();\n    expect(normalizeFutureTripDate('')).toBeNull();\n  });\n});\n\ndescribe('calculateTripDays', () => {\n  it('calculates days between dates correctly', () => {\n    expect(calculateTripDays('2026-01-20', '2026-01-22')).toBe(2);\n    expect(calculateTripDays('2026-01-01', '2026-01-31')).toBe(30);\n    expect(calculateTripDays('2026-01-01', '2026-01-01')).toBe(0);\n  });\n\n  it('handles month boundaries', () => {\n    expect(calculateTripDays('2026-01-31', '2026-02-01')).toBe(1);\n    expect(calculateTripDays('2026-03-31', '2026-04-02')).toBe(2);\n  });\n\n  it('handles year boundaries', () => {\n    expect(calculateTripDays('2026-12-31', '2027-01-01')).toBe(1);\n    expect(calculateTripDays('2026-12-25', '2027-01-05')).toBe(11);\n  });\n\n  it('handles leap years', () => {\n    expect(calculateTripDays('2024-02-28', '2024-03-01')).toBe(2); // leap year\n    expect(calculateTripDays('2025-02-28', '2025-03-01')).toBe(1); // not a leap year\n  });\n\n  it('returns 0 for invalid dates', () => {\n    expect(calculateTripDays('invalid', '2026-01-22')).toBe(0);\n    expect(calculateTripDays('2026-01-20', 'invalid')).toBe(0);\n  });\n\n  it('handles negative durations (returns 0)', () => {\n    expect(calculateTripDays('2026-01-22', '2026-01-20')).toBe(0);\n  });\n});\n\ndescribe('isValidDateRange', () => {\n  it('returns true when end date is after start date', () => {\n    expect(isValidDateRange('2026-01-20', '2026-01-22')).toBe(true);\n    expect(isValidDateRange('2026-01-01', '2026-12-31')).toBe(true);\n  });\n\n  it('returns false when end date is before or equal to start date', () => {\n    expect(isValidDateRange('2026-01-22', '2026-01-20')).toBe(false);\n    expect(isValidDateRange('2026-01-20', '2026-01-20')).toBe(false);\n  });\n\n  it('returns false for invalid dates', () => {\n    expect(isValidDateRange('invalid', '2026-01-22')).toBe(false);\n    expect(isValidDateRange('2026-01-20', 'invalid')).toBe(false);\n  });\n});\n\ndescribe('formatDateIT', () => {\n  it('converts ISO to Italian format', () => {\n    expect(formatDateIT('2026-01-20')).toBe('20/01/2026');\n    expect(formatDateIT('2026-12-31')).toBe('31/12/2026');\n    expect(formatDateIT('2026-05-05')).toBe('05/05/2026');\n  });\n\n  it('returns input unchanged for invalid format', () => {\n    expect(formatDateIT('invalid')).toBe('invalid');\n    expect(formatDateIT('20/01/2026')).toBe('20/01/2026'); // already Italian format\n  });\n});\n\ndescribe('extractDateOnly', () => {\n  it('extracts date from ISO datetime strings', () => {\n    expect(extractDateOnly('2026-01-20T10:30:00')).toBe('2026-01-20');\n    expect(extractDateOnly('2026-01-20T10:30:00+01:00')).toBe('2026-01-20');\n    expect(extractDateOnly('2026-01-20T00:00:00Z')).toBe('2026-01-20');\n  });\n\n  it('handles date-only strings', () => {\n    expect(extractDateOnly('2026-01-20')).toBe('2026-01-20');\n  });\n\n  it('returns empty string for empty input', () => {\n    expect(extractDateOnly('')).toBe('');\n  });\n});\n\ndescribe('formatFlightDateTime', () => {\n  it('formats ISO datetime for display', () => {\n    expect(formatFlightDateTime('2026-01-20T10:30:00')).toBe('20/01/2026 10:30');\n    expect(formatFlightDateTime('2026-01-20T10:30:00+01:00')).toBe('20/01/2026 10:30');\n    expect(formatFlightDateTime('2026-12-31T23:59:00')).toBe('31/12/2026 23:59');\n  });\n\n  it('returns empty string for empty input', () => {\n    expect(formatFlightDateTime('')).toBe('');\n  });\n});\n\ndescribe('formatDateRangeIT', () => {\n  it('formats date range within same month', () => {\n    expect(formatDateRangeIT('2026-01-10', '2026-01-15')).toBe('10-15 Gennaio 2026');\n    expect(formatDateRangeIT('2026-06-01', '2026-06-30')).toBe('1-30 Giugno 2026');\n  });\n\n  it('formats date range across different months', () => {\n    expect(formatDateRangeIT('2026-01-28', '2026-02-05')).toBe('28 Gennaio - 5 Febbraio 2026');\n    expect(formatDateRangeIT('2026-12-28', '2027-01-03')).toBe('28 Dicembre - 3 Gennaio 2026');\n  });\n\n  it('returns empty string for empty input', () => {\n    expect(formatDateRangeIT('', '')).toBe('');\n    expect(formatDateRangeIT('2026-01-10', '')).toBe('');\n    expect(formatDateRangeIT('', '2026-01-15')).toBe('');\n  });\n\n  it('uses correct Italian month names', () => {\n    expect(formatDateRangeIT('2026-01-01', '2026-01-02')).toContain('Gennaio');\n    expect(formatDateRangeIT('2026-02-01', '2026-02-02')).toContain('Febbraio');\n    expect(formatDateRangeIT('2026-03-01', '2026-03-02')).toContain('Marzo');\n    expect(formatDateRangeIT('2026-04-01', '2026-04-02')).toContain('Aprile');\n    expect(formatDateRangeIT('2026-05-01', '2026-05-02')).toContain('Maggio');\n    expect(formatDateRangeIT('2026-06-01', '2026-06-02')).toContain('Giugno');\n    expect(formatDateRangeIT('2026-07-01', '2026-07-02')).toContain('Luglio');\n    expect(formatDateRangeIT('2026-08-01', '2026-08-02')).toContain('Agosto');\n    expect(formatDateRangeIT('2026-09-01', '2026-09-02')).toContain('Settembre');\n    expect(formatDateRangeIT('2026-10-01', '2026-10-02')).toContain('Ottobre');\n    expect(formatDateRangeIT('2026-11-01', '2026-11-02')).toContain('Novembre');\n    expect(formatDateRangeIT('2026-12-01', '2026-12-02')).toContain('Dicembre');\n  });\n});\n","path":null,"size_bytes":8360,"size_tokens":null},"client/src/lib/aviasales.ts":{"content":"/**\n * Aviasales URL Builder - Single source of truth for generating Aviasales booking links\n * NEVER uses Date() constructor to avoid timezone issues\n * All dates must be in YYYY-MM-DD format\n */\n\nexport interface AviasalesUrlParams {\n  originIata: string;\n  destinationIata: string;\n  departDate: string; // YYYY-MM-DD\n  returnDate?: string; // YYYY-MM-DD (optional for one-way)\n  adults?: number;\n  currency?: string;\n  locale?: string;\n}\n\nconst AVIASALES_PARTNER_ID = 'byebi';\n\n/**\n * Validates that a date string is in YYYY-MM-DD format\n */\nfunction isValidDateFormat(dateStr: string): boolean {\n  if (!dateStr || typeof dateStr !== 'string') return false;\n  const regex = /^\\d{4}-\\d{2}-\\d{2}$/;\n  return regex.test(dateStr);\n}\n\n/**\n * Extracts day and month from YYYY-MM-DD string\n * Returns { day: \"DD\", month: \"MM\" } or null if invalid\n */\nfunction extractDayMonth(dateStr: string): { day: string; month: string } | null {\n  if (!isValidDateFormat(dateStr)) {\n    console.warn(`⚠️ Invalid date format for Aviasales URL: ${dateStr}`);\n    return null;\n  }\n  \n  const parts = dateStr.split('-');\n  return {\n    month: parts[1], // Already \"MM\"\n    day: parts[2]    // Already \"DD\"\n  };\n}\n\n/**\n * Builds Aviasales search URL with correct date formatting\n * Format: https://www.aviasales.com/search/{origin}{depDay}{depMonth}{dest}{retDay}{retMonth}{adults}\n * \n * @example\n * buildAviasalesUrl({\n *   originIata: 'FCO',\n *   destinationIata: 'BCN',\n *   departDate: '2025-12-19',\n *   returnDate: '2025-12-22',\n *   adults: 4\n * })\n * // Returns: https://www.aviasales.com/search/FCO1912BCN22124?marker=byebi\n */\nexport function buildAviasalesUrl(params: AviasalesUrlParams): string | null {\n  const {\n    originIata,\n    destinationIata,\n    departDate,\n    returnDate,\n    adults = 1,\n  } = params;\n\n  console.log('🔗 Building Aviasales URL with params:', {\n    originIata,\n    destinationIata,\n    departDate,\n    returnDate,\n    adults\n  });\n\n  if (!originIata || !destinationIata) {\n    console.warn('⚠️ Missing origin or destination IATA code');\n    return null;\n  }\n\n  const depParts = extractDayMonth(departDate);\n  if (!depParts) {\n    console.warn(`⚠️ Cannot build Aviasales URL: invalid departDate \"${departDate}\"`);\n    return null;\n  }\n\n  let searchPath = `${originIata.toUpperCase()}${depParts.day}${depParts.month}${destinationIata.toUpperCase()}`;\n\n  if (returnDate) {\n    const retParts = extractDayMonth(returnDate);\n    if (retParts) {\n      searchPath += `${retParts.day}${retParts.month}`;\n    }\n  }\n\n  searchPath += adults.toString();\n\n  const url = `https://www.aviasales.com/search/${searchPath}?marker=${AVIASALES_PARTNER_ID}`;\n  \n  console.log('✅ Built Aviasales URL:', url);\n  return url;\n}\n\n/**\n * City to IATA code mapping (synced with server/services/cityMapping.ts)\n * This is a subset for frontend use - the server has the authoritative mapping\n */\nconst cityToIataMap: Record<string, string> = {\n  // ===== ITALY =====\n  \"roma\": \"ROM\",\n  \"rome\": \"ROM\",\n  \"milano\": \"MIL\",\n  \"milan\": \"MIL\",\n  \"malpensa\": \"MXP\",  // Milan Malpensa airport\n  \"linate\": \"LIN\",    // Milan Linate airport\n  \"fiumicino\": \"FCO\", // Rome Fiumicino airport\n  \"napoli\": \"NAP\",\n  \"naples\": \"NAP\",\n  \"torino\": \"TRN\",\n  \"turin\": \"TRN\",\n  \"venezia\": \"VCE\",\n  \"venice\": \"VCE\",\n  \"bologna\": \"BLQ\",\n  \"firenze\": \"FLR\",\n  \"florence\": \"FLR\",\n  \"bari\": \"BRI\",\n  \"catania\": \"CTA\",\n  \"palermo\": \"PMO\",\n  \"verona\": \"VRN\",\n  \"pisa\": \"PSA\",\n  \"bergamo\": \"BGY\",\n  \"genova\": \"GOA\",\n  \"genoa\": \"GOA\",\n  \"brindisi\": \"BDS\",\n  \"olbia\": \"OLB\",\n  \"cagliari\": \"CAG\",\n  \"alghero\": \"AHO\",\n  \"trieste\": \"TRS\",\n\n  // ===== SPAIN =====\n  \"madrid\": \"MAD\",\n  \"barcellona\": \"BCN\",\n  \"barcelona\": \"BCN\",\n  \"ibiza\": \"IBZ\",\n  \"palma de mallorca\": \"PMI\",\n  \"palma\": \"PMI\",\n  \"mallorca\": \"PMI\",\n  \"valencia\": \"VLC\",\n  \"siviglia\": \"SVQ\",\n  \"seville\": \"SVQ\",\n  \"malaga\": \"AGP\",\n  \"bilbao\": \"BIO\",\n  \"alicante\": \"ALC\",\n  \"tenerife\": \"TFS\",\n\n  // ===== FRANCE =====\n  \"parigi\": \"PAR\",\n  \"paris\": \"PAR\",\n  \"nizza\": \"NCE\",\n  \"nice\": \"NCE\",\n  \"lione\": \"LYS\",\n  \"lyon\": \"LYS\",\n  \"marsiglia\": \"MRS\",\n  \"marseille\": \"MRS\",\n\n  // ===== GERMANY =====\n  \"berlino\": \"BER\",\n  \"berlin\": \"BER\",\n  \"monaco di baviera\": \"MUC\",\n  \"munich\": \"MUC\",\n  \"munchen\": \"MUC\",\n  \"francoforte\": \"FRA\",\n  \"frankfurt\": \"FRA\",\n  \"amburgo\": \"HAM\",\n  \"hamburg\": \"HAM\",\n\n  // ===== UNITED KINGDOM =====\n  \"londra\": \"LON\",\n  \"london\": \"LON\",\n  \"manchester\": \"MAN\",\n  \"edimburgo\": \"EDI\",\n  \"edinburgh\": \"EDI\",\n\n  // ===== NETHERLANDS =====\n  \"amsterdam\": \"AMS\",\n\n  // ===== PORTUGAL =====\n  \"lisbona\": \"LIS\",\n  \"lisbon\": \"LIS\",\n  \"lisboa\": \"LIS\",\n  \"porto\": \"OPO\",\n\n  // ===== POLAND =====\n  \"varsavia\": \"WAW\",\n  \"warsaw\": \"WAW\",\n  \"cracovia\": \"KRK\",\n  \"krakow\": \"KRK\",\n  \"cracow\": \"KRK\",\n\n  // ===== CZECH REPUBLIC =====\n  \"praga\": \"PRG\",\n  \"prague\": \"PRG\",\n\n  // ===== HUNGARY =====\n  \"budapest\": \"BUD\",\n\n  // ===== AUSTRIA =====\n  \"vienna\": \"VIE\",\n  \"wien\": \"VIE\",\n\n  // ===== SWITZERLAND =====\n  \"zurigo\": \"ZRH\",\n  \"zurich\": \"ZRH\",\n  \"ginevra\": \"GVA\",\n  \"geneva\": \"GVA\",\n\n  // ===== IRELAND =====\n  \"dublino\": \"DUB\",\n  \"dublin\": \"DUB\",\n\n  // ===== SCANDINAVIA =====\n  \"copenaghen\": \"CPH\",\n  \"copenhagen\": \"CPH\",\n  \"stoccolma\": \"ARN\",\n  \"stockholm\": \"ARN\",\n\n  // ===== GREECE =====\n  \"atene\": \"ATH\",\n  \"athens\": \"ATH\",\n  \"santorini\": \"JTR\",\n  \"mykonos\": \"JMK\",\n\n  // ===== CROATIA =====\n  \"dubrovnik\": \"DBV\",\n  \"spalato\": \"SPU\",\n  \"split\": \"SPU\",\n};\n\n/**\n * Extract IATA code from city string\n * Handles formats like \"Malpensa (MXP)\", \"Milano\", \"MXP\", etc.\n */\nexport function getCityIata(city: string): string | null {\n  if (!city) return null;\n  \n  // Check if the string contains an IATA code in parentheses, e.g., \"Malpensa (MXP)\"\n  const parenMatch = city.match(/\\(([A-Z]{3})\\)/);\n  if (parenMatch) {\n    return parenMatch[1];\n  }\n  \n  // Check if it's already a 3-letter IATA code\n  if (/^[A-Z]{3}$/.test(city.trim())) {\n    return city.trim();\n  }\n  \n  // Normalize and look up in mapping\n  const normalized = city.toLowerCase().trim();\n  if (cityToIataMap[normalized]) {\n    return cityToIataMap[normalized];\n  }\n  \n  // Try removing parenthetical content and look up again\n  const withoutParens = city.replace(/\\s*\\([^)]*\\)\\s*/g, '').toLowerCase().trim();\n  if (cityToIataMap[withoutParens]) {\n    return cityToIataMap[withoutParens];\n  }\n  \n  console.warn(`⚠️ No IATA mapping found for \"${city}\"`);\n  return null;\n}\n","path":null,"size_bytes":6385,"size_tokens":null},"shared/dateUtils.ts":{"content":"/**\n * Date utilities for trip dates - NO timezone conversions\n * Treats dates as \"date-only\" strings without time or timezone\n */\n\n/**\n * Gets current year/month/day without timezone issues\n */\nfunction getCurrentDateParts(): { year: number; month: number; day: number } {\n  const now = new Date();\n  return {\n    year: now.getFullYear(),\n    month: now.getMonth() + 1,\n    day: now.getDate()\n  };\n}\n\n/**\n * Determines the appropriate year for a given month/day\n * If the date has already passed this year, use next year\n */\nfunction inferFutureYear(month: number, day: number): number {\n  const current = getCurrentDateParts();\n  \n  // If month/day is in the past this year, use next year\n  if (month < current.month || (month === current.month && day < current.day)) {\n    return current.year + 1;\n  }\n  return current.year;\n}\n\n/**\n * Normalizes a date input to YYYY-MM-DD format\n * Accepts: \"YYYY-MM-DD\", \"DD/MM/YYYY\", \"DD-MM-YYYY\", \"DD/MM\", \"DD-MM\"\n * For inputs without year, assigns future year automatically\n * User-provided years are respected and never modified\n * Returns: \"YYYY-MM-DD\" or null if invalid\n */\nexport function normalizeTripDate(input: string): string | null {\n  if (!input || typeof input !== 'string') {\n    return null;\n  }\n\n  const trimmed = input.trim();\n  \n  // Already in YYYY-MM-DD format - respect user-provided year\n  const isoMatch = trimmed.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\n  if (isoMatch) {\n    const [, yearStr, monthStr, dayStr] = isoMatch;\n    const year = parseInt(yearStr);\n    const month = parseInt(monthStr);\n    const day = parseInt(dayStr);\n    \n    if (isValidDateParts(year, month, day)) {\n      return trimmed; // Respect user-provided year\n    }\n    return null;\n  }\n\n  // DD/MM/YYYY or DD-MM-YYYY format - respect user-provided year\n  const euFullMatch = trimmed.match(/^(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{4})$/);\n  if (euFullMatch) {\n    const [, dayStr, monthStr, yearStr] = euFullMatch;\n    const day = parseInt(dayStr);\n    const month = parseInt(monthStr);\n    const year = parseInt(yearStr);\n    \n    if (isValidDateParts(year, month, day)) {\n      return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\n    }\n    return null;\n  }\n\n  // DD/MM or DD-MM format (no year) - infer future year\n  const euShortMatch = trimmed.match(/^(\\d{1,2})[\\/\\-](\\d{1,2})$/);\n  if (euShortMatch) {\n    const [, dayStr, monthStr] = euShortMatch;\n    const day = parseInt(dayStr);\n    const month = parseInt(monthStr);\n    const year = inferFutureYear(month, day);\n    \n    if (isValidDateParts(year, month, day)) {\n      return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\n    }\n    return null;\n  }\n\n  return null;\n}\n\n/**\n * Normalizes a date input ensuring it's in the future\n * If the date is in the past, adjusts to next occurrence\n * Use this when dates MUST be in the future (like trip booking)\n */\nexport function normalizeFutureTripDate(input: string): string | null {\n  const normalized = normalizeTripDate(input);\n  if (!normalized) return null;\n  \n  const year = parseInt(normalized.slice(0, 4));\n  const month = parseInt(normalized.slice(5, 7));\n  const day = parseInt(normalized.slice(8, 10));\n  \n  const current = getCurrentDateParts();\n  \n  // If date is in the past, adjust to next occurrence\n  if (year < current.year || \n      (year === current.year && (month < current.month || (month === current.month && day < current.day)))) {\n    const futureYear = inferFutureYear(month, day);\n    return `${futureYear}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;\n  }\n  \n  return normalized;\n}\n\n/**\n * Validates date parts without creating Date objects\n */\nfunction isValidDateParts(year: number, month: number, day: number): boolean {\n  if (year < 2024 || year > 2100) return false;\n  if (month < 1 || month > 12) return false;\n  if (day < 1 || day > 31) return false;\n\n  const daysInMonth = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];\n  \n  // Leap year check\n  if (month === 2) {\n    const isLeap = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n    const maxDay = isLeap ? 29 : 28;\n    if (day > maxDay) return false;\n  } else if (day > daysInMonth[month]) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Calculates days between two YYYY-MM-DD date strings\n * Uses simple arithmetic, no Date objects\n */\nexport function calculateTripDays(startDate: string, endDate: string): number {\n  const start = parseDateString(startDate);\n  const end = parseDateString(endDate);\n  \n  if (!start || !end) return 0;\n  \n  // Convert to days since epoch using simple formula\n  const startDays = toDaysSinceEpoch(start.year, start.month, start.day);\n  const endDays = toDaysSinceEpoch(end.year, end.month, end.day);\n  \n  return Math.max(0, endDays - startDays);\n}\n\n/**\n * Parses YYYY-MM-DD string to parts object\n */\nfunction parseDateString(dateStr: string): { year: number; month: number; day: number } | null {\n  const match = dateStr.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\n  if (!match) return null;\n  \n  return {\n    year: parseInt(match[1]),\n    month: parseInt(match[2]),\n    day: parseInt(match[3])\n  };\n}\n\n/**\n * Converts date parts to days since a reference point\n * Simple algorithm that works for date comparisons\n */\nfunction toDaysSinceEpoch(year: number, month: number, day: number): number {\n  // Simplified calculation - works for comparison purposes\n  let days = year * 365 + day;\n  \n  // Add days for each month\n  const monthDays = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];\n  days += monthDays[month - 1];\n  \n  // Add leap year days\n  const leapYears = Math.floor((year - 1) / 4) - Math.floor((year - 1) / 100) + Math.floor((year - 1) / 400);\n  days += leapYears;\n  \n  // If after Feb in a leap year, add 1\n  const isLeap = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);\n  if (isLeap && month > 2) {\n    days += 1;\n  }\n  \n  return days;\n}\n\n/**\n * Validates that return date is after depart date\n */\nexport function isValidDateRange(startDate: string, endDate: string): boolean {\n  const start = parseDateString(startDate);\n  const end = parseDateString(endDate);\n  \n  if (!start || !end) return false;\n  \n  const startDays = toDaysSinceEpoch(start.year, start.month, start.day);\n  const endDays = toDaysSinceEpoch(end.year, end.month, end.day);\n  \n  return endDays > startDays;\n}\n\n/**\n * Formats date for display in Italian format\n * Input: YYYY-MM-DD, Output: DD/MM/YYYY\n */\nexport function formatDateIT(dateStr: string): string {\n  const match = dateStr.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\n  if (!match) return dateStr;\n  \n  const [, year, month, day] = match;\n  return `${day}/${month}/${year}`;\n}\n\n/**\n * Extracts date-only portion from ISO datetime string\n * Input: \"2026-01-20T10:30:00\" -> \"2026-01-20\"\n */\nexport function extractDateOnly(isoString: string): string {\n  if (!isoString) return '';\n  return isoString.slice(0, 10);\n}\n\n/**\n * Formats ISO datetime string for display without timezone shift\n * Extracts date and time parts directly from string\n * Input: \"2026-01-20T10:30:00+01:00\" -> \"20/01/2026 10:30\"\n */\nexport function formatFlightDateTime(isoString: string): string {\n  if (!isoString) return '';\n  \n  // Extract date part (YYYY-MM-DD)\n  const datePart = isoString.slice(0, 10);\n  const timePart = isoString.slice(11, 16); // HH:MM\n  \n  // Parse date without Date object\n  const year = datePart.slice(0, 4);\n  const month = datePart.slice(5, 7);\n  const day = datePart.slice(8, 10);\n  \n  return `${day}/${month}/${year} ${timePart}`;\n}\n\n/**\n * Formats date range for display\n * Input: \"2026-01-10\", \"2026-01-15\" -> \"10-15 Gennaio 2026\"\n */\nexport function formatDateRangeIT(startDate: string, endDate: string): string {\n  if (!startDate || !endDate) return '';\n  \n  const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',\n                  'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];\n  \n  const startDay = parseInt(startDate.slice(8, 10));\n  const startMonth = parseInt(startDate.slice(5, 7)) - 1;\n  const endDay = parseInt(endDate.slice(8, 10));\n  const endMonth = parseInt(endDate.slice(5, 7)) - 1;\n  const year = startDate.slice(0, 4);\n  \n  if (startMonth === endMonth) {\n    return `${startDay}-${endDay} ${months[startMonth]} ${year}`;\n  }\n  return `${startDay} ${months[startMonth]} - ${endDay} ${months[endMonth]} ${year}`;\n}\n","path":null,"size_bytes":8392,"size_tokens":null},"vitest.config.ts":{"content":"import { defineConfig } from 'vitest/config';\nimport react from '@vitejs/plugin-react';\nimport path from 'path';\n\nexport default defineConfig({\n  plugins: [react()],\n  test: {\n    globals: true,\n    include: ['**/*.test.ts', '**/*.test.tsx'],\n    exclude: ['node_modules', 'dist'],\n    environment: 'node',\n    setupFiles: ['./vitest.setup.ts'],\n  },\n  resolve: {\n    alias: {\n      '@': path.resolve(__dirname, './client/src'),\n      '@shared': path.resolve(__dirname, './shared'),\n    },\n  },\n});\n","path":null,"size_bytes":499,"size_tokens":null},"shared/cityMapping.ts":{"content":"export interface CityDefinition {\n  canonical: string;\n  iata: string;\n  aliases: string[];\n}\n\nexport const SUPPORTED_DESTINATIONS: CityDefinition[] = [\n  { canonical: \"Rome\", iata: \"ROM\", aliases: [\"roma\", \"rome\"] },\n  { canonical: \"Ibiza\", iata: \"IBZ\", aliases: [\"ibiza\"] },\n  { canonical: \"Barcelona\", iata: \"BCN\", aliases: [\"barcellona\", \"barcelona\"] },\n  { canonical: \"Prague\", iata: \"PRG\", aliases: [\"praga\", \"prague\"] },\n  { canonical: \"Budapest\", iata: \"BUD\", aliases: [\"budapest\"] },\n  { canonical: \"Krakow\", iata: \"KRK\", aliases: [\"cracovia\", \"krakow\", \"kraków\", \"cracow\"] },\n  { canonical: \"Amsterdam\", iata: \"AMS\", aliases: [\"amsterdam\"] },\n  { canonical: \"Berlin\", iata: \"BER\", aliases: [\"berlino\", \"berlin\"] },\n  { canonical: \"Lisbon\", iata: \"LIS\", aliases: [\"lisbona\", \"lisbon\", \"lisboa\"] },\n  { canonical: \"Palma de Mallorca\", iata: \"PMI\", aliases: [\"palma de mallorca\", \"palma\", \"mallorca\", \"maiorca\"] },\n];\n\nfunction normalizeCity(input: string): string {\n  return input\n    .toLowerCase()\n    .trim()\n    .replace(/\\s*\\([^)]*\\)\\s*/g, '')\n    .replace(/\\s+/g, ' ');\n}\n\nexport function getCityCode(destination: string): string | null {\n  const normalized = normalizeCity(destination);\n  \n  for (const city of SUPPORTED_DESTINATIONS) {\n    if (city.aliases.includes(normalized)) {\n      return city.iata;\n    }\n  }\n  \n  return null;\n}\n\nexport function getCanonicalCityName(destination: string): string | null {\n  const normalized = normalizeCity(destination);\n  \n  for (const city of SUPPORTED_DESTINATIONS) {\n    if (city.aliases.includes(normalized)) {\n      return city.canonical;\n    }\n  }\n  \n  return null;\n}\n\nexport function isSupportedDestination(destination: string): boolean {\n  return getCityCode(destination) !== null;\n}\n","path":null,"size_bytes":1749,"size_tokens":null},"thoughts/shared/research/2026-01-29-authentication-flow.md":{"content":"---\ndate: 2026-01-29T17:36:34Z\nresearcher: Alessio Fanelli\ngit_commit: 7f659d2\nbranch: main\nrepository: ByeBi-replit\ntopic: \"How is authentication implemented?\"\ntags: [research, codebase, authentication, passport, session, auth]\nstatus: complete\nlast_updated: 2026-01-29\nlast_updated_by: Alessio Fanelli\n---\n\n# Research: How is authentication implemented?\n\n**Date**: 2026-01-29T17:36:34Z\n**Researcher**: Alessio Fanelli\n**Git Commit**: 7f659d2\n**Branch**: main\n**Repository**: ByeBi-replit\n\n## Research Question\nHow is authentication implemented?\n\n## Summary\n\nThe application uses **session-based authentication** powered by Passport.js with a LocalStrategy (username/password). Sessions are stored in-memory via MemoryStore and passwords are hashed with Node.js's scrypt algorithm. The client manages auth state through two separate React context implementations — one using React Query and one using localStorage. There are no OAuth or third-party authentication integrations.\n\n## Detailed Findings\n\n### Server-Side Authentication Core\n\n#### Password Hashing (`server/auth.ts:22-33`)\n- Uses Node.js native `crypto.scrypt` for key derivation\n- Generates a random 16-byte salt per password via `crypto.randomBytes()`\n- Produces a 64-byte hash and stores it as `{hash}.{salt}` (both hex-encoded)\n- Verification uses `crypto.timingSafeEqual()` for constant-time comparison\n\n#### Session Configuration (`server/auth.ts:35-57`)\n- Session secret sourced from `process.env.SESSION_SECRET`, falling back to a random 32-byte hex string\n- MemoryStore with 24-hour expired entry pruning\n- Cookie settings: 24-hour max age, `httpOnly: true`, `secure` in production, `sameSite: \"lax\"`\n- Trust proxy enabled for HTTPS behind reverse proxies\n- Middleware chain: `session` → `passport.initialize()` → `passport.session()`\n\n#### Passport LocalStrategy (`server/auth.ts:60-86`)\n- Accepts username or email for login (tries username first, then email)\n- Verifies password with `comparePasswords()`\n- Returns generic \"Incorrect username or password\" message on failure (doesn't reveal which field was wrong)\n\n#### Serialization (`server/auth.ts:88-101`)\n- Serialize: stores only `user.id` in the session\n- Deserialize: loads full user object from storage by ID on each request\n\n### API Endpoints\n\n| Endpoint | Method | File:Line | Description |\n|---|---|---|---|\n| `/api/register` | POST | `server/auth.ts:104-144` | Creates user, hashes password, auto-logs in |\n| `/api/login` | POST | `server/auth.ts:147-166` | Authenticates via Passport LocalStrategy |\n| `/api/logout` | POST | `server/auth.ts:169-174` | Destroys session via `req.logout()` |\n| `/api/user` | GET | `server/auth.ts:177-186` | Returns current user if authenticated |\n\n#### Registration flow:\n1. Validates presence of username, email, password\n2. Checks for existing username and email (returns 400 if duplicate)\n3. Hashes password with scrypt\n4. Creates user in storage\n5. Auto-logs in the new user via `req.login()`\n6. Returns user object without password (201)\n\n#### Login flow:\n1. `passport.authenticate(\"local\")` invoked with custom callback\n2. Strategy finds user by username or email\n3. Verifies password\n4. Session established via `req.login()`\n5. Returns user object without password (200)\n\n### Server-Side Route Protection\n\n#### Middleware (`server/routes.ts:26-31`)\n```\nconst isAuthenticated = (req, res, next) => {\n  if (req.isAuthenticated()) return next();\n  res.status(401).json({ message: \"Authentication required\" });\n};\n```\n\nApplied to:\n- `POST /api/users/:id/premium` (`routes.ts:33`)\n- `POST /api/trips` (`routes.ts:58`)\n\n### Client-Side Auth State\n\n#### Primary: React Query Context (`client/src/hooks/use-auth.tsx`)\n- Provides `AuthProvider` and `useAuth()` hook\n- Fetches user from `/api/user` using React Query with `getQueryFn({ on401: \"returnNull\" })`\n- Exposes `loginMutation`, `logoutMutation`, `registerMutation`\n- Updates React Query cache on successful auth operations\n- `isAuthenticated` computed as `!!user`\n- Used by: Header, TripPlanningForm, OneClickAssistant, ProtectedRoute, AuthPage\n\n#### Secondary: localStorage Context (`client/src/contexts/AuthContext.tsx`)\n- Separate `AuthProvider` and `useAuth()` hook\n- Persists user in localStorage under key `\"byebroUser\"`\n- Manual `login()`, `logout()`, `updateUser()` methods\n- No server validation on mount\n- Used by: SecretBlog, SecretBlogPage, Dashboard, PremiumFeatures, AuthModal\n\n#### Provider Setup\n- `client/src/App.tsx:74` — wraps app with `AuthProvider` (from hooks/use-auth.tsx) inside `QueryClientProvider`\n- `client/src/main.tsx:6` — wraps `<App />` with `AuthProvider` (from contexts/AuthContext.tsx)\n\n### Client-Side Route Protection\n\n#### ProtectedRoute Component (`client/src/lib/protected-route.tsx`)\n- Shows loading spinner while auth state resolves\n- Redirects to `/auth` if user is not authenticated\n- Renders component if authenticated\n- Uses wouter's `Route` and `Redirect` components\n\nProtected routes in `App.tsx`:\n- `/dashboard` → Dashboard\n- `/secret-blog` → SecretBlogPage\n\n### API Request Handling (`client/src/lib/queryClient.ts:10`)\n- All requests include `credentials: \"include\"` to send session cookies\n- `getQueryFn` supports configurable 401 behavior:\n  - `\"returnNull\"` — used for `/api/user` to gracefully handle unauthenticated state\n  - Default — throws error on non-OK responses\n\n### Data Model\n\n#### Users Table (`shared/schema.ts:6-23`)\n| Column | Type | Constraints |\n|---|---|---|\n| id | serial | primary key |\n| username | text | not null, unique |\n| password | text | not null |\n| email | text | not null, unique |\n| firstName | text | nullable |\n| lastName | text | nullable |\n| isPremium | boolean | default false |\n| createdAt | timestamp | default now |\n\n#### Storage Layer (`server/storage.ts`)\n- `MemStorage` class using `Map<number, User>`\n- Methods: `getUser(id)`, `getUserByUsername(username)`, `getUserByEmail(email)`, `createUser(user)`, `updateUserPremiumStatus(id, isPremium)`\n- Auto-incrementing ID counter\n- All data in-memory (lost on server restart)\n\n### Auth-Dependent Features\n\n- **Premium content gating**: Components check `user?.isPremium` to show/hide premium features (`SecretBlog.tsx:25`, `SecretBlogPage.tsx:17`)\n- **Form submission guards**: TripPlanningForm checks `isAuthenticated` before allowing submission (`TripPlanningForm.tsx:133`)\n- **Header UI**: Conditionally renders login/signup buttons or user dropdown with logout (`Header.tsx:20`)\n\n### Dependencies\n\n| Package | Version | Purpose |\n|---|---|---|\n| passport | ^0.7.0 | Authentication middleware |\n| passport-local | ^1.0.0 | Username/password strategy |\n| express-session | ^1.18.1 | Session middleware |\n| memorystore | ^1.6.7 | In-memory session store |\n| Node.js crypto | built-in | scrypt hashing, randomBytes, timingSafeEqual |\n\n## Code References\n- `server/auth.ts:22-33` — Password hashing and comparison functions\n- `server/auth.ts:35-57` — Session and Passport configuration\n- `server/auth.ts:60-86` — Passport LocalStrategy definition\n- `server/auth.ts:88-101` — Session serialization/deserialization\n- `server/auth.ts:104-186` — Auth API endpoints (register, login, logout, get user)\n- `server/routes.ts:22-23` — Auth setup initialization\n- `server/routes.ts:26-31` — isAuthenticated middleware\n- `server/storage.ts:123-157` — User storage methods\n- `shared/schema.ts:6-23` — Users table schema\n- `client/src/hooks/use-auth.tsx` — Primary React Query-based auth context\n- `client/src/contexts/AuthContext.tsx` — Secondary localStorage-based auth context\n- `client/src/lib/protected-route.tsx` — Client-side route protection\n- `client/src/lib/queryClient.ts:10` — API request helper with credentials\n- `client/src/pages/auth-page.tsx` — Login/signup page\n- `client/src/components/AuthModal.tsx` — Modal auth UI\n- `client/src/components/Header.tsx:20` — Auth-aware header navigation\n\n## Architecture Documentation\n\n**Authentication Pattern**: Session-based with Passport.js LocalStrategy. No JWT, no OAuth. Sessions stored server-side in MemoryStore with cookie-based session IDs sent to the client.\n\n**Client State Pattern**: Two coexisting auth context implementations — React Query-based (hooks/use-auth.tsx) and localStorage-based (contexts/AuthContext.tsx). Both export `useAuth()` and `AuthProvider`. Different components import from different sources.\n\n**Protection Pattern**: Server uses `isAuthenticated` middleware on protected routes. Client uses `ProtectedRoute` wrapper component that redirects to `/auth`. Some components also perform inline auth checks before actions.\n\n**Data Layer**: In-memory Map storage (MemStorage class). Drizzle schema defined but storage uses in-memory maps rather than a database connection.\n\n## Related Research\n_No prior research documents found in thoughts/shared/research/_\n\n## Open Questions\n- Which components should use which AuthContext (hooks/ vs contexts/)? Both are active and used by different parts of the app.\n- Is the in-memory storage intentional for development, or is a database connection planned?\n","path":null,"size_bytes":9089,"size_tokens":null},"server/services/amadeus-flights.ts":{"content":"// server/services/amadeus-flights.ts\nimport axios from \"axios\";\n\nexport type FlightSearchParams = {\n  originCode: string;      // IATA code, e.g., \"FCO\"\n  destinationCode: string; // IATA code, e.g., \"BCN\"\n  departureDate: string;   // \"2026-05-15\"\n  returnDate?: string;     // \"2026-05-20\" (optional for one-way)\n  adults: number;          // 1-9\n  currency?: string;       // \"EUR\"\n};\n\nexport type FlightSegment = {\n  departure: {\n    iataCode: string;\n    terminal?: string;\n    at: string; // ISO datetime\n  };\n  arrival: {\n    iataCode: string;\n    terminal?: string;\n    at: string;\n  };\n  carrierCode: string;\n  carrierName?: string;\n  flightNumber: string;\n  duration: string; // e.g., \"PT2H30M\"\n};\n\nexport type FlightResult = {\n  id: string;\n  price: number;\n  currency: string;\n  outbound: FlightSegment[];\n  inbound?: FlightSegment[];\n  airlines: string[];\n  totalDuration: string;\n  stops: number;\n};\n\nconst isProd = process.env.NODE_ENV === \"production\";\nconst useAmadeusLive = process.env.AMADEUS_ENV === \"production\";\n\nconst AMADEUS_API_KEY = useAmadeusLive\n  ? process.env.AMADEUS_API_KEY_LIVE\n  : process.env.AMADEUS_API_KEY_TEST;\n\nconst AMADEUS_API_SECRET = useAmadeusLive\n  ? process.env.AMADEUS_API_SECRET_LIVE\n  : process.env.AMADEUS_API_SECRET_TEST;\n\nif (!AMADEUS_API_KEY || !AMADEUS_API_SECRET) {\n  console.error(\n    `[Amadeus Flights] Missing credentials for ${useAmadeusLive ? \"LIVE\" : \"TEST\"} environment`\n  );\n}\n\nconst AMADEUS_BASE_URL = useAmadeusLive\n  ? \"https://api.amadeus.com\"\n  : \"https://test.api.amadeus.com\";\n\nlet tokenCache: { token: string | null; expiresAt: number } = {\n  token: null,\n  expiresAt: 0,\n};\n\nasync function getAmadeusToken(): Promise<string> {\n  if (tokenCache.token && tokenCache.expiresAt > Date.now() + 10_000) {\n    return tokenCache.token;\n  }\n\n  if (!AMADEUS_API_KEY || !AMADEUS_API_SECRET) {\n    throw new Error(\"Amadeus credentials are not configured\");\n  }\n\n  const body = new URLSearchParams({\n    grant_type: \"client_credentials\",\n    client_id: AMADEUS_API_KEY,\n    client_secret: AMADEUS_API_SECRET,\n  });\n\n  const resp = await axios.post(\n    `${AMADEUS_BASE_URL}/v1/security/oauth2/token`,\n    body,\n    { headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" } }\n  );\n\n  tokenCache = {\n    token: resp.data.access_token,\n    expiresAt: Date.now() + (resp.data.expires_in - 60) * 1000,\n  };\n\n  return tokenCache.token!;\n}\n\n// Airline code to name mapping (common carriers)\nconst AIRLINE_NAMES: Record<string, string> = {\n  \"IB\": \"Iberia\",\n  \"VY\": \"Vueling\",\n  \"UX\": \"Air Europa\",\n  \"AZ\": \"ITA Airways\",\n  \"LH\": \"Lufthansa\",\n  \"AF\": \"Air France\",\n  \"KL\": \"KLM\",\n  \"BA\": \"British Airways\",\n  \"LX\": \"Swiss\",\n  \"OS\": \"Austrian\",\n  \"SN\": \"Brussels Airlines\",\n  \"TP\": \"TAP Portugal\",\n  \"TK\": \"Turkish Airlines\",\n  \"EW\": \"Eurowings\",\n  \"A3\": \"Aegean\",\n  \"FR\": \"Ryanair\",\n  \"U2\": \"easyJet\",\n  \"W6\": \"Wizz Air\",\n};\n\nexport async function searchFlights(\n  params: FlightSearchParams\n): Promise<FlightResult[]> {\n  const {\n    originCode,\n    destinationCode,\n    departureDate,\n    returnDate,\n    adults,\n    currency = \"EUR\",\n  } = params;\n\n  const token = await getAmadeusToken();\n\n  console.log(\"🔍 Amadeus Flight Search request:\", {\n    originCode,\n    destinationCode,\n    departureDate,\n    returnDate,\n    adults,\n  });\n\n  try {\n    const queryParams: Record<string, string | number> = {\n      originLocationCode: originCode,\n      destinationLocationCode: destinationCode,\n      departureDate,\n      adults,\n      currencyCode: currency,\n      max: 50, // Request more to get variety after deduplication\n    };\n\n    if (returnDate) {\n      queryParams.returnDate = returnDate;\n    }\n\n    const resp = await axios.get(\n      `${AMADEUS_BASE_URL}/v2/shopping/flight-offers`,\n      {\n        headers: { Authorization: `Bearer ${token}` },\n        params: queryParams,\n      }\n    );\n\n    console.log(\"📦 Amadeus Flight Search response:\", {\n      status: resp.status,\n      count: resp.data?.data?.length || 0,\n    });\n\n    const offers = resp.data?.data || [];\n    const dictionaries = resp.data?.dictionaries || {};\n\n    const allFlights = offers.map((offer: any) => transformFlightOffer(offer, dictionaries, currency));\n\n    // Deduplicate flights - keep only one per airline/price/stops combination\n    // This collapses multiple departure times into a single representative option\n    const seen = new Set<string>();\n    const uniqueFlights = allFlights.filter((f: FlightResult) => {\n      const key = [\n        f.airlines.sort().join(\",\"),\n        f.price.toFixed(2),\n        f.stops\n      ].join(\"|\");\n\n      if (seen.has(key)) {\n        return false;\n      }\n      seen.add(key);\n      return true;\n    });\n\n    console.log(`🔄 Deduplicated: ${allFlights.length} → ${uniqueFlights.length} flights`);\n\n    return uniqueFlights;\n  } catch (error: any) {\n    console.error(\"❌ Amadeus Flight Search error:\", JSON.stringify({\n      status: error.response?.status,\n      data: error.response?.data,\n      message: error.message,\n    }, null, 2));\n\n    // Return empty array on error (don't throw)\n    return [];\n  }\n}\n\nfunction transformFlightOffer(\n  offer: any,\n  dictionaries: any,\n  currency: string\n): FlightResult {\n  const itineraries = offer.itineraries || [];\n  const outboundItinerary = itineraries[0];\n  const inboundItinerary = itineraries[1];\n\n  const outboundSegments = (outboundItinerary?.segments || []).map((seg: any) =>\n    transformSegment(seg, dictionaries)\n  );\n  const inboundSegments = inboundItinerary\n    ? (inboundItinerary.segments || []).map((seg: any) =>\n        transformSegment(seg, dictionaries)\n      )\n    : undefined;\n\n  // Collect unique airline codes\n  const airlineCodes = new Set<string>();\n  outboundSegments.forEach((s: FlightSegment) => airlineCodes.add(s.carrierCode));\n  if (inboundSegments) {\n    inboundSegments.forEach((s: FlightSegment) => airlineCodes.add(s.carrierCode));\n  }\n\n  const airlines = Array.from(airlineCodes).map(\n    (code) =>\n      dictionaries?.carriers?.[code] ||\n      AIRLINE_NAMES[code] ||\n      code\n  );\n\n  return {\n    id: offer.id,\n    price: parseFloat(offer.price?.total || \"0\"),\n    currency: offer.price?.currency || currency,\n    outbound: outboundSegments,\n    inbound: inboundSegments,\n    airlines,\n    totalDuration: outboundItinerary?.duration || \"\",\n    stops: Math.max(0, outboundSegments.length - 1),\n  };\n}\n\nfunction transformSegment(seg: any, dictionaries: any): FlightSegment {\n  return {\n    departure: {\n      iataCode: seg.departure?.iataCode || \"\",\n      terminal: seg.departure?.terminal,\n      at: seg.departure?.at || \"\",\n    },\n    arrival: {\n      iataCode: seg.arrival?.iataCode || \"\",\n      terminal: seg.arrival?.terminal,\n      at: seg.arrival?.at || \"\",\n    },\n    carrierCode: seg.carrierCode || \"\",\n    carrierName:\n      dictionaries?.carriers?.[seg.carrierCode] ||\n      AIRLINE_NAMES[seg.carrierCode] ||\n      seg.carrierCode,\n    flightNumber: seg.number || \"\",\n    duration: seg.duration || \"\",\n  };\n}\n","path":null,"size_bytes":7000,"size_tokens":null},"server/services/cityMapping.test.ts":{"content":"import { describe, it, expect } from 'vitest';\nimport {\n  cityToIata,\n  iataToCity,\n  getAllCities,\n  getAllIataCodes,\n  CITY_TO_IATA,\n  IATA_TO_CITY,\n} from './cityMapping';\n\ndescribe('cityToIata', () => {\n  describe('Italian city names', () => {\n    it('maps Italian city names to IATA codes', () => {\n      expect(cityToIata('roma')).toBe('ROM');\n      expect(cityToIata('milano')).toBe('MIL');\n      expect(cityToIata('napoli')).toBe('NAP');\n      expect(cityToIata('venezia')).toBe('VCE');\n      expect(cityToIata('firenze')).toBe('FLR');\n      expect(cityToIata('torino')).toBe('TRN');\n      expect(cityToIata('bologna')).toBe('BLQ');\n    });\n  });\n\n  describe('English city names', () => {\n    it('maps English city names to IATA codes', () => {\n      expect(cityToIata('rome')).toBe('ROM');\n      expect(cityToIata('milan')).toBe('MIL');\n      expect(cityToIata('naples')).toBe('NAP');\n      expect(cityToIata('venice')).toBe('VCE');\n      expect(cityToIata('florence')).toBe('FLR');\n      expect(cityToIata('turin')).toBe('TRN');\n    });\n  });\n\n  describe('European cities', () => {\n    it('maps major European cities', () => {\n      expect(cityToIata('parigi')).toBe('PAR');\n      expect(cityToIata('paris')).toBe('PAR');\n      expect(cityToIata('londra')).toBe('LON');\n      expect(cityToIata('london')).toBe('LON');\n      expect(cityToIata('berlino')).toBe('BER');\n      expect(cityToIata('berlin')).toBe('BER');\n      expect(cityToIata('madrid')).toBe('MAD');\n      expect(cityToIata('barcellona')).toBe('BCN');\n      expect(cityToIata('barcelona')).toBe('BCN');\n      expect(cityToIata('amsterdam')).toBe('AMS');\n      expect(cityToIata('praga')).toBe('PRG');\n      expect(cityToIata('prague')).toBe('PRG');\n    });\n  });\n\n  describe('case insensitivity', () => {\n    it('handles uppercase input', () => {\n      expect(cityToIata('ROMA')).toBe('ROM');\n      expect(cityToIata('MILAN')).toBe('MIL');\n      expect(cityToIata('PARIS')).toBe('PAR');\n    });\n\n    it('handles mixed case input', () => {\n      expect(cityToIata('Roma')).toBe('ROM');\n      expect(cityToIata('MiLaN')).toBe('MIL');\n      expect(cityToIata('PaRiS')).toBe('PAR');\n    });\n  });\n\n  describe('whitespace handling', () => {\n    it('trims whitespace from input', () => {\n      expect(cityToIata('  roma  ')).toBe('ROM');\n      expect(cityToIata('  paris ')).toBe('PAR');\n      expect(cityToIata('london  ')).toBe('LON');\n    });\n  });\n\n  describe('null/undefined handling', () => {\n    it('returns null for null/undefined input', () => {\n      expect(cityToIata(null)).toBeNull();\n      expect(cityToIata(undefined)).toBeNull();\n    });\n\n    it('returns null for empty string', () => {\n      expect(cityToIata('')).toBeNull();\n    });\n\n    it('returns null for unknown cities', () => {\n      expect(cityToIata('unknowncity')).toBeNull();\n      expect(cityToIata('xyz')).toBeNull();\n    });\n  });\n\n  describe('airport-specific codes', () => {\n    it('maps specific airport names', () => {\n      expect(cityToIata('fiumicino')).toBe('FCO');\n      expect(cityToIata('ciampino')).toBe('CIA');\n      expect(cityToIata('malpensa')).toBe('MXP');\n      expect(cityToIata('linate')).toBe('LIN');\n      expect(cityToIata('bergamo')).toBe('BGY');\n      expect(cityToIata('orio al serio')).toBe('BGY');\n    });\n  });\n});\n\ndescribe('iataToCity', () => {\n  describe('Italian cities', () => {\n    it('maps IATA codes to city names', () => {\n      expect(iataToCity('ROM')).toBe('Roma');\n      expect(iataToCity('MIL')).toBe('Milano');\n      expect(iataToCity('NAP')).toBe('Napoli');\n      expect(iataToCity('VCE')).toBe('Venezia');\n      expect(iataToCity('FLR')).toBe('Firenze');\n    });\n  });\n\n  describe('European cities', () => {\n    it('maps IATA codes for European cities', () => {\n      expect(iataToCity('PAR')).toBe('Paris');\n      expect(iataToCity('LON')).toBe('London');\n      expect(iataToCity('BER')).toBe('Berlin');\n      expect(iataToCity('MAD')).toBe('Madrid');\n      expect(iataToCity('BCN')).toBe('Barcelona');\n      expect(iataToCity('AMS')).toBe('Amsterdam');\n    });\n  });\n\n  describe('case handling', () => {\n    it('normalizes lowercase input to uppercase', () => {\n      expect(iataToCity('rom')).toBe('Roma');\n      expect(iataToCity('par')).toBe('Paris');\n      expect(iataToCity('lon')).toBe('London');\n    });\n\n    it('handles mixed case input', () => {\n      expect(iataToCity('RoM')).toBe('Roma');\n      expect(iataToCity('pAr')).toBe('Paris');\n    });\n  });\n\n  describe('null/undefined handling', () => {\n    it('returns \"Unknown\" for null/undefined input', () => {\n      expect(iataToCity(null)).toBe('Unknown');\n      expect(iataToCity(undefined)).toBe('Unknown');\n    });\n\n    it('returns the code itself for unknown IATA codes', () => {\n      expect(iataToCity('XYZ')).toBe('XYZ');\n      expect(iataToCity('ABC')).toBe('ABC');\n    });\n  });\n});\n\ndescribe('getAllCities', () => {\n  it('returns an array of city names', () => {\n    const cities = getAllCities();\n    expect(Array.isArray(cities)).toBe(true);\n    expect(cities.length).toBeGreaterThan(0);\n  });\n\n  it('returns sorted city names', () => {\n    const cities = getAllCities();\n    const sortedCities = [...cities].sort();\n    expect(cities).toEqual(sortedCities);\n  });\n\n  it('contains major cities', () => {\n    const cities = getAllCities();\n    expect(cities).toContain('Roma');\n    expect(cities).toContain('Milano');\n    expect(cities).toContain('Paris');\n    expect(cities).toContain('London');\n    expect(cities).toContain('Berlin');\n  });\n\n  it('returns unique values only', () => {\n    const cities = getAllCities();\n    const uniqueCities = [...new Set(cities)];\n    expect(cities.length).toBe(uniqueCities.length);\n  });\n});\n\ndescribe('getAllIataCodes', () => {\n  it('returns an array of IATA codes', () => {\n    const codes = getAllIataCodes();\n    expect(Array.isArray(codes)).toBe(true);\n    expect(codes.length).toBeGreaterThan(0);\n  });\n\n  it('contains major airport codes', () => {\n    const codes = getAllIataCodes();\n    expect(codes).toContain('ROM');\n    expect(codes).toContain('MIL');\n    expect(codes).toContain('PAR');\n    expect(codes).toContain('LON');\n    expect(codes).toContain('BER');\n    expect(codes).toContain('BCN');\n    expect(codes).toContain('AMS');\n  });\n\n  it('returns unique codes only', () => {\n    const codes = getAllIataCodes();\n    const uniqueCodes = [...new Set(codes)];\n    expect(codes.length).toBe(uniqueCodes.length);\n  });\n\n  it('all codes are 3 characters', () => {\n    const codes = getAllIataCodes();\n    codes.forEach(code => {\n      expect(code.length).toBe(3);\n    });\n  });\n});\n\ndescribe('mapping consistency', () => {\n  it('every IATA code in IATA_TO_CITY exists in CITY_TO_IATA values', () => {\n    const iataCodes = Object.keys(IATA_TO_CITY);\n    const cityToIataValues = Object.values(CITY_TO_IATA);\n\n    iataCodes.forEach(code => {\n      expect(cityToIataValues).toContain(code);\n    });\n  });\n\n  it('getAllCities returns values from IATA_TO_CITY', () => {\n    const cities = getAllCities();\n    const iataToValues = Object.values(IATA_TO_CITY);\n\n    cities.forEach(city => {\n      expect(iataToValues).toContain(city);\n    });\n  });\n\n  it('getAllIataCodes returns keys from IATA_TO_CITY', () => {\n    const codes = getAllIataCodes();\n    const iataToKeys = Object.keys(IATA_TO_CITY);\n\n    expect(codes.length).toBe(iataToKeys.length);\n    codes.forEach(code => {\n      expect(iataToKeys).toContain(code);\n    });\n  });\n});\n","path":null,"size_bytes":7454,"size_tokens":null},"server/app.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport express from 'express';\n\n// Mock the storage module\nvi.mock('./storage', () => ({\n  storage: {\n    getAllDestinations: vi.fn().mockResolvedValue([]),\n    getAllExperiences: vi.fn().mockResolvedValue([]),\n    getAllBlogPosts: vi.fn().mockResolvedValue([]),\n    getFreeBlogPosts: vi.fn().mockResolvedValue([]),\n    getAllMerchandise: vi.fn().mockResolvedValue([]),\n    getMerchandiseByType: vi.fn().mockResolvedValue([]),\n    getAllExpenseGroups: vi.fn().mockResolvedValue([]),\n  },\n}));\n\n// Mock auth setup\nvi.mock('./auth', () => ({\n  setupAuth: vi.fn(),\n}));\n\n// Mock zapier integration\nvi.mock('./zapier-integration', () => ({\n  registerZapierRoutes: vi.fn(),\n}));\n\n// Mock OpenAI service\nvi.mock('./services/openai', () => ({\n  generateItinerary: vi.fn(),\n  generateAssistantResponse: vi.fn(),\n  streamOpenAIChatCompletion: vi.fn(),\n}));\n\n// Mock image search service\nvi.mock('./services/image-search', () => ({\n  imageSearchService: {\n    searchImages: vi.fn().mockResolvedValue({ images: [] }),\n    searchDestinationImages: vi.fn().mockResolvedValue({ images: [] }),\n    searchBarcelonaImages: vi.fn().mockResolvedValue({ images: [] }),\n  },\n}));\n\n// Mock aviasales service\nvi.mock('./services/aviasales', () => ({\n  searchCheapestFlights: vi.fn().mockResolvedValue({ data: {} }),\n}));\n\n// Mock amadeus-hotels service\nvi.mock('./services/amadeus-hotels', () => ({\n  searchHotels: vi.fn().mockResolvedValue([]),\n  bookHotel: vi.fn().mockResolvedValue({ success: true }),\n}));\n\ndescribe('Express App', () => {\n  describe('app creation', () => {\n    it('creates an express application', () => {\n      const app = express();\n      expect(app).toBeDefined();\n      expect(typeof app.use).toBe('function');\n      expect(typeof app.get).toBe('function');\n      expect(typeof app.post).toBe('function');\n    });\n\n    it('can add middleware', () => {\n      const app = express();\n      app.use(express.json());\n      app.use(express.urlencoded({ extended: false }));\n      expect(app).toBeDefined();\n    });\n\n    it('can define routes', () => {\n      const app = express();\n\n      app.get('/api/health', (req, res) => {\n        res.json({ status: 'ok' });\n      });\n\n      // Check that the route stack has the route\n      const routes = app._router?.stack?.filter(\n        (layer: any) => layer.route?.path === '/api/health'\n      );\n      expect(routes?.length).toBe(1);\n    });\n  });\n\n  describe('middleware stack', () => {\n    it('processes JSON body correctly', async () => {\n      const app = express();\n      app.use(express.json());\n\n      let receivedBody: any;\n      app.post('/test', (req, res) => {\n        receivedBody = req.body;\n        res.json({ received: true });\n      });\n\n      // Simulate the middleware by creating a mock request\n      const mockReq = {\n        headers: { 'content-type': 'application/json' },\n        body: { test: 'data' },\n      };\n\n      expect(mockReq.body).toEqual({ test: 'data' });\n    });\n  });\n});\n\ndescribe('Route structure', () => {\n  it('imports route registration function', async () => {\n    // Just verify the routes module can be imported\n    const routesModule = await import('./routes');\n    expect(routesModule.registerRoutes).toBeDefined();\n    expect(typeof routesModule.registerRoutes).toBe('function');\n  });\n\n  it('imports city mapping service', async () => {\n    const { cityToIata, iataToCity } = await import('./services/cityMapping');\n    expect(cityToIata).toBeDefined();\n    expect(iataToCity).toBeDefined();\n  });\n});\n","path":null,"size_bytes":3556,"size_tokens":null},"client/src/lib/track.ts":{"content":"/**\n * Simple event tracking helper\n * For now, logs to console in a structured format\n * Can be extended to send to analytics backend later\n */\nexport function trackEvent(name: string, payload: Record<string, unknown>) {\n  console.log(\"[track]\", name, payload);\n}\n","path":null,"size_bytes":265,"size_tokens":null},"server/services/fallback-itinerary.ts":{"content":"import type { ItineraryRequest, DailyPlan, GeneratedItinerary } from \"./openai\";\n\n// Funzione per generare itinerari di esempio in caso di fallback\nexport function generateFallbackItinerary(request: ItineraryRequest): GeneratedItinerary {\n  console.log(\"Generando itinerario fallback per\", request.destination, \"con budget\", request.budget);\n  \n  // Moltiplicatore di costo basato sul budget\n  const budgetMultiplier = request.budget === \"budget\" ? 1 : request.budget === \"standard\" ? 1.6 : 2.5;\n  const baseCost = 80 * budgetMultiplier;\n  const totalPerDay = baseCost * request.groupSize;\n  const totalCost = (totalPerDay * request.days).toFixed(0);\n  \n  // Dati specifici per Barcellona\n  const barcelonaData = {\n    brunch: [\n      { name: \"Brunch & Cake\", location: \"Carrer d'Enric Granados, 19\", price: 25 },\n      { name: \"Milk Bar & Bistro\", location: \"Carrer d'en Gignàs, 21\", price: 20 },\n      { name: \"Federal Café\", location: \"Carrer del Parlament, 39\", price: 18 },\n      { name: \"Flax & Kale\", location: \"Carrer dels Tallers, 74b\", price: 30 }\n    ],\n    bars: [\n      { name: \"Espit Chupitos\", location: \"Carrer d'Aribau, 77\", price: 30, description: \"Famous shots bar with hundreds of different creative shots\" },\n      { name: \"Dow Jones Bar\", location: \"Carrer del Bruc, 97\", price: 35, description: \"Bar where drink prices fluctuate based on demand, like a stock market\" },\n      { name: \"CocoVail Beer Hall\", location: \"Carrer d'Aragó, 284\", price: 40, description: \"American-style beer hall with a wide selection of craft beers\" },\n      { name: \"Bobby's Free\", location: \"Carrer de Pau Claris, 85\", price: 45, description: \"Speakeasy cocktail bar hidden behind a barbershop façade\" },\n      { name: \"Dr. Stravinsky\", location: \"Carrer dels Mirallers, 5\", price: 50, description: \"Innovative cocktail bar with lab-like atmosphere and unique drinks\" }\n    ],\n    nightclubs: [\n      { name: \"Opium Barcelona\", location: \"Passeig Marítim, 34\", price: 60, description: \"Beachfront superclub with international DJs and ocean views\" },\n      { name: \"Pacha Barcelona\", location: \"Passeig Marítim, 38\", price: 65, description: \"Barcelona outpost of the famous Ibiza club\" },\n      { name: \"Razzmatazz\", location: \"Carrer dels Almogàvers, 122\", price: 50, description: \"Huge multi-room club with different music styles in each space\" },\n      { name: \"Shôko\", location: \"Passeig Marítim, 36\", price: 70, description: \"Beachfront restaurant that transforms into a high-energy nightclub\" },\n      { name: \"Sala Apolo\", location: \"Carrer Nou de la Rambla, 113\", price: 40, description: \"Historic venue with different themed nights\" }\n    ],\n    restaurants: [\n      { name: \"Ciudad Condal\", location: \"Rambla de Catalunya, 18\", price: 45, description: \"Popular tapas bar with a wide variety of Spanish cuisine\" },\n      { name: \"Cervecería Catalana\", location: \"Carrer de Mallorca, 236\", price: 40, description: \"Bustling tapas bar serving Spanish classics\" },\n      { name: \"El Nacional\", location: \"Passeig de Gràcia, 24\", price: 65, description: \"Multi-space culinary experience with different food areas\" },\n      { name: \"Botafumeiro\", location: \"Carrer Gran de Gràcia, 81\", price: 90, description: \"Upscale seafood restaurant favored by celebrities\" },\n      { name: \"Can Culleretes\", location: \"Carrer d'en Quintana, 5\", price: 50, description: \"The oldest restaurant in Barcelona (since 1786)\" }\n    ],\n    activities: [\n      { name: \"Boat Party Barcelona\", location: \"Port Olímpic\", price: 80, description: \"3-hour party cruise with drinks and music along the coast\" },\n      { name: \"Barça Stadium Tour\", location: \"C. d'Arístides Maillol, 12\", price: 35, description: \"Tour of Camp Nou, the legendary FC Barcelona stadium\" },\n      { name: \"Beach Club Day\", location: \"W Barcelona, Plaça Rosa Del Vents, 1\", price: 100, description: \"Day beds, cocktails and beach service at a premium beach club\" },\n      { name: \"Montjuïc Cable Car\", location: \"Av. Miramar, 30\", price: 15, description: \"Scenic cable car ride offering panoramic views of the city\" },\n      { name: \"Cooking Class\", location: \"Barcelona Cooking, La Rambla, 91\", price: 70, description: \"Interactive paella and tapas cooking class with drinks\" }\n    ],\n    tips: [\n      \"Barcelona's nightlife usually doesn't pick up until after midnight, so plan accordingly\",\n      \"The metro stops running at midnight Sunday to Thursday, and at 2 AM on Friday nights\",\n      \"Reserve tables at popular clubs in advance to avoid waiting in long lines\",\n      \"Taxis are plentiful and relatively affordable for late-night transportation\",\n      \"Pickpocketing can be common in touristy areas, especially La Rambla, so stay alert\",\n      \"Most bars in Barcelona have happy hour specials from 6-8 PM\",\n      \"Clubs often have a free guest list you can join online before 1 AM\",\n      \"Keep a copy of your hotel address in Spanish to show taxi drivers\"\n    ]\n  };\n  \n  // Set per tenere traccia dei luoghi usati per evitare duplicati\n  const usedPlaces = new Set<string>();\n  \n  // Funzione per selezionare un elemento casuale da un array senza ripetizioni\n  const getUniqueRandom = <T extends { name: string }>(array: T[]): T => {\n    const availableOptions = array.filter(item => !usedPlaces.has(item.name));\n    if (availableOptions.length === 0) {\n      // Se abbiamo usato tutte le opzioni, ripristiniamo\n      usedPlaces.clear();\n      return array[Math.floor(Math.random() * array.length)];\n    }\n    const selected = availableOptions[Math.floor(Math.random() * availableOptions.length)];\n    usedPlaces.add(selected.name);\n    return selected;\n  };\n  \n  // Temi diversi per ogni giorno\n  const dayThemes = [\n    \"The Perfect Introduction\",\n    \"Local Culture Immersion\",\n    \"Beach & Party Day\",\n    \"Final Celebration\"\n  ];\n  \n  // Crea giorni diversi per l'itinerario\n  const createDayPlan = (dayNum: number): DailyPlan => {\n    const dayActivities = [];\n    \n    // MATTINA\n    if (dayNum === 1) {\n      // Primo giorno: check-in e introduzione alla città\n      dayActivities.push({\n        time: \"11:00\",\n        activity: \"Check-in & Welcome Drinks\",\n        description: \"Arrive at your accommodation, check in, and enjoy welcome drinks while planning your adventure\",\n        location: \"Your Accommodation in Barcelona\",\n        cost: `€${(15 * budgetMultiplier).toFixed(0)} per person`\n      });\n    } else {\n      // Brunch di recupero\n      const brunchSpot = getUniqueRandom(barcelonaData.brunch);\n      dayActivities.push({\n        time: \"11:00\",\n        activity: `Recovery Brunch at ${brunchSpot.name}`,\n        description: \"Start the day with a late, hearty brunch to recover from the previous night's activities\",\n        location: brunchSpot.location,\n        cost: `€${(brunchSpot.price * budgetMultiplier).toFixed(0)} per person`\n      });\n    }\n    \n    // POMERIGGIO\n    if (dayNum === 1) {\n      // Primo giorno: tour orientativo\n      dayActivities.push({\n        time: \"14:00\",\n        activity: \"Bachelor Party Kickoff Tour\",\n        description: \"A guided walking tour of Barcelona's best bachelor party spots with a local expert\",\n        location: \"Gothic Quarter\",\n        cost: `€${(30 * budgetMultiplier).toFixed(0)} per person`\n      });\n    } else if (dayNum === request.days) {\n      // Ultimo giorno: attività speciale\n      const activity = barcelonaData.activities[0]; // Boat party\n      dayActivities.push({\n        time: \"14:00\",\n        activity: activity.name,\n        description: activity.description,\n        location: activity.location,\n        cost: `€${(activity.price * budgetMultiplier).toFixed(0)} per person`\n      });\n    } else {\n      // Altri giorni: attività varie\n      const activity = getUniqueRandom(barcelonaData.activities);\n      dayActivities.push({\n        time: \"15:00\",\n        activity: activity.name,\n        description: activity.description,\n        location: activity.location,\n        cost: `€${(activity.price * budgetMultiplier).toFixed(0)} per person`\n      });\n    }\n    \n    // SERA: Bar Crawl o Cena\n    if (request.interests.includes(\"barCrawl\")) {\n      // Se hanno selezionato bar crawl\n      const startBar = getUniqueRandom(barcelonaData.bars);\n      const secondBar = getUniqueRandom(barcelonaData.bars);\n      \n      dayActivities.push({\n        time: \"19:30\",\n        activity: `Bar Crawl Starting at ${startBar.name}`,\n        description: `Begin your epic bar crawl at ${startBar.name} (${startBar.description}), followed by ${secondBar.name} and more`,\n        location: startBar.location,\n        cost: `€${((startBar.price + secondBar.price) * budgetMultiplier).toFixed(0)} per person`\n      });\n    } else {\n      // Altrimenti, cena in ristorante\n      const restaurant = getUniqueRandom(barcelonaData.restaurants);\n      dayActivities.push({\n        time: \"20:00\",\n        activity: `Group Dinner at ${restaurant.name}`,\n        description: restaurant.description,\n        location: restaurant.location,\n        cost: `€${(restaurant.price * budgetMultiplier).toFixed(0)} per person`\n      });\n    }\n    \n    // NOTTE\n    if (request.interests.includes(\"nightclubs\")) {\n      const club = getUniqueRandom(barcelonaData.nightclubs);\n      dayActivities.push({\n        time: \"00:00\",\n        activity: `VIP Night at ${club.name}`,\n        description: `${club.description} with VIP table service and bottle service`,\n        location: club.location,\n        cost: `€${(club.price * 2 * budgetMultiplier).toFixed(0)} per person`\n      });\n    } else {\n      // Fallback per chi non ha selezionato locali notturni\n      const bar = getUniqueRandom(barcelonaData.bars);\n      dayActivities.push({\n        time: \"22:00\",\n        activity: `Premium Experience at ${bar.name}`,\n        description: bar.description,\n        location: bar.location,\n        cost: `€${(bar.price * 1.5 * budgetMultiplier).toFixed(0)} per person`\n      });\n    }\n    \n    // Genera il giorno formattato\n    return {\n      day: dayNum,\n      title: `Day ${dayNum}: ${dayThemes[Math.min(dayNum - 1, dayThemes.length - 1)]}`,\n      schedule: dayActivities,\n      notes: dayNum === 1\n        ? \"Start your bachelor party adventure with a perfect introduction to Barcelona's vibrant scene.\"\n        : dayNum === request.days\n        ? \"Make your final day in Barcelona an epic celebration to remember!\"\n        : \"Continue exploring Barcelona's incredible nightlife and culture.\"\n    };\n  };\n  \n  // Crea un giorno per ciascun giorno richiesto\n  const days = [];\n  for (let i = 1; i <= request.days; i++) {\n    days.push(createDayPlan(i));\n  }\n  \n  // Calcola il costo stimato totale basato sulle attività\n  let totalEstimated = 0;\n  days.forEach(day => {\n    day.schedule.forEach(activity => {\n      if (activity.cost) {\n        const costMatch = activity.cost.match(/€(\\d+)/);\n        if (costMatch && costMatch[1]) {\n          totalEstimated += parseInt(costMatch[1], 10);\n        }\n      }\n    });\n  });\n  \n  // Arrotonda il totale a multipli di 50\n  totalEstimated = Math.ceil(totalEstimated / 50) * 50;\n  \n  return {\n    title: `${request.theme} in ${request.destination}`,\n    destination: `${request.destination}, ${request.country}`,\n    summary: `An unforgettable ${request.days}-day bachelor party in ${request.destination}, featuring the best nightlife, activities, and experiences tailored for a group of ${request.groupSize}. Experience the vibrant atmosphere of Barcelona's famous nightlife with a carefully curated plan that fits your ${request.budget} budget.`,\n    days: days,\n    tips: barcelonaData.tips.slice(0, 5),\n    estimatedTotalCost: `€${totalEstimated} per person`\n  };\n}\n\n","path":null,"size_bytes":11689,"size_tokens":null},"client/src/lib/getyourguide.ts":{"content":"/**\n * GetYourGuide affiliate links mapping\n * Uses canonical keys for supported destinations\n */\nconst GYG_LINKS: Record<string, string> = {\n  \"rome\": \"https://gyg.me/JvxfvhRT\",\n  \"barcelona\": \"https://gyg.me/dL0Pwlqx\",\n  \"ibiza\": \"https://gyg.me/EavPKji2\",\n  \"prague\": \"https://gyg.me/JHh2phID\",\n  \"budapest\": \"https://gyg.me/fD74LpqV\",\n  \"krakow\": \"https://gyg.me/SzTVCadI\",\n  \"amsterdam\": \"https://gyg.me/cPRD7CEG\",\n  \"berlin\": \"https://gyg.me/TrvBd850\",\n  \"lisbon\": \"https://gyg.me/rZpPMi3h\",\n  \"palma-de-mallorca\": \"https://gyg.me/sXLoRnFc\",\n};\n\n/**\n * IT/EN synonyms mapping to canonical keys\n */\nconst CITY_SYNONYMS: Record<string, string> = {\n  \"roma\": \"rome\",\n  \"rome\": \"rome\",\n  \"barcellona\": \"barcelona\",\n  \"barcelona\": \"barcelona\",\n  \"ibiza\": \"ibiza\",\n  \"praga\": \"prague\",\n  \"prague\": \"prague\",\n  \"budapest\": \"budapest\",\n  \"cracovia\": \"krakow\",\n  \"krakow\": \"krakow\",\n  \"amsterdam\": \"amsterdam\",\n  \"berlino\": \"berlin\",\n  \"berlin\": \"berlin\",\n  \"lisbona\": \"lisbon\",\n  \"lisbon\": \"lisbon\",\n  \"palma\": \"palma-de-mallorca\",\n  \"palma de mallorca\": \"palma-de-mallorca\",\n  \"palma di maiorca\": \"palma-de-mallorca\",\n  \"mallorca\": \"palma-de-mallorca\",\n  \"maiorca\": \"palma-de-mallorca\",\n};\n\n/**\n * Get GetYourGuide affiliate link for a city\n * Supports IT/EN city names with normalization\n * \n * @param destinationCity - City name in IT or EN\n * @returns Affiliate URL or null if not supported\n */\nexport function getGetYourGuideCityLink(destinationCity: string | null | undefined): string | null {\n  if (!destinationCity) {\n    return null;\n  }\n\n  const normalized = destinationCity.trim().toLowerCase();\n  const canonicalKey = CITY_SYNONYMS[normalized];\n\n  if (!canonicalKey) {\n    return null;\n  }\n\n  return GYG_LINKS[canonicalKey] || null;\n}\n\n/**\n * List of supported cities for display purposes\n */\nexport const SUPPORTED_CITIES = Object.keys(GYG_LINKS);\n","path":null,"size_bytes":1859,"size_tokens":null},"vitest.setup.ts":{"content":"import '@testing-library/jest-dom/vitest';\n","path":null,"size_bytes":43,"size_tokens":null},"shared/schema.test.ts":{"content":"import { describe, it, expect } from 'vitest';\nimport {\n  insertUserSchema,\n  insertTripSchema,\n  insertExpenseSchema,\n  insertExpenseGroupSchema,\n} from './schema';\n\ndescribe('insertUserSchema', () => {\n  describe('valid data', () => {\n    it('accepts valid user data', () => {\n      const validUser = {\n        username: 'testuser',\n        password: 'password123',\n        email: 'test@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n      };\n      const result = insertUserSchema.safeParse(validUser);\n      expect(result.success).toBe(true);\n    });\n\n    it('accepts user without optional fields', () => {\n      const minimalUser = {\n        username: 'testuser',\n        password: 'password123',\n        email: 'test@example.com',\n      };\n      const result = insertUserSchema.safeParse(minimalUser);\n      expect(result.success).toBe(true);\n    });\n  });\n\n  describe('invalid data', () => {\n    it('rejects user without username', () => {\n      const invalidUser = {\n        password: 'password123',\n        email: 'test@example.com',\n      };\n      const result = insertUserSchema.safeParse(invalidUser);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects user without password', () => {\n      const invalidUser = {\n        username: 'testuser',\n        email: 'test@example.com',\n      };\n      const result = insertUserSchema.safeParse(invalidUser);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects user without email', () => {\n      const invalidUser = {\n        username: 'testuser',\n        password: 'password123',\n      };\n      const result = insertUserSchema.safeParse(invalidUser);\n      expect(result.success).toBe(false);\n    });\n  });\n});\n\ndescribe('insertTripSchema', () => {\n  const validTrip = {\n    userId: 1,\n    name: 'Summer Vacation',\n    participants: 4,\n    startDate: '2026-07-01',\n    endDate: '2026-07-15',\n    departureCity: 'Roma',\n    destinations: ['Barcelona', 'Madrid'],\n    experienceType: 'adventure',\n    budget: 2000,\n    activities: ['hiking', 'sightseeing'],\n    specialRequests: 'Vegetarian meals',\n    includeMerch: true,\n  };\n\n  describe('valid data', () => {\n    it('accepts valid trip data', () => {\n      const result = insertTripSchema.safeParse(validTrip);\n      expect(result.success).toBe(true);\n    });\n\n    it('accepts trip without optional fields', () => {\n      const minimalTrip = {\n        userId: 1,\n        name: 'Summer Vacation',\n        participants: 4,\n        startDate: '2026-07-01',\n        endDate: '2026-07-15',\n        departureCity: 'Roma',\n        experienceType: 'adventure',\n        budget: 2000,\n      };\n      const result = insertTripSchema.safeParse(minimalTrip);\n      expect(result.success).toBe(true);\n    });\n  });\n\n  describe('invalid data', () => {\n    it('rejects trip without name', () => {\n      const invalidTrip = { ...validTrip, name: undefined };\n      const result = insertTripSchema.safeParse(invalidTrip);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects trip without participants', () => {\n      const invalidTrip = { ...validTrip, participants: undefined };\n      const result = insertTripSchema.safeParse(invalidTrip);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects trip with invalid participants type', () => {\n      const invalidTrip = { ...validTrip, participants: 'four' };\n      const result = insertTripSchema.safeParse(invalidTrip);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects trip without budget', () => {\n      const invalidTrip = { ...validTrip, budget: undefined };\n      const result = insertTripSchema.safeParse(invalidTrip);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects trip with invalid budget type', () => {\n      const invalidTrip = { ...validTrip, budget: '2000' };\n      const result = insertTripSchema.safeParse(invalidTrip);\n      expect(result.success).toBe(false);\n    });\n  });\n});\n\ndescribe('insertExpenseGroupSchema', () => {\n  describe('valid data', () => {\n    it('accepts valid expense group data', () => {\n      const validGroup = {\n        name: 'Trip to Barcelona',\n        description: 'Expenses for summer trip',\n        members: ['Alice', 'Bob', 'Charlie'],\n        currency: 'EUR',\n      };\n      const result = insertExpenseGroupSchema.safeParse(validGroup);\n      expect(result.success).toBe(true);\n    });\n\n    it('accepts group without optional fields', () => {\n      const minimalGroup = {\n        name: 'Trip Expenses',\n        members: ['Alice', 'Bob'],\n      };\n      const result = insertExpenseGroupSchema.safeParse(minimalGroup);\n      expect(result.success).toBe(true);\n    });\n  });\n\n  describe('invalid data', () => {\n    it('rejects group without name', () => {\n      const invalidGroup = {\n        members: ['Alice', 'Bob'],\n      };\n      const result = insertExpenseGroupSchema.safeParse(invalidGroup);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects group without members', () => {\n      const invalidGroup = {\n        name: 'Trip Expenses',\n      };\n      const result = insertExpenseGroupSchema.safeParse(invalidGroup);\n      expect(result.success).toBe(false);\n    });\n  });\n});\n\ndescribe('insertExpenseSchema', () => {\n  const validExpense = {\n    groupId: 1,\n    description: 'Dinner at restaurant',\n    amount: 120,\n    paidBy: 'Alice',\n    splitBetween: ['Alice', 'Bob', 'Charlie'],\n    category: 'food',\n    date: '2026-07-05',\n  };\n\n  describe('valid data', () => {\n    it('accepts valid expense data', () => {\n      const result = insertExpenseSchema.safeParse(validExpense);\n      expect(result.success).toBe(true);\n    });\n  });\n\n  describe('invalid data', () => {\n    it('rejects expense without groupId', () => {\n      const invalidExpense = { ...validExpense, groupId: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense without description', () => {\n      const invalidExpense = { ...validExpense, description: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense without amount', () => {\n      const invalidExpense = { ...validExpense, amount: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense with invalid amount type', () => {\n      const invalidExpense = { ...validExpense, amount: '120' };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense without paidBy', () => {\n      const invalidExpense = { ...validExpense, paidBy: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense without splitBetween', () => {\n      const invalidExpense = { ...validExpense, splitBetween: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense without category', () => {\n      const invalidExpense = { ...validExpense, category: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n\n    it('rejects expense without date', () => {\n      const invalidExpense = { ...validExpense, date: undefined };\n      const result = insertExpenseSchema.safeParse(invalidExpense);\n      expect(result.success).toBe(false);\n    });\n  });\n});\n","path":null,"size_bytes":7623,"size_tokens":null},"client/src/contexts/LanguageContext.tsx":{"content":"import { createContext, useContext, useState, useCallback, useEffect } from 'react';\nimport itTranslations from '../locales/it.json';\n\nexport type Locale = 'it' | 'en' | 'es';\n\ninterface LanguageContextType {\n  locale: Locale;\n  setLocale: (locale: Locale) => void;\n  t: (key: string, params?: Record<string, string | number>) => string;\n}\n\nconst LanguageContext = createContext<LanguageContextType | null>(null);\n\ntype TranslationMap = Record<string, string>;\n\nconst translationCache: Record<Locale, TranslationMap | null> = {\n  it: itTranslations as TranslationMap,\n  en: null,\n  es: null,\n};\n\nasync function loadTranslations(locale: Locale): Promise<TranslationMap> {\n  if (translationCache[locale]) return translationCache[locale]!;\n\n  const modules: Record<Locale, () => Promise<{ default: TranslationMap }>> = {\n    it: () => import('../locales/it.json'),\n    en: () => import('../locales/en.json'),\n    es: () => import('../locales/es.json'),\n  };\n\n  const mod = await modules[locale]();\n  translationCache[locale] = mod.default;\n  return mod.default;\n}\n\nfunction interpolate(template: string, params?: Record<string, string | number>): string {\n  if (!params) return template;\n  return template.replace(/\\{\\{(\\w+)\\}\\}/g, (_, k) => String(params[k] ?? `{{${k}}}`));\n}\n\nfunction getInitialTranslations(locale: Locale): TranslationMap {\n  return translationCache[locale] || (itTranslations as TranslationMap);\n}\n\nexport function LanguageProvider({ children }: { children: React.ReactNode }) {\n  const [locale, setLocaleState] = useState<Locale>(() => {\n    const saved = localStorage.getItem('byebi_locale') as Locale | null;\n    return saved && ['it', 'en', 'es'].includes(saved) ? saved : 'it';\n  });\n\n  const [translations, setTranslations] = useState<TranslationMap>(() => getInitialTranslations(locale));\n\n  useEffect(() => {\n    loadTranslations(locale).then(setTranslations);\n  }, [locale]);\n\n  const setLocale = useCallback((newLocale: Locale) => {\n    setLocaleState(newLocale);\n    localStorage.setItem('byebi_locale', newLocale);\n  }, []);\n\n  const t = useCallback((key: string, params?: Record<string, string | number>): string => {\n    const value = translations[key];\n    if (value === undefined) {\n      if (import.meta.env.DEV) {\n        console.warn(`[i18n] Missing key: \"${key}\" for locale \"${locale}\"`);\n      }\n      return key;\n    }\n    return interpolate(value, params);\n  }, [translations, locale]);\n\n  return (\n    <LanguageContext.Provider value={{ locale, setLocale, t }}>\n      {children}\n    </LanguageContext.Provider>\n  );\n}\n\nexport function useTranslation() {\n  const ctx = useContext(LanguageContext);\n  if (!ctx) {\n    throw new Error('useTranslation must be used within a LanguageProvider');\n  }\n  return ctx;\n}\n\nexport function useLocale(): Locale {\n  const { locale } = useTranslation();\n  return locale;\n}\n","path":null,"size_bytes":2849,"size_tokens":null},"client/src/components/GetYourGuideCta.tsx":{"content":"import { Card, CardContent } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Compass, ExternalLink } from 'lucide-react';\nimport { getGetYourGuideCityLink } from '@/lib/getyourguide';\nimport { trackEvent } from '@/lib/track';\nimport { useTranslation } from '@/contexts/LanguageContext';\n\ninterface GetYourGuideCtaProps {\n  destinationCity?: string;\n  placement: \"itinerary\" | \"checkout\";\n  tripId?: string;\n}\n\nexport function GetYourGuideCta({ destinationCity, placement, tripId }: GetYourGuideCtaProps) {\n  const { t } = useTranslation();\n  const url = getGetYourGuideCityLink(destinationCity);\n\n  if (!url) {\n    return null;\n  }\n\n  const handleClick = () => {\n    trackEvent(\"gyg_click\", {\n      destinationCity,\n      placement,\n      tripId,\n      url\n    });\n    window.open(url, \"_blank\", \"noopener,noreferrer\");\n  };\n\n  return (\n    <Card className=\"bg-gradient-to-br from-orange-900/30 to-amber-900/30 backdrop-blur-sm border-2 border-orange-500/50 shadow-xl\">\n      <CardContent className=\"pt-6\">\n        <div className=\"flex items-start gap-4\">\n          <div className=\"p-3 bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl shadow-lg flex-shrink-0\">\n            <Compass className=\"w-6 h-6 text-white\" />\n          </div>\n          <div className=\"flex-1\">\n            <h3 className=\"text-lg font-bold text-white mb-1\">\n              {t('gyg.title', { city: destinationCity || '' })}\n            </h3>\n            <p className=\"text-white/70 text-sm mb-4\">\n              {t('gyg.subtitle')}\n            </p>\n            <Button\n              onClick={handleClick}\n              className=\"w-full sm:w-auto bg-gradient-to-r from-orange-500 to-amber-600 hover:from-orange-600 hover:to-amber-700 text-white font-semibold\"\n              data-testid={`button-gyg-${placement}`}\n            >\n              <Compass className=\"w-4 h-4 mr-2\" />\n              {t('gyg.cta')}\n              <ExternalLink className=\"w-4 h-4 ml-2\" />\n            </Button>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default GetYourGuideCta;\n","path":null,"size_bytes":2109,"size_tokens":null},"thoughts/shared/plans/2026-01-18-replace-aviasales-with-amadeus.md":{"content":"# Replace Aviasales API with Amadeus Flight Offers Search\n\n## Overview\n\nReplace the cache-based Travelpayouts/Aviasales Data API (`/v1/prices/cheap`) with the real-time Amadeus Flight Offers Search API (`/v2/shopping/flight-offers`). The current API returns empty data for future dates because it only serves cached prices from recent user searches. Amadeus provides real-time flight data for any date range.\n\n## Current State Analysis\n\n### The Problem\n- Travelpayouts `/v1/prices/cheap` is **cache-based** - only returns data from recent Aviasales website searches\n- Returns empty `{ data: {} }` for dates far in the future (e.g., May 2026)\n- Users see \"no flights found\" even though flights exist\n\n### Current Architecture\n```\nUser → Chat → OpenAI Tool (search_flights) → aviasales.ts → Travelpayouts API\n                    ↓\n              routes.ts (/api/flights/search) → aviasales.ts → Travelpayouts API\n                    ↓\n              Client displays results + Aviasales checkout URL\n```\n\n### Key Files\n- `server/services/aviasales.ts` - Current API integration (lines 15-54)\n- `server/services/openai.ts` - Tool execution (lines 430-518)\n- `server/routes.ts` - REST endpoint (lines 824-915)\n- `client/src/lib/aviasales.ts` - URL builder for checkout links\n\n## Desired End State\n\nAfter this change:\n- Flight searches return real-time data for **any future date**\n- Same authentication pattern as existing `amadeus-hotels.ts`\n- Aviasales checkout URLs still work (they're just deep links to the booking site)\n- OpenAI model receives actual flight options to present to users\n\n### Verification\n1. Search for flights to a date 6+ months in the future\n2. API returns flight options with prices\n3. OpenAI model presents flight choices to user\n4. Checkout URL redirects to Aviasales booking page\n\n## What We're NOT Doing\n\n- Not changing the Aviasales checkout URL generation (it works)\n- Not modifying the client-side flight display components\n- Not adding flight booking (redirect to Aviasales for booking)\n- Not changing the tool definition schema in OpenAI\n\n## Known Limitations\n\nAmadeus Self-Service API does **not** return:\n- American Airlines, Delta, British Airways\n- Low-cost carriers (Ryanair, EasyJet, etc.)\n\nThis is a trade-off: real-time data for any date vs. broader airline coverage.\n\n---\n\n## Phase 1: Create `amadeus-flights.ts` Service\n\n### Overview\nCreate a new flight search service using Amadeus Flight Offers Search API, following the same patterns as `amadeus-hotels.ts`.\n\n### Changes Required:\n\n#### 1. Create new service file\n**File**: `server/services/amadeus-flights.ts`\n\n```typescript\n// server/services/amadeus-flights.ts\nimport axios from \"axios\";\n\nexport type FlightSearchParams = {\n  originCode: string;      // IATA code, e.g., \"FCO\"\n  destinationCode: string; // IATA code, e.g., \"BCN\"\n  departureDate: string;   // \"2026-05-15\"\n  returnDate?: string;     // \"2026-05-20\" (optional for one-way)\n  adults: number;          // 1-9\n  currency?: string;       // \"EUR\"\n};\n\nexport type FlightSegment = {\n  departure: {\n    iataCode: string;\n    terminal?: string;\n    at: string; // ISO datetime\n  };\n  arrival: {\n    iataCode: string;\n    terminal?: string;\n    at: string;\n  };\n  carrierCode: string;\n  carrierName?: string;\n  flightNumber: string;\n  duration: string; // e.g., \"PT2H30M\"\n};\n\nexport type FlightResult = {\n  id: string;\n  price: number;\n  currency: string;\n  outbound: FlightSegment[];\n  inbound?: FlightSegment[];\n  airlines: string[];\n  totalDuration: string;\n  stops: number;\n};\n\n// Reuse token cache from amadeus-hotels or create shared module\nconst isProd = process.env.NODE_ENV === \"production\";\nconst useAmadeusLive = process.env.AMADEUS_ENV === \"production\";\n\nconst AMADEUS_API_KEY = useAmadeusLive\n  ? process.env.AMADEUS_API_KEY_LIVE\n  : process.env.AMADEUS_API_KEY_TEST;\n\nconst AMADEUS_API_SECRET = useAmadeusLive\n  ? process.env.AMADEUS_API_SECRET_LIVE\n  : process.env.AMADEUS_API_SECRET_TEST;\n\nconst AMADEUS_BASE_URL = useAmadeusLive\n  ? \"https://api.amadeus.com\"\n  : \"https://test.api.amadeus.com\";\n\nlet tokenCache: { token: string | null; expiresAt: number } = {\n  token: null,\n  expiresAt: 0,\n};\n\nasync function getAmadeusToken(): Promise<string> {\n  if (tokenCache.token && tokenCache.expiresAt > Date.now() + 10_000) {\n    return tokenCache.token;\n  }\n\n  if (!AMADEUS_API_KEY || !AMADEUS_API_SECRET) {\n    throw new Error(\"Amadeus credentials are not configured\");\n  }\n\n  const body = new URLSearchParams({\n    grant_type: \"client_credentials\",\n    client_id: AMADEUS_API_KEY,\n    client_secret: AMADEUS_API_SECRET,\n  });\n\n  const resp = await axios.post(\n    `${AMADEUS_BASE_URL}/v1/security/oauth2/token`,\n    body,\n    { headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" } }\n  );\n\n  tokenCache = {\n    token: resp.data.access_token,\n    expiresAt: Date.now() + (resp.data.expires_in - 60) * 1000,\n  };\n\n  return tokenCache.token!;\n}\n\n// Airline code to name mapping (common carriers)\nconst AIRLINE_NAMES: Record<string, string> = {\n  \"IB\": \"Iberia\",\n  \"VY\": \"Vueling\",\n  \"UX\": \"Air Europa\",\n  \"AZ\": \"ITA Airways\",\n  \"LH\": \"Lufthansa\",\n  \"AF\": \"Air France\",\n  \"KL\": \"KLM\",\n  \"BA\": \"British Airways\",\n  \"LX\": \"Swiss\",\n  \"OS\": \"Austrian\",\n  \"SN\": \"Brussels Airlines\",\n  \"TP\": \"TAP Portugal\",\n  \"TK\": \"Turkish Airlines\",\n  \"EW\": \"Eurowings\",\n  \"A3\": \"Aegean\",\n};\n\nexport async function searchFlights(\n  params: FlightSearchParams\n): Promise<FlightResult[]> {\n  const {\n    originCode,\n    destinationCode,\n    departureDate,\n    returnDate,\n    adults,\n    currency = \"EUR\",\n  } = params;\n\n  const token = await getAmadeusToken();\n\n  console.log(\"🔍 Amadeus Flight Search request:\", {\n    originCode,\n    destinationCode,\n    departureDate,\n    returnDate,\n    adults,\n  });\n\n  try {\n    const queryParams: Record<string, string | number> = {\n      originLocationCode: originCode,\n      destinationLocationCode: destinationCode,\n      departureDate,\n      adults,\n      currencyCode: currency,\n      max: 10, // Limit results\n    };\n\n    if (returnDate) {\n      queryParams.returnDate = returnDate;\n    }\n\n    const resp = await axios.get(\n      `${AMADEUS_BASE_URL}/v2/shopping/flight-offers`,\n      {\n        headers: { Authorization: `Bearer ${token}` },\n        params: queryParams,\n      }\n    );\n\n    console.log(\"📦 Amadeus Flight Search response:\", {\n      status: resp.status,\n      count: resp.data?.data?.length || 0,\n    });\n\n    const offers = resp.data?.data || [];\n    const dictionaries = resp.data?.dictionaries || {};\n\n    return offers.map((offer: any) => transformFlightOffer(offer, dictionaries, currency));\n  } catch (error: any) {\n    console.error(\"❌ Amadeus Flight Search error:\", {\n      status: error.response?.status,\n      data: error.response?.data,\n      message: error.message,\n    });\n\n    // Return empty array on error (don't throw)\n    return [];\n  }\n}\n\nfunction transformFlightOffer(\n  offer: any,\n  dictionaries: any,\n  currency: string\n): FlightResult {\n  const itineraries = offer.itineraries || [];\n  const outboundItinerary = itineraries[0];\n  const inboundItinerary = itineraries[1];\n\n  const outboundSegments = (outboundItinerary?.segments || []).map((seg: any) =>\n    transformSegment(seg, dictionaries)\n  );\n  const inboundSegments = inboundItinerary\n    ? (inboundItinerary.segments || []).map((seg: any) =>\n        transformSegment(seg, dictionaries)\n      )\n    : undefined;\n\n  // Collect unique airline codes\n  const airlineCodes = new Set<string>();\n  outboundSegments.forEach((s: FlightSegment) => airlineCodes.add(s.carrierCode));\n  if (inboundSegments) {\n    inboundSegments.forEach((s: FlightSegment) => airlineCodes.add(s.carrierCode));\n  }\n\n  const airlines = Array.from(airlineCodes).map(\n    (code) =>\n      dictionaries?.carriers?.[code] ||\n      AIRLINE_NAMES[code] ||\n      code\n  );\n\n  return {\n    id: offer.id,\n    price: parseFloat(offer.price?.total || \"0\"),\n    currency: offer.price?.currency || currency,\n    outbound: outboundSegments,\n    inbound: inboundSegments,\n    airlines,\n    totalDuration: outboundItinerary?.duration || \"\",\n    stops: Math.max(0, outboundSegments.length - 1),\n  };\n}\n\nfunction transformSegment(seg: any, dictionaries: any): FlightSegment {\n  return {\n    departure: {\n      iataCode: seg.departure?.iataCode || \"\",\n      terminal: seg.departure?.terminal,\n      at: seg.departure?.at || \"\",\n    },\n    arrival: {\n      iataCode: seg.arrival?.iataCode || \"\",\n      terminal: seg.arrival?.terminal,\n      at: seg.arrival?.at || \"\",\n    },\n    carrierCode: seg.carrierCode || \"\",\n    carrierName:\n      dictionaries?.carriers?.[seg.carrierCode] ||\n      AIRLINE_NAMES[seg.carrierCode] ||\n      seg.carrierCode,\n    flightNumber: seg.number || \"\",\n    duration: seg.duration || \"\",\n  };\n}\n```\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] TypeScript compiles: `npx tsc --noEmit`\n- [ ] File exists at `server/services/amadeus-flights.ts`\n\n#### Manual Verification:\n- [ ] N/A for this phase (tested in Phase 2)\n\n---\n\n## Phase 2: Update Server Routes\n\n### Overview\nUpdate the `/api/flights/search` REST endpoint to use the new Amadeus service.\n\n### Changes Required:\n\n#### 1. Update routes.ts\n**File**: `server/routes.ts`\n**Lines**: 824-915 (replace the existing `/api/flights/search` handler)\n\n```typescript\n// Replace import at top of file\n// OLD: import { searchCheapestFlights } from \"./services/aviasales\";\n// NEW: import { searchFlights } from \"./services/amadeus-flights\";\n\napp.get(\"/api/flights/search\", async (req: Request, res: Response) => {\n  try {\n    const { origin, destination, departDate, returnDate, passengers } = req.query;\n\n    console.log(\"🔍 /api/flights/search called with:\", {\n      origin,\n      destination,\n      departDate,\n      returnDate,\n      passengers,\n    });\n\n    // Helper to extract IATA code\n    const extractIata = (input: string): string => {\n      const parenMatch = input.match(/\\(([A-Z]{3})\\)/i);\n      if (parenMatch) return parenMatch[1].toUpperCase();\n\n      const { cityToIata } = require(\"./services/cityMapping\");\n      const mapped = cityToIata(input);\n      if (mapped) return mapped;\n\n      if (/^[A-Z]{3}$/i.test(input.trim())) return input.trim().toUpperCase();\n\n      return input.substring(0, 3).toUpperCase();\n    };\n\n    const originIata = extractIata(String(origin || \"\"));\n    const destIata = extractIata(String(destination || \"\"));\n\n    console.log(\"✈️ Resolved IATA codes:\", { originIata, destIata });\n\n    const { searchFlights } = await import(\"./services/amadeus-flights\");\n\n    const flights = await searchFlights({\n      originCode: originIata,\n      destinationCode: destIata,\n      departureDate: String(departDate || \"\"),\n      returnDate: returnDate ? String(returnDate) : undefined,\n      adults: Number(passengers) || 1,\n      currency: \"EUR\",\n    });\n\n    // Transform to match expected client format + add Aviasales checkout URLs\n    const numPassengers = Number(passengers) || 1;\n    const transformedFlights = flights.map((f, idx) => {\n      // Build Aviasales checkout URL from flight dates\n      const depDate = f.outbound[0]?.departure.at?.slice(0, 10) || String(departDate);\n      const retDate = f.inbound?.[0]?.departure.at?.slice(0, 10) || String(returnDate) || depDate;\n      const depDay = depDate.slice(8, 10);\n      const depMonth = depDate.slice(5, 7);\n      const retDay = retDate.slice(8, 10);\n      const retMonth = retDate.slice(5, 7);\n\n      const checkoutUrl = `https://www.aviasales.com/search/${originIata}${depDay}${depMonth}${destIata}${retDay}${retMonth}${numPassengers}?marker=${process.env.AVIASALES_PARTNER_ID || \"byebi\"}`;\n\n      return {\n        id: f.id,\n        airline: f.airlines.join(\", \"),\n        price: f.price,\n        currency: f.currency,\n        departure_at: f.outbound[0]?.departure.at,\n        return_at: f.inbound?.[0]?.departure.at,\n        stops: f.stops,\n        duration: f.totalDuration,\n        checkoutUrl,\n      };\n    });\n\n    console.log(\"✅ Returning\", transformedFlights.length, \"flights\");\n\n    return res.json({\n      flights: transformedFlights,\n      origin: originIata,\n      destination: destIata,\n    });\n  } catch (err: any) {\n    console.error(\"Flight search error:\", err.message);\n    return res.status(500).json({\n      error: \"Flight search failed\",\n      details: err.message,\n      flights: [],\n    });\n  }\n});\n```\n\n#### 2. Remove old aviasales import\n**File**: `server/routes.ts`\n**Line**: 16\n\nRemove or comment out:\n```typescript\n// import { searchCheapestFlights } from \"./services/aviasales\";\n```\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] TypeScript compiles: `npx tsc --noEmit`\n- [ ] Server starts: `npm run dev`\n\n#### Manual Verification:\n- [ ] Call `/api/flights/search?origin=Rome&destination=Barcelona&departDate=2026-06-15&returnDate=2026-06-20&passengers=4`\n- [ ] Response contains flights with prices\n- [ ] Each flight has a valid `checkoutUrl`\n\n**Implementation Note**: Test the REST endpoint manually before proceeding to Phase 3.\n\n---\n\n## Phase 3: Update OpenAI Tool Execution\n\n### Overview\nUpdate the `search_flights` tool in `openai.ts` to use the new Amadeus service.\n\n### Changes Required:\n\n#### 1. Update search_flights case\n**File**: `server/services/openai.ts`\n**Lines**: 430-518 (replace the existing case)\n\n```typescript\ncase \"search_flights\": {\n  const { searchFlights } = await import(\"./amadeus-flights\");\n  const { cityToIata } = await import(\"./cityMapping\");\n\n  // Helper to extract IATA code from strings like \"Fiumicino (FCO)\"\n  const extractIata = (input: string): string => {\n    const parenMatch = input.match(/\\(([A-Z]{3})\\)/i);\n    if (parenMatch) return parenMatch[1].toUpperCase();\n    const mapped = cityToIata(input);\n    if (mapped) return mapped;\n    if (/^[A-Z]{3}$/i.test(input.trim())) return input.trim().toUpperCase();\n    return input.substring(0, 3).toUpperCase();\n  };\n\n  const originCity = typeof args.origin === \"string\" ? args.origin : \"\";\n  const destCity = typeof args.destination === \"string\" ? args.destination : \"\";\n  const originIata = extractIata(originCity);\n  const destIata = extractIata(destCity);\n  const numPassengers = typeof args.passengers === \"number\" ? args.passengers : 1;\n  const departureDate = typeof args.departure_date === \"string\" ? args.departure_date : \"\";\n  const returnDate = typeof args.return_date === \"string\" ? args.return_date : undefined;\n\n  console.log(\"🔍 search_flights tool called with:\", {\n    originCity,\n    destCity,\n    originIata,\n    destIata,\n    departure_date: departureDate,\n    return_date: returnDate,\n    passengers: numPassengers,\n  });\n\n  try {\n    const flightResults = await searchFlights({\n      originCode: originIata,\n      destinationCode: destIata,\n      departureDate,\n      returnDate,\n      adults: numPassengers,\n      currency: \"EUR\",\n    });\n\n    console.log(\"📦 Amadeus returned\", flightResults.length, \"flights\");\n\n    // Transform to simplified format for OpenAI + add checkout URLs\n    const flights = flightResults.slice(0, 5).map((f) => {\n      const depDate = f.outbound[0]?.departure.at?.slice(0, 10) || departureDate;\n      const retDate = f.inbound?.[0]?.departure.at?.slice(0, 10) || returnDate || depDate;\n      const depDay = depDate.slice(8, 10);\n      const depMonth = depDate.slice(5, 7);\n      const retDay = retDate.slice(8, 10);\n      const retMonth = retDate.slice(5, 7);\n\n      const checkoutUrl = `https://www.aviasales.com/search/${originIata}${depDay}${depMonth}${destIata}${retDay}${retMonth}${numPassengers}?marker=${process.env.AVIASALES_PARTNER_ID || \"byebi\"}`;\n\n      return {\n        airline: f.airlines.join(\", \"),\n        price: f.price,\n        currency: f.currency,\n        departure_at: f.outbound[0]?.departure.at,\n        return_at: f.inbound?.[0]?.departure.at,\n        stops: f.stops,\n        duration: f.totalDuration,\n        checkoutUrl,\n      };\n    });\n\n    console.log(\"✅ Transformed flights:\", JSON.stringify(flights, null, 2));\n\n    return { flights, origin: originIata, destination: destIata };\n  } catch (error) {\n    console.error(\"❌ Flight search error:\", error);\n    return { error: \"Failed to search flights. Please try again.\", flights: [] };\n  }\n}\n```\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] TypeScript compiles: `npx tsc --noEmit`\n- [ ] Tests pass: `npm test`\n\n#### Manual Verification:\n- [ ] Start chat and ask: \"Search flights from Rome to Barcelona for June 15-20, 2026 for 4 people\"\n- [ ] OpenAI model responds with flight options (not \"no flights found\")\n- [ ] Flight cards appear in UI with prices and checkout links\n\n**Implementation Note**: Full end-to-end test with the chat interface.\n\n---\n\n## Phase 4: Update Tests\n\n### Overview\nUpdate the test mocks to use the new Amadeus service.\n\n### Changes Required:\n\n#### 1. Update mocks in openai.test.ts\n**File**: `server/services/openai.test.ts`\n\nReplace the aviasales mock with amadeus-flights mock:\n\n```typescript\n// Replace this mock:\nvi.mock('./aviasales', () => ({\n  searchCheapestFlights: vi.fn()\n}));\n\n// With:\nvi.mock('./amadeus-flights', () => ({\n  searchFlights: vi.fn()\n}));\n```\n\nUpdate the test cases to use the new mock:\n\n```typescript\ndescribe('search_flights tool', () => {\n  it('calls Amadeus API with correct IATA codes and generates checkoutUrl', async () => {\n    const { searchFlights } = await import('./amadeus-flights');\n    vi.mocked(searchFlights).mockResolvedValue([\n      {\n        id: '1',\n        price: 150,\n        currency: 'EUR',\n        outbound: [{\n          departure: { iataCode: 'ROM', at: '2025-06-15T10:00:00' },\n          arrival: { iataCode: 'BCN', at: '2025-06-15T12:30:00' },\n          carrierCode: 'IB',\n          carrierName: 'Iberia',\n          flightNumber: '123',\n          duration: 'PT2H30M'\n        }],\n        inbound: [{\n          departure: { iataCode: 'BCN', at: '2025-06-20T18:00:00' },\n          arrival: { iataCode: 'ROM', at: '2025-06-20T20:30:00' },\n          carrierCode: 'IB',\n          carrierName: 'Iberia',\n          flightNumber: '456',\n          duration: 'PT2H30M'\n        }],\n        airlines: ['Iberia'],\n        totalDuration: 'PT2H30M',\n        stops: 0\n      }\n    ]);\n\n    const result = await executeToolCall('search_flights', {\n      origin: 'Rome',\n      destination: 'Barcelona',\n      departure_date: '2025-06-15',\n      return_date: '2025-06-20',\n      passengers: 5\n    }, {});\n\n    expect(searchFlights).toHaveBeenCalledWith({\n      originCode: 'ROM',\n      destinationCode: 'BCN',\n      departureDate: '2025-06-15',\n      returnDate: '2025-06-20',\n      adults: 5,\n      currency: 'EUR'\n    });\n\n    expect(result.flights).toHaveLength(1);\n    const flight = (result.flights as any[])[0];\n    expect(flight.airline).toBe('Iberia');\n    expect(flight.price).toBe(150);\n    expect(flight.checkoutUrl).toContain('https://www.aviasales.com/search/ROM1506BCN2006');\n    expect(flight.checkoutUrl).toContain('5'); // passengers\n  });\n\n  // ... update other test cases similarly\n});\n```\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] All tests pass: `npm test`\n- [ ] No TypeScript errors: `npx tsc --noEmit`\n\n#### Manual Verification:\n- [ ] N/A\n\n---\n\n## Testing Strategy\n\n### Unit Tests\n- Mock `searchFlights` function\n- Test IATA extraction for various formats\n- Test checkout URL generation\n- Test error handling\n\n### Integration Tests\n- Test REST endpoint with real Amadeus test API\n- Verify response format matches client expectations\n\n### Manual Testing Steps\n1. Start dev server: `npm run dev`\n2. Open chat dialog\n3. Type: \"I want to fly from Rome to Barcelona on June 15-20, 2026 with 4 friends\"\n4. Verify:\n   - Server logs show Amadeus API request/response\n   - Model responds with flight options\n   - Flight cards appear in UI\n   - Checkout URLs work (redirect to Aviasales)\n\n## Migration Notes\n\n- The old `aviasales.ts` can be kept temporarily for reference\n- Client-side `aviasales.ts` URL builder remains unchanged\n- Environment variables remain the same (Amadeus credentials already configured)\n\n## References\n\n- [Amadeus Flight Offers Search API](https://developers.amadeus.com/self-service/category/flights/api-doc/flight-offers-search)\n- Existing implementation: `server/services/amadeus-hotels.ts`\n- Current Aviasales implementation: `server/services/aviasales.ts`\n","path":null,"size_bytes":20310,"size_tokens":null},"server/services/openai.integration.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport type { StreamChunk } from './openai';\n\n// Mock OpenAI module with a proper class\nconst mockCreate = vi.fn();\nvi.mock('openai', () => {\n  return {\n    default: class MockOpenAI {\n      chat = {\n        completions: {\n          create: mockCreate\n        }\n      };\n    }\n  };\n});\n\n// Mock amadeus-flights\nvi.mock('./amadeus-flights', () => ({\n  searchFlights: vi.fn().mockResolvedValue([\n    {\n      id: '1',\n      price: 89,\n      currency: 'EUR',\n      outbound: [{\n        departure: { iataCode: 'ROM', at: '2025-06-15T10:00:00' },\n        arrival: { iataCode: 'BCN', at: '2025-06-15T12:30:00' },\n        carrierCode: 'VY',\n        carrierName: 'Vueling',\n        flightNumber: '456',\n        duration: 'PT2H30M'\n      }],\n      inbound: [{\n        departure: { iataCode: 'BCN', at: '2025-06-20T18:00:00' },\n        arrival: { iataCode: 'ROM', at: '2025-06-20T20:30:00' },\n        carrierCode: 'VY',\n        carrierName: 'Vueling',\n        flightNumber: '789',\n        duration: 'PT2H30M'\n      }],\n      airlines: ['Vueling'],\n      totalDuration: 'PT2H30M',\n      stops: 0\n    }\n  ])\n}));\n\n// Mock cityMapping\nvi.mock('./cityMapping', () => ({\n  cityToIata: vi.fn((city: string) => {\n    const mapping: Record<string, string> = {\n      'Rome': 'ROM',\n      'Barcelona': 'BCN'\n    };\n    return mapping[city] || null;\n  }),\n  iataToCity: vi.fn((iata: string) => {\n    const mapping: Record<string, string> = {\n      'ROM': 'Rome',\n      'BCN': 'Barcelona'\n    };\n    return mapping[iata] || null;\n  })\n}));\n\n// Helper to create mock async iterator for streaming\nfunction createMockStream(events: Array<{\n  content?: string;\n  tool_call?: { id: string; name: string; arguments: string };\n  finish?: string;\n}>) {\n  return {\n    [Symbol.asyncIterator]: async function* () {\n      for (const event of events) {\n        if (event.content) {\n          yield {\n            choices: [{\n              delta: { content: event.content },\n              finish_reason: null\n            }]\n          };\n        }\n        if (event.tool_call) {\n          yield {\n            choices: [{\n              delta: {\n                tool_calls: [{\n                  index: 0,\n                  id: event.tool_call.id,\n                  function: {\n                    name: event.tool_call.name,\n                    arguments: event.tool_call.arguments\n                  }\n                }]\n              },\n              finish_reason: null\n            }]\n          };\n        }\n        if (event.finish) {\n          yield {\n            choices: [{\n              delta: {},\n              finish_reason: event.finish\n            }]\n          };\n        }\n      }\n    }\n  };\n}\n\ndescribe('streamOpenAIChatCompletionWithTools integration', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n  });\n\n  it('streams content without tool calls', async () => {\n    // Import fresh after mocks are set\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'Hello! ' },\n      { content: 'How can I help you today?' },\n      { finish: 'stop' }\n    ]));\n\n    const chunks: StreamChunk[] = [];\n    for await (const chunk of streamOpenAIChatCompletionWithTools('Hi', {}, [])) {\n      chunks.push(chunk);\n    }\n\n    expect(mockCreate).toHaveBeenCalledTimes(1);\n\n    const contentChunks = chunks.filter(c => c.type === 'content');\n    expect(contentChunks).toHaveLength(2);\n\n    const fullContent = contentChunks.map(c => (c as any).content).join('');\n    expect(fullContent).toBe('Hello! How can I help you today?');\n  });\n\n  it('handles single tool call and continues conversation', async () => {\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    // First call: model returns tool call for set_destination\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'Barcelona sounds great! ' },\n      {\n        tool_call: {\n          id: 'call_123',\n          name: 'set_destination',\n          arguments: '{\"city\":\"Barcelona\"}'\n        }\n      },\n      { finish: 'tool_calls' }\n    ]));\n\n    // Second call: model responds naturally after receiving tool result\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'When would you like to travel?' },\n      { finish: 'stop' }\n    ]));\n\n    const chunks: StreamChunk[] = [];\n    for await (const chunk of streamOpenAIChatCompletionWithTools(\n      'I want to go to Barcelona',\n      {},\n      []\n    )) {\n      chunks.push(chunk);\n    }\n\n    // Verify OpenAI was called twice (initial + after tool result)\n    expect(mockCreate).toHaveBeenCalledTimes(2);\n\n    // Verify tool call was emitted\n    const toolCallChunks = chunks.filter(c => c.type === 'tool_call');\n    expect(toolCallChunks).toHaveLength(1);\n    expect((toolCallChunks[0] as any).toolCall.name).toBe('set_destination');\n\n    // Verify tool result was emitted\n    const toolResultChunks = chunks.filter(c => c.type === 'tool_result');\n    expect(toolResultChunks).toHaveLength(1);\n    expect((toolResultChunks[0] as any).name).toBe('set_destination');\n    expect((toolResultChunks[0] as any).result).toEqual({ success: true, destination: 'Barcelona' });\n\n    // Verify final content includes follow-up question\n    const contentChunks = chunks.filter(c => c.type === 'content');\n    const fullContent = contentChunks.map(c => (c as any).content).join('');\n    expect(fullContent).toContain('Barcelona');\n    expect(fullContent).toContain('travel');\n  });\n\n  it('handles search_flights tool with API call', async () => {\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    // First call: model calls search_flights\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'Let me search for flights... ' },\n      {\n        tool_call: {\n          id: 'call_456',\n          name: 'search_flights',\n          arguments: JSON.stringify({\n            origin: 'Rome',\n            destination: 'Barcelona',\n            departure_date: '2025-06-15',\n            return_date: '2025-06-20',\n            passengers: 2\n          })\n        }\n      },\n      { finish: 'tool_calls' }\n    ]));\n\n    // Second call: model presents flight options\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'I found a great flight with Vueling!' },\n      { finish: 'stop' }\n    ]));\n\n    const chunks: StreamChunk[] = [];\n    for await (const chunk of streamOpenAIChatCompletionWithTools(\n      'Find flights from Rome to Barcelona June 15-20 for 2 people',\n      { selectedDestination: 'Barcelona' },\n      []\n    )) {\n      chunks.push(chunk);\n    }\n\n    // Verify tool result contains flight data\n    const toolResultChunks = chunks.filter(c => c.type === 'tool_result');\n    expect(toolResultChunks).toHaveLength(1);\n\n    const flightResult = (toolResultChunks[0] as any).result;\n    expect(flightResult.flights).toBeDefined();\n    expect(flightResult.flights.length).toBeGreaterThan(0);\n    expect(flightResult.flights[0].airline).toBe('Vueling');\n  });\n\n  it('handles multiple tool calls in sequence', async () => {\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    // First call: set_destination\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      {\n        tool_call: {\n          id: 'call_1',\n          name: 'set_destination',\n          arguments: '{\"city\":\"Barcelona\"}'\n        }\n      },\n      { finish: 'tool_calls' }\n    ]));\n\n    // Second call: set_origin\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      {\n        tool_call: {\n          id: 'call_2',\n          name: 'set_origin',\n          arguments: '{\"city\":\"Rome\"}'\n        }\n      },\n      { finish: 'tool_calls' }\n    ]));\n\n    // Third call: final response\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'When are you planning to travel?' },\n      { finish: 'stop' }\n    ]));\n\n    const chunks: StreamChunk[] = [];\n    for await (const chunk of streamOpenAIChatCompletionWithTools(\n      'I want to fly from Rome to Barcelona',\n      {},\n      []\n    )) {\n      chunks.push(chunk);\n    }\n\n    // Verify OpenAI was called 3 times\n    expect(mockCreate).toHaveBeenCalledTimes(3);\n\n    // Verify both tool calls were emitted\n    const toolCallChunks = chunks.filter(c => c.type === 'tool_call');\n    expect(toolCallChunks).toHaveLength(2);\n    expect((toolCallChunks[0] as any).toolCall.name).toBe('set_destination');\n    expect((toolCallChunks[1] as any).toolCall.name).toBe('set_origin');\n  });\n\n  it('stops loop when no tool calls are returned', async () => {\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'I can help you plan a trip. Where would you like to go?' },\n      { finish: 'stop' }\n    ]));\n\n    const chunks: StreamChunk[] = [];\n    for await (const chunk of streamOpenAIChatCompletionWithTools('Help me plan a trip', {}, [])) {\n      chunks.push(chunk);\n    }\n\n    // Should only call OpenAI once since no tools were invoked\n    expect(mockCreate).toHaveBeenCalledTimes(1);\n\n    // Should not have any tool calls\n    const toolCallChunks = chunks.filter(c => c.type === 'tool_call');\n    expect(toolCallChunks).toHaveLength(0);\n  });\n\n  it('handles unlock_checkout tool', async () => {\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'Taking you to checkout now! ' },\n      {\n        tool_call: {\n          id: 'call_checkout',\n          name: 'unlock_checkout',\n          arguments: '{}'\n        }\n      },\n      { finish: 'tool_calls' }\n    ]));\n\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'Your checkout is ready!' },\n      { finish: 'stop' }\n    ]));\n\n    const chunks: StreamChunk[] = [];\n    for await (const chunk of streamOpenAIChatCompletionWithTools(\n      'Yes, proceed to checkout',\n      { selectedDestination: 'Barcelona' },\n      []\n    )) {\n      chunks.push(chunk);\n    }\n\n    const toolResultChunks = chunks.filter(c => c.type === 'tool_result');\n    expect(toolResultChunks).toHaveLength(1);\n    expect((toolResultChunks[0] as any).result).toEqual({\n      success: true,\n      checkout_unlocked: true\n    });\n  });\n\n  it('passes context to system prompt', async () => {\n    const { streamOpenAIChatCompletionWithTools } = await import('./openai');\n\n    mockCreate.mockResolvedValueOnce(createMockStream([\n      { content: 'I see you want to go to Barcelona!' },\n      { finish: 'stop' }\n    ]));\n\n    const context = {\n      selectedDestination: 'Barcelona',\n      tripDetails: { people: 5, days: 3 },\n      partyType: 'bachelor' as const,\n      originCityName: 'Rome'\n    };\n\n    for await (const _ of streamOpenAIChatCompletionWithTools('Hello', context, [])) {\n      // consume the stream\n    }\n\n    // Check that the system prompt includes context\n    const callArgs = mockCreate.mock.calls[0][0];\n    const systemMessage = callArgs.messages.find((m: any) => m.role === 'system');\n    expect(systemMessage.content).toContain('Barcelona');\n  });\n});\n","path":null,"size_bytes":11240,"size_tokens":null},"server/services/openai.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\n\n// Mock OpenAI before importing the module\nvi.mock('openai', () => {\n  return {\n    default: class MockOpenAI {\n      chat = {\n        completions: {\n          create: vi.fn()\n        }\n      };\n    }\n  };\n});\n\n// Mock external dependencies\nvi.mock('./amadeus-flights', () => ({\n  searchFlights: vi.fn()\n}));\n\nvi.mock('./amadeus-hotels', () => ({\n  searchHotels: vi.fn()\n}));\n\nvi.mock('./cityMapping', () => ({\n  cityToIata: vi.fn((city: string) => {\n    const mapping: Record<string, string> = {\n      'Rome': 'ROM',\n      'Barcelona': 'BCN',\n      'Milan': 'MIL',\n      'Ibiza': 'IBZ',\n      'Prague': 'PRG'\n    };\n    return mapping[city] || null;\n  }),\n  iataToCity: vi.fn((iata: string) => {\n    const mapping: Record<string, string> = {\n      'ROM': 'Rome',\n      'BCN': 'Barcelona',\n      'MIL': 'Milan',\n      'IBZ': 'Ibiza',\n      'PRG': 'Prague'\n    };\n    return mapping[iata] || null;\n  })\n}));\n\n// Import after mocks are set up\nimport { executeToolCall } from './openai';\n\ndescribe('executeToolCall', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('set_destination tool', () => {\n    it('returns success with the destination city', async () => {\n      const result = await executeToolCall('set_destination', { city: 'Barcelona' }, {});\n      expect(result).toEqual({ success: true, destination: 'Barcelona' });\n    });\n\n    it('handles empty city gracefully', async () => {\n      const result = await executeToolCall('set_destination', { city: '' }, {});\n      expect(result).toEqual({ success: true, destination: '' });\n    });\n  });\n\n  describe('set_origin tool', () => {\n    it('returns success with the origin city', async () => {\n      const result = await executeToolCall('set_origin', { city: 'Rome' }, {});\n      expect(result).toEqual({ success: true, origin: 'Rome' });\n    });\n\n    it('handles different cities', async () => {\n      const result = await executeToolCall('set_origin', { city: 'Milan' }, {});\n      expect(result).toEqual({ success: true, origin: 'Milan' });\n    });\n  });\n\n  describe('set_dates tool', () => {\n    it('returns success with departure and return dates', async () => {\n      const result = await executeToolCall('set_dates', {\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20'\n      }, {});\n      expect(result).toEqual({\n        success: true,\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20'\n      });\n    });\n\n    it('handles dates close together', async () => {\n      const result = await executeToolCall('set_dates', {\n        departure_date: '2025-07-01',\n        return_date: '2025-07-02'\n      }, {});\n      expect(result).toEqual({\n        success: true,\n        departure_date: '2025-07-01',\n        return_date: '2025-07-02'\n      });\n    });\n  });\n\n  describe('set_participants tool', () => {\n    it('returns success with participant count', async () => {\n      const result = await executeToolCall('set_participants', { count: 5 }, {});\n      expect(result).toEqual({ success: true, participants: 5 });\n    });\n\n    it('handles single participant', async () => {\n      const result = await executeToolCall('set_participants', { count: 1 }, {});\n      expect(result).toEqual({ success: true, participants: 1 });\n    });\n\n    it('handles large groups', async () => {\n      const result = await executeToolCall('set_participants', { count: 20 }, {});\n      expect(result).toEqual({ success: true, participants: 20 });\n    });\n  });\n\n  describe('search_flights tool', () => {\n    it('calls Amadeus API with correct IATA codes and generates checkoutUrl', async () => {\n      const { searchFlights } = await import('./amadeus-flights');\n      vi.mocked(searchFlights).mockResolvedValue([\n        {\n          id: '1',\n          price: 150,\n          currency: 'EUR',\n          outbound: [{\n            departure: { iataCode: 'ROM', at: '2025-06-15T10:00:00' },\n            arrival: { iataCode: 'BCN', at: '2025-06-15T12:30:00' },\n            carrierCode: 'IB',\n            carrierName: 'Iberia',\n            flightNumber: '123',\n            duration: 'PT2H30M'\n          }],\n          inbound: [{\n            departure: { iataCode: 'BCN', at: '2025-06-20T18:00:00' },\n            arrival: { iataCode: 'ROM', at: '2025-06-20T20:30:00' },\n            carrierCode: 'IB',\n            carrierName: 'Iberia',\n            flightNumber: '456',\n            duration: 'PT2H30M'\n          }],\n          airlines: ['Iberia'],\n          totalDuration: 'PT2H30M',\n          stops: 0\n        }\n      ]);\n\n      const result = await executeToolCall('search_flights', {\n        origin: 'Rome',\n        destination: 'Barcelona',\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20',\n        passengers: 5\n      }, {});\n\n      expect(searchFlights).toHaveBeenCalledWith({\n        originCode: 'ROM',\n        destinationCode: 'BCN',\n        departureDate: '2025-06-15',\n        returnDate: '2025-06-20',\n        adults: 5,\n        currency: 'EUR'\n      });\n\n      expect(result.flights).toHaveLength(1);\n      const flight = (result.flights as any[])[0];\n      expect(flight.airline).toBe('Iberia');\n      expect(flight.price).toBe(150);\n      // Verify checkoutUrl is generated with correct format\n      expect(flight.checkoutUrl).toContain('https://www.aviasales.com/search/ROM1506BCN2006');\n      expect(flight.checkoutUrl).toContain('5'); // passengers\n    });\n\n    it('handles multiple flight results', async () => {\n      const { searchFlights } = await import('./amadeus-flights');\n      vi.mocked(searchFlights).mockResolvedValue([\n        {\n          id: '1', price: 150, currency: 'EUR',\n          outbound: [{ departure: { iataCode: 'ROM', at: '2025-06-15T10:00:00' }, arrival: { iataCode: 'BCN', at: '2025-06-15T12:30:00' }, carrierCode: 'IB', flightNumber: '123', duration: 'PT2H30M' }],\n          inbound: [{ departure: { iataCode: 'BCN', at: '2025-06-20T18:00:00' }, arrival: { iataCode: 'ROM', at: '2025-06-20T20:30:00' }, carrierCode: 'IB', flightNumber: '456', duration: 'PT2H30M' }],\n          airlines: ['Iberia'], totalDuration: 'PT2H30M', stops: 0\n        },\n        {\n          id: '2', price: 180, currency: 'EUR',\n          outbound: [{ departure: { iataCode: 'ROM', at: '2025-06-15T14:00:00' }, arrival: { iataCode: 'BCN', at: '2025-06-15T16:30:00' }, carrierCode: 'VY', flightNumber: '789', duration: 'PT2H30M' }],\n          inbound: [{ departure: { iataCode: 'BCN', at: '2025-06-20T20:00:00' }, arrival: { iataCode: 'ROM', at: '2025-06-20T22:30:00' }, carrierCode: 'VY', flightNumber: '012', duration: 'PT2H30M' }],\n          airlines: ['Vueling'], totalDuration: 'PT2H30M', stops: 0\n        },\n        {\n          id: '3', price: 200, currency: 'EUR',\n          outbound: [{ departure: { iataCode: 'ROM', at: '2025-06-15T08:00:00' }, arrival: { iataCode: 'BCN', at: '2025-06-15T10:30:00' }, carrierCode: 'AZ', flightNumber: '345', duration: 'PT2H30M' }],\n          inbound: [{ departure: { iataCode: 'BCN', at: '2025-06-20T16:00:00' }, arrival: { iataCode: 'ROM', at: '2025-06-20T18:30:00' }, carrierCode: 'AZ', flightNumber: '678', duration: 'PT2H30M' }],\n          airlines: ['ITA Airways'], totalDuration: 'PT2H30M', stops: 0\n        }\n      ]);\n\n      const result = await executeToolCall('search_flights', {\n        origin: 'Rome',\n        destination: 'Barcelona',\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20',\n        passengers: 2\n      }, {});\n\n      expect(result.flights).toHaveLength(3);\n    });\n\n    it('handles empty flight results', async () => {\n      const { searchFlights } = await import('./amadeus-flights');\n      vi.mocked(searchFlights).mockResolvedValue([]);\n\n      const result = await executeToolCall('search_flights', {\n        origin: 'Rome',\n        destination: 'Barcelona',\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20',\n        passengers: 2\n      }, {});\n\n      expect(result.flights).toEqual([]);\n    });\n\n    it('handles API errors gracefully', async () => {\n      const { searchFlights } = await import('./amadeus-flights');\n      vi.mocked(searchFlights).mockRejectedValue(new Error('API Error'));\n\n      const result = await executeToolCall('search_flights', {\n        origin: 'Rome',\n        destination: 'Barcelona',\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20',\n        passengers: 2\n      }, {});\n\n      expect(result.error).toBeDefined();\n      expect(result.flights).toEqual([]);\n    });\n\n    it('uses city substring for unknown cities', async () => {\n      const { searchFlights } = await import('./amadeus-flights');\n      vi.mocked(searchFlights).mockResolvedValue([]);\n\n      await executeToolCall('search_flights', {\n        origin: 'UnknownCity',\n        destination: 'AnotherCity',\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20',\n        passengers: 2\n      }, {});\n\n      expect(searchFlights).toHaveBeenCalledWith({\n        originCode: 'UNK',\n        destinationCode: 'ANO',\n        departureDate: '2025-06-15',\n        returnDate: '2025-06-20',\n        adults: 2,\n        currency: 'EUR'\n      });\n    });\n\n    it('extracts IATA code from parentheses format like \"Fiumicino (FCO)\"', async () => {\n      const { searchFlights } = await import('./amadeus-flights');\n      vi.mocked(searchFlights).mockResolvedValue([]);\n\n      await executeToolCall('search_flights', {\n        origin: 'Fiumicino (FCO)',\n        destination: 'Barcelona (BCN)',\n        departure_date: '2025-06-15',\n        return_date: '2025-06-20',\n        passengers: 3\n      }, {});\n\n      expect(searchFlights).toHaveBeenCalledWith({\n        originCode: 'FCO',\n        destinationCode: 'BCN',\n        departureDate: '2025-06-15',\n        returnDate: '2025-06-20',\n        adults: 3,\n        currency: 'EUR'\n      });\n    });\n  });\n\n  describe('search_hotels tool', () => {\n    it('calls amadeus API with correct parameters', async () => {\n      const { searchHotels } = await import('./amadeus-hotels');\n      vi.mocked(searchHotels).mockResolvedValue([\n        {\n          hotelId: 'H1',\n          name: 'Test Hotel',\n          stars: '4',\n          priceTotal: 150,\n          currency: 'EUR',\n          offerId: 'OFF1',\n          bookingFlow: 'IN_APP',\n          paymentPolicy: 'PAY_AT_HOTEL',\n          checkInDate: '2025-06-15',\n          checkOutDate: '2025-06-20',\n          roomDescription: 'Standard Room'\n        }\n      ]);\n\n      const result = await executeToolCall('search_hotels', {\n        destination: 'Barcelona',\n        check_in_date: '2025-06-15',\n        check_out_date: '2025-06-20',\n        guests: 2\n      }, {});\n\n      expect(searchHotels).toHaveBeenCalledWith({\n        cityCode: 'BCN',\n        checkInDate: '2025-06-15',\n        checkOutDate: '2025-06-20',\n        adults: 2,\n        currency: 'EUR'\n      });\n\n      expect(result.hotels).toHaveLength(1);\n      expect((result.hotels as any[])[0].name).toBe('Test Hotel');\n      expect((result.hotels as any[])[0].priceTotal).toBe(150);\n    });\n\n    it('handles multiple hotel results and limits to 5', async () => {\n      const { searchHotels } = await import('./amadeus-hotels');\n      const mockHotels = Array.from({ length: 10 }, (_, i) => ({\n        hotelId: `H${i + 1}`,\n        name: `Hotel ${i + 1}`,\n        stars: '3',\n        priceTotal: 100 + i * 10,\n        currency: 'EUR',\n        offerId: `OFF${i + 1}`,\n        bookingFlow: 'IN_APP' as const,\n        paymentPolicy: 'PAY_NOW',\n        checkInDate: '2025-06-15',\n        checkOutDate: '2025-06-20'\n      }));\n      vi.mocked(searchHotels).mockResolvedValue(mockHotels);\n\n      const result = await executeToolCall('search_hotels', {\n        destination: 'Barcelona',\n        check_in_date: '2025-06-15',\n        check_out_date: '2025-06-20',\n        guests: 4\n      }, {});\n\n      expect(result.hotels).toHaveLength(5);\n    });\n\n    it('handles empty hotel results', async () => {\n      const { searchHotels } = await import('./amadeus-hotels');\n      vi.mocked(searchHotels).mockResolvedValue([]);\n\n      const result = await executeToolCall('search_hotels', {\n        destination: 'Barcelona',\n        check_in_date: '2025-06-15',\n        check_out_date: '2025-06-20',\n        guests: 2\n      }, {});\n\n      expect(result.hotels).toEqual([]);\n    });\n\n    it('handles API errors gracefully', async () => {\n      const { searchHotels } = await import('./amadeus-hotels');\n      vi.mocked(searchHotels).mockRejectedValue(new Error('API Error'));\n\n      const result = await executeToolCall('search_hotels', {\n        destination: 'Barcelona',\n        check_in_date: '2025-06-15',\n        check_out_date: '2025-06-20',\n        guests: 2\n      }, {});\n\n      expect(result.error).toBeDefined();\n      expect(result.hotels).toEqual([]);\n    });\n\n    it('uses city substring for unknown cities', async () => {\n      const { searchHotels } = await import('./amadeus-hotels');\n      vi.mocked(searchHotels).mockResolvedValue([]);\n\n      await executeToolCall('search_hotels', {\n        destination: 'UnknownCity',\n        check_in_date: '2025-06-15',\n        check_out_date: '2025-06-20',\n        guests: 2\n      }, {});\n\n      expect(searchHotels).toHaveBeenCalledWith({\n        cityCode: 'UNK',\n        checkInDate: '2025-06-15',\n        checkOutDate: '2025-06-20',\n        adults: 2,\n        currency: 'EUR'\n      });\n    });\n\n    it('defaults to 2 guests when guests is not a number', async () => {\n      const { searchHotels } = await import('./amadeus-hotels');\n      vi.mocked(searchHotels).mockResolvedValue([]);\n\n      await executeToolCall('search_hotels', {\n        destination: 'Barcelona',\n        check_in_date: '2025-06-15',\n        check_out_date: '2025-06-20',\n        guests: null\n      }, {});\n\n      expect(searchHotels).toHaveBeenCalledWith({\n        cityCode: 'BCN',\n        checkInDate: '2025-06-15',\n        checkOutDate: '2025-06-20',\n        adults: 2,\n        currency: 'EUR'\n      });\n    });\n  });\n\n  describe('select_flight tool', () => {\n    it('returns success with selected flight number', async () => {\n      const result = await executeToolCall('select_flight', { flight_number: 2 }, {});\n      expect(result).toEqual({ success: true, selected_flight: 2 });\n    });\n\n    it('handles first flight selection', async () => {\n      const result = await executeToolCall('select_flight', { flight_number: 1 }, {});\n      expect(result).toEqual({ success: true, selected_flight: 1 });\n    });\n  });\n\n  describe('unlock_checkout tool', () => {\n    it('returns success with checkout unlocked', async () => {\n      const result = await executeToolCall('unlock_checkout', {}, {});\n      expect(result).toEqual({ success: true, checkout_unlocked: true });\n    });\n  });\n\n  describe('unknown tool', () => {\n    it('returns error for unknown tool name', async () => {\n      const result = await executeToolCall('unknown_tool', {}, {});\n      expect(result).toEqual({ error: 'Unknown tool: unknown_tool' });\n    });\n\n    it('returns error for empty tool name', async () => {\n      const result = await executeToolCall('', {}, {});\n      expect(result).toEqual({ error: 'Unknown tool: ' });\n    });\n  });\n});\n","path":null,"size_bytes":15213,"size_tokens":null},"client/src/components/ui/button.test.tsx":{"content":"/**\n * @vitest-environment jsdom\n */\nimport { describe, it, expect, vi } from 'vitest';\nimport { render, screen, fireEvent } from '@testing-library/react';\nimport { Button } from './button';\n\ndescribe('Button component', () => {\n  describe('rendering', () => {\n    it('renders with children text', () => {\n      render(<Button>Click me</Button>);\n      expect(screen.getByRole('button', { name: 'Click me' })).toBeInTheDocument();\n    });\n\n    it('renders as a button element by default', () => {\n      render(<Button>Test</Button>);\n      expect(screen.getByRole('button')).toBeInTheDocument();\n    });\n  });\n\n  describe('variants', () => {\n    it('applies default variant styles', () => {\n      render(<Button variant=\"default\">Default</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('bg-primary');\n    });\n\n    it('applies destructive variant styles', () => {\n      render(<Button variant=\"destructive\">Delete</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('bg-destructive');\n    });\n\n    it('applies outline variant styles', () => {\n      render(<Button variant=\"outline\">Outline</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('border');\n    });\n\n    it('applies ghost variant styles', () => {\n      render(<Button variant=\"ghost\">Ghost</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('hover:bg-accent');\n    });\n  });\n\n  describe('sizes', () => {\n    it('applies default size', () => {\n      render(<Button size=\"default\">Default Size</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('h-10');\n    });\n\n    it('applies small size', () => {\n      render(<Button size=\"sm\">Small</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('h-9');\n    });\n\n    it('applies large size', () => {\n      render(<Button size=\"lg\">Large</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('h-11');\n    });\n\n    it('applies icon size', () => {\n      render(<Button size=\"icon\">Icon</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('h-10', 'w-10');\n    });\n  });\n\n  describe('interactions', () => {\n    it('calls onClick handler when clicked', () => {\n      const handleClick = vi.fn();\n      render(<Button onClick={handleClick}>Click me</Button>);\n\n      fireEvent.click(screen.getByRole('button'));\n      expect(handleClick).toHaveBeenCalledTimes(1);\n    });\n\n    it('does not call onClick when disabled', () => {\n      const handleClick = vi.fn();\n      render(<Button onClick={handleClick} disabled>Disabled</Button>);\n\n      fireEvent.click(screen.getByRole('button'));\n      expect(handleClick).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('disabled state', () => {\n    it('applies disabled attribute', () => {\n      render(<Button disabled>Disabled</Button>);\n      expect(screen.getByRole('button')).toBeDisabled();\n    });\n\n    it('applies disabled styles', () => {\n      render(<Button disabled>Disabled</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('disabled:opacity-50');\n    });\n  });\n\n  describe('custom className', () => {\n    it('allows custom className to be added', () => {\n      render(<Button className=\"custom-class\">Custom</Button>);\n      const button = screen.getByRole('button');\n      expect(button).toHaveClass('custom-class');\n    });\n  });\n\n  describe('type attribute', () => {\n    it('defaults to type button', () => {\n      render(<Button>Default Type</Button>);\n      // Button doesn't explicitly set type, so it won't have it in the DOM\n    });\n\n    it('accepts submit type', () => {\n      render(<Button type=\"submit\">Submit</Button>);\n      expect(screen.getByRole('button')).toHaveAttribute('type', 'submit');\n    });\n  });\n});\n","path":null,"size_bytes":3954,"size_tokens":null},"thoughts/shared/plans/2026-01-18-fix-flight-search-tool.md":{"content":"# Fix Flight Search Tool Implementation Plan\n\n## Overview\n\nThe flight search tool (`search_flights`) is not returning flight results to the OpenAI model, causing it to say \"no flights found\" even though the Aviasales URL is generated correctly on the client side. This plan addresses the root cause and fixes the data flow.\n\n## Current State Analysis\n\n### The Issue\n\nWhen a user asks to search for flights, two parallel processes happen:\n\n1. **Server-side (OpenAI tool loop)**:\n   - OpenAI calls `search_flights` tool\n   - Server executes `executeToolCall(\"search_flights\", ...)` in `openai.ts:430-468`\n   - Returns result to OpenAI, which generates a response\n   - **This is returning empty flights**\n\n2. **Client-side (UI update)**:\n   - Client receives `tool_call` event via SSE\n   - `handleToolCall` in `ChatDialogCompact.tsx:613-658` calls `/api/flights/search` REST endpoint\n   - Populates `flights` state and generates Aviasales URLs\n   - **This works correctly**\n\n### Key Discoveries\n\n1. **Both implementations use the same API call** but the server-side `executeToolCall` returns empty flights\n2. The Aviasales API (`api.travelpayouts.com/v1/prices/cheap`) returns data nested as `data.[DESTINATION_IATA].[index]`\n3. **Critical**: The API returns empty data for past dates without errors\n4. **Missing logging**: No debug output to see what the API actually returns during tool execution\n\n### Root Cause Hypothesis\n\nMost likely causes (in order of probability):\n\n1. **Date format mismatch**: The model might pass dates in an unexpected format\n2. **Empty API response**: The Aviasales API might return empty `data` object for certain date ranges\n3. **Silent failure**: Errors in the transformation logic aren't surfaced properly\n\n## Desired End State\n\nAfter this fix:\n- The OpenAI model receives flight data from `executeToolCall` and can present options to users\n- Debug logging shows the API request/response for troubleshooting\n- The model and client-side UI show consistent flight data\n- Error cases are properly handled and logged\n\n### Verification\n\n1. Send a chat message like \"Search flights from Rome to Barcelona for June 15-20, 2026 for 5 people\"\n2. OpenAI model should respond with flight options (not \"no flights found\")\n3. Server logs should show the Aviasales API request and response\n4. The same flights should appear in both the model's response and the client UI\n\n## What We're NOT Doing\n\n- Not changing the Aviasales API integration fundamentally\n- Not modifying the client-side flight search logic (it works)\n- Not adding new features to the flight search\n- Not changing the OpenAI tool definitions\n\n## Implementation Approach\n\nAdd debug logging first to confirm the issue, then fix the data transformation if needed.\n\n---\n\n## Phase 1: Add Debug Logging to executeToolCall\n\n### Overview\nAdd comprehensive logging to understand what data flows through the `search_flights` tool execution.\n\n### Changes Required:\n\n#### 1. Add logging to search_flights tool execution\n**File**: `server/services/openai.ts`\n**Changes**: Add console.log statements to trace the data flow\n\n```typescript\ncase \"search_flights\": {\n  const { searchCheapestFlights } = await import(\"./aviasales\");\n  const { cityToIata } = await import(\"./cityMapping\");\n\n  const originCity = typeof args.origin === \"string\" ? args.origin : \"\";\n  const destCity = typeof args.destination === \"string\" ? args.destination : \"\";\n  const originIata = cityToIata(originCity) || originCity.substring(0, 3).toUpperCase();\n  const destIata = cityToIata(destCity) || destCity.substring(0, 3).toUpperCase();\n\n  console.log(\"🔍 search_flights tool called with:\", {\n    originCity,\n    destCity,\n    originIata,\n    destIata,\n    departure_date: args.departure_date,\n    return_date: args.return_date,\n    passengers: args.passengers\n  });\n\n  try {\n    const flightData = await searchCheapestFlights({\n      origin: originIata,\n      destination: destIata,\n      departDate: typeof args.departure_date === \"string\" ? args.departure_date : undefined,\n      currency: \"EUR\"\n    });\n\n    console.log(\"📦 Aviasales API response:\", JSON.stringify(flightData, null, 2));\n\n    // Transform to user-friendly format\n    const destCode = Object.keys(flightData.data || {})[0];\n    console.log(\"🎯 Destination code from response:\", destCode);\n\n    const offersObj = flightData.data?.[destCode] || {};\n    console.log(\"✈️ Offers object:\", JSON.stringify(offersObj, null, 2));\n\n    const flights = Object.values(offersObj as Record<string, unknown>)\n      .slice(0, 5)\n      .map((f: unknown) => {\n        const flight = f as Record<string, unknown>;\n        return {\n          airline: flight.airline,\n          price: flight.price,\n          departure_at: flight.departure_at,\n          return_at: flight.return_at,\n          flight_number: flight.flight_number\n        };\n      });\n\n    console.log(\"✅ Transformed flights:\", JSON.stringify(flights, null, 2));\n\n    return { flights, origin: originIata, destination: destIata };\n  } catch (error) {\n    console.error(\"❌ Flight search error:\", error);\n    return { error: \"Failed to search flights. Please try again.\", flights: [] };\n  }\n}\n```\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] TypeScript compiles without errors: `npx tsc --noEmit`\n- [ ] Server starts without errors: `npm run dev`\n\n#### Manual Verification:\n- [ ] Send a chat message to search for flights\n- [ ] Check server console logs for the debug output\n- [ ] Verify logs show: input args, API response, destination code, offers, transformed flights\n\n**Implementation Note**: After completing this phase, run a test to see the actual data flowing through. The logs will reveal whether the API is returning empty data or if the transformation is failing. Pause here for manual testing before proceeding.\n\n---\n\n## Phase 2: Fix Data Transformation (if needed based on Phase 1 findings)\n\n### Overview\nBased on Phase 1 logging, fix any issues with the data transformation.\n\n### Potential Fixes:\n\n#### Scenario A: API returns data but transformation fails\n**File**: `server/services/openai.ts`\n\nIf the logs show `flightData.data` has flights but they're not being extracted properly:\n\n```typescript\n// The API response structure is: { success: true, data: { \"BCN\": { \"0\": {...}, \"1\": {...} } } }\n// We need to handle cases where destination key might differ from what we expect\n\nconst destCode = Object.keys(flightData.data || {})[0];\nif (!destCode) {\n  console.log(\"⚠️ No destination code found in API response\");\n  return { flights: [], origin: originIata, destination: destIata };\n}\n```\n\n#### Scenario B: API returns empty data\nIf the API consistently returns `{ success: true, data: {} }`, we need to investigate:\n- Check if dates are in the future\n- Check if the IATA codes are valid\n- Consider using a different API endpoint or parameters\n\n#### Scenario C: IATA code conversion fails\nIf `cityToIata` returns null for valid cities, update the city mapping.\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] All existing tests pass: `npm test`\n- [ ] TypeScript compiles: `npx tsc --noEmit`\n\n#### Manual Verification:\n- [ ] OpenAI model responds with flight options when asked to search\n- [ ] Flight details (airline, departure, return times) are accurate\n- [ ] Server logs show successful data transformation\n\n**Implementation Note**: The specific fix depends on what Phase 1 reveals. Pause after Phase 1 to analyze the logs.\n\n---\n\n## Phase 3: Ensure Consistency Between Tool and REST Endpoint\n\n### Overview\nAfter fixing the tool, ensure the `executeToolCall` returns data in a format consistent with what the client expects.\n\n### Changes Required:\n\n#### 1. Add checkoutUrl to tool response (optional but helpful)\n**File**: `server/services/openai.ts`\n\nThe client-side code generates checkoutUrls, but the model could also provide them:\n\n```typescript\nconst flights = Object.values(offersObj as Record<string, unknown>)\n  .slice(0, 5)\n  .map((f: unknown, idx: number) => {\n    const flight = f as Record<string, unknown>;\n    const depDate = (flight.departure_at as string)?.slice(0, 10) || \"\";\n    const retDate = (flight.return_at as string)?.slice(0, 10) || \"\";\n    const depDay = depDate.slice(8, 10);\n    const depMonth = depDate.slice(5, 7);\n    const retDay = retDate.slice(8, 10);\n    const retMonth = retDate.slice(5, 7);\n\n    const numPassengers = typeof args.passengers === \"number\" ? args.passengers : 1;\n    const checkoutUrl = `https://www.aviasales.com/search/${originIata}${depDay}${depMonth}${destIata}${retDay}${retMonth}${numPassengers}?marker=${process.env.AVIASALES_PARTNER_ID || \"byebi\"}`;\n\n    return {\n      airline: flight.airline,\n      price: flight.price,\n      departure_at: flight.departure_at,\n      return_at: flight.return_at,\n      flight_number: flight.flight_number,\n      checkoutUrl\n    };\n  });\n```\n\n### Success Criteria:\n\n#### Automated Verification:\n- [ ] All tests pass: `npm test`\n- [ ] TypeScript compiles: `npx tsc --noEmit`\n\n#### Manual Verification:\n- [ ] Complete a full flight search conversation\n- [ ] Verify the model can present flight options with booking links\n- [ ] Verify checkout URLs work correctly\n\n---\n\n## Testing Strategy\n\n### Unit Tests:\n- Existing tests in `openai.test.ts` cover `executeToolCall`\n- Tests mock the Aviasales API, so they pass even if the real API has issues\n- Consider adding an integration test that uses the real API\n\n### Integration Tests:\n- Test the full flow: message → tool call → API call → response\n- Check that tool results are properly sent back to OpenAI\n\n### Manual Testing Steps:\n1. Start the dev server: `npm run dev`\n2. Open the chat dialog\n3. Type: \"I want to fly from Rome to Barcelona on June 15-20, 2026 with 5 friends\"\n4. Verify:\n   - Server logs show API request/response\n   - Model responds with flight options (not \"no flights found\")\n   - Flight cards appear in the UI\n   - Checkout URLs work\n\n## References\n\n- Aviasales API documentation: `server/services/aviasales.ts`\n- Tool execution: `server/services/openai.ts:430-468`\n- REST endpoint: `server/routes.ts:824-890`\n- Client handling: `client/src/components/ChatDialogCompact.tsx:613-658`\n- [Travelpayouts API Documentation](https://support.travelpayouts.com/hc/en-us/articles/203956163-Aviasales-Data-API)\n","path":null,"size_bytes":10285,"size_tokens":null},"client/src/lib/utils.test.ts":{"content":"import { describe, it, expect } from 'vitest';\nimport { cn } from './utils';\n\ndescribe('cn utility', () => {\n  it('merges class names', () => {\n    expect(cn('foo', 'bar')).toBe('foo bar');\n  });\n\n  it('handles conditional classes', () => {\n    expect(cn('base', true && 'included', false && 'excluded')).toBe('base included');\n  });\n\n  it('handles undefined and null', () => {\n    expect(cn('base', undefined, null, 'end')).toBe('base end');\n  });\n\n  it('merges tailwind classes correctly', () => {\n    expect(cn('px-2 py-1', 'px-4')).toBe('py-1 px-4');\n  });\n\n  it('handles arrays of classes', () => {\n    expect(cn(['foo', 'bar'])).toBe('foo bar');\n  });\n\n  it('handles objects with conditional classes', () => {\n    expect(cn({ foo: true, bar: false, baz: true })).toBe('foo baz');\n  });\n\n  it('handles empty input', () => {\n    expect(cn()).toBe('');\n  });\n});\n","path":null,"size_bytes":866,"size_tokens":null},"client/src/App.test.tsx":{"content":"/**\n * @vitest-environment jsdom\n */\nimport { describe, it, expect, vi, beforeEach } from 'vitest';\nimport { render, screen, fireEvent } from '@testing-library/react';\nimport React from 'react';\n\ndescribe('App smoke tests', () => {\n  describe('React basics', () => {\n    it('can render a basic React component', () => {\n      const TestComponent = () => <div data-testid=\"test\">Hello</div>;\n      render(<TestComponent />);\n      expect(screen.getByTestId('test')).toBeInTheDocument();\n    });\n\n    it('can render components with children', () => {\n      const Parent = ({ children }: { children: React.ReactNode }) => (\n        <div data-testid=\"parent\">{children}</div>\n      );\n      const Child = () => <span data-testid=\"child\">Child content</span>;\n\n      render(\n        <Parent>\n          <Child />\n        </Parent>\n      );\n\n      expect(screen.getByTestId('parent')).toBeInTheDocument();\n      expect(screen.getByTestId('child')).toBeInTheDocument();\n    });\n\n    it('can handle state updates', async () => {\n      const Counter = () => {\n        const [count, setCount] = React.useState(0);\n        return (\n          <div>\n            <span data-testid=\"count\">{count}</span>\n            <button onClick={() => setCount(c => c + 1)} data-testid=\"increment\">\n              Increment\n            </button>\n          </div>\n        );\n      };\n\n      render(<Counter />);\n\n      expect(screen.getByTestId('count')).toHaveTextContent('0');\n\n      fireEvent.click(screen.getByTestId('increment'));\n\n      expect(screen.getByTestId('count')).toHaveTextContent('1');\n    });\n  });\n\n  describe('context providers', () => {\n    it('can use React Context', () => {\n      const ThemeContext = React.createContext('light');\n\n      const ThemedComponent = () => {\n        const theme = React.useContext(ThemeContext);\n        return <div data-testid=\"theme\">{theme}</div>;\n      };\n\n      render(\n        <ThemeContext.Provider value=\"dark\">\n          <ThemedComponent />\n        </ThemeContext.Provider>\n      );\n\n      expect(screen.getByTestId('theme')).toHaveTextContent('dark');\n    });\n  });\n\n  describe('DOM environment', () => {\n    it('has document available', () => {\n      expect(document).toBeDefined();\n      expect(document.body).toBeDefined();\n    });\n\n    it('has window available', () => {\n      expect(window).toBeDefined();\n    });\n\n    it('has localStorage available', () => {\n      expect(window.localStorage).toBeDefined();\n\n      window.localStorage.setItem('test', 'value');\n      expect(window.localStorage.getItem('test')).toBe('value');\n      window.localStorage.removeItem('test');\n    });\n  });\n});\n","path":null,"size_bytes":2628,"size_tokens":null}},"version":2}